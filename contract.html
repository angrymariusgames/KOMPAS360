<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KOMPAS ‚Ä¢ Udviklingskontrakt</title>
  <link rel="icon" href="data:,">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --brand: #f5576c;
      --bg: #f8f9fa;
      --surface: #ffffff;
      --line: #e2e8f0;
      --text: #1e293b;
      --text-secondary: #64748b;
      --muted: #94a3b8;
      --success: #22c55e;
      --info: #3b82f6;
      --warning: #f59e0b;
      --error: #ef4444;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }
    
    .app {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      background: linear-gradient(135deg, var(--brand) 0%, #ff6b7a 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      text-align: center;
    }
    
    .header h1 {
      margin: 0 0 8px 0;
      font-size: 2rem;
    }
    
    .header p {
      margin: 0;
      opacity: 0.95;
      font-size: 1.1rem;
    }
    
    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: white;
      color: var(--brand);
      border: 2px solid var(--brand);
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.2s;
      margin-bottom: 20px;
    }
    
    .back-button:hover {
      background: var(--brand);
      color: white;
    }
    
    .section {
      background: white;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }
    
    .section h3 {
      margin: 0 0 16px 0;
      color: var(--brand);
      font-size: 1.3rem;
    }
    
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--text);
      font-size: 0.95rem;
    }
    
    .input, .select {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--line);
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.2s;
    }
    
    .input:focus, .select:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(245, 87, 108, 0.1);
    }
    
    textarea.input {
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: var(--brand);
      color: white;
    }
    
    .btn-primary:hover:not(:disabled) {
      background: #e04658;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(245, 87, 108, 0.3);
    }
    
    .btn-secondary {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--line);
    }
    
    .btn-secondary:hover:not(:disabled) {
      background: var(--bg);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--line);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--brand), var(--success));
      transition: width 0.3s ease;
      border-radius: 4px;
    }
    
    .contract-unified-section {
      background: white;
      border: 2px solid var(--line);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s;
    }
    
    .contract-unified-section.active {
      border-color: var(--brand);
      opacity: 1 !important;
      box-shadow: 0 4px 12px rgba(245, 87, 108, 0.1);
    }
    
    .competency-card {
      background: var(--surface);
      border: 2px solid var(--line);
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .competency-card:hover {
      border-color: var(--brand);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .competency-card.selected {
      background: rgba(245, 87, 108, 0.1);
      border-color: var(--brand);
    }
    
    .tip-card {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tip-card:hover {
      border-color: var(--brand);
    }
    
    .tip-card.selected {
      background: rgba(245, 87, 108, 0.05);
      border-color: var(--brand);
      border-left: 3px solid var(--brand);
    }
    
    .method-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--line);
      color: var(--text-secondary);
    }
    
    .status-text {
      font-size: 0.8rem;
      color: var(--muted);
    }
    
    .status-text.complete {
      color: var(--success);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="app">
    <a href="admin.html" class="back-button">‚Üê Tilbage til Admin</a>
    
    <div class="header">
      <h1>üìã Udviklingskontrakt</h1>
      <p>Skab en personlig udviklingsplan baseret p√• KOMPAS-resultaterne</p>
    </div>
    
    <!-- Progress Tracker -->
    <div class="section">
      <div class="progress-bar">
        <div id="contractProgressFill" class="progress-fill" style="width: 0%"></div>
      </div>
      <p id="contractProgressText" style="text-align: center; color: var(--muted); font-size: 0.9rem">0/4 sektioner f√¶rdige</p>
    </div>
    
    <!-- Project & Person Selection -->
    <div class="section">
      <h3>Projekt og m√•lperson</h3>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px">
        <div>
          <label>Projekt</label>
          <select id="contractProjectSelect" class="select">
            <option value="">V√¶lg projekt...</option>
          </select>
        </div>
        <div>
          <label>M√•lperson</label>
          <select id="contractTargetSelect" class="select">
            <option value="">V√¶lg m√•lperson...</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Main Sections Grid -->
    <div id="contractUnifiedSections" style="display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto auto; gap: 20px; margin-bottom: 120px">
      
      <!-- Section 1: Kompetencer -->
      <section class="contract-unified-section competencies-section active" id="contractCompetenciesSection" style="opacity: 1">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--line)">
          <div style="background: var(--brand); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 700">1</div>
          <h3 style="margin: 0; font-size: 1.1rem; font-weight: 700; flex: 1">V√¶lg kompetencer til udvikling</h3>
          <div id="contractCompetenciesStatus" style="background: var(--surface); border: 1px solid var(--line); border-radius: 6px; padding: 4px 8px; font-size: 0.8rem; color: var(--muted)">
            <span class="status-text">0 valgt</span>
          </div>
        </div>
        <div>
          <p style="color: var(--muted); margin-bottom: 16px">
            V√¶lg de KOMPAS-kompetencer som skal fokuseres p√• i udviklingsplanen
          </p>
          <div id="contractCompetencyGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin: 16px 0">
            <!-- Kompetencer indl√¶ses dynamisk -->
          </div>
        </div>
      </section>
      
      <!-- Section 2: Aktiviteter -->
      <section class="contract-unified-section activities-section" id="contractActivitiesSection" style="opacity: 0.6">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--line)">
          <div style="background: var(--brand); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 700">2</div>
          <h3 style="margin: 0; font-size: 1.1rem; font-weight: 700; flex: 1">V√¶lg udviklingsaktiviteter</h3>
          <div id="contractActivitiesStatus" style="background: var(--surface); border: 1px solid var(--line); border-radius: 6px; padding: 4px 8px; font-size: 0.8rem; color: var(--muted)">
            <span class="status-text">V√¶lg f√∏rst kompetencer</span>
          </div>
        </div>
        <div>
          <p style="color: var(--muted); margin-bottom: 16px">
            V√¶lg konkrete tips og aktiviteter for hver kompetence
          </p>
          <div id="contractTipsContainer">
            <!-- Tips indl√¶ses dynamisk -->
          </div>
        </div>
      </section>
      
      <!-- Section 3: Roller & aftaler -->
      <section class="contract-unified-section roles-section" id="contractRolesSection" style="opacity: 0.6">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--line)">
          <div style="background: var(--brand); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 700">3</div>
          <h3 style="margin: 0; font-size: 1.1rem; font-weight: 700; flex: 1">Aftaler om roller og ansvar</h3>
          <div id="contractRolesStatus" style="background: var(--surface); border: 1px solid var(--line); border-radius: 6px; padding: 4px 8px; font-size: 0.8rem; color: var(--muted)">
            <span class="status-text">V√¶lg f√∏rst aktiviteter</span>
          </div>
        </div>
        <div>
          <p style="color: var(--muted); margin-bottom: 16px">
            Definer hvem g√∏r hvad og s√¶t opf√∏lgning
          </p>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px">
            <div style="background: #fff; border: 1px solid var(--line); border-radius: 8px; padding: 16px">
              <h4 style="margin: 0 0 16px 0; text-align: center; color: var(--brand)">üë§ Medarbejder g√∏r</h4>
              <textarea id="contractEmployeeActions" class="input" style="width: 100%; min-height: 120px; resize: vertical" placeholder="Skriv hvad medarbejderen skal g√∏re..."></textarea>
            </div>
            <div style="background: #fff; border: 1px solid var(--line); border-radius: 8px; padding: 16px">
              <h4 style="margin: 0 0 16px 0; text-align: center; color: var(--brand)">üí≠ Medarbejder √∏nsker</h4>
              <textarea id="contractEmployeeWishes" class="input" style="width: 100%; min-height: 120px; resize: vertical" placeholder="Skriv hvad medarbejderen √∏nsker at opn√•..."></textarea>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px">
            <div style="background: #fff; border: 1px solid var(--line); border-radius: 8px; padding: 16px">
              <h4 style="margin: 0 0 16px 0; text-align: center; color: var(--brand)">üë®‚Äçüíº Leder st√∏tter</h4>
              <textarea id="contractLeaderActions" class="input" style="width: 100%; min-height: 120px; resize: vertical" placeholder="Skriv hvordan lederen st√∏tter..."></textarea>
            </div>
            <div style="background: #fff; border: 1px solid var(--line); border-radius: 8px; padding: 16px; position: relative">
              <h4 style="margin: 0 0 16px 0; text-align: center; color: var(--brand)">ü§ù Kollega st√∏tte</h4>
              <label style="position: absolute; top: 12px; right: 12px; display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 0.8rem; color: var(--muted)">
                <input type="checkbox" id="includeColleagueSupport" checked style="cursor: pointer">
                <span>Medtag</span>
              </label>
              <div id="contractColleagueSupport" style="max-height: 120px; overflow-y: auto; padding: 12px; background: var(--bg); border: 1px solid var(--line); border-radius: 6px">
                <p style="color: var(--muted); font-size: 0.85rem; margin: 0">Ingen egnede kollegaer fundet</p>
              </div>
            </div>
          </div>
          
          <!-- 30/60/90 M√•l -->
          <div style="background: #fff; border: 1px solid var(--line); border-radius: 8px; padding: 16px; margin-bottom: 20px; position: relative">
            <h4 style="margin: 0 0 16px 0; text-align: center; color: var(--brand)">üìÖ 30/60/90 M√•l</h4>
            <label style="position: absolute; top: 12px; right: 12px; display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 0.8rem; color: var(--muted)">
              <input type="checkbox" id="include306090Goals" checked style="cursor: pointer">
              <span>Medtag</span>
            </label>
            <div id="contractGoalsContainer" style="max-height: 200px; overflow-y: auto">
              <p style="color: var(--muted); font-size: 0.85rem; margin: 0">Ingen 30/60/90 m√•l valgt</p>
            </div>
          </div>
          
          <!-- Team Roller -->
          <div style="background: #fff; border: 1px solid var(--line); border-radius: 8px; padding: 16px; margin-bottom: 20px; position: relative">
            <h4 style="margin: 0 0 16px 0; text-align: center; color: var(--brand)">üß© Team Roller</h4>
            <label style="position: absolute; top: 12px; right: 12px; display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 0.8rem; color: var(--muted)">
              <input type="checkbox" id="includeTeamRoles" checked style="cursor: pointer">
              <span>Medtag</span>
            </label>
            <div id="contractRolesContainer" style="max-height: 200px; overflow-y: auto">
              <p style="color: var(--muted); font-size: 0.85rem; margin: 0">Ingen roller valgt</p>
            </div>
          </div>
          
          <!-- Opf√∏lgningsdato -->
          <div style="margin-bottom: 20px">
            <label>Opf√∏lgningsdato</label>
            <input type="date" id="contractFollowupDate" class="input" style="width: 100%">
          </div>
        </div>
      </section>
      
      <!-- Section 4: Oversigt -->
      <section class="contract-unified-section overview-section" id="contractOverviewSection" style="opacity: 0.6">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--line)">
          <div style="background: var(--brand); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 700">4</div>
          <h3 style="margin: 0; font-size: 1.1rem; font-weight: 700; flex: 1">Kontraktoversigt og eksport</h3>
          <div id="contractOverviewStatus" style="background: var(--surface); border: 1px solid var(--line); border-radius: 6px; padding: 4px 8px; font-size: 0.8rem; color: var(--muted)">
            <span class="status-text">Live preview</span>
          </div>
        </div>
        <div>
          <div id="contractOverviewContent" style="background: var(--surface); border: 1px solid var(--line); border-radius: 6px; padding: 16px; min-height: 200px">
            <!-- Kontraktoversigt opdateres live -->
          </div>
          
          <!-- Version info -->
          <div style="background: var(--surface); border: 1px solid var(--line); border-radius: 6px; padding: 12px; margin-top: 16px; font-size: 0.9rem; color: var(--muted)">
            <strong>Version:</strong> 1.0<br>
            <strong>Sidst opdateret:</strong> <span id="contractLastUpdated">-</span><br>
            <strong>Oprettet af:</strong> <span id="contractCreatedBy">-</span>
          </div>
        </div>
      </section>
    </div>
    
    <!-- Action Buttons -->
    <div style="position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 2px solid var(--line); padding: 16px; box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1); z-index: 100">
      <div style="max-width: 1400px; margin: 0 auto; display: flex; gap: 12px; justify-content: center">
        <button id="contractSaveDraftBtn" class="btn btn-secondary">üíæ Gem som kladde</button>
        <button id="contractSaveFinalBtn" class="btn btn-primary" disabled>‚úÖ Gem endelig kontrakt</button>
        <button id="contractExportPdfBtn" class="btn btn-secondary" disabled>üìÑ Eksporter til PDF</button>
        <button id="contractLoadBtn" class="btn btn-secondary">üìÇ Indl√¶s kontrakt</button>
      </div>
    </div>
  </div>
  
  <script>
    // Supabase init
    const SUPABASE_URL = 'https://wsrstyrsuwhcmmlmnbrz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzcnN0eXJzdXdoY21tbG1uYnJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MTU0NTIsImV4cCI6MjA3MTE5MTQ1Mn0.Rf3Z3bQGjV5CKXKZr6IMOjzPdbhVJCh3SwuvlkpxUD0';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Helper function
    const $ = (id) => document.getElementById(id);

    // XSS protection: escape HTML entities in user-supplied strings
    function escapeHtml(str) {
      if (!str && str !== 0) return '';
      const div = document.createElement('div');
      div.textContent = String(str);
      return div.innerHTML;
    }
    
    // Global state
    const contractState = {
      project_id: null,
      target_id: null,
      template_id: null,
      selectedCompetencies: new Set(),
      selectedTips: new Map(),
      roles: new Map(),
      employee_actions: '',
      employee_wishes: '',
      leader_actions: '',
      include_colleague_support: true,
      include_306090_goals: true,
      include_team_roles: true,
      followup_date: null
    };
    
    let contractAvailableCompetencies = [];
    let contractAvailableTips = new Map();
    
    // Init
    document.addEventListener('DOMContentLoaded', async () => {
      await contractLoadProjects();
      contractSetupEventListeners();
      contractUpdateProgress();
    });
    
    // ========== PROJECT & TARGET LOADING ==========
    async function contractLoadProjects() {
      try {
        const { data, error } = await supabase
          .from('projects')
          .select('id, title, template_id')
          .order('title');
        
        if (error) throw error;
        
        const select = $('contractProjectSelect');
        select.innerHTML = '<option value="">V√¶lg projekt...</option>';
        
        data.forEach(project => {
          const opt = document.createElement('option');
          opt.value = project.id;
          opt.textContent = project.title;
          opt.dataset.templateId = project.template_id;
          select.appendChild(opt);
        });
      } catch (error) {
        console.error('Fejl ved indl√¶sning af projekter:', error);
        alert('Kunne ikke indl√¶se projekter: ' + error.message);
      }
    }
    
    async function contractLoadTargets(projectId) {
      try {
        const { data, error } = await supabase
          .from('project_people')
          .select('id, full_name')
          .eq('project_id', projectId)
          .order('full_name');
        
        if (error) throw error;
        
        const select = $('contractTargetSelect');
        select.innerHTML = '<option value="">V√¶lg m√•lperson...</option>';
        
        data.forEach(person => {
          const opt = document.createElement('option');
          opt.value = person.id;
          opt.textContent = person.full_name;
          select.appendChild(opt);
        });
      } catch (error) {
        console.error('Fejl ved indl√¶sning af m√•lpersoner:', error);
      }
    }
    
    async function contractLoadCompetencies(templateId) {
      if (!templateId) return;
      
      try {
        const { data, error } = await supabase
          .from('coaching_competency')
          .select(`
            category_id,
            category_name,
            synopsis,
            importance,
            why_matters,
            how_improve
          `)
          .eq('template_id', templateId)
          .order('category_name');
        
        if (error) throw error;
        
        contractAvailableCompetencies = data || [];
        contractDisplayCompetencies();
      } catch (error) {
        console.error('Fejl ved indl√¶sning af kompetencer:', error);
      }
    }
    
    // ========== COMPETENCY DISPLAY ==========
    function contractDisplayCompetencies() {
      const grid = $('contractCompetencyGrid');
      if (!grid) return;
      
      if (contractAvailableCompetencies.length === 0) {
        grid.innerHTML = '<p style="color: var(--muted); grid-column: 1/-1">Ingen kompetencer tilg√¶ngelige</p>';
        return;
      }
      
      grid.innerHTML = '';
      contractAvailableCompetencies.forEach(comp => {
        const card = document.createElement('div');
        card.className = 'competency-card';
        if (contractState.selectedCompetencies.has(comp.category_id)) {
          card.classList.add('selected');
        }
        
        card.innerHTML = `
          <div style="font-weight: 600; margin-bottom: 4px; color: var(--brand)">${escapeHtml(comp.category_name)}</div>
          <div style="font-size: 0.85rem; color: var(--text-secondary)">${escapeHtml(comp.synopsis || '')}</div>
        `;
        
        card.addEventListener('click', () => contractToggleCompetency(comp.category_id));
        grid.appendChild(card);
      });
    }
    
    function contractToggleCompetency(categoryId) {
      if (contractState.selectedCompetencies.has(categoryId)) {
        contractState.selectedCompetencies.delete(categoryId);
        contractState.selectedTips.delete(categoryId);
      } else {
        contractState.selectedCompetencies.add(categoryId);
      }
      
      contractDisplayCompetencies();
      contractUpdateSectionStatus();
      contractUpdateOverview();
      contractUpdateProgress();
    }
    
    // ========== TIPS LOADING ==========
    async function contractLoadTipsForSelected() {
      const grid = $('contractTipsContainer');
      if (!grid) return;
      
      if (contractState.selectedCompetencies.size === 0) {
        grid.innerHTML = '<p style="color: var(--muted)">V√¶lg f√∏rst nogle kompetencer</p>';
        return;
      }
      
      grid.innerHTML = '<p style="color: var(--muted)">Indl√¶ser tips...</p>';
      
      try {
        for (const categoryId of contractState.selectedCompetencies) {
          if (!contractAvailableTips.has(categoryId)) {
            const { data, error } = await supabase
              .from('coaching_tip')
              .select('*')
              .eq('category_id', categoryId)
              .order('title');
            
            if (error) throw error;
            contractAvailableTips.set(categoryId, data || []);
          }
        }
        
        contractDisplayTips();
      } catch (error) {
        console.error('Fejl ved indl√¶sning af tips:', error);
        grid.innerHTML = '<p style="color: var(--error)">Fejl ved indl√¶sning af tips</p>';
      }
    }
    
    function contractDisplayTips() {
      const container = $('contractTipsContainer');
      if (!container) return;
      
      container.innerHTML = '';
      
      for (const categoryId of contractState.selectedCompetencies) {
        const comp = contractAvailableCompetencies.find(c => c.category_id === categoryId);
        const tips = contractAvailableTips.get(categoryId) || [];
        
        const section = document.createElement('div');
        section.style.marginBottom = '24px';
        
        section.innerHTML = `
          <h4 style="color: var(--brand); margin-bottom: 12px; font-size: 1rem">${escapeHtml(comp?.category_name || 'Kompetence')}</h4>
        `;
        
        if (tips.length === 0) {
          section.innerHTML += '<p style="color: var(--muted); font-size: 0.9rem">Ingen tips tilg√¶ngelige</p>';
        } else {
          tips.forEach(tip => {
            const card = document.createElement('div');
            card.className = 'tip-card';
            
            const isSelected = contractState.selectedTips.get(categoryId)?.has(tip.id) || false;
            if (isSelected) card.classList.add('selected');
            
            card.innerHTML = `
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px">
                <span class="method-badge">${escapeHtml(contractMethodLabel(tip.method))}</span>
                <strong style="flex: 1">${escapeHtml(tip.title)}</strong>
              </div>
              <div style="font-size: 0.9rem; color: var(--text-secondary)">${escapeHtml(tip.description)}</div>
            `;
            
            card.addEventListener('click', () => contractToggleTip(categoryId, tip.id));
            section.appendChild(card);
          });
        }
        
        container.appendChild(section);
      }
    }
    
    function contractToggleTip(categoryId, tipId) {
      if (!contractState.selectedTips.has(categoryId)) {
        contractState.selectedTips.set(categoryId, new Set());
      }
      
      const tipSet = contractState.selectedTips.get(categoryId);
      if (tipSet.has(tipId)) {
        tipSet.delete(tipId);
      } else {
        tipSet.add(tipId);
      }
      
      contractDisplayTips();
      contractUpdateSectionStatus();
      contractUpdateOverview();
      contractUpdateProgress();
    }
    
    // ========== METHOD LABELS ==========
    function contractMethodLabel(method) {
      const labels = {
        self: 'Selv',
        colleague: 'Kollega',
        leader_employee: 'Leder',
        group: 'Gruppe',
        external: 'Ekstern',
        course: 'Kursus'
      };
      return labels[method] || method;
    }
    
    // ========== OVERVIEW ==========
    function contractUpdateOverview() {
      const el = $('contractOverviewContent');
      if (!el) return;
      
      let html = '';
      
      // Header info
      html += `<div style="margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid var(--line)">`;
      html += `<h4 style="margin: 0 0 8px 0; color: var(--brand)">Udviklingskontrakt</h4>`;
      html += `<p style="margin: 0; color: var(--muted); font-size: 0.9rem">`;
      html += `Projekt: ${$('contractProjectSelect')?.selectedOptions[0]?.textContent || 'Ikke valgt'}<br>`;
      html += `M√•lperson: ${$('contractTargetSelect')?.selectedOptions[0]?.textContent || 'Ikke valgt'}<br>`;
      html += `Opf√∏lgningsdato: ${contractState.followup_date || 'Ikke sat'}`;
      html += `</p></div>`;
      
      // Kompetencer
      if (contractState.selectedCompetencies.size > 0) {
        html += '<h5>Valgte kompetencer:</h5>';
        contractState.selectedCompetencies.forEach(cid => {
          const c = contractAvailableCompetencies.find(x => x.category_id === cid);
          if (c) {
            html += `<div style="background: var(--surface); border: 1px solid var(--line); border-radius: 6px; padding: 12px; margin-bottom: 8px">`;
            html += `<strong style="color: var(--brand)">${c.category_name}</strong><br>`;
            if (c.synopsis) html += `<div style="margin-top: 4px; font-size: 0.9rem"><em>${c.synopsis}</em></div>`;
            if (c.importance) html += `<div style="margin-top: 4px; font-size: 0.9rem">Vigtighed: ${c.importance}</div>`;
            if (c.why_matters) html += `<div style="margin-top: 4px; font-size: 0.9rem">Hvorfor det betyder noget: ${c.why_matters}</div>`;
            html += `</div>`;
          }
        });
      } else {
        html += '<p style="color: var(--muted)">Ingen kompetencer valgt endnu</p>';
      }
      
      // Aktiviteter
      let totalActivities = 0;
      for (const tips of contractState.selectedTips.values()) totalActivities += tips.size;
      
      if (totalActivities > 0) {
        html += `<h5>Aktiviteter (${totalActivities} valgt):</h5>`;
        for (const [categoryId, tipIds] of contractState.selectedTips.entries()) {
          const category = contractAvailableCompetencies.find(c => c.category_id === categoryId);
          const tips = contractAvailableTips.get(categoryId) || [];
          
          html += `<div style="margin-bottom: 16px"><strong style="color: var(--brand)">${category?.category_name || 'Kompetence'}:</strong></div>`;
          
          tipIds.forEach(tipId => {
            const tip = tips.find(t => t.id === tipId);
            if (tip) {
              html += `<div style="background: var(--surface); border: 1px solid var(--line); border-left: 3px solid var(--brand); border-radius: 6px; padding: 12px; margin-bottom: 8px">`;
              html += `<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px">`;
              html += `<span style="background: var(--brand); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem">${contractMethodLabel(tip.method)}</span>`;
              html += `<strong>${tip.title}</strong>`;
              html += `</div>`;
              html += `<div style="font-size: 0.9rem; color: var(--text)">${tip.description}</div>`;
              html += `</div>`;
            }
          });
        }
      } else {
        html += '<p style="color: var(--muted)">Ingen aktiviteter valgt endnu</p>';
      }
      
      // Roller og aftaler
      html += '<h5>Roller og aftaler:</h5>';
      const hasEmployeeActions = contractState.employee_actions?.trim();
      const hasEmployeeWishes = contractState.employee_wishes?.trim();
      const hasLeaderActions = contractState.leader_actions?.trim();
      
      if (hasEmployeeActions || hasEmployeeWishes || hasLeaderActions) {
        html += '<div style="background: var(--surface); border: 1px solid var(--line); border-radius: 6px; padding: 12px; margin-top: 8px">';
        
        if (hasEmployeeActions) {
          html += `<div style="margin-bottom: 12px">
            <strong style="color: var(--brand)">üë§ Medarbejder g√∏r:</strong>
            <p style="margin: 4px 0 0 0; color: var(--text)">${contractState.employee_actions.replace(/\n/g, '<br>')}</p>
          </div>`;
        }
        
        if (hasEmployeeWishes) {
          html += `<div style="margin-bottom: 12px">
            <strong style="color: var(--brand)">üí≠ Medarbejder √∏nsker:</strong>
            <p style="margin: 4px 0 0 0; color: var(--text)">${contractState.employee_wishes.replace(/\n/g, '<br>')}</p>
          </div>`;
        }
        
        if (hasLeaderActions) {
          html += `<div>
            <strong style="color: var(--brand)">üë®‚Äçüíº Leder st√∏tter:</strong>
            <p style="margin: 4px 0 0 0; color: var(--text)">${contractState.leader_actions.replace(/\n/g, '<br>')}</p>
          </div>`;
        }
        
        html += '</div>';
      } else {
        html += '<p style="color: var(--muted)">Ingen roller defineret endnu</p>';
      }
      
      // Kollega st√∏tte (hvis medtaget)
      if (contractState.include_colleague_support) {
        html += '<h5>ü§ù Kollega st√∏tte:</h5>';
        const colleagueEl = $('contractColleagueSupport');
        if (colleagueEl && colleagueEl.innerHTML.trim() && !colleagueEl.innerHTML.includes('Ingen egnede kollegaer')) {
          html += `<div style="background: var(--surface); border: 1px solid var(--line); border-radius: 6px; padding: 12px; margin-top: 8px">${colleagueEl.innerHTML}</div>`;
        } else {
          html += '<p style="color: var(--muted)">Ingen kollega forslag</p>';
        }
      }
      
      // 30/60/90 M√•l (hvis medtaget)
      if (contractState.include_306090_goals) {
        html += '<h5>üìÖ 30/60/90 M√•l:</h5>';
        const goalsEl = $('contractGoalsContainer');
        if (goalsEl && goalsEl.innerHTML.trim() && !goalsEl.innerHTML.includes('Ingen 30/60/90 m√•l')) {
          html += `<div style="background: var(--surface); border: 1px solid var(--line); border-radius: 6px; padding: 12px; margin-top: 8px">`;
          html += goalsEl.innerHTML;
          html += `</div>`;
        } else {
          html += '<p style="color: var(--muted)">Ingen 30/60/90 m√•l valgt</p>';
        }
      }
      
      // Team Roller (hvis medtaget)
      if (contractState.include_team_roles) {
        html += '<h5>üß© Team Roller:</h5>';
        const rolesEl = $('contractRolesContainer');
        if (rolesEl && rolesEl.innerHTML.trim() && !rolesEl.innerHTML.includes('Ingen roller valgt')) {
          html += `<div style="background: var(--surface); border: 1px solid var(--line); border-radius: 6px; padding: 12px; margin-top: 8px">${rolesEl.innerHTML}</div>`;
        } else {
          html += '<p style="color: var(--muted)">Ingen team roller valgt</p>';
        }
      }
      
      el.innerHTML = html;
    }
    
    // ========== SECTION STATUS ==========
    function contractUpdateSectionStatus() {
      // 1) Kompetencer
      const compCount = contractState.selectedCompetencies.size;
      const compStatus = $('contractCompetenciesStatus');
      const compSection = $('contractCompetenciesSection');
      
      if (compCount > 0) {
        compStatus.innerHTML = `<span class="status-text complete">${compCount} valgt</span>`;
        compSection.classList.add('active');
        $('contractActivitiesSection').classList.add('active');
        contractLoadTipsForSelected();
      } else {
        compStatus.innerHTML = `<span class="status-text">0 valgt</span>`;
        compSection.classList.remove('active');
        $('contractActivitiesSection').classList.remove('active');
        $('contractRolesSection').classList.remove('active');
        $('contractOverviewSection').classList.remove('active');
      }
      
      // 2) Aktiviteter
      let totalTips = 0;
      for (const s of contractState.selectedTips.values()) totalTips += s.size;
      
      const actStatus = $('contractActivitiesStatus');
      if (totalTips > 0) {
        actStatus.innerHTML = `<span class="status-text complete">${totalTips} valgt</span>`;
        $('contractRolesSection').classList.add('active');
      } else if (compCount > 0) {
        actStatus.innerHTML = `<span class="status-text">0 valgt</span>`;
        $('contractRolesSection').classList.remove('active');
        $('contractOverviewSection').classList.remove('active');
      } else {
        actStatus.innerHTML = `<span class="status-text">V√¶lg f√∏rst kompetencer</span>`;
      }
      
      // 3) Roller
      const rolesStatus = $('contractRolesStatus');
      const hasRoles = contractState.employee_actions?.trim() || 
                      contractState.employee_wishes?.trim() || 
                      contractState.leader_actions?.trim();
      
      if (hasRoles) {
        rolesStatus.innerHTML = `<span class="status-text complete">‚úì Defineret</span>`;
        $('contractOverviewSection').classList.add('active');
      } else if (totalTips > 0) {
        rolesStatus.innerHTML = `<span class="status-text">Mangler roller</span>`;
        $('contractOverviewSection').classList.remove('active');
      } else {
        rolesStatus.innerHTML = `<span class="status-text">V√¶lg f√∏rst aktiviteter</span>`;
      }
    }
    
    // ========== PROGRESS ==========
    function contractUpdateProgress() {
      let done = 0;
      if (contractState.selectedCompetencies.size > 0) done++;
      
      let totalTips = 0;
      for (const s of contractState.selectedTips.values()) totalTips += s.size;
      if (totalTips > 0 && contractState.selectedCompetencies.size > 0) done++;
      
      const hasRoles = contractState.employee_actions?.trim() || 
                      contractState.employee_wishes?.trim() || 
                      contractState.leader_actions?.trim();
      if (hasRoles) done++;
      if (hasRoles && contractState.followup_date) done++;
      
      const pct = Math.round((done / 4) * 100);
      $('contractProgressText').textContent = `${done}/4 sektioner f√¶rdige`;
      $('contractProgressFill').style.width = `${pct}%`;
      
      const allComplete = done >= 3;
      $('contractSaveFinalBtn').disabled = !allComplete;
      $('contractExportPdfBtn').disabled = !allComplete;
    }
    
    // ========== EVENT LISTENERS ==========
    function contractSetupEventListeners() {
      // Project selection
      $('contractProjectSelect').addEventListener('change', async (e) => {
        const projectId = e.target.value;
        const templateId = e.target.selectedOptions[0]?.dataset.templateId;
        
        contractState.project_id = projectId || null;
        contractState.template_id = templateId || null;
        
        if (projectId) {
          await contractLoadTargets(projectId);
          await contractLoadCompetencies(templateId);
        }
      });
      
      // Target selection
      $('contractTargetSelect').addEventListener('change', (e) => {
        contractState.target_id = e.target.value || null;
        contractUpdateOverview();
      });
      
      // Roles text areas
      $('contractEmployeeActions').addEventListener('input', (e) => {
        contractState.employee_actions = e.target.value;
        contractUpdateSectionStatus();
        contractUpdateOverview();
        contractUpdateProgress();
      });
      
      $('contractEmployeeWishes').addEventListener('input', (e) => {
        contractState.employee_wishes = e.target.value;
        contractUpdateOverview();
      });
      
      $('contractLeaderActions').addEventListener('input', (e) => {
        contractState.leader_actions = e.target.value;
        contractUpdateSectionStatus();
        contractUpdateOverview();
        contractUpdateProgress();
      });
      
      // Checkboxes
      $('includeColleagueSupport').addEventListener('change', (e) => {
        contractState.include_colleague_support = e.target.checked;
        contractUpdateOverview();
      });
      
      $('include306090Goals').addEventListener('change', (e) => {
        contractState.include_306090_goals = e.target.checked;
        contractUpdateOverview();
      });
      
      $('includeTeamRoles').addEventListener('change', (e) => {
        contractState.include_team_roles = e.target.checked;
        contractUpdateOverview();
      });
      
      // Followup date
      $('contractFollowupDate').addEventListener('change', (e) => {
        contractState.followup_date = e.target.value || null;
        contractUpdateSectionStatus();
        contractUpdateOverview();
        contractUpdateProgress();
      });
      
      // Buttons
      $('contractSaveDraftBtn').addEventListener('click', () => contractSave(true));
      $('contractSaveFinalBtn').addEventListener('click', () => contractSave(false));
      $('contractExportPdfBtn').addEventListener('click', contractExportPdf);
      $('contractLoadBtn').addEventListener('click', contractLoad);
    }
    
    // ========== SAVE ==========
    async function contractSave(isDraft) {
      try {
        if (!contractState.project_id || !contractState.target_id) {
          alert('V√¶lg b√•de projekt og m√•lperson f√∏rst.');
          return;
        }
        
        // Hent navne
        const { data: project } = await supabase
          .from('projects')
          .select('title')
          .eq('id', contractState.project_id)
          .single();
        
        const { data: person } = await supabase
          .from('project_people')
          .select('full_name')
          .eq('id', contractState.target_id)
          .single();
        
        // Byg data
        const contractData = {
          version: 1,
          created_at: new Date().toISOString(),
          is_draft: isDraft,
          project_id: contractState.project_id,
          project_name: project?.title || 'Ukendt projekt',
          target_id: contractState.target_id,
          target_name: person?.full_name || 'Ukendt person',
          template_id: contractState.template_id,
          selected_competencies: Array.from(contractState.selectedCompetencies),
          selected_tips: contractSerializeSelectedTips(),
          roles: contractSerializeRoles(),
          employee_actions: contractState.employee_actions,
          employee_wishes: contractState.employee_wishes,
          leader_actions: contractState.leader_actions,
          include_colleague_support: contractState.include_colleague_support,
          include_306090_goals: contractState.include_306090_goals,
          include_team_roles: contractState.include_team_roles,
          followup_date: contractState.followup_date
        };
        
        // Gem til Supabase
        const { data, error } = await supabase
          .from('development_contract')
          .insert({
            project_id: contractState.project_id,
            target_id: contractState.target_id,
            contract_data: contractData,
            is_draft: isDraft
          })
          .select()
          .single();
        
        if (error) throw error;
        
        // Opdater UI
        $('contractLastUpdated').textContent = new Date().toLocaleString('da-DK');
        $('contractCreatedBy').textContent = 'Systembruger';
        
        alert(isDraft ? 'Kladde gemt ‚úÖ' : 'Endelig kontrakt gemt ‚úÖ');
        
      } catch (error) {
        console.error('Fejl ved gemning:', error);
        alert('Fejl ved gemning af kontrakt: ' + error.message);
      }
    }
    
    function contractSerializeSelectedTips() {
      const obj = {};
      for (const [catId, set] of contractState.selectedTips.entries()) {
        obj[catId] = Array.from(set);
      }
      return obj;
    }
    
    function contractSerializeRoles() {
      const obj = {};
      for (const [tipId, val] of contractState.roles.entries()) {
        obj[tipId] = val;
      }
      return obj;
    }
    
    // ========== LOAD ==========
    function contractLoad() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = async (e) => {
        try {
          const file = e.target.files[0];
          if (!file) return;
          
          const text = await file.text();
          const data = JSON.parse(text);
          
          // Gendan state
          contractState.project_id = data.project_id;
          contractState.target_id = data.target_id;
          contractState.template_id = data.template_id;
          contractState.selectedCompetencies = new Set(data.selected_competencies || []);
          contractState.employee_actions = data.employee_actions || '';
          contractState.employee_wishes = data.employee_wishes || '';
          contractState.leader_actions = data.leader_actions || '';
          contractState.include_colleague_support = data.include_colleague_support !== false;
          contractState.include_306090_goals = data.include_306090_goals !== false;
          contractState.include_team_roles = data.include_team_roles !== false;
          contractState.followup_date = data.followup_date || null;
          
          // Gendan selected tips
          contractState.selectedTips.clear();
          if (data.selected_tips) {
            for (const [catId, tipIds] of Object.entries(data.selected_tips)) {
              contractState.selectedTips.set(catId, new Set(tipIds));
            }
          }
          
          // Gendan roles
          contractState.roles.clear();
          if (data.roles) {
            for (const [tipId, val] of Object.entries(data.roles)) {
              contractState.roles.set(tipId, val);
            }
          }
          
          // Opdater UI
          $('contractProjectSelect').value = contractState.project_id || '';
          if (contractState.project_id) {
            await contractLoadTargets(contractState.project_id);
            await contractLoadCompetencies(contractState.template_id);
          }
          
          $('contractTargetSelect').value = contractState.target_id || '';
          $('contractEmployeeActions').value = contractState.employee_actions;
          $('contractEmployeeWishes').value = contractState.employee_wishes;
          $('contractLeaderActions').value = contractState.leader_actions;
          $('includeColleagueSupport').checked = contractState.include_colleague_support;
          $('include306090Goals').checked = contractState.include_306090_goals;
          $('includeTeamRoles').checked = contractState.include_team_roles;
          $('contractFollowupDate').value = contractState.followup_date || '';
          
          contractUpdateSectionStatus();
          
          alert('Kontrakt indl√¶st ‚úÖ');
          
        } catch (error) {
          console.error('Fejl ved indl√¶sning:', error);
          alert('Fejl ved indl√¶sning af kontrakt: ' + error.message);
        }
      };
      
      input.click();
    }
    
    // ========== PDF EXPORT ==========
    async function contractExportPdf() {
      try {
        alert('PDF eksport funktion kommer snart! üöß');
      } catch (error) {
        console.error('Fejl ved PDF eksport:', error);
        alert('Fejl ved PDF eksport: ' + error.message);
      }
    }
  </script>
</body>
</html>