<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net; img-src 'self' data: blob:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; connect-src 'self' https://*.supabase.co wss://*.supabase.co">
  <title>KOMPAS • Login</title>
  <link rel="icon" href="data:," />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    /* Theme */
    .kompas-login *{box-sizing:border-box;margin:0;padding:0}
    .kompas-login{
      --bg1:#667eea; --bg2:#764ba2; --ink:#2d3748; --muted:#718096;
      --card:#ffffff; --line:#e2e8f0; --brand:#667eea; --radius:20px;
      --success:#48bb78; --error:#f56565;
    }
    
    .kompas-login{
      font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:20px;
      color:var(--ink);
    }

    
    .container{
      width:100%;
      max-width:480px;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:0 20px 40px rgba(0,0,0,.15);
      overflow:hidden;
    }
    
    .header{
      background:linear-gradient(135deg,#2d3748 0%,#4a5568 100%);
      color:#fff;
      padding:32px;
      text-align:center;
    }
    
    .logo{
      width:80px;
      height:80px;
      margin:0 auto 16px;
      background:white;
      border-radius:20px;
      display:grid;
      place-items:center;
    }
    
    .logo img{
      max-width:65px;
      max-height:65px;
      width:auto;
      height:auto;
      object-fit:contain;
    }
    
    .title{
      font-size:1.8rem;
      font-weight:800;
      margin-bottom:8px;
    }
    
    .subtitle{
      opacity:.9;
      font-size:.95rem;
    }
    
    .tabs{
      display:flex;
      background:#f7fafc;
      border-bottom:1px solid var(--line);
    }
    
    .kompas-login .tab{
      flex:1;
      padding:16px;
      background:none;
      border:none;
      font-size:1rem;
      font-weight:600;
      color:#64748b;
      cursor:pointer;
      transition:.25s;
      border-bottom:3px solid transparent;
    }

    
    .tab.active{
      color:var(--brand);
      background:#fff;
      border-bottom-color:var(--brand);
    }
    
    .kompas-login .content{
      padding:32px;
    }

    
    .panel{
      display:none;
    }
    
    .panel.active{
      display:block;
    }
    
    .form-group{
      margin-bottom:20px;
    }
    
    label{
      display:block;
      font-weight:600;
      margin-bottom:8px;
      color:#4a5568;
      font-size:.95rem;
    }
    
    .input{
      width:100%;
      padding:12px 16px;
      border:1px solid var(--line);
      border-radius:10px;
      font-size:1rem;
      transition:.25s;
      background:#fff;
    }
    
    .input:focus{
      outline:none;
      border-color:var(--brand);
      box-shadow:0 0 0 3px rgba(102,126,234,.1);
    }
    
    .input.error{
      border-color:var(--error);
    }
    
    .kompas-login .btn{
      width:100%;
      padding:14px;
      border:none;
      border-radius:10px;
      font-size:1rem;
      font-weight:700;
      cursor:pointer;
      transition:.25s;
      text-transform:uppercase;
      letter-spacing:.5px;
    }

    
    .btn.primary{
      background:var(--brand);
      color:#fff;
    }
    
    .btn.primary:hover{
      background:#5a67d8;
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(102,126,234,.3);
    }
    
    .btn:disabled{
      opacity:.5;
      cursor:not-allowed;
      transform:none!important;
    }
    
    .message{
      padding:12px 16px;
      border-radius:10px;
      margin-bottom:20px;
      font-size:.92rem;
      animation:slideIn .3s ease;
    }
    
    .message.error{
      background:#fed7d7;
      color:#9b2c2c;
      border:1px solid #fc8181;
    }
    
    .message.success{
      background:#c6f6d5;
      color:#22543d;
      border:1px solid #68d391;
    }
    
    .message.info{
      background:#e6fffa;
      color:#234e52;
      border:1px solid #81e6d9;
    }
    
    @keyframes slideIn{
      from{opacity:0;transform:translateY(-10px)}
      to{opacity:1;transform:translateY(0)}
    }
    
    .divider{
      text-align:center;
      margin:24px 0;
      position:relative;
    }
    
    .divider::before{
      content:'';
      position:absolute;
      top:50%;
      left:0;
      right:0;
      height:1px;
      background:var(--line);
    }
    
    .divider span{
      background:#fff;
      padding:0 16px;
      position:relative;
      color:var(--muted);
      font-size:.9rem;
    }
    
    .help-text{
      color:var(--muted);
      font-size:.9rem;
      margin-top:8px;
    }
    
    .step-indicator{
      display:flex;
      justify-content:center;
      gap:8px;
      margin-bottom:24px;
    }
    
    .step{
      width:12px;
      height:12px;
      border-radius:50%;
      background:var(--line);
      transition:.3s;
    }
    
    .step.active{
      background:var(--brand);
      transform:scale(1.2);
    }
    
    .step.completed{
      background:var(--success);
    }
    
    .password-requirements{
      background:#f7fafc;
      border:1px solid var(--line);
      border-radius:8px;
      padding:12px;
      margin-top:8px;
      font-size:.85rem;
    }
    
    .requirement{
      display:flex;
      align-items:center;
      gap:8px;
      margin:4px 0;
      color:var(--muted);
      transition:.2s;
    }
    
    .requirement.met{
      color:var(--success);
    }
    
    .requirement::before{
      content:'○';
      font-weight:bold;
    }
    
    .requirement.met::before{
      content:'✓';
    }
    
    .link{
      color:var(--brand);
      text-decoration:none;
      font-weight:600;
      cursor:pointer;
    }
    
    .link:hover{
      text-decoration:underline;
    }
    
    .footer{
      padding:20px 32px;
      background:#f7fafc;
      border-top:1px solid var(--line);
      text-align:center;
      color:var(--muted);
      font-size:.9rem;
    }
  </style>
</head>
<body class="kompas-login">

<div class="container">
  <div class="header">
    <div class="logo">
      <!-- Læg dit logo fx i ./assets/dit_logo.png -->
      <img src="./assets/logo.png" alt="logo" onerror="this.style.display='none'">
    </div>
    <div class="title">KOMPAS 360</div>
    <div class="subtitle">Evaluering & Feedback System</div>
  </div>
  
  <div class="tabs">
    <button class="tab active" data-tab="login">Log ind</button>
    <button class="tab" data-tab="activate">Aktivér</button>
    <button class="tab" data-tab="register">Opret Profil</button>
    <button class="tab" data-tab="reset">Nulstil kode</button>
  </div>
  
  <div class="content">
    <!-- Login Panel -->
    <div id="login-panel" class="panel active">
      <div id="login-message"></div>
      
      <form id="login-form">
        <div class="form-group">
          <label for="login-email">Email</label>
          <input type="email" id="login-email" class="input" required placeholder="din@email.dk">
        </div>
        
        <div class="form-group">
          <label for="login-password">Adgangskode</label>
          <input type="password" id="login-password" class="input" required placeholder="••••••••">
        </div>
        
        <button type="submit" class="btn primary">Log ind</button>
      </form>
      
      <p class="help-text" style="text-align:center;margin-top:16px">
        <a class="link" onclick="switchTab('reset')">Glemt adgangskode?</a>
      </p>
      
      <div class="divider">
        <span>Ny bruger?</span>
      </div>
      
      <p class="help-text" style="text-align:center">
        Har du modtaget en aktiveringsnøgle? 
        <a class="link" onclick="switchTab('activate')">Aktivér din konto her</a>
      </p>
    </div>
    
    <!-- Activation Panel -->
    <div id="activate-panel" class="panel">
      <div id="activate-message"></div>
      
      <!-- Step 1: Enter key and email -->
      <div id="step1" class="activation-step">
        <div class="step-indicator">
          <div class="step active"></div>
          <div class="step"></div>
          <div class="step"></div>
        </div>
        
        <h3 style="margin-bottom:20px">Indtast aktiveringsnøgle</h3>
        
        <form id="activate-form-step1">
          <div class="form-group">
            <label for="activation-key">Aktiveringsnøgle</label>
            <input type="text" id="activation-key" class="input" required 
                   placeholder="ABCD123456" maxlength="10">
            <p class="help-text">Indtast den 6-cifrede kode du har modtaget</p>
          </div>
          
          <div class="form-group">
            <label for="activation-email">Email</label>
            <input type="email" id="activation-email" class="input" required 
                   placeholder="din@email.dk">
            <p class="help-text">Brug samme email som nøglen er sendt til</p>
          </div>
          
          <button type="submit" class="btn primary">Fortsæt</button>
        </form>
      </div>
      
      <!-- Step 2: Create password -->
      <div id="step2" class="activation-step" style="display:none">
        <div class="step-indicator">
          <div class="step completed"></div>
          <div class="step active"></div>
          <div class="step"></div>
        </div>
        
        <h3 style="margin-bottom:20px">Opret adgangskode</h3>
        
        <form id="activate-form-step2">
          <div class="form-group">
            <label for="new-password">Ny adgangskode</label>
            <input type="password" id="new-password" class="input" required 
                   placeholder="••••••••" minlength="8">
            
            <div class="password-requirements">
              <div class="requirement" data-req="length">Mindst 8 tegn</div>
              <div class="requirement" data-req="upper">Mindst ét stort bogstav</div>
              <div class="requirement" data-req="lower">Mindst ét lille bogstav</div>
              <div class="requirement" data-req="number">Mindst ét tal</div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="confirm-password">Gentag adgangskode</label>
            <input type="password" id="confirm-password" class="input" required 
                   placeholder="••••••••">
            <p class="help-text" id="password-match" style="display:none"></p>
          </div>
          
          <button type="submit" class="btn primary" disabled>Opret konto</button>
        </form>
      </div>
      
      <!-- Step 3: Success -->
      <div id="step3" class="activation-step" style="display:none">
        <div class="step-indicator">
          <div class="step completed"></div>
          <div class="step completed"></div>
          <div class="step completed"></div>
        </div>
        
        <div class="message success">
          <h3 style="margin-bottom:8px">Konto aktiveret!</h3>
          <p>Din konto er nu oprettet og klar til brug.</p>
        </div>
        
        <p style="text-align:center;margin:24px 0">
          Du bliver automatisk sendt til admin-panelet...
        </p>
        
        <button class="btn primary" onclick="goToAdmin()">Gå til admin panel</button>
      </div>
      
      <div class="divider" id="activate-divider">
        <span>Allerede aktiveret?</span>
      </div>
      
      <p class="help-text" style="text-align:center" id="activate-footer">
        <a class="link" onclick="switchTab('login')">Log ind her</a>
      </p>
    </div>
    
    <!-- Register Panel (Individual Registration) -->
    <div id="register-panel" class="panel">
      <div id="register-message" style="display:none"></div>
      
      <!-- Step 1: Registration Form -->
      <div id="register-step1">
        <div class="step-indicator">
          <div class="step active"></div>
          <div class="step"></div>
          <div class="step"></div>
        </div>
        
        <form id="register-form">
          <div class="form-group">
            <label for="register-ma">Medarbejdernummer (MA)</label>
            <input
              type="text"
              id="register-ma"
              class="input"
              placeholder="123456"
              maxlength="6"
              pattern="\d{6}"
              required
              autocomplete="off"
            />
            <p class="help-text">Dit 6-cifrede medarbejdernummer</p>
          </div>
          
          <div class="form-group">
            <label for="register-email">Email</label>
            <input
              type="email"
              id="register-email"
              class="input"
              placeholder="navn@firma.dk"
              required
              autocomplete="email"
            />
          </div>
          
          <div class="form-group">
            <label for="register-password">Adgangskode</label>
            <input
              type="password"
              id="register-password"
              class="input"
              required
              autocomplete="new-password"
            />
            
            <div class="password-requirements">
              <div class="requirement" data-req="length">Mindst 8 tegn</div>
              <div class="requirement" data-req="upper">Mindst 1 stort bogstav</div>
              <div class="requirement" data-req="lower">Mindst 1 lille bogstav</div>
              <div class="requirement" data-req="number">Mindst 1 tal</div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="register-confirm-password">Bekræft adgangskode</label>
            <input
              type="password"
              id="register-confirm-password"
              class="input"
              required
              autocomplete="new-password"
            />
            <p id="register-password-match" style="display:none;margin-top:8px;font-size:.9rem"></p>
          </div>
          
          <div class="form-group" style="display:flex;align-items:start;gap:12px">
            <input
              type="checkbox"
              id="register-consent"
              required
              style="width:20px;height:20px;margin-top:2px;cursor:pointer"
            />
            <label for="register-consent" style="margin:0;font-weight:400;cursor:pointer">
              Jeg accepterer <a href="terms.html" target="_blank" style="color:var(--brand);text-decoration:underline">vilkår for brug</a> og <a href="privacy.html" target="_blank" style="color:var(--brand);text-decoration:underline">privatlivspolitikken</a> for MinUdvikling systemet
            </label>
          </div>
          
          <button type="submit" class="btn primary" disabled>Opret Profil</button>
        </form>
      </div>
      
      <!-- Step 2: Processing -->
      <div id="register-step2" style="display:none">
        <div class="step-indicator">
          <div class="step completed"></div>
          <div class="step active"></div>
          <div class="step"></div>
        </div>
        
        <div class="message info">
          <h3 style="margin-bottom:8px">Opretter din profil...</h3>
          <p id="register-progress-text">Vent venligst mens vi opretter din konto.</p>
        </div>
      </div>
      
      <!-- Step 3: Success -->
      <div id="register-step3" style="display:none">
        <div class="step-indicator">
          <div class="step completed"></div>
          <div class="step completed"></div>
          <div class="step completed"></div>
        </div>
        
        <div class="message success">
          <h3 style="margin-bottom:8px">✓ Profil oprettet!</h3>
          <p>Din profil er nu klar. Du omdirigeres automatisk...</p>
        </div>
      </div>
      
      <div id="register-divider" class="divider">
        <span>Har du allerede en profil?</span>
      </div>
      
      <p id="register-footer" class="help-text" style="text-align:center">
        <a class="link" onclick="switchTab('login')">Log ind her</a>
      </p>
    </div>
    
    <!-- Reset Password Panel -->
    <div id="reset-panel" class="panel">
      <div id="reset-message"></div>
      
      <!-- Step 1: Request reset -->
      <div id="reset-step1" class="reset-step">
        <h3 style="margin-bottom:20px">Nulstil adgangskode</h3>
        
        <p class="help-text" style="margin-bottom:20px">
          Indtast din email, så sender vi dig et link til at nulstille din adgangskode.
        </p>
        
        <form id="reset-form">
          <div class="form-group">
            <label for="reset-email">Email</label>
            <input type="email" id="reset-email" class="input" required 
                   placeholder="din@email.dk">
          </div>
          
          <button type="submit" class="btn primary">Send nulstillingslink</button>
        </form>
      </div>
      
      <!-- Step 2: Confirmation -->
      <div id="reset-step2" class="reset-step" style="display:none">
        <div class="message success">
          <h3 style="margin-bottom:8px">Email sendt!</h3>
          <p>Vi har sendt et link til at nulstille din adgangskode til din email.</p>
        </div>
        
        <p class="help-text" style="margin:24px 0;text-align:center">
          Tjek din indbakke og følg linket i emailen for at oprette en ny adgangskode.
        </p>
        
        <button class="btn primary" onclick="switchTab('login')">Tilbage til login</button>
      </div>
      
      <div class="divider">
        <span>Husker du din kode?</span>
      </div>
      
      <p class="help-text" style="text-align:center">
        <a class="link" onclick="switchTab('login')">Log ind her</a>
      </p>
    </div>
  </div>
  
  <div class="footer">
    KOMPAS 360 • Evaluering & Feedback System
  </div>
</div>

<script>
// ============================================================
// 1) PURE UI FUNCTIONS — must work even if Supabase fails to load
// ============================================================
const $ = (id) => document.getElementById(id);
let activationData = {};

function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  
  const tabBtn = document.querySelector(`[data-tab="${tabName}"]`);
  const panel = $(`${tabName}-panel`);
  if (tabBtn) tabBtn.classList.add('active');
  if (panel) panel.classList.add('active');
}

document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => switchTab(tab.dataset.tab));
});

function showMessage(elementId, message, type = 'error') {
  const el = $(elementId);
  if (!el) return;
  el.className = `message ${type}`;
  el.textContent = message;
  el.style.display = 'block';
  
  if (type === 'success') {
    setTimeout(() => { el.style.display = 'none'; }, 5000);
  }
}

// ============================================================
// 2) SUPABASE INITIALIZATION — with error handling
// ============================================================
const SUPABASE_URL = "https://wsrstyrsuwhcmmlmnbrz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzcnN0eXJzdXdoY21tbG1uYnJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MTU0NTIsImV4cCI6MjA3MTE5MTQ1Mn0.Rf3Z3bQGjV5CKXKZr6IMOjzPdbhVJCh3SwuvlkpxUD0";

const supabaseLib = window.supabase;  // save library reference before reassignment
supabase = null;                      // reassign existing var (declared by CDN)
try {
  if (!supabaseLib) throw new Error('Supabase library failed to load from CDN');
  supabase = supabaseLib.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
} catch (err) {
  console.error('Supabase init failed:', err);
  showMessage('login-message', 'Kunne ikke oprette forbindelse. Genindlæs siden eller tjek din internetforbindelse.', 'error');
}

// Login form
$('login-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!supabase) { showMessage('login-message', 'Systemfejl: Genindlæs siden.', 'error'); return; }
  showMessage('login-message', '', 'info');
  
  const email = $('login-email').value.trim().toLowerCase();
  const password = $('login-password').value;
  
  $('login-form').querySelector('button').disabled = true;
  
  try {
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password
    });
    
    if (error) throw error;
    
    // Tjek om email er bekræftet
    if (!data.user.email_confirmed_at && !data.user.confirmed_at) {
      // Email ikke bekræftet - log brugeren ud igen
      await supabase.auth.signOut();
      throw new Error('Din email er ikke bekræftet endnu. Tjek din indbakke for bekræftelses-emailen.');
    }
    
    // Ensartet role-routing (programmer → master, admin → admin, ellers individ → profile)
    const { data: roleData } = await supabase
      .from('user_roles')
      .select('role')
      .eq('user_id', data.user.id)
      .single();

    const role = roleData?.role || null;

    if (role === 'programmer') {
      window.location.href = 'master.html';
    } else if (role === 'admin') {
      window.location.href = 'admin.html';
    } else if (role === 'profile') {
      window.location.href = 'profile.html';
    } else {
      // Fallback: prøv at afgøre via MA (sikrer profil-univers selv uden rolle)
      const { data: ma } = await supabase.rpc('get_ma_from_auth');
      if (ma) {
        window.location.href = 'profile.html';
      } else {
        throw new Error('Ingen profil eller rolle fundet. Kontakt support.');
      }
    }
  } catch (error) {
    showMessage('login-message', error.message || 'Login fejlede', 'error');
  } finally {
    $('login-form').querySelector('button').disabled = false;
  }
});

// Reset password form
$('reset-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!supabase) { showMessage('reset-message', 'Systemfejl: Genindlæs siden.', 'error'); return; }
  
  const email = $('reset-email').value.trim().toLowerCase();
  const submitBtn = e.target.querySelector('button[type="submit"]');
  
  submitBtn.disabled = true;
  submitBtn.textContent = 'Sender...';
  
  try {
    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: `${window.location.origin}/reset-password.html`
    });
    
    if (error) throw error;
    
    // Show success step
    $('reset-step1').style.display = 'none';
    $('reset-step2').style.display = 'block';
    
  } catch (error) {
    console.error('Reset error:', error);
    submitBtn.disabled = false;
    submitBtn.textContent = 'Send nulstillingslink';
    showMessage('reset-message', error.message || 'Fejl ved afsendelse af email', 'error');
  }
});

// Activation Step 1
$('activate-form-step1').addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!supabase) { showMessage('activate-message', 'Systemfejl: Genindlæs siden.', 'error'); return; }
  
  const key = $('activation-key').value.trim().toUpperCase();
  const email = $('activation-email').value.trim().toLowerCase();
  
  try {
    // Validate key
    const { data, error } = await supabase.rpc('activate_account_with_key', {
      p_key_code: key,
      p_email: email,
      p_password: 'temp' // Vi validerer kun nøglen først
    });
    
    if (error) throw error;
    if (data.error) throw new Error(data.error);
    
    // Store for next step
    activationData = { key, email };
    
    // Move to step 2
    $('step1').style.display = 'none';
    $('step2').style.display = 'block';
    $('activate-divider').style.display = 'none';
    $('activate-footer').style.display = 'none';
    
  } catch (error) {
    showMessage('activate-message', error.message || 'Ugyldig nøgle eller email', 'error');
  }
});

// Password validation
$('new-password').addEventListener('input', validatePassword);
$('confirm-password').addEventListener('input', validatePassword);

function validatePassword() {
  const password = $('new-password').value;
  const confirm = $('confirm-password').value;
  const submitBtn = $('activate-form-step2').querySelector('button[type="submit"]');
  
  // Check requirements
  const requirements = {
    length: password.length >= 8,
    upper: /[A-Z]/.test(password),
    lower: /[a-z]/.test(password),
    number: /[0-9]/.test(password)
  };
  
  // Update UI
  Object.keys(requirements).forEach(req => {
    const el = document.querySelector(`[data-req="${req}"]`);
    if (requirements[req]) {
      el.classList.add('met');
    } else {
      el.classList.remove('met');
    }
  });
  
  // Check if passwords match
  const matchEl = $('password-match');
  if (confirm.length > 0) {
    if (password === confirm) {
      matchEl.textContent = '✓ Adgangskoderne matcher';
      matchEl.style.color = 'var(--success)';
      matchEl.style.display = 'block';
    } else {
      matchEl.textContent = '✗ Adgangskoderne matcher ikke';
      matchEl.style.color = 'var(--error)';
      matchEl.style.display = 'block';
    }
  } else {
    matchEl.style.display = 'none';
  }
  
  // Enable/disable submit button
  const allRequirementsMet = Object.values(requirements).every(v => v);
  const passwordsMatch = password === confirm && confirm.length > 0;
  
  submitBtn.disabled = !(allRequirementsMet && passwordsMatch);
}

// Activation Step 2 - SIMPEL version når email confirmation er slået FRA
$('activate-form-step2').addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!supabase) { showMessage('activate-message', 'Systemfejl: Genindlæs siden.', 'error'); return; }
  const password = $('new-password').value;
  const submitBtn = e.target.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.textContent = 'Opretter konto...';

  try {
    // 1) Opret bruger (ingen email confirmation nødvendig)
    const { error: signUpError } = await supabase.auth.signUp({
      email: activationData.email,
      password
    });
    if (signUpError) throw signUpError;

    // 2) Vent kort tid for database propagation
    submitBtn.textContent = 'Aktiverer konto...';
    await new Promise(resolve => setTimeout(resolve, 1000));

    // 3) Markér nøgle som brugt og giv rolle
    const { data: markData, error: markError } = await supabase.rpc('mark_activation_key_used', {
      p_key_code: activationData.key,
      p_email: activationData.email
    });
    
    if (markError) {
      console.error('Mark key error:', markError);
      // Prøv igen efter lidt længere ventetid
      await new Promise(resolve => setTimeout(resolve, 2000));
      const { data: retryData, error: retryError } = await supabase.rpc('mark_activation_key_used', {
        p_key_code: activationData.key,
        p_email: activationData.email
      });
      if (retryError) throw retryError;
      if (retryData?.error) throw new Error(retryData.error);
    } else if (markData?.error) {
      throw new Error(markData.error);
    }

    // 4) Log ind med det samme
    submitBtn.textContent = 'Logger ind...';
    const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({
      email: activationData.email,
      password
    });
    
    if (signInError) throw signInError;

    // 5) Success! Check rolle og redirect
    submitBtn.textContent = 'Success! Omdirigerer...';
    
    const { data: roleData } = await supabase
      .from('user_roles')
      .select('role')
      .eq('user_id', signInData.user.id)
      .single();

    // Show success step
    $('step2').style.display = 'none';
    $('step3').style.display = 'block';

    // Redirect efter 2 sekunder – fuld role-routing inkl. profile
    setTimeout(async () => {
      const role = roleData?.role || null;
      if (role === 'programmer') {
        window.location.href = 'master.html';
      } else if (role === 'admin') {
        window.location.href = 'admin.html';
      } else if (role === 'profile') {
        window.location.href = 'profile.html';
      } else {
        const { data: ma } = await supabase.rpc('get_ma_from_auth');
        window.location.href = ma ? 'profile.html' : 'login.html';
      }
    }, 2000);

  } catch (error) {
    console.error('Activation error:', error);
    submitBtn.disabled = false;
    submitBtn.textContent = 'Opret konto';
    showMessage('activate-message', error.message || 'Fejl ved aktivering', 'error');
  }
});

function goToAdmin() {
  window.location.href = 'admin.html';
}

// Registration form - Password validation
$('register-password').addEventListener('input', validateRegisterPassword);
$('register-confirm-password').addEventListener('input', validateRegisterPassword);
$('register-ma').addEventListener('input', validateRegisterForm);
$('register-email').addEventListener('input', validateRegisterForm);
$('register-consent').addEventListener('change', validateRegisterForm);

function validateRegisterPassword() {
  const password = $('register-password').value;
  const confirm = $('register-confirm-password').value;
  
  // Check requirements
  const requirements = {
    length: password.length >= 8,
    upper: /[A-Z]/.test(password),
    lower: /[a-z]/.test(password),
    number: /[0-9]/.test(password)
  };
  
  // Update UI
  Object.keys(requirements).forEach(req => {
    const el = document.querySelector(`#register-panel [data-req="${req}"]`);
    if (requirements[req]) {
      el.classList.add('met');
    } else {
      el.classList.remove('met');
    }
  });
  
  // Check if passwords match
  const matchEl = $('register-password-match');
  if (confirm.length > 0) {
    if (password === confirm) {
      matchEl.textContent = '✓ Adgangskoderne matcher';
      matchEl.style.color = 'var(--success)';
      matchEl.style.display = 'block';
    } else {
      matchEl.textContent = '✗ Adgangskoderne matcher ikke';
      matchEl.style.color = 'var(--error)';
      matchEl.style.display = 'block';
    }
  } else {
    matchEl.style.display = 'none';
  }
  
  validateRegisterForm();
}

function validateRegisterForm() {
  const password = $('register-password').value;
  const confirm = $('register-confirm-password').value;
  const ma = $('register-ma').value;
  const email = $('register-email').value;
  const consent = $('register-consent').checked;
  const submitBtn = $('register-form').querySelector('button[type="submit"]');
  
  // Password requirements
  const requirements = {
    length: password.length >= 8,
    upper: /[A-Z]/.test(password),
    lower: /[a-z]/.test(password),
    number: /[0-9]/.test(password)
  };
  
  const allRequirementsMet = Object.values(requirements).every(v => v);
  const passwordsMatch = password === confirm && confirm.length > 0;
  const maValid = /^\d{6}$/.test(ma);
  const emailValid = email.length > 0 && email.includes('@');
  
  submitBtn.disabled = !(allRequirementsMet && passwordsMatch && maValid && emailValid && consent);
}

// Registration form submission
$('register-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!supabase) { showMessage('register-message', 'Systemfejl: Genindlæs siden.', 'error'); $('register-message').style.display='block'; return; }
  
  const ma = $('register-ma').value.trim();
  const email = $('register-email').value.trim().toLowerCase();
  const password = $('register-password').value;
  
  // Client-side MA validation
  if (!/^\d{6}$/.test(ma)) {
    showMessage('register-message', 'MA skal være præcis 6 cifre', 'error');
    return;
  }
  
  // Hide step 1, show step 2
  $('register-step1').style.display = 'none';
  $('register-step2').style.display = 'block';
  $('register-divider').style.display = 'none';
  $('register-footer').style.display = 'none';
  
  try {
    // Pre-check: Tjek om email allerede er registreret
    const { data: existingProfile } = await supabase
      .from('individual_users')
      .select('email, ma')
      .eq('email', email)
      .maybeSingle();
    
    if (existingProfile) {
      throw new Error('Denne email er allerede registreret som individuel bruger. Log ind i stedet.');
    }
    
    // Step 1: Create auth user (eller fortsæt hvis email allerede findes)
    $('register-progress-text').textContent = 'Opretter bruger.';
    const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
      email,
      password,
      options: {
        emailRedirectTo: `${window.location.origin}/profile.html`
      }
    });

    // Hvis brugeren allerede findes (fx admin-konto), så fortsæt uden at fejle
    const emailAlleredeOprettet = !!(signUpError && (
      (signUpError.message && signUpError.message.toLowerCase().includes('already registered')) ||
      (signUpError.status === 400) || (signUpError.code === 'user_already_exists')
    ));
    if (signUpError && !emailAlleredeOprettet) throw signUpError;

    // Step 2: Wait for propagation (kun relevant når ny auth bruger er lavet)
    $('register-progress-text').textContent = 'Forbereder profil.';
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    // Step 3: Create individual_user profile (tilladt også når email allerede findes i auth)
    $('register-progress-text').textContent = 'Opretter profil.';
    const { data: profileData, error: profileError } = await supabase.rpc(
      'create_individual_user_profile',
      { p_email: email, p_ma: ma }
    );
    if (profileError) throw profileError;
    if (profileData?.error) throw new Error(profileData.error);
    if (!profileData?.success) throw new Error('Kunne ikke oprette profil');

    // Step 4: Email bekræftelse påkrævet
    if (!emailAlleredeOprettet) {
      // Ny bruger – vis bekræftelses-besked (IKKE automatisk login)
      $('register-step2').style.display = 'none';
      $('register-step3').style.display = 'block';
      
      // Opdater succes-beskeden
      const successMsg = document.querySelector('#register-step3 .message.success');
      if (successMsg) {
        successMsg.innerHTML = `
          <div style="text-align: center;">
            <h3 style="margin-bottom: 12px;">✉️ Bekræft din email</h3>
            <p style="margin-bottom: 8px;">Vi har sendt en bekræftelses-email til:</p>
            <p style="font-weight: 600; margin-bottom: 12px;" id="confirmed-email-display"></p>
            <p style="font-size: 0.9em; color: var(--muted);">Tjek din indbakke og klik på linket for at aktivere din konto.</p>
            <p style="font-size: 0.9em; color: var(--muted); margin-top: 8px;">Kan du ikke finde emailen? Tjek spam/uønsket.</p>
          </div>
        `;
        // Safe: use textContent to prevent XSS via email
        const emailEl = document.getElementById('confirmed-email-display');
        if (emailEl) emailEl.textContent = email;
      }
      
      // Ingen automatisk redirect - bruger skal bekræfte email først
      
    } else {
      // Email fandtes i forvejen (fx admin-konto): spring auto-login over
      $('register-step2').style.display = 'none';
      $('register-step3').style.display = 'block';
      // Opdater succes-teksten så det er tydeligt hvad der skal ske nu
      const msg = document.querySelector('#register-step3 .message.success p');
      if (msg) msg.textContent = 'Profil oprettet. Log ind med din eksisterende adgangskode.';
    }
    
  } catch (error) {
    console.error('Registration error:', error);
    
    // Vis fejl og tilbage til step 1
    $('register-step2').style.display = 'none';
    $('register-step1').style.display = 'block';
    $('register-divider').style.display = 'block';
    $('register-footer').style.display = 'block';
    
    let errorMessage = error.message || 'Registrering fejlede';
    // User-friendly error messages
    if (errorMessage.toLowerCase().includes('already registered') || errorMessage.toLowerCase().includes('duplicate')) {
      errorMessage = 'Denne email findes allerede. Log ind med din eksisterende adgangskode.';
    } else if (errorMessage.includes('Password should be')) {
      errorMessage = 'Adgangskoden er for svag. Prøv en stærkere adgangskode.';
    } else if (errorMessage.toLowerCase().includes('constraint') || errorMessage.toLowerCase().includes('unique_violation') || errorMessage.toLowerCase().includes('uq_individual')) {
      errorMessage = 'Dette medarbejdernummer eller denne email er allerede registreret. Log ind i stedet.';
    } else if (errorMessage.toLowerCase().includes('does not exist')) {
      errorMessage = 'Der opstod en teknisk fejl. Kontakt venligst support.';
    }
    showMessage('register-message', errorMessage, 'error');
  }
});


// Check if already logged in - Håndterer dual profiler (admin + individ)
if (supabase) supabase.auth.getUser().then(async ({ data }) => {
  if (!data.user) return;

  // Tjek om email er bekræftet
  if (!data.user.email_confirmed_at && !data.user.confirmed_at) {
    await supabase.auth.signOut();
    showMessage('login-message', 'Din email er ikke bekræftet. Tjek din indbakke for bekræftelses-emailen.', 'error');
    return;
  }

  const { data: roleData } = await supabase
    .from('user_roles')
    .select('role')
    .eq('user_id', data.user.id)
    .single();

  const role = roleData?.role || null;

  if (role === 'programmer') {
    window.location.href = 'master.html';
    return;
  }
  if (role === 'admin') {
    window.location.href = 'admin.html';
    return;
  }
  if (role === 'profile') {
    window.location.href = 'profile.html';
    return;
  }

  // Fallback via MA
  const { data: ma } = await supabase.rpc('get_ma_from_auth');
  if (ma) {
    window.location.href = 'profile.html';
    return;
  }
});
</script>

</body>
</html>
