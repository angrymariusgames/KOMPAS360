<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KOMPAS • Nulstil adgangskode</title>
  <link rel="icon" href="data:," />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    /* Theme */
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg1:#667eea; --bg2:#764ba2; --ink:#2d3748; --muted:#718096;
      --card:#ffffff; --line:#e2e8f0; --brand:#667eea; --radius:20px;
      --success:#48bb78; --error:#f56565;
    }
    
    body{
      font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:20px;
      color:var(--ink);
    }
    
    .container{
      width:100%;
      max-width:480px;
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:0 20px 40px rgba(0,0,0,.15);
      overflow:hidden;
    }
    
    .header{
      background:linear-gradient(135deg,#2d3748 0%,#4a5568 100%);
      color:#fff;
      padding:32px;
      text-align:center;
    }
    
    .logo{
      width:80px;
      height:80px;
      margin:0 auto 16px;
      background:white;
      border-radius:20px;
      display:grid;
      place-items:center;
    }
    
    .logo img{
      max-width:65px;
      max-height:65px;
      width:auto;
      height:auto;
      object-fit:contain;
    }
    
    .title{
      font-size:1.8rem;
      font-weight:800;
      margin-bottom:8px;
    }
    
    .subtitle{
      opacity:.9;
      font-size:.95rem;
    }
    
    .content{
      padding:32px;
    }
    
    .form-group{
      margin-bottom:20px;
    }
    
    label{
      display:block;
      font-weight:600;
      margin-bottom:8px;
      color:#4a5568;
      font-size:.95rem;
    }
    
    .input{
      width:100%;
      padding:12px 16px;
      border:1px solid var(--line);
      border-radius:10px;
      font-size:1rem;
      transition:.25s;
      background:#fff;
    }
    
    .input:focus{
      outline:none;
      border-color:var(--brand);
      box-shadow:0 0 0 3px rgba(102,126,234,.1);
    }
    
    .input.error{
      border-color:var(--error);
    }
    
    .btn{
      width:100%;
      padding:14px;
      border:none;
      border-radius:10px;
      font-size:1rem;
      font-weight:700;
      cursor:pointer;
      transition:.25s;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    
    .btn.primary{
      background:var(--brand);
      color:#fff;
    }
    
    .btn.primary:hover{
      background:#5a67d8;
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(102,126,234,.3);
    }
    
    .btn:disabled{
      opacity:.5;
      cursor:not-allowed;
      transform:none!important;
    }
    
    .message{
      padding:12px 16px;
      border-radius:10px;
      margin-bottom:20px;
      font-size:.92rem;
      animation:slideIn .3s ease;
    }
    
    .message.error{
      background:#fed7d7;
      color:#c53030;
      border:1px solid #fc8181;
    }
    
    .message.success{
      background:#c6f6d5;
      color:#22543d;
      border:1px solid #68d391;
    }
    
    .message.info{
      background:#bee3f8;
      color:#2c5282;
      border:1px solid #63b3ed;
    }
    
    @keyframes slideIn{
      from{opacity:0;transform:translateY(-8px)}
      to{opacity:1;transform:translateY(0)}
    }
    
    .help-text{
      font-size:.88rem;
      color:var(--muted);
      margin-top:8px;
    }
    
    .password-requirements{
      margin-top:12px;
      padding:12px;
      background:#f7fafc;
      border-radius:8px;
      font-size:.88rem;
    }
    
    .requirement{
      padding:4px 0;
      color:#718096;
      position:relative;
      padding-left:24px;
    }
    
    .requirement::before{
      content:'○';
      position:absolute;
      left:0;
      transition:.25s;
    }
    
    .requirement.met{
      color:#48bb78;
      font-weight:bold;
    }
    
    .requirement.met::before{
      content:'✓';
    }
    
    .link{
      color:var(--brand);
      text-decoration:none;
      font-weight:600;
      cursor:pointer;
    }
    
    .link:hover{
      text-decoration:underline;
    }
    
    .footer{
      padding:20px 32px;
      background:#f7fafc;
      border-top:1px solid var(--line);
      text-align:center;
      color:var(--muted);
      font-size:.9rem;
    }
    
    .divider{
      margin:24px 0;
      text-align:center;
      position:relative;
    }
    
    .divider::before{
      content:'';
      position:absolute;
      top:50%;
      left:0;
      right:0;
      height:1px;
      background:var(--line);
    }
    
    .divider span{
      position:relative;
      padding:0 16px;
      background:var(--card);
      color:var(--muted);
      font-size:.88rem;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="logo">
      <img src="./assets/logo.png" alt="logo" onerror="this.style.display='none'">
    </div>
    <div class="title">KOMPAS 360</div>
    <div class="subtitle">Evaluering & Feedback System</div>
  </div>
  
  <div class="content">
    <div id="message-area"></div>
    
    <!-- Loading state -->
    <div id="loading-state">
      <div class="message info">
        Validerer reset link...
      </div>
    </div>
    
    <!-- Reset form -->
    <div id="reset-form-container" style="display:none">
      <h3 style="margin-bottom:20px;text-align:center">Opret ny adgangskode</h3>
      
      <form id="reset-form">
        <div class="form-group">
          <label for="new-password">Ny adgangskode</label>
          <input type="password" id="new-password" class="input" required 
                 placeholder="••••••••" minlength="8">
          
          <div class="password-requirements">
            <div class="requirement" data-req="length">Mindst 8 tegn</div>
            <div class="requirement" data-req="upper">Mindst ét stort bogstav</div>
            <div class="requirement" data-req="lower">Mindst ét lille bogstav</div>
            <div class="requirement" data-req="number">Mindst ét tal</div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="confirm-password">Gentag adgangskode</label>
          <input type="password" id="confirm-password" class="input" required 
                 placeholder="••••••••">
          <p class="help-text" id="password-match" style="display:none"></p>
        </div>
        
        <button type="submit" class="btn primary" disabled>Opdater adgangskode</button>
      </form>
    </div>
    
    <!-- Success state -->
    <div id="success-state" style="display:none">
      <div class="message success">
        <h3 style="margin-bottom:8px">Adgangskode opdateret!</h3>
        <p>Din nye adgangskode er nu gemt.</p>
      </div>
      
      <p style="text-align:center;margin:24px 0">
        Du bliver automatisk sendt til login...
      </p>
      
      <button class="btn primary" onclick="goToLogin()">Gå til login</button>
    </div>
    
    <!-- Error state -->
    <div id="error-state" style="display:none">
      <div class="message error">
        <h3 style="margin-bottom:8px">Ugyldigt eller udløbet link</h3>
        <p>Dette reset link er ikke længere gyldigt.</p>
      </div>
      
      <div class="divider">
        <span>Prøv igen</span>
      </div>
      
      <button class="btn primary" onclick="goToLogin()">Tilbage til login</button>
    </div>
  </div>
  
  <div class="footer">
    KOMPAS 360 • Evaluering & Feedback System
  </div>
</div>

<script>
const SUPABASE_URL = "https://wsrstyrsuwhcmmlmnbrz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzcnN0eXJzdXdoY21tbG1uYnJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MTU0NTIsImV4cCI6MjA3MTE5MTQ1Mn0.Rf3Z3bQGjV5CKXKZr6IMOjzPdbhVJCh3SwuvlkpxUD0";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const $ = (id) => document.getElementById(id);

// Check for recovery token in URL
async function init() {
  const hashParams = new URLSearchParams(window.location.hash.substring(1));
  const accessToken = hashParams.get('access_token');
  const type = hashParams.get('type');
  
  // Check if this is a password recovery
  if (type === 'recovery' && accessToken) {
    // Valid recovery link
    $('loading-state').style.display = 'none';
    $('reset-form-container').style.display = 'block';
  } else {
    // Invalid or missing token
    $('loading-state').style.display = 'none';
    $('error-state').style.display = 'block';
  }
}

// Password validation
$('new-password').addEventListener('input', validatePassword);
$('confirm-password').addEventListener('input', validatePassword);

function validatePassword() {
  const password = $('new-password').value;
  const confirm = $('confirm-password').value;
  const submitBtn = $('reset-form').querySelector('button[type="submit"]');
  
  // Check requirements
  const requirements = {
    length: password.length >= 8,
    upper: /[A-Z]/.test(password),
    lower: /[a-z]/.test(password),
    number: /[0-9]/.test(password)
  };
  
  // Update UI
  Object.keys(requirements).forEach(req => {
    const el = document.querySelector(`[data-req="${req}"]`);
    if (requirements[req]) {
      el.classList.add('met');
    } else {
      el.classList.remove('met');
    }
  });
  
  // Check if passwords match
  const matchEl = $('password-match');
  if (confirm.length > 0) {
    if (password === confirm) {
      matchEl.textContent = '✓ Adgangskoderne matcher';
      matchEl.style.color = 'var(--success)';
      matchEl.style.display = 'block';
    } else {
      matchEl.textContent = '✗ Adgangskoderne matcher ikke';
      matchEl.style.color = 'var(--error)';
      matchEl.style.display = 'block';
    }
  } else {
    matchEl.style.display = 'none';
  }
  
  // Enable/disable submit button
  const allRequirementsMet = Object.values(requirements).every(v => v);
  const passwordsMatch = password === confirm && confirm.length > 0;
  
  submitBtn.disabled = !(allRequirementsMet && passwordsMatch);
}

// Handle form submission
$('reset-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const password = $('new-password').value;
  const submitBtn = e.target.querySelector('button[type="submit"]');
  
  submitBtn.disabled = true;
  submitBtn.textContent = 'Opdaterer...';
  
  try {
    const { error } = await supabase.auth.updateUser({
      password: password
    });
    
    if (error) throw error;
    
    // Show success
    $('reset-form-container').style.display = 'none';
    $('success-state').style.display = 'block';
    
    // Redirect after 3 seconds
    setTimeout(() => {
      window.location.href = 'login.html';
    }, 3000);
    
  } catch (error) {
    console.error('Reset error:', error);
    submitBtn.disabled = false;
    submitBtn.textContent = 'Opdater adgangskode';
    
    const messageArea = $('message-area');
    messageArea.innerHTML = `
      <div class="message error">
        ${error.message || 'Fejl ved opdatering af adgangskode'}
      </div>
    `;
  }
});

function goToLogin() {
  window.location.href = 'login.html';
}

// Initialize on page load
init();
</script>

</body>
</html>
