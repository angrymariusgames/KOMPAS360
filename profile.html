<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MinUdvikling ‚Ä¢ Din Personlige Profil</title>
  <link rel="icon" href="data:," />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net; img-src 'self' data: blob:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-hashes' https://cdn.jsdelivr.net; connect-src 'self' http://localhost:8000 https://minudvikling.dk https://*.supabase.co wss://*.supabase.co https://cdn.jsdelivr.net">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

  <style>
    /* Theme */
    .mu-profile *{box-sizing:border-box;margin:0;padding:0}
    .mu-profile{
      --bg1:#667eea; --bg2:#764ba2; --ink:#2d3748; --muted:#718096;
      --card:#ffffff; --line:#e2e8f0; --brand:#667eea; --radius:20px;
      --success:#48bb78; --error:#f56565; --warning:#ed8936;
      --surface:#f8fafc; --info:#3b82f6; --text-secondary:#64748b;
    }

    .mu-profile{
      font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);
      min-height:100vh;
      padding:20px;
      color:var(--ink);
    }
    
    .app{
      max-width:1200px;
      margin:0 auto;
      background:#fff;
      border-radius:20px;
      box-shadow:0 20px 40px rgba(0,0,0,0.15);
      overflow:hidden;
    }

    /* Header */
    .mu-profile .header{
      background:linear-gradient(135deg,#2d3748 0%,#4a5568 100%);
      color:#fff;
      padding:20px 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
    }
    
    .logo-title{display:flex;align-items:center;gap:14px}
    .logo-box{width:56px;height:56px;border-radius:14px;background:#fff;display:grid;place-items:center}
    .logo-box img{height:38px;object-fit:contain}
    .title-text h1{font-size:1.6rem;font-weight:800;margin-bottom:2px}
    .title-text p{opacity:.85;font-size:.92rem}
    
    .header-actions{display:flex;gap:10px;align-items:center}
    .user-info{background:rgba(255,255,255,.1);padding:8px 14px;border-radius:10px;font-size:.9rem}
    
    .mu-profile .btn{cursor:pointer;font-weight:700;border:1px solid var(--line);background:#fff;color:#111;padding:10px 14px;border-radius:10px;transition:.25s}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.ghost{background:rgba(255,255,255,.1);color:#fff;border-color:rgba(255,255,255,.35)}
    .btn.small{padding:6px 10px;font-size:.85rem}
    .btn.success{background:var(--success);border-color:var(--success);color:#fff}
    .btn.error{background:var(--error);border-color:var(--error);color:#fff}
    .btn.warning{background:var(--warning);border-color:var(--warning);color:#fff}

    /* Tabs */
    .mu-profile .tabbar{
      background:var(--card);
      border-bottom:1px solid var(--line);
      padding:0 20px;
      display:flex;
      gap:0;
      position:sticky;
      top:0;
      z-index:20;
    }
    
    .mu-profile .tabbtn{
      background:none;
      border:none;
      padding:16px 22px;
      font-size:1.05rem;
      font-weight:700;
      color:#64748b;
      cursor:pointer;
      border-bottom:3px solid transparent;
      transition:.25s;
      white-space:nowrap;
    }

    
    .tabbtn:hover{color:#334155;background:rgba(102,126,234,0.06)}
    .tabbtn.active{color:var(--brand);border-bottom-color:var(--brand);background:#fff}
    
    .mu-profile .content{padding:24px;display:none}
    .mu-profile .content.active{display:block}
    
    /* Cards og sektioner */
    .section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:20px;margin-bottom:20px}
    .section-title{font-size:1.3rem;font-weight:700;margin-bottom:16px;color:var(--ink)}
    .section-subtitle{color:var(--muted);font-size:.95rem;margin-top:-10px;margin-bottom:16px}
    
    .card{background:var(--surface);border:1px solid var(--line);border-radius:12px;padding:16px;margin-bottom:16px;transition:.2s}
    .card:hover{box-shadow:0 4px 12px rgba(0,0,0,.08)}
    .card-title{font-weight:700;font-size:1.1rem;margin-bottom:8px}
    .card-meta{color:var(--muted);font-size:.9rem;margin-bottom:8px}
    .card-actions{display:flex;gap:8px;margin-top:12px}
    
    /* Grid layouts */
    .grid{display:grid;gap:16px}
    .grid-2{grid-template-columns:repeat(2,1fr)}
    .grid-3{grid-template-columns:repeat(3,1fr)}
    @media(max-width:768px){.grid-2,.grid-3{grid-template-columns:1fr}}
    
    /* Kompas graf */
    .compass-container{background:#fff;padding:20px;border-radius:12px;border:1px solid var(--line)}
    .compass-controls{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px}
    .round-checkbox{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--surface);border:2px solid var(--line);border-radius:8px;cursor:pointer;transition:.2s}
    .round-checkbox:hover{border-color:var(--brand);background:#fff}
    .round-checkbox input{margin:0;cursor:pointer}
    .round-checkbox input:checked + span{color:var(--brand);font-weight:700}
    
    /* Liste styling */
    .file-list{list-style:none}
    .file-item{display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--surface);border-radius:8px;margin-bottom:8px}
    .file-item:hover{background:#fff}
    .file-info{flex:1}
    .file-name{font-weight:600;margin-bottom:4px}
    .file-meta{color:var(--muted);font-size:.9rem}
    
    /* Upload omr√•de */
    .upload-zone{border:2px dashed var(--line);border-radius:12px;padding:40px;text-align:center;background:var(--surface);cursor:pointer;transition:.2s}
    .upload-zone:hover{border-color:var(--brand);background:#fff}
    .upload-zone.dragging{border-color:var(--brand);background:rgba(102,126,234,0.05)}
    
    /* Samtykke */
    .consent-box{background:var(--surface);border:1px solid var(--line);border-radius:12px;padding:20px;margin:20px 0}
    .consent-text{margin-bottom:16px;line-height:1.6}
    .consent-link{color:var(--brand);text-decoration:none;font-weight:600}
    .consent-link:hover{text-decoration:underline}
    
    /* Slette konto advarsel */
    .danger-zone{background:#fff5f5;border:2px solid var(--error);border-radius:12px;padding:20px}
    .danger-title{color:var(--error);font-weight:700;font-size:1.1rem;margin-bottom:12px}
    .danger-text{margin-bottom:16px;line-height:1.6}
    
    /* Modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center}
    .modal.active{display:flex}
    .modal-content{background:#fff;border-radius:20px;padding:24px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .modal-title{font-size:1.4rem;font-weight:700}
    .modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--muted)}
    
    /* Input styling */
    .input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;font-size:1rem;background:#fff}
    .input:focus{outline:none;border-color:var(--brand);box-shadow:0 0 0 3px rgba(102,126,234,.1)}
    
    /* Loading spinner */
    .loading{text-align:center;padding:40px;color:var(--muted)}
    .spinner{display:inline-block;width:40px;height:40px;border:4px solid var(--line);border-radius:50%;border-top-color:var(--brand);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    
    /* Alert/meddelelser */
    .alert{padding:14px 18px;border-radius:10px;margin-bottom:16px;display:flex;align-items:center;gap:12px}
    .alert.info{background:#e6fffa;color:#234e52;border:1px solid#81e6d9}
    .alert.success{background:#c6f6d5;color:#22543d;border:1px solid#68d391}
    .alert.warning{background:#fefcbf;color:#744210;border:1px solid#f6e05e}
    .alert.error{background:#fed7d7;color:#9b2c2c;border:1px solid#fc8181}
    
    /* Empty state */
    .empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
    .empty-icon{font-size:3rem;margin-bottom:16px;opacity:.5}
    .empty-title{font-size:1.2rem;font-weight:600;margin-bottom:8px;color:var(--ink)}
    .empty-text{margin-bottom:20px}
  </style>
</head>

a<body class="mu-profile">
<div class="app">
  <!-- Header -->
  <div class="header">
    <div class="logo-title">
      <div class="logo-box">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23667eea'/%3E%3Ctext x='50' y='65' text-anchor='middle' fill='white' font-size='40' font-weight='bold'%3EM%3C/text%3E%3C/svg%3E" alt="Logo">
      </div>
      <div class="title-text">
        <h1>MinUdvikling</h1>
        <p id="userNameDisplay">Din Personlige Profil</p>
      </div>
    </div>
    
    <div class="header-actions">
      <div class="user-info" id="userEmailDisplay"></div>
      <button id="switchToAdminBtn" class="btn ghost small" style="display:none">Skift til Admin</button>
      <button id="logoutBtn" class="btn ghost small">Log ud</button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabbar">
    <button class="tabbtn active" data-tab="oversigt">Oversigt</button>
    <button class="tabbtn" data-tab="kompas">Kompas</button>
    <button class="tabbtn" data-tab="kontrakt">Udviklingskontrakt</button>
    <button class="tabbtn" data-tab="sammenlign">Sammenlign</button>
    <button class="tabbtn" data-tab="upload">Upload</button>
    <button class="tabbtn" data-tab="profil">Profil</button>
  </div>

  <!-- Dashboard Tab -->
  <div id="tab-oversigt" class="content active">
    <div class="section">
      <h2 class="section-title">Velkommen til MinUdvikling</h2>
      <p class="section-subtitle">Her kan du se dine evalueringsresultater og udviklingskontakter</p>
      
      <div id="dashboardStats" class="grid grid-3">
        <div class="card">
          <div class="card-title">üìä Evalueringer</div>
          <div id="statsAssessments" style="font-size:2rem;font-weight:700;color:var(--brand)">0</div>
          <div class="card-meta">Udgivne runder</div>
        </div>
        
        <div class="card">
          <div class="card-title">üìÑ Kontrakter</div>
          <div id="statsContracts" style="font-size:2rem;font-weight:700;color:var(--success)">0</div>
          <div class="card-meta">Udviklingskontrakter</div>
        </div>
        
        <div class="card">
          <div class="card-title">üìÅ Filer</div>
          <div id="statsFiles" style="font-size:2rem;font-weight:700;color:var(--info)">0</div>
          <div class="card-meta">Totale filer</div>
        </div>
      </div>
    </div>
    
    <div class="section">
      <h2 class="section-title">Seneste Udviklingskontrakt</h2>
      <div id="latestContractContainer"></div>
    </div>
    
    <div class="section">
      <h2 class="section-title">Mine Evalueringer</h2>
      <div id="assessmentsList"></div>
    </div>
  </div>

  <!-- Kompas Tab -->
  <div id="tab-kompas" class="content">
    <div class="section">
      <h2 class="section-title">üß≠ Kompas - Dine Kompetencer</h2>
      <p class="section-subtitle">Visualiser dine kompetencer med interaktivt radar diagram</p>
      
      <!-- Assessment v√¶lger -->
      <div style="margin-bottom:20px">
        <label style="display:block;font-weight:600;margin-bottom:8px">V√¶lg assessment:</label>
        <select id="compassAssessmentSelect" class="input" onchange="loadCompassForAssessment()" style="max-width:400px">
          <option value="">-- V√¶lg en assessment --</option>
        </select>
      </div>
      
      <!-- Respondent type checkboxes -->
      <div id="compassRespondentControls" class="compass-controls" style="margin-bottom:20px;display:none">
        <label class="round-checkbox">
          <input type="checkbox" id="cbSelf" checked onchange="updateCompassChart()">
          <span>üë§ Selv</span>
        </label>
        <label class="round-checkbox">
          <input type="checkbox" id="cbPeer" checked onchange="updateCompassChart()">
          <span>üë• Kolleger</span>
        </label>
        <label class="round-checkbox">
          <input type="checkbox" id="cbLeader" checked onchange="updateCompassChart()">
          <span>üëî Leder</span>
        </label>
      </div>
      
      <!-- Radar chart -->
      <div class="compass-container" id="compassChartContainer" style="display:none">
        <canvas id="compassChart" style="max-height:500px"></canvas>
      </div>
      
      <!-- Actions -->
      <div id="compassActions" style="margin-top:20px;display:none;gap:12px">
        <button class="btn primary" onclick="downloadCompassPDF()">üì• Download Kompas PDF</button>
        <button class="btn" onclick="exportCompassData()">üìä Eksporter Data</button>
      </div>
      
      <!-- Empty state -->
      <div id="compassEmptyState" class="empty-state">
        <div class="empty-icon">üß≠</div>
        <div class="empty-title">Ingen assessments tilg√¶ngelige</div>
        <div class="empty-text">Upload eller vent p√• at en assessment bliver udgivet</div>
      </div>
    </div>
  </div>

  <!-- Udviklingskontrakt Tab -->
  <div id="tab-kontrakt" class="content">
    <div class="section">
      <h2 class="section-title">üìã Udviklingskontrakt</h2>
      <p class="section-subtitle">Dine udviklingsm√•l og handlingsplaner</p>
      
      <!-- Assessment v√¶lger -->
      <div style="margin-bottom:20px">
        <label style="display:block;font-weight:600;margin-bottom:8px">V√¶lg assessment:</label>
        <select id="contractAssessmentSelect" class="input" onchange="loadContractForAssessment()" style="max-width:400px">
          <option value="">-- V√¶lg en assessment --</option>
        </select>
      </div>
      
      <!-- Kontrakt indhold -->
      <div id="contractContent"></div>
      
      <!-- Actions -->
      <div id="contractActions" style="margin-top:20px;display:none;gap:12px">
        <button class="btn primary" onclick="downloadContractPDF()">üì• Download Kontrakt PDF</button>
        <button class="btn" onclick="printContract()">üñ®Ô∏è Udskriv</button>
      </div>
      
      <!-- Empty state -->
      <div id="contractEmptyState" class="empty-state">
        <div class="empty-icon">üìã</div>
        <div class="empty-title">Ingen udviklingskontrakt tilg√¶ngelig</div>
        <div class="empty-text">Din udviklingskontrakt vil vises her n√•r den er udgivet</div>
      </div>
    </div>
  </div>
<!-- Sammenlign Tab -->
  <div id="tab-sammenlign" class="content">
    <div class="section">
     <h2 class="section-title">‚öñÔ∏è Sammenlign Assessments</h2>
      <p class="section-subtitle">Sammenlign dine resultater p√• tv√¶rs af forskellige evalueringsrunder</p>
      
      <!-- V√¶lg assessments -->
      <div style="margin-bottom:20px">
        <label style="display:block;font-weight:600;margin-bottom:12px">V√¶lg assessments at sammenligne (2-4):</label>
        <div id="compareCheckboxes" class="compass-controls"></div>
      </div>
      
      <!-- Action buttons -->
      <div style="display:flex;gap:12px;margin-bottom:20px">
        <button id="btnCompare" class="btn primary" onclick="renderComparison()" disabled>üìä Vis Tabel</button>
        <button id="btnCompareRadar" class="btn" onclick="renderComparisonRadar()" disabled>üß≠ Vis Radar</button>
      </div>
      
      <!-- Comparison output -->
      <div id="comparisonResult"></div>
      
      <!-- Empty state -->
      <div id="compareEmptyState" class="empty-state">
        <div class="empty-icon">‚öñÔ∏è</div>
        <div class="empty-title">Ikke nok assessments</div>
        <div class="empty-text">Du skal have mindst 2 assessments for at kunne sammenligne</div>
      </div>
    </div>
  </div>  
  <!-- Upload Tab -->
  <div id="tab-upload" class="content">
    <div class="section">
      <h2 class="section-title">Upload .UDV Fil</h2>
      <p class="section-subtitle">Upload din egen evaluerings-fil (self-import)</p>
      
      <div class="upload-zone" id="uploadZone">
        <input type="file" id="udvFileInput" style="display:none">
        <div style="font-size:3rem;margin-bottom:12px">üì§</div>
        <div style="font-weight:600;margin-bottom:8px">Klik for at v√¶lge fil eller tr√¶k den hertil</div>
        <div style="color:var(--muted);font-size:.9rem">Underst√∏tter .UDV og .JSON filer</div>
      </div>

      
      <div id="uploadStatus" class="alert info" style="display:none"></div>
    </div>
    
    <div class="section">
      <h2 class="section-title">Mine Filer</h2>
      <ul id="filesList" class="file-list"></ul>
    </div>
  </div>

  <!-- Profil Tab -->
  <div id="tab-profil" class="content">
    <div class="section">
      <h2 class="section-title">Kontooplysninger</h2>
      
      <div class="card">
        <div class="card-title">Email</div>
        <div id="accountEmail" style="font-size:1.1rem"></div>
      </div>
      
      <div class="card">
        <div class="card-title">Medarbejdernummer (MA)</div>
        <div id="accountMA" style="font-size:1.1rem;font-weight:700;color:var(--brand)"></div>
      </div>
      
      <div class="card">
        <div class="card-title">Oprettet</div>
        <div id="accountCreated"></div>
      </div>
    </div>
    
    <div class="section">
      <h2 class="section-title">Samtykke</h2>
      <div class="consent-box">
        <div class="consent-text">
          Ved at bruge MinUdvikling accepterer du vores <a href="#" class="consent-link" onclick="showConsentModal();return false">privatlivspolitik og vilk√•r</a>.
        </div>
        <div id="consentStatus"></div>
      </div>
    </div>
    
    <div class="section danger-zone">
      <h3 class="danger-title">‚ö†Ô∏è Slet Konto</h3>
      <div class="danger-text">
        <p><strong>Advarsel:</strong> Hvis du sletter din konto, vil alle dine data blive permanent fjernet. Denne handling kan ikke fortrydes.</p>
        <p style="margin-top:12px">Du vil f√• mulighed for at downloade alle dine filer som en ZIP-fil f√∏r sletningen.</p>
      </div>
      <button class="btn error" onclick="initiateAccountDeletion()">Slet min konto</button>
    </div>
  </div>
</div>

<!-- Samtykke Modal -->
<div id="consentModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Privatlivspolitik & Vilk√•r</h2>
      <button class="modal-close" onclick="closeConsentModal()">√ó</button>
    </div>
    <div>
      <h3>Privatlivspolitik</h3>
      <p>MinUdvikling behandler dine personlige data i overensstemmelse med GDPR...</p>
      
      <h3 style="margin-top:20px">Vilk√•r for brug</h3>
      <p>Ved at bruge MinUdvikling accepterer du f√∏lgende vilk√•r...</p>
      
      <div style="margin-top:24px">
        <button class="btn primary" onclick="acceptConsent()">Accept√©r og luk</button>
      </div>
    </div>
  </div>
</div>

<!-- Slet konto modal -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Bekr√¶ft Sletning</h2>
      <button class="modal-close" onclick="closeDeleteModal()">√ó</button>
    </div>
    <div>
      <p style="margin-bottom:16px">Er du sikker p√• at du vil slette din konto? Alle dine data vil blive permanent fjernet.</p>
      
      <div class="alert warning" style="margin-bottom:16px">
        <span>‚ö†Ô∏è</span>
        <span>F√∏rst f√•r du mulighed for at downloade en ZIP-fil med alle dine data.</span>
      </div>
      
      <div style="display:flex;gap:12px">
        <button class="btn" onclick="closeDeleteModal()">Annuller</button>
        <button class="btn warning" onclick="downloadDataBeforeDelete()">Download data f√∏rst</button>
        <button class="btn error" onclick="confirmAccountDeletion()">Slet nu</button>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================================================
// KONFIGURATION
// ============================================================================
const SUPABASE_URL = "https://wsrstyrsuwhcmmlmnbrz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzcnN0eXJzdXdoY21tbG1uYnJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MTU0NTIsImV4cCI6MjA3MTE5MTQ1Mn0.Rf3Z3bQGjV5CKXKZr6IMOjzPdbhVJCh3SwuvlkpxUD0";
const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:8000' : 'https://minudvikling.dk';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Global state
let currentUser = null;
let userMA = null;
let assessments = [];
let selectedRounds = [];
let compassChart = null;
let currentCompassAssessment = null;
let currentCompassScores = [];
let currentContractAssessment = null;

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

// Retry logic for RPC calls med exponential backoff
async function retryRPC(rpcName, params = {}, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      const { data, error } = await supabase.rpc(rpcName, params);
      
      if (error) {
        console.warn(`RPC ${rpcName} attempt ${i + 1} failed:`, error);
        if (i === maxRetries - 1) {
          throw error; // Sidste fors√∏g - throw fejlen
        }
        // Vent f√∏r retry (exponential backoff)
        await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
        continue;
      }
      
      return { data, error: null };
    } catch (err) {
      console.error(`RPC ${rpcName} attempt ${i + 1} exception:`, err);
      if (i === maxRetries - 1) throw err;
      await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
    }
  }
}

// Wrapper for queries med retry logic
async function retryQuery(queryBuilder, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      const result = await queryBuilder;
      if (result.error) {
        console.warn(`Query attempt ${i + 1} failed:`, result.error);
        if (i === maxRetries - 1) return result;
        await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
        continue;
      }
      return result;
    } catch (err) {
      console.error(`Query attempt ${i + 1} exception:`, err);
      if (i === maxRetries - 1) throw err;
      await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, i)));
    }
  }
}

// ============================================================================
// INITIALISERING
// ============================================================================
// S√∏rg for at "Log ud" altid virker ‚Äì ogs√• hvis init fejler
document.addEventListener('DOMContentLoaded', () => {
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
});

async function init() {
  let authUser = null;
  try {
    // Tjek om bruger er logget ind
    const { data: { user }, error: authError } = await supabase.auth.getUser();
    if (authError) {
      console.error('Auth fejl:', authError);
      alert('Kunne ikke verificere login. Omdirigerer til login...');
      window.location.href = 'login.html';
      return;
    }
    if (!user) {
      console.log('Ingen bruger logget ind');
      window.location.href = 'login.html';
      return;
    }
    authUser = user;
  } catch (error) {
    console.error('Kritisk fejl ved initialisering:', error);
    alert('Der opstod en fejl: ' + error.message);
    return;
  }

  currentUser = authUser;

  // Hent MA via RPC (undg√•r RLS 403), og suppler profilfelter hvis muligt
  const { data: ma, error: maErr } = await supabase.rpc('get_ma_from_auth');
  
  if (maErr) {
    console.error('MA fetch fejl:', maErr);
    alert(`Kunne ikke hente din profil: ${maErr.message}. Kontakt support hvis problemet forts√¶tter.`);
    await supabase.auth.signOut();
    window.location.href = 'login.html';
    return;
  }
  
  if (!ma) {
    console.error('MA er null - profil eksisterer ikke');
    alert('Din individuelle profil blev ikke fundet. Du skal registrere dig f√∏rst.');
    await supabase.auth.signOut();
    window.location.href = 'login.html';
    return;
  }
  
  userMA = ma;

  // Fors√∏g at hente ekstra profilfelter ‚Äì forts√¶t hvis RLS blokerer
  let userData = { ma: userMA, email: authUser.email };
  try {
    const { data: profileMaybe, error: profileErr } = await supabase
      .from('individual_users')
      .select('created_at,last_login_at')
      .eq('ma', userMA)
      .single();
    if (!profileErr && profileMaybe) userData = { ...userData, ...profileMaybe };
  } catch (_) {}

  // Opdater sidste login timestamp (ignorer fejl hvis RLS blokerer)
  try {
    await supabase
      .from('individual_users')
      .update({ last_login_at: new Date().toISOString() })
      .eq('ma', userMA);
  } catch (_) {}

  // Opdater UI
  document.getElementById('userEmailDisplay').textContent = authUser.email;
  document.getElementById('userNameDisplay').textContent = `MA: ${userMA}`;
  const welcomeNameEl = document.getElementById('welcomeName');
  if (welcomeNameEl) welcomeNameEl.textContent = userMA;
  document.getElementById('accountEmail').textContent = authUser.email;
  document.getElementById('accountMA').textContent = userMA;
  if (userData.created_at) {
    document.getElementById('accountCreated').textContent = new Date(userData.created_at).toLocaleDateString('da-DK');
  }

  // Vis "Skift til Admin", kun hvis brugeren ogs√• har en adminrolle
  try {
    const { data: roleData } = await supabase
      .from('user_roles')
      .select('role')
      .eq('user_id', authUser.id)
      .maybeSingle();

    const switchBtn = document.getElementById('switchToAdminBtn');
    if (!switchBtn) { /* ingen knap i DOM */ }
    if (roleData?.role) {
      // Kortl√¶gning: programmer -> master.html, admin -> admin.html
      const role = roleData.role;
      // Upload skal v√¶re tilladt for alle roller ‚Äì ingen specialh√•ndtering
      try {
        // no-op
      } catch {}
      switchBtn.style.display = 'inline-block';
      switchBtn.onclick = () => {
        if (role === 'programmer') {
          window.location.href = 'master.html';
        } else if (role === 'admin') {
          window.location.href = 'admin.html';
        } else {
          // Ukendt/anden rolle: vis intet
          switchBtn.style.display = 'none';
        }
      };

    } else if (switchBtn) {
      switchBtn.style.display = 'none';
    }
  } catch (e) {
    console.warn('Kunne ikke afg√∏re om brugeren har admin-rolle:', e);
    const switchBtn = document.getElementById('switchToAdminBtn');
    if (switchBtn) switchBtn.style.display = 'none';
  }
  
  if (userData.consent_at) {
    document.getElementById('consentStatus').innerHTML = `<div class="alert success">‚úì Accepteret ${new Date(userData.consent_at).toLocaleDateString('da-DK')}</div>`;
  } else {
    document.getElementById('consentStatus').innerHTML = `<div class="alert warning">Du har endnu ikke accepteret vilk√•rene</div>`;
  }
  
  // Load data
  await loadAssessments();
  renderDashboard();
  initializeCompassTab();
  renderFilesList();
  
  // Setup event listeners for knapper
  setupEventListeners();
  
  // Setup tab navigation
  try {
    setupTabs();
  } catch (error) {
    console.error('Fejl ved ops√¶tning af tabs:', error);
  }
  
  try {
    setupUploadZone();
  } catch (error) {
    console.error('Fejl ved ops√¶tning af upload zone:', error);
  }
  
  console.log('Profile.html initialiseret succesfuldt');
}

// ============================================================================
// EVENT LISTENERS
// ============================================================================
function setupEventListeners() {
  // Log ud knap
  const logoutBtn = document.getElementById('logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', handleLogout);
  }
}

// ============================================================================
// TABS
// ============================================================================
function setupTabs() {
  try {
    document.querySelectorAll('.tabbtn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const target = btn.getAttribute('data-tab');
        
        if (!target) {
          console.error('Tab mangler data-tab attribut');
          return;
        }
        
        // Update tabs
        document.querySelectorAll('.tabbtn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Update content
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        const contentEl = document.getElementById(`tab-${target}`);
        if (contentEl) {
          contentEl.classList.add('active');
        } else {
          console.error(`Kunne ikke finde indhold for tab: ${target}`);
          return;
        }
        
        // Refresh content baseret p√• tab
        try {
          if (target === 'oversigt') renderDashboard();
          if (target === 'kompas') initializeCompassTab();
          if (target === 'kontrakt') initializeContractTab();
          if (target === 'sammenlign') renderCompareOptions();
          if (target === 'upload') renderFilesList();
          if (target === 'profil') renderProfileInfo();
        } catch (err) {
          console.error(`Fejl ved indl√¶sning af tab ${target}:`, err);
          alert(`Der opstod en fejl ved indl√¶sning af denne fane: ${err.message}`);
        }
      });
    });
    
    // Aktiv√©r f√∏rste tab som standard
    const firstTab = document.querySelector('.tabbtn');
    if (firstTab) {
      firstTab.click();
    }
  } catch (error) {
    console.error('Fejl ved ops√¶tning af tabs:', error);
    alert('Der opstod en fejl ved indl√¶sning af navigation');
  }
}

function switchTab(tabName) {
  const btn = document.querySelector(`[data-tab="${tabName}"]`);
  if (btn) btn.click();
}

// ============================================================================
// UPLOAD FUNKTIONALITET (kun Admin .UDV, ingen legacy ZIP)
// ============================================================================
// Note: Upload zone event listeners s√¶ttes op i setupUploadZone() funktionen senere

// Parser identisk til admin.html
async function readUdvFileProfile(file) {
  const text = await file.text();
  let json = null;

  // 1) Pr√∏v ren JSON
  try { json = JSON.parse(text); } catch {}

  // 2) Pr√∏v base64-encoded JSON
  if (!json) {
    try {
      const decoded = atob(String(text).trim());
      json = JSON.parse(decoded);
    } catch {}
  }

  if (!json || !json.udv_version) {
    // Ikke l√¶ngere et krav ‚Äì return√©r det vi kunne parse
    return json || {};
  }

  // Normaliser strukturen som i Admin
  json.people = Array.isArray(json.people) ? json.people : [];
  json.scores = Array.isArray(json.scores) ? json.scores : [];

  return json;
}

async function handleUDVUpload(file) {
  const statusEl = document.getElementById('uploadStatus');
  if (!statusEl) {
    console.error('Upload status element ikke fundet');
    return;
  }

  statusEl.style.display = 'block';
  statusEl.className = 'alert info';
  statusEl.textContent = 'Uploader fil.';

  try {
    // L√ÜS r√• tekst √©n gang (bruges til fallback/MA-scan)
    const rawText = await file.text();

    // Fors√∏g at parse .UDV med f√¶lles parser (underst√∏tter JSON + base64-JSON)
    let udv = await readUdvFileProfile(new File([rawText], file.name, { type: file.type }));

    // Hvis ikke parsebart som JSON, gem r√• fil som base64-wrapper (bevar adf√¶rd)
    if (!udv || Object.keys(udv).length === 0) {
      const buf = await file.arrayBuffer();
      const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
      udv = {
        raw_file_base64: b64,
        filename: file.name,
        mimetype: file.type || 'application/octet-stream',
        note: 'unparsed'
      };
    }

    let assessment, categories, responses, contract;

    if (udv && udv.udv_version) {
      // ===== Survey-/project-UDV (med udv_version) =====
      const people = Array.isArray(udv.people) ? udv.people : [];

      // Kandidater fra people[]
      const maSet = new Set(
        people.flatMap(p => [
          p.employee_no, p.employeeNo, p.ma, p.ma_no, p.maNo,
          p.employee?.number, p.employee?.id, p.meta?.employee_no, p.meta?.ma_no
        ].filter(v => v !== undefined && v !== null && String(v).trim() !== ''))
        .map(v => String(v).trim())
      );

      // Fald tilbage: scan r√• tekst for 6-cifrede tal (MA-format)
      try {
        (rawText.match(/\b\d{6}\b/g) || []).forEach(v => maSet.add(String(v).trim()));
      } catch {}

      const variant =
        udv.variant ||
        (udv.project && (udv.project.is_lite ? 'LITE' : 'FULL')) ||
        'FULL';

      const projectLabel =
        (udv.project && (udv.project.label || udv.project.title)) ||
        'UKENDT';

      assessment = {
        ma: String(userMA).trim(),
        project_label: projectLabel,
        variant: variant,
        completed_at: udv.exported_at || new Date().toISOString()
      };

      const cats =
        (udv.taxonomy && (udv.taxonomy.categories || udv.taxonomy)) ||
        [];
      categories = { categories: Array.isArray(cats) ? cats : [] };
      responses = {};
      contract = udv.contract || {};

      statusEl.textContent = 'Importerer udviklingskontrakt til database.';

      const { data, error } = await supabase.rpc('import_individual_assessment', {
        p_ma: assessment.ma,
        p_project_label: assessment.project_label,
        p_variant: assessment.variant,
        p_completed_at: assessment.completed_at,
        p_udv_json: udv,
        p_categories: categories.categories || [],
        p_development_contract: contract
      });

      if (error) throw error;
      if (data?.error) throw new Error(data.error);
      if (!data?.success) throw new Error('Import fejlede');

    } else if (udv && udv.contract) {
      // ===== NYT: Contract-only UDV fra Admin (Gem/Udgiv) =====
      // Struktur: { contract: { ... } } uden udv_version
      const c = udv.contract || {};

      // Minimal assessment (ingen taxonomy/scores i dette format)
      assessment = {
        ma: String(userMA).trim(),
        project_label: (c.project && c.project.title) || 'UKENDT',
        variant: 'FULL',
        completed_at: c.saved_at || new Date().toISOString()
      };

      categories = { categories: [] };
      responses  = {};
      contract   = c; // behold felter inkl. kollegast√∏tte (include_colleague_support, colleagues_selected, colleague_support_text)

      statusEl.textContent = 'Importerer udviklingskontrakt (contract-only) til database.';

      const { data, error } = await supabase.rpc('import_individual_assessment', {
        p_ma: assessment.ma,
        p_project_label: assessment.project_label,
        p_variant: assessment.variant,
        p_completed_at: assessment.completed_at,
        p_udv_json: udv,                 // gem hele payload‚Äôen som modtaget
        p_categories: [],                // ingen kategorier i contract-only
        p_development_contract: contract // vigtig: kontrakten ind i development_contract
      });

      if (error) throw error;
      if (data?.error) throw new Error(data.error);
      if (!data?.success) throw new Error('Import fejlede');

    } else {
      // ===== Legacy/ukendt ‚Äì accepter JSON wrappers eller base64 RAW =====
      let data = null;
      try { data = JSON.parse(rawText); } catch {}

      if (data && (data.assessment || data.categories || data.contract)) {
        assessment = data.assessment || { ma: String(userMA).trim(), project_label: 'IMPORT', variant: 'LEGACY', completed_at: new Date().toISOString() };
        categories = data.categories || { categories: [] };
        responses  = data.responses  || {};
        contract   = data.contract   || {};
      } else {
        // Ikke-JSON: gem som base64-wrapper
        const buf = await file.arrayBuffer();
        const b64 = btoa(String.fromCharCode(...new Uint8Array(buf)));
        assessment = {
          ma: String(userMA).trim(),
          project_label: 'UPLOAD',
          variant: 'RAW',
          completed_at: new Date().toISOString()
        };
        categories = { categories: [] };
        responses  = {};
        contract   = {};
        udv = { raw_file_base64: b64, filename: file.name, mimetype: file.type || 'application/octet-stream', note: 'unparsed' };
      }

      // Gem i DB
      statusEl.textContent = 'Importerer til database.';

      const { data: res, error: err } = await supabase.rpc('import_individual_assessment', {
        p_ma: assessment.ma,
        p_project_label: assessment.project_label,
        p_variant: assessment.variant,
        p_completed_at: assessment.completed_at,
        p_udv_json: { assessment, responses, categories, contract },
        p_categories: categories.categories || [],
        p_development_contract: contract
      });

      if (err) throw err;
      if (res?.error) throw new Error(res.error);
      if (!res?.success) throw new Error('Import fejlede');
    }

    // Success
    statusEl.className = 'alert success';
    statusEl.textContent = '‚úÖ UDV-fil uploadet og l√¶st korrekt.';

    // Opdat√©r data og hop direkte til Udviklingskontrakt
    await loadAssessments();
    initializeContractTab();
    setTimeout(() => {
      switchTab('kontrakt');
      const sel = document.getElementById('contractAssessmentSelect');
      if (sel && assessments.length) {
        const withContract = assessments.filter(a => a.development_contract);
        if (withContract.length) {
          sel.value = withContract[0].id;
        } else {
          sel.value = assessments[0].id;
        }
        loadContractForAssessment();
      }
      statusEl.style.display = 'none';
      const inp = document.getElementById('udvFileInput');
      if (inp) inp.value = '';
    }, 500);

  } catch (error) {
    console.error('Upload error:', error);
    statusEl.className = 'alert error';
    const msg = (error && error.message) ? String(error.message) : 'Upload fejlede';
    const pretty = msg.includes('end of central directory')
      ? 'UDV-filen er ikke en ZIP (og b√∏r v√¶re JSON fra Admin).'
      : msg;
    statusEl.textContent = `‚ùå ${pretty}`;
  }
}

// ============================================================================
// TIMELINE RENDERING
// ============================================================================
function renderTimeline() {
  const container = document.getElementById('assessmentTimeline');
  const emptyState = document.getElementById('emptyStateOversigt');
  
  if (assessments.length === 0) {
    container.innerHTML = '';
    emptyState.style.display = 'block';
    return;
  }
  
  emptyState.style.display = 'none';
  
  // Sort by date desc
  const sorted = [...assessments].sort((a, b) => 
    new Date(b.published_at) - new Date(a.published_at)
  );

  
  container.innerHTML = `
    <div class="grid grid-2">
      ${sorted.map(a => {
        const date = new Date(a.published_at).toLocaleDateString('da-DK', {
          day: 'numeric',
          month: 'long',
          year: 'numeric'
        });
        
        const categoryCount = (a.udv_json?.categories?.categories || []).length;
        const variant = a.variant === 'FULL' ? 'FULL' : 'LITE';
        const badgeColor = variant === 'FULL' ? 'var(--brand)' : 'var(--info)';
        
        return `
          <div class="card">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
              <div class="card-title">${a.project_label}</div>
              <div style="background:${badgeColor};color:#fff;padding:4px 10px;border-radius:6px;font-size:0.8rem;font-weight:700">
                ${variant}
              </div>
            </div>
            <div class="card-meta">
              üìÖ ${date}<br/>
              üìà ${categoryCount} kategorier
            </div>
            <div class="card-actions">
              <button class="btn small primary" onclick="viewAssessmentDetails('${a.id}')">
                Vis Detaljer
              </button>
              <button class="btn small" onclick="downloadUDV('${a.id}')">
                ‚¨á Download
              </button>
              <button class="btn small error" onclick="deleteAssessment('${a.id}')">
                üóë
              </button>
            </div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}

function viewAssessmentDetails(assessmentId) {
  viewCompass(assessmentId);
}

async function deleteAssessment(assessmentId) {
  if (!confirm('Er du sikker p√•, du vil slette denne udviklingskontrakt og ALT relateret? Dette kan ikke fortrydes.')) {
    return;
  }

  // Hj√¶lpere der t√•ler manglende tabeller/buckets
  const isIgnorableMissingTable = (err) =>
    !!err && (
      (typeof err.message === 'string' && err.message.toLowerCase().includes('schema cache')) ||
      err.code === 'PGRST116' ||
      (typeof err.details === 'string' && err.details.toLowerCase().includes('does not exist'))
    );

  async function tryDeleteRelated(table, column, value) {
    const { error } = await supabase.from(table).delete().eq(column, value);
    if (error && !isIgnorableMissingTable(error)) throw error;
  }

  async function trySelectFiles(table, assessmentId) {
    const { data, error } = await supabase
      .from(table)
      .select('bucket, path')
      .eq('assessment_id', assessmentId);

    if (error) {
      if (isIgnorableMissingTable(error)) return [];
      throw error;
    }
    return Array.isArray(data) ? data : [];
  }

  async function tryRemoveFromStorage(bucket, paths) {
    if (!paths || paths.length === 0) return;
    const { error } = await supabase.storage.from(bucket).remove(paths);
    if (error && !(typeof error.message === 'string' && error.message.toLowerCase().includes('not found'))) {
      throw error;
    }
  }

  try {
    const fileRows = await trySelectFiles('individual_assessment_files', assessmentId);
    if (fileRows.length > 0) {
      const pathsByBucket = fileRows.reduce((acc, row) => {
        if (row?.bucket && row?.path) {
          if (!acc[row.bucket]) acc[row.bucket] = [];
          acc[row.bucket].push(row.path);
        }
        return acc;
      }, {});

      for (const [bucket, paths] of Object.entries(pathsByBucket)) {
        await tryRemoveFromStorage(bucket, paths);
      }
    }

    const RELATED_TABLES = [
      'individual_assessment_notes',
      'individual_assessment_collaborators',
      'individual_assessment_signatures',
      'individual_assessment_events',
      'individual_assessment_files'
    ];

    for (const table of RELATED_TABLES) {
      await tryDeleteRelated(table, 'assessment_id', assessmentId);
    }

    {
      const { error: delErr } = await supabase
        .from('individual_assessments')
        .delete()
        .eq('id', assessmentId);
      if (delErr) throw delErr;
    }

    // UI refresh ‚Äî robust mod manglende elementer/funktioner
    try {
      if (typeof loadAssessments === 'function') {
        await loadAssessments();
      }
    } catch (e) {
      console.warn('loadAssessments() fejlede:', e);
    }

    try {
      if (typeof renderTimeline === 'function') {
        renderTimeline();
      }
    } catch (e) {
      console.warn('renderTimeline() fejlede:', e);
    }

  } catch (error) {
    console.error('Delete error:', error);
    alert('Kunne ikke slette udviklingskontrakten fuldst√¶ndigt: ' + (error?.message || 'ukendt fejl'));
  }
}

// ============================================================================
// SAMMENLIGN FUNKTIONALITET (MED RADAR OVERLAY)
// ============================================================================
let selectedForComparison = [];
let comparisonChart = null;

function renderCompareOptions() {
  if (assessments.length < 2) {
    document.getElementById('compareCheckboxes').innerHTML = '';
    document.getElementById('compareEmptyState').style.display = 'block';
    document.getElementById('btnCompare').disabled = true;
    document.getElementById('btnCompareRadar').disabled = true;
    return;
  }
  
  document.getElementById('compareEmptyState').style.display = 'none';

  
  document.getElementById('compareCheckboxes').innerHTML = assessments.map(a => `
    <label class="round-checkbox">
      <input type="checkbox" value="${a.id}" onchange="updateCompareSelection(this)">
      <span>${a.project_label} (${a.variant})</span>
    </label>
  `).join('');
  
  updateCompareSelection();
}

function updateCompareSelection(checkbox) {
  if (checkbox) {
    if (checkbox.checked) {
      if (selectedForComparison.length < 4) {
        selectedForComparison.push(checkbox.value);
      } else {
        checkbox.checked = false;
        alert('Du kan maksimalt sammenligne 4 assessments');
      }
    } else {
      selectedForComparison = selectedForComparison.filter(id => id !== checkbox.value);
    }
  }
  
  document.getElementById('btnCompare').disabled = selectedForComparison.length < 2;
  document.getElementById('btnCompare').textContent = `üìä Vis Tabel (${selectedForComparison.length})`;
  
  document.getElementById('btnCompareRadar').disabled = selectedForComparison.length < 2;
  document.getElementById('btnCompareRadar').textContent = `üß≠ Vis Radar (${selectedForComparison.length})`;
}

async function renderComparison() {
  const container = document.getElementById('comparisonResult');
  
  if (selectedForComparison.length < 2) {
    container.innerHTML = '<div class="alert warning">V√¶lg mindst 2 assessments</div>';
    return;
  }
  
  try {
    // Hent scores for alle valgte assessments
    const { data: scores, error } = await supabase
      .from('individual_compass_scores')
      .select('*')
      .in('assessment_id', selectedForComparison);
    
    if (error) throw error;
    
    const assessmentLabels = selectedForComparison.map(id => {
      const a = assessments.find(x => x.id === id);
      return { id, label: a?.project_label || 'Ukendt' };
    });
    
    // Grupper data
    const categories = Array.from(new Set(scores.map(s => s.category_name)));
    const respondentTypes = ['self', 'peer', 'leader'];
    
    let html = '<div class="compass-container">';
    html += '<h3 style="margin-bottom:20px">üìä Sammenligning - Tabelvisning</h3>';
    
    respondentTypes.forEach(type => {
      const typeLabel = type === 'self' ? 'üë§ Selv' : type === 'peer' ? 'üë• Kolleger' : 'üëî Leder';
      const typeScores = scores.filter(s => s.respondent_type === type);
      
      if (typeScores.length === 0) return;
      
      html += `<h4 style="margin-top:25px;margin-bottom:15px;color:var(--brand)">${typeLabel}</h4>`;
      html += '<table style="width:100%;border-collapse:collapse;font-size:0.95em">';
      html += '<thead><tr style="background:var(--surface)"><th style="padding:10px;text-align:left">Kategori</th>';
      
      assessmentLabels.forEach(a => {
        html += `<th style="padding:10px;text-align:center">${a.label}</th>`;
      });
      
      html += '<th style="padding:10px;text-align:center">√Ündring</th></tr></thead><tbody>';
      
      categories.forEach((cat, idx) => {
        html += `<tr style="border-bottom:1px solid var(--line);background:${idx % 2 === 0 ? '#fff' : 'var(--surface)'}">`;
        html += `<td style="padding:10px">${cat}</td>`;
        
        const values = assessmentLabels.map(a => {
          const score = typeScores.find(s => s.assessment_id === a.id && s.category_name === cat);
          return score ? parseFloat(score.score_numeric) : 0;
        });
        
        values.forEach(v => {
          html += `<td style="padding:10px;text-align:center;font-weight:600">${v > 0 ? v.toFixed(2) : '-'}</td>`;
        });
        
        // √Ündring
        const delta = values[values.length - 1] - values[0];
        const arrow = delta > 0 ? '‚ñ≤' : delta < 0 ? '‚ñº' : '‚îÅ';
        const color = delta > 0 ? 'var(--success)' : delta < 0 ? 'var(--error)' : 'var(--muted)';
        
        html += `<td style="padding:10px;text-align:center;color:${color};font-weight:700">${arrow} ${Math.abs(delta).toFixed(2)}</td>`;
        html += '</tr>';
      });
      
      html += '</tbody></table>';
    });
    
    html += '<div style="margin-top:25px">';
    html += '<button class="btn primary" onclick="downloadComparisonPDF()">üì• Download Sammenligning PDF</button>';
    html += '<button class="btn" onclick="exportComparisonCSV()" style="margin-left:10px">üìä Eksporter CSV</button>';
    html += '</div>';
    
    html += '</div>';
    
    container.innerHTML = html;
    
  } catch (error) {
    console.error('Comparison error:', error);
    container.innerHTML = '<div class="alert error">Kunne ikke sammenligne assessments</div>';
  }
}

async function renderComparisonRadar() {
  const container = document.getElementById('comparisonResult');
  
  if (selectedForComparison.length < 2) {
    container.innerHTML = '<div class="alert warning">V√¶lg mindst 2 assessments</div>';
    return;
  }
  
  try {
    // Hent scores
    const { data: scores, error } = await supabase
      .from('individual_compass_scores')
      .select('*')
      .in('assessment_id', selectedForComparison);
    
    if (error) throw error;
    
    // Respondent type selector
    let html = '<div class="compass-container">';
    html += '<h3 style="margin-bottom:20px">üß≠ Sammenligning - Radar Overlay</h3>';
    
    html += '<div style="margin-bottom:20px">';
    html += '<label style="font-weight:600;display:block;margin-bottom:8px">V√¶lg respondent type:</label>';
    html += '<select id="comparisonRespondentType" class="input" onchange="updateComparisonRadar()" style="max-width:300px">';
    html += '<option value="self">üë§ Selv</option>';
    html += '<option value="peer">üë• Kolleger</option>';
    html += '<option value="leader">üëî Leder</option>';
    html += '</select>';
    html += '</div>';
    
    html += '<div style="max-width:700px;margin:0 auto">';
    html += '<canvas id="comparisonRadarChart" style="max-height:500px"></canvas>';
    html += '</div>';
    
    html += '<div style="margin-top:25px">';
    html += '<button class="btn primary" onclick="downloadComparisonPDF()">üì• Download Sammenligning PDF</button>';
    html += '<button class="btn" onclick="exportComparisonCSV()" style="margin-left:10px">üìä Eksporter CSV</button>';
    html += '</div>';
    
    html += '</div>';
    
    container.innerHTML = html;
    
    // Render initial chart
    updateComparisonRadar();
    
  } catch (error) {
    console.error('Comparison radar error:', error);
    container.innerHTML = '<div class="alert error">Kunne ikke oprette radar sammenligning</div>';
  }
}

async function updateComparisonRadar() {
  const select = document.getElementById('comparisonRespondentType');
  if (!select) return;
  
  const respondentType = select.value;
  
  try {
    // Hent scores
    const { data: scores, error } = await supabase
      .from('individual_compass_scores')
      .select('*')
      .in('assessment_id', selectedForComparison)
      .eq('respondent_type', respondentType);
    
    if (error) throw error;
    
    // Organiser data
    const categories = Array.from(new Set(scores.map(s => s.category_name)));
    const colors = ['#667eea', '#48bb78', '#ed8936', '#f56565'];
    
    const datasets = selectedForComparison.map((assessmentId, idx) => {
      const assessment = assessments.find(a => a.id === assessmentId);
      const assessmentScores = scores.filter(s => s.assessment_id === assessmentId);
      
      return {
        label: assessment.project_label,
        data: categories.map(cat => {
          const score = assessmentScores.find(s => s.category_name === cat);
          return score ? parseFloat(score.score_numeric) : null;
        }),
        borderColor: colors[idx % colors.length],
        backgroundColor: colors[idx % colors.length] + '33',
        borderWidth: 2,
        pointRadius: 4,
        pointHoverRadius: 6
      };
    });
    
    const ctx = document.getElementById('comparisonRadarChart');
    
    if (comparisonChart) {
      comparisonChart.destroy();
    }
    
    comparisonChart = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: categories,
        datasets: datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
          r: {
            beginAtZero: true,
            min: 0,
            max: 5,
            ticks: {
              stepSize: 1
            }
          }
        },
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 15,
              font: {
                size: 13,
                weight: '600'
              }
            }
          },
          title: {
            display: true,
            text: `Sammenligning - ${respondentType === 'self' ? 'Selv' : respondentType === 'peer' ? 'Kolleger' : 'Leder'}`,
            font: {
              size: 18,
              weight: 'bold'
            }
          }
        }
      }
    });
    
  } catch (error) {
    console.error('Update comparison radar error:', error);
  }
}

async function downloadComparisonPDF() {
  alert('PDF download af sammenligning implementeres (samme princip som kompas PDF)');
}

function exportComparisonCSV() {
  alert('CSV eksport implementeres');
}

// ============================================================================
// PROFIL INFO
// ============================================================================
async function renderProfileInfo() {
  try {
    // Hent MA via RPC for at undg√• RLS 403
    const { data: ma } = await supabase.rpc('get_ma_from_auth');
    if (!ma) return;

    // Fors√∏g at hente profil ‚Äì toler√©r RLS og udfyld det vi kan
    const { data: profile, error: profileErr } = await supabase
      .from('individual_users')
      .select('ma,email,created_at,last_login_at')
      .eq('ma', ma)
      .single();

    document.getElementById('profileMA').textContent = profile?.ma ?? ma;

    // Fald tilbage til auth.getUser() for email hvis profil ikke m√• l√¶ses
    const { data: authData } = await supabase.auth.getUser();
    document.getElementById('profileEmail').textContent =
      profile?.email ?? authData?.user?.email ?? '';

    if (profile?.created_at) {
      document.getElementById('profileCreated').textContent =
        new Date(profile.created_at).toLocaleDateString('da-DK');
    }
    document.getElementById('profileLastLogin').textContent =
      profile?.last_login_at
        ? new Date(profile.last_login_at).toLocaleDateString('da-DK')
        : 'Aldrig';
    
    // Statistik
    document.getElementById('statsCount').textContent = assessments.length;
    
    if (assessments.length > 0) {
      const sorted = [...assessments].sort((a, b) => 
        new Date(a.published_at) - new Date(b.published_at)
      );
      document.getElementById('statsFirst').textContent = 
        new Date(sorted[0].published_at).toLocaleDateString('da-DK');
      document.getElementById('statsLast').textContent = 
        new Date(sorted[sorted.length - 1].published_at).toLocaleDateString('da-DK');
    }
    
  } catch (error) {
    console.error('Profile error:', error);
  }
}

function initiatePasswordChange() {
  alert('Skift adgangskode funktionalitet implementeres. Brug "Glemt adgangskode" p√• login siden.');
}

async function downloadAllData() {
  try {
    if (assessments.length === 0) {
      alert('Ingen data at downloade');
      return;
    }
    
    const zip = new JSZip();
    
    assessments.forEach(a => {
      const filename = `${a.project_label}_${a.variant}.json`;
      zip.file(filename, JSON.stringify(a.udv_json, null, 2));
    });
    
    const blob = await zip.generateAsync({ type: 'blob' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `MinUdvikling_${userMA}_Alle_Data.zip`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    
  } catch (error) {
    console.error('Download error:', error);
    alert('Kunne ikke downloade data');
  }
}

// ============================================================================
// DATA LOADING
// ============================================================================
async function loadAssessments() {
  try {
    const { data, error } = await supabase
      .from('individual_assessments')
      .select('*')
      .eq('ma', userMA)
      .order('published_at', { ascending: false });
    
    if (error) throw error;
    
    assessments = data || [];
    
  } catch (error) {
    console.error('Load assessments error:', error);
    assessments = [];
  }
}

// ============================================================================
// DASHBOARD RENDERING
// ============================================================================
function renderDashboard() {
  // Stats
  document.getElementById('statsAssessments').textContent = assessments.length;
  
  const contractsCount = assessments.filter(a => a.development_contract).length;
  document.getElementById('statsContracts').textContent = contractsCount;
  
  // Filer t√¶lles senere n√•r vi implementerer artifacts
  document.getElementById('statsFiles').textContent = assessments.length; // Placeholder
  
  // Seneste kontrakt
  const latestWithContract = assessments.find(a => a.development_contract);
  const contractContainer = document.getElementById('latestContractContainer');
  
  if (latestWithContract) {
    contractContainer.innerHTML = `
      <div class="card">
        <div class="card-title">${esc(latestWithContract.project_label)}</div>
        <div class="card-meta">Udgivet ${new Date(latestWithContract.published_at).toLocaleDateString('da-DK')}</div>
        <div class="card-actions">
          <button class="btn primary small" onclick="viewContract('${latestWithContract.id}')">Se kontrakt</button>
          <button class="btn small" onclick="downloadContract('${latestWithContract.id}')">Download PDF</button>
        </div>
      </div>
    `;
  } else {
    contractContainer.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üìã</div>
        <div class="empty-title">Ingen udviklingskontrakt endnu</div>
        <div class="empty-text">Din kontrakt vil blive vist her n√•r den er udgivet</div>
      </div>
    `;
  }
  
  // Assessments liste
  const assessmentsList = document.getElementById('assessmentsList');
  
  if (assessments.length === 0) {
    assessmentsList.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üìä</div>
        <div class="empty-title">Ingen evalueringer endnu</div>
        <div class="empty-text">Dine evalueringsresultater vil blive vist her n√•r de er udgivet</div>
      </div>
    `;
  } else {
    assessmentsList.innerHTML = assessments.map(a => `
      <div class="card">
        <div class="card-title">${a.project_label}</div>
        <div class="card-meta">
          ${a.variant} ‚Ä¢ Udgivet ${new Date(a.published_at).toLocaleDateString('da-DK')}
        </div>
        <div class="card-actions">
          <button class="btn primary small" onclick="viewCompass('${a.id}')">Se Kompas</button>
          <button class="btn small" onclick="downloadUDV('${a.id}')">Download .UDV</button>
        </div>
      </div>
    `).join('');
  }
}

// ============================================================================
// KOMPAS VISUALIZATION
// ============================================================================
function initializeCompassTab() {
  const select = document.getElementById('compassAssessmentSelect');

  // Reset UI
  document.getElementById('compassRespondentControls').style.display = 'none';
  document.getElementById('compassChartContainer').style.display = 'none';
  document.getElementById('compassActions').style.display = 'none';

  // Byg dropdown KUN fra profilens assessments (inkl. uploadede .UDV)
  const opts = [
    '<option value="">-- V√¶lg en assessment --</option>',
    (assessments || []).map(a => `<option value="${a.id}">${a.project_label} (${a.variant})</option>`).join('')
  ].join('');
  select.innerHTML = opts;

  if ((assessments || []).length > 0) {
    document.getElementById('compassEmptyState').style.display = 'none';
    // Bevar evt. tidligere valg ‚Äì ellers v√¶lg f√∏rste
    if (!select.value) select.value = assessments[0].id;
    loadCompassForAssessment();
  } else {
    document.getElementById('compassEmptyState').style.display = 'block';
  }
}

async function loadCompassForAssessment() {
  const select = document.getElementById('compassAssessmentSelect');
  const assessmentId = select.value;

  if (!assessmentId) {
    document.getElementById('compassRespondentControls').style.display = 'none';
    document.getElementById('compassChartContainer').style.display = 'none';
    document.getElementById('compassActions').style.display = 'none';
    return;
  }

  currentCompassAssessment = assessmentId;

  try {
    // 1) Pr√∏v DB-beregnede scores
    const { data: dbScores, error } = await supabase
      .from('individual_compass_scores')
      .select('*')
      .eq('assessment_id', assessmentId);

    if (error) throw error;

    let built = Array.isArray(dbScores) ? dbScores : [];

    // 2) Fallback: byg fra UDV‚Äôen gemt i profilens dataset
    if (!built.length) {
      const a = (assessments || []).find(x => x.id === assessmentId);
      const udv = a && a.udv_json ? a.udv_json : null;

      // 2A) Fallback #1: klassiske per-score m√•linger (udv.scores)
      if (udv && Array.isArray(udv.scores)) {
        // Taxonomi-navne: 1) udv.taxonomy, 2) a.categories, 3) afled fra scores
        let taxonomy = Array.isArray(udv.taxonomy)
          ? udv.taxonomy.map(t => ({ category_id: t.category_id, category_name: t.category_name }))
          : [];

        if (!taxonomy.length && Array.isArray(a?.categories)) {
          taxonomy = a.categories.map(c => ({ category_id: c.category_id, category_name: c.category_name }));
        }

        if (!taxonomy.length) {
          const ids = Array.from(new Set(udv.scores.map(s => s.category_id)));
          taxonomy = ids.map((id, i) => ({ category_id: id, category_name: `Kategori ${i+1}` }));
        }

        // Find m√•lperson i UDV
        const people = Array.isArray(udv.people) ? udv.people : [];
        let targetId = null;
        const match = people.find(p => String(p.employee_no ?? p.ma ?? p.meta?.employee_no ?? '').trim() === String(userMA).trim());
        if (match) targetId = match.id;
        else if (people.length === 1) targetId = people[0].id;
        else targetId = people[0]?.id ?? null;

        const getVal = (catId, type) => {
          const r = udv.scores.find(s =>
            String(s.target_id) === String(targetId) &&
            s.category_id === catId &&
            s.respondent_type === type
          );
          if (!r) return null;
          const v = Number.isFinite(r.value) ? r.value : (Number.isFinite(r.safe_avg) ? r.safe_avg : null);
          return v;
        };

        built = [];
        ['self','peer','leader'].forEach(type => {
          taxonomy.forEach(cat => {
            const v = getVal(cat.category_id, type);
            if (v !== null) {
              built.push({
                category_name: cat.category_name,
                respondent_type: type,
                score_numeric: v
              });
            }
          });
        });
      } else if (udv && udv.compass_snapshot && Array.isArray(udv.compass_snapshot.categories) && udv.compass_snapshot.series) {
        // Fallback: brug kompakt kompas-snapshot
        const snap = udv.compass_snapshot;
        const catNames = snap.categories.map(c => c.name);
        const pushSeries = (arr, type) => {
          if (!Array.isArray(arr)) return;
          arr.forEach((v, idx) => {
            const n = catNames[idx];
            if (n == null || v == null) return;
            built.push({ category_name: n, respondent_type: type, score_numeric: Number(v) });
          });
        };
        built = [];
        pushSeries(snap.series.self,   'self');
        pushSeries(snap.series.peer,   'peer');
        pushSeries(snap.series.leader, 'leader');

        // Hvis kun blended er udfyldt, vis den som 'peer' (√©n serie)
        if (!built.length && Array.isArray(snap.series.blended)) {
          snap.series.blended.forEach((v, idx) => {
            const n = catNames[idx];
            if (n == null || v == null) return;
            built.push({ category_name: n, respondent_type: 'peer', score_numeric: Number(v) });
          });
        }
      }

      // 2B) Fallback #2: kompakt kompas-snapshot (udv.compass_snapshot)
      else if (udv && udv.compass_snapshot && Array.isArray(udv.compass_snapshot.categories) && udv.compass_snapshot.series) {
        const snap = udv.compass_snapshot;
        const catNames = snap.categories.map(c => c.name);
        const pushSeries = (arr, type) => {
          if (!Array.isArray(arr)) return;
          arr.forEach((v, idx) => {
            const n = catNames[idx];
            if (n == null) return;
            if (v == null) return;
            built.push({
              category_name: n,
              respondent_type: type,
              score_numeric: Number(v)
            });
          });
        };

        built = [];
        pushSeries(snap.series.self,   'self');
        pushSeries(snap.series.peer,   'peer');
        pushSeries(snap.series.leader, 'leader');

        // Hvis alt var tomt (kun blended udfyldt), s√• brug blended som ‚Äúpeer‚Äù (vises stadig korrekt i √©n farve)
        if (!built.length && Array.isArray(snap.series.blended)) {
          snap.series.blended.forEach((v, idx) => {
            const n = catNames[idx];
            if (n == null || v == null) return;
            built.push({
              category_name: n,
              respondent_type: 'peer',
              score_numeric: Number(v)
            });
          });
        }
      }
    }

    currentCompassScores = built || [];

    // UI on/off
    if (!currentCompassScores.length) {
      document.getElementById('compassRespondentControls').style.display = 'none';
      document.getElementById('compassChartContainer').style.display = 'none';
      document.getElementById('compassActions').style.display = 'none';
      alert('Ingen KOMPAS-data fundet for denne assessment.');
      return;
    }

    document.getElementById('compassEmptyState').style.display = 'none';
    document.getElementById('compassRespondentControls').style.display = 'flex';
    document.getElementById('compassChartContainer').style.display = 'block';
    document.getElementById('compassActions').style.display = 'flex';

    updateCompassChart();

  } catch (err) {
    console.error('Fejl ved indl√¶sning af kompas data:', err);
    alert('Kunne ikke indl√¶se kompas data');
  }
}

function updateCompassChart() {
  if (!currentCompassAssessment || currentCompassScores.length === 0) {
    return;
  }
  
  // Check hvilke respondent typer er valgt
  const showSelf = document.getElementById('cbSelf').checked;
  const showPeer = document.getElementById('cbPeer').checked;
  const showLeader = document.getElementById('cbLeader').checked;
  
  // Find unikke kategorier (i stabil r√¶kkef√∏lge)
  const categories = Array.from(new Set(currentCompassScores.map(s => s.category_name)));

  
  // Opbyg datasets
  const datasets = [];
  const colors = {
    self: { border: '#667eea', bg: 'rgba(102, 126, 234, 0.2)' },
    peer: { border: '#48bb78', bg: 'rgba(72, 187, 120, 0.2)' },
    leader: { border: '#ed8936', bg: 'rgba(237, 137, 54, 0.2)' }
  };
  const labels = {
    self: 'üë§ Selv',
    peer: 'üë• Kolleger',
    leader: 'üëî Leder'
  };
  
  ['self', 'peer', 'leader'].forEach(type => {
    if ((type === 'self' && showSelf) || 
        (type === 'peer' && showPeer) || 
        (type === 'leader' && showLeader)) {
      
      const typeScores = currentCompassScores.filter(s => s.respondent_type === type);
      
      if (typeScores.length > 0) {
        datasets.push({
          label: labels[type],
          data: categories.map(cat => {
            const score = typeScores.find(s => s.category_name === cat);
            return score ? parseFloat(score.score_numeric) : null;
          }),
          borderColor: colors[type].border,
          backgroundColor: colors[type].bg,
          borderWidth: 2,
          pointRadius: 4,
          pointHoverRadius: 6
        });
      }
    }
  });
  
  // Opdater eller opret chart
  const ctx = document.getElementById('compassChart');
  if (compassChart) compassChart.destroy();

  if (datasets.length === 0) {
    ctx.parentElement.innerHTML = '<div class="alert warning">V√¶lg mindst √©n respondent type</div><canvas id="compassChart" style="max-height:500px"></canvas>';
    return;
  }

  // Kvadrant-baggrund som i Admin (Resultater)
  const quadrantBackgroundPlugin = {
    id: 'quadrantBackground',
    beforeDatasetsDraw: (chart) => {
      const { ctx, scales: { r } } = chart;
      const cx = r.xCenter, cy = r.yCenter, radius = r.drawingArea;
      const draw = (a,b,col) => { ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,radius,a,b); ctx.closePath(); ctx.fillStyle = col; ctx.fill(); };
      const rad = (deg) => (deg - 90) * Math.PI / 180;
      draw(rad(0),   rad(90),  'rgba(34,139,34,0.08)');   // Fornyelse
      draw(rad(90),  rad(180), 'rgba(220,20,60,0.08)');   // Resultater
      draw(rad(180), rad(270), 'rgba(128,128,128,0.08)'); // Stabilitet
      draw(rad(270), rad(360), 'rgba(100,149,237,0.08)'); // Relationer
    }
  };

  compassChart = new Chart(ctx, {
    type: 'radar',
    data: { labels: categories, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      elements: { line: { tension: 0.2 }, point: { radius: 3, hitRadius: 6 } },
      scales: {
        r: {
          beginAtZero: true, min: 0, max: 5,
          grid: { circular: true },
          angleLines: { color: 'rgba(0,0,0,0.08)' },
          ticks: { stepSize: 1, display: false },
          pointLabels: { font: { size: 12, weight: 'bold' } }
        }
      },
      plugins: {
        legend: { position: 'bottom', align: 'center' },
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.dataset.label}: ${Number(ctx.parsed.r ?? 0).toFixed(2)}`
          }
        }
      }
    },
    plugins: [quadrantBackgroundPlugin]
  });
}

async function downloadCompassPDF() {
  if (!compassChart) {
    alert('Ingen graf at downloade');
    return;
  }
  
  try {
    const assessment = assessments.find(a => a.id === currentCompassAssessment);
    
    // Opret PDF container
    const container = document.createElement('div');
    container.style.width = '800px';
    container.style.padding = '40px';
    container.style.background = '#fff';
    container.innerHTML = `
      <h1 style="color:#667eea;margin-bottom:10px">üß≠ KOMPAS - Kompetenceprofil</h1>
      <h2 style="color:#666;margin-bottom:30px">${assessment.project_label} (${assessment.variant})</h2>
      <p style="margin-bottom:20px;color:#555">Medarbejdernummer: ${userMA}</p>
      <div id="chartForPdf" style="width:700px;height:500px;margin:20px auto"></div>
      <div style="margin-top:30px;padding:20px;background:#f8fafc;border-radius:10px">
        <h3 style="margin-bottom:15px;color:#667eea">üìä Kategorier og scores</h3>
        <div id="scoresTable"></div>
      </div>
      <div style="margin-top:30px;padding:15px;background:#e6fffa;border-radius:10px;font-size:0.9em;color:#234e52">
        <strong>Note:</strong> Dette er et √∏jebliksbillede af dine kompetencer baseret p√• feedback fra dig selv, kolleger og leder.
      </div>
    `;
    
    // Tilf√∏j scores tabel
    const categories = [...new Set(currentCompassScores.map(s => s.category_name))];
    let tableHtml = '<table style="width:100%;border-collapse:collapse;font-size:0.95em">';
    tableHtml += '<thead><tr style="background:#667eea;color:#fff"><th style="padding:10px;text-align:left">Kategori</th>';
    tableHtml += '<th style="padding:10px;text-align:center">Selv</th>';
    tableHtml += '<th style="padding:10px;text-align:center">Kolleger</th>';
    tableHtml += '<th style="padding:10px;text-align:center">Leder</th></tr></thead><tbody>';
    
    categories.forEach((cat, idx) => {
      const selfScore = currentCompassScores.find(s => s.category_name === cat && s.respondent_type === 'self');
      const peerScore = currentCompassScores.find(s => s.category_name === cat && s.respondent_type === 'peer');
      const leaderScore = currentCompassScores.find(s => s.category_name === cat && s.respondent_type === 'leader');
      
      tableHtml += `<tr style="border-bottom:1px solid #e2e8f0;background:${idx % 2 === 0 ? '#fff' : '#f8fafc'}">`;
      tableHtml += `<td style="padding:10px">${cat}</td>`;
      tableHtml += `<td style="padding:10px;text-align:center;font-weight:600">${selfScore ? parseFloat(selfScore.score_numeric).toFixed(2) : '-'}</td>`;
      tableHtml += `<td style="padding:10px;text-align:center;font-weight:600">${peerScore ? parseFloat(peerScore.score_numeric).toFixed(2) : '-'}</td>`;
      tableHtml += `<td style="padding:10px;text-align:center;font-weight:600">${leaderScore ? parseFloat(leaderScore.score_numeric).toFixed(2) : '-'}</td>`;
      tableHtml += '</tr>';
    });
    
    tableHtml += '</tbody></table>';
    container.querySelector('#scoresTable').innerHTML = tableHtml;
    
    document.body.appendChild(container);
    
    // Render chart til PDF container
    const pdfCanvas = document.createElement('canvas');
    pdfCanvas.width = 700;
    pdfCanvas.height = 500;
    document.getElementById('chartForPdf').appendChild(pdfCanvas);
    
    const pdfChart = new Chart(pdfCanvas, {
      type: 'radar',
      data: compassChart.data,
      options: compassChart.options
    });
    
    // Vent p√• chart render
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // Generer PDF
    const canvas = await html2canvas(container, {
      scale: 2,
      backgroundColor: '#ffffff'
    });
    
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    const imgWidth = 210;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    
    pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
    pdf.save(`Kompas_${userMA}_${assessment.project_label}.pdf`);
    
    // Cleanup
    pdfChart.destroy();
    document.body.removeChild(container);
    
  } catch (error) {
    console.error('PDF generation error:', error);
    alert('Kunne ikke generere PDF');
  }
}

function exportCompassData() {
  if (currentCompassScores.length === 0) {
    alert('Ingen data at eksportere');
    return;
  }
  
  const assessment = assessments.find(a => a.id === currentCompassAssessment);
  
  // CSV format
  let csv = 'Kategori,Selv,Kolleger,Leder\n';
  
  const categories = [...new Set(currentCompassScores.map(s => s.category_name))];
  categories.forEach(cat => {
    const selfScore = currentCompassScores.find(s => s.category_name === cat && s.respondent_type === 'self');
    const peerScore = currentCompassScores.find(s => s.category_name === cat && s.respondent_type === 'peer');
    const leaderScore = currentCompassScores.find(s => s.category_name === cat && s.respondent_type === 'leader');
    
    csv += `"${cat}",`;
    csv += `${selfScore ? parseFloat(selfScore.score_numeric).toFixed(2) : ''},`;
    csv += `${peerScore ? parseFloat(peerScore.score_numeric).toFixed(2) : ''},`;
    csv += `${leaderScore ? parseFloat(leaderScore.score_numeric).toFixed(2) : ''}\n`;
  });
  
  // Download
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Kompas_Data_${userMA}_${assessment.project_label}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ============================================================================
// FILE UPLOAD (SELF-IMPORT)
// ============================================================================
function setupUploadZone() {
  const zone = document.getElementById('udvFileInput');
  const uploadZone = document.querySelector('.upload-zone');
  
  if (!zone || !uploadZone) return;

  // Klik p√• zonen √•bner filv√¶lgeren (manglede)
  uploadZone.addEventListener('click', () => zone.click());

  // File input change
  zone.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) handleUDVUpload(file);
  });
  
  // Drag and drop
  uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragging');
  });
  
  uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragging');
  });
  
  uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragging');
    
    const file = e.dataTransfer.files[0];
    if (file) {
      zone.files = e.dataTransfer.files;
      handleUDVUpload(file);
    }
  });
}

// ============================================================================
// FILES LIST
// ============================================================================
function renderFilesList() {
  const list = document.getElementById('filesList');
  if (!list) return; // <- robust mod manglende container
  
  if (assessments.length === 0) {
    list.innerHTML = `
      <li class="empty-state">
        <div class="empty-icon">üìÅ</div>
        <div class="empty-title">Ingen filer endnu</div>
      </li>
    `;
    return;
  }
  
  list.innerHTML = assessments.map(a => `
    <li class="file-item">
      <div class="file-info">
        <div class="file-name">udviklingskontrakt_${(a.project_label || '').replace(/\s+/g,'_')}_${(userMA || '').toString().trim()}.udv</div>
        <div class="file-meta">Udgivet ${new Date(a.published_at).toLocaleDateString('da-DK')}</div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn small" onclick="viewContract('${a.id}')">√Öbn i Kontrakt</button>
        <button class="btn small" onclick="downloadUDV('${a.id}')">Download</button>
        <button class="btn small error" onclick="deleteAssessment('${a.id}')">Slet</button>
      </div>
    </li>
  `).join('');
}

// ============================================================================
// DOWNLOAD FUNKTIONER
// ============================================================================
async function downloadUDV(assessmentId) {
  try {
    const assessment = assessments.find(a => a.id === assessmentId);
    if (!assessment) return;

    // 1:1 ‚ÄúGem‚Äù-format (ingen omskrivning) + korrekt MIME + MA i filnavn
    const udvData = assessment.udv_json;
    const safe = (s) => String(s || '').replace(/\s+/g, '_').replace(/[^A-Za-z0-9_\-\.]/g, '');
    const filename = `udviklingskontrakt_${safe(assessment.project_label)}_${safe(userMA)}.udv`;

    const blob = new Blob(
      [JSON.stringify(udvData, null, 2)],
      { type: 'application/kompas-udv+json' }
    );

    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

  } catch (error) {
    console.error('Download fejl:', error);
    alert('Kunne ikke downloade fil');
  }
}

async function downloadCompassPDF() {
  alert('PDF download funktionalitet implementeres');
  // TODO: Generer PDF med jsPDF + html2canvas (samme som admin.html)
}

async function downloadContract(assessmentId) {
  alert('Kontrakt PDF download implementeres');
  // TODO: Generer kontrakt PDF
}

// ============================================================================
// KONTO ADMINISTRATION
// ============================================================================
function showConsentModal() {
  document.getElementById('consentModal').classList.add('active');
}

function closeConsentModal() {
  document.getElementById('consentModal').classList.remove('active');
}

async function acceptConsent() {
  try {
    const { error } = await supabase
      .from('individual_users')
      .update({ consent_at: new Date().toISOString() })
      .eq('ma', userMA);
    
    if (error) throw error;
    
    document.getElementById('consentStatus').innerHTML = `<div class="alert success">‚úì Accepteret lige nu</div>`;
    closeConsentModal();
    
  } catch (error) {
    console.error('Fejl ved opdatering af samtykke:', error);
    alert('Kunne ikke gemme samtykke');
  }
}

function initiateAccountDeletion() {
  document.getElementById('deleteModal').classList.add('active');
}

function closeDeleteModal() {
  document.getElementById('deleteModal').classList.remove('active');
}

async function downloadDataBeforeDelete() {
  try {
    // Hent alle data
    const response = await fetch(`${API_BASE_URL}/api/minudvikling/export-zip/${userMA}`);
    const result = await response.json();
    
    if (result.files && result.files.length > 0) {
      // Opret ZIP
      const zip = new JSZip();
      
      for (const file of result.files) {
        if (file.type === 'udv') {
          zip.file(file.filename, JSON.stringify(file.content, null, 2));
        }
      }
      
      const blob = await zip.generateAsync({ type: 'blob' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `MinUdvikling_${userMA}_Export.zip`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      alert('Dine data er downloadet. Du kan nu forts√¶tte med sletningen hvis du √∏nsker det.');
    } else {
      alert('Ingen data at downloade');
    }
    
  } catch (error) {
    console.error('Download fejl:', error);
    alert('Kunne ikke downloade data');
  }
}

async function confirmAccountDeletion() {
  const confirm = prompt('Skriv "SLET" for at bekr√¶fte (stort bogstaver):');
  
  if (confirm !== 'SLET') {
    alert('Sletning annulleret');
    return;
  }
  
  try {
    const response = await fetch(`${API_BASE_URL}/api/minudvikling/delete-account/${userMA}`, {
      method: 'DELETE'
    });
    
    const result = await response.json();
    
    if (result.status === 'deleted') {
      // Log bruger ud af Supabase
      await supabase.auth.signOut();
      
      alert('Din konto er blevet slettet. Du vil nu blive logget ud.');
      window.location.href = 'login.html';
    } else {
      throw new Error(result.message || 'Sletning fejlede');
    }
    
  } catch (error) {
    console.error('Sletning fejl:', error);
    alert('Kunne ikke slette konto: ' + error.message);
  }
}

async function handleLogout() {
  await supabase.auth.signOut();
  window.location.href = 'login.html';
}

// ============================================================================
// UDVIKLINGSKONTRAKT
// ============================================================================
// SIKKER ESCAPE til alt der inds√¶ttes i template-strings/innerHTML
function esc(value) {
  return String(value ?? '')
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/<\/script/gi, '<\\/script')  // forhindrer at inline <script> lukkes
    .replace(/<\/style/gi, '<\\/style');
}

function initializeContractTab() {
  // Populate assessment dropdown
  const select = document.getElementById('contractAssessmentSelect');
  
  const assessmentsWithContract = assessments.filter(a => a.development_contract);
  
  if (assessmentsWithContract.length === 0) {
    document.getElementById('contractEmptyState').style.display = 'block';
    document.getElementById('contractContent').innerHTML = '';
    document.getElementById('contractActions').style.display = 'none';
    return;
  }
  
  document.getElementById('contractEmptyState').style.display = 'none';
  
  select.innerHTML = '<option value="">-- V√¶lg en assessment --</option>' +
    assessmentsWithContract.map(a => `<option value="${a.id}">${a.project_label} (${a.variant})</option>`).join('');
  
  // Auto-select f√∏rste
  if (assessmentsWithContract.length > 0) {
    select.value = assessmentsWithContract[0].id;
    loadContractForAssessment();
  }
}

function loadContractForAssessment() {
  const select = document.getElementById('contractAssessmentSelect');
  const assessmentId = select.value;

  if (!assessmentId) {
    document.getElementById('contractContent').innerHTML = '';
    document.getElementById('contractActions').style.display = 'none';
    return;
  }

  currentContractAssessment = assessmentId;
  const assessment = assessments.find(a => a.id === assessmentId);

  if (!assessment || !assessment.development_contract) {
    document.getElementById('contractContent').innerHTML = '<div class="alert warning">Ingen udviklingskontrakt for denne assessment</div>';
    document.getElementById('contractActions').style.display = 'none';
    return;
  }

  const c = assessment.development_contract || {};
  const escOrDash = v => (v === null || v === undefined || v === '' ? '‚Äî' : esc(v));

  let html = `
    <div id="contractPrintable" style="background:#fff;padding:30px;border-radius:12px;border:1px solid var(--line)">
      <div style="text-align:center;margin-bottom:30px;padding-bottom:20px;border-bottom:2px solid var(--brand)">
        <h2 style="color:var(--brand);margin-bottom:10px">üìã UDVIKLINGSKONTRAKT</h2>
        <div style="font-size:1.1em;color:#666">${escOrDash(assessment.project_label)}</div>
        <div style="margin-top:10px;color:#888">Medarbejdernummer: ${escOrDash(userMA)}</div>
        <div style="margin-top:5px;color:#888">Udgivet: ${escOrDash(new Date(assessment.published_at).toLocaleDateString('da-DK'))}</div>
      </div>
  `;

  // === 1) Admin-format (kompetencer/tips/plan/fritekster/flags) ===
  const looksLikeAdmin =
    (Array.isArray(c.competencies) && c.competencies.length) ||
    (Array.isArray(c.tips) && c.tips.length) ||
    (Array.isArray(c.plan) && c.plan.length) ||
    c.employee_actions || c.leader_actions || c.employee_wishes || c.followup_date ||
    c.include_team_roles || c.include_colleague_support || c.include_306090_goals;

  if (looksLikeAdmin) {
    // HERO med titel + kompas-hjul (read-only)
    html += `
      <div style="background:linear-gradient(135deg,var(--brand) 0%,#ff6b7a 100%);color:white;padding:20px;border-radius:12px;margin:0 0 20px 0;text-align:center">
        <h2 style="margin:0 0 6px 0">üìã Udviklingskontrakt</h2>
        ${c.title ? `<p style="margin:0;opacity:0.9">${esc(c.title)}</p>` : ''}
      </div>
      <div style="display:grid;grid-template-columns:1fr;gap:16px;align-items:stretch;margin-bottom:20px">
        <div style="background:transparent;border:none;border-radius:0;padding:0">
          <h3 style="margin:0 0 10px 0;display:flex;align-items:center;gap:8px;color:var(--ink)"><span>üß≠</span> Kompas</h3>
          <div id="contractRadarSection" class="section" style="background:transparent;margin:0">
            <canvas id="contractRadar" height="420" style="max-height:600px;width:100%"></canvas>
          </div>
        </div>
      </div>
    `;

    // Kompetencer som chips (robust) + Tips (Fastholde/Udvikle) grupperet pr. kompetence ‚Äì READ-ONLY
{
  // === Opslagstabeller ===
  const catById = new Map(
    Array.isArray(c?.compass_snapshot?.categories)
      ? c.compass_snapshot.categories.map(x => [String(x.id), x.name])
      : []
  );

  // Map af tipId -> {title, desc, category}
  const tipLookup = (() => {
    const out = new Map();
    const add = (arr) => {
      (Array.isArray(arr) ? arr : []).forEach(t => {
        if (!t || !t.id) return;
        out.set(String(t.id), {
          title: t.title || t.text || 'Tip',
          desc:  t.description || t.desc || t.text || '',
          category: t.category || ''
        });
      });
    };
    const p = c?.plan || {};
    add(p.plan30); add(p.plan60); add(p.plan90);

    // ‚ûï Nye: Tilf√∏j ‚Äúplaceholder‚Äù-poster for alle id‚Äôer i c.tips/c.keep_tips,
    // s√• de altid bliver vist ‚Äì ogs√• f√∏r vi henter metadata
    const addIds = (obj) => {
      if (!obj || typeof obj !== 'object') return;
      Object.values(obj).flat().forEach(id => {
        const k = String(id);
        if (!out.has(k)) out.set(k, { title: `Tip ${k}`, desc: '', category: '' });
      });
    };
    addIds(c?.tips);
    addIds(c?.keep_tips);

    // ‚ûï Nye: Asynkron hydrering ‚Äì hent manglende metadata via Supabase og opdater DOM
    (async () => {
      try {
        const missing = [];
        const seen = new Set();
        const pushIds = (obj) => {
          if (!obj || typeof obj !== 'object') return;
          Object.values(obj).flat().forEach(id => {
            const k = String(id);
            if (!seen.has(k)) { seen.add(k); if (!(p.plan30||[]).some(t=>String(t?.id)===k) &&
                                               !(p.plan60||[]).some(t=>String(t?.id)===k) &&
                                               !(p.plan90||[]).some(t=>String(t?.id)===k)) {
              missing.push(k);
            }}
          });
        };
        pushIds(c?.tips);
        pushIds(c?.keep_tips);
        if (missing.length === 0) return;

        const { data, error } = await supabase
          .from('coaching_tip')
          .select('id,title,description,category_id')
          .in('id', missing);
        if (error) return;

        // Kategorinavne fra kompas-snapshot
        const catById = new Map(
          Array.isArray(c?.compass_snapshot?.categories)
            ? c.compass_snapshot.categories.map(x => [String(x.id), x.name])
            : []
        );

        (data||[]).forEach(r => {
          out.set(String(r.id), {
            title: r.title || `Tip ${r.id}`,
            desc:  r.description || '',
            category: catById.get(String(r.category_id)) || ''
          });
        });

        // Hydr√©r DOM‚Äôen for allerede renderede tip-linjer
        document.querySelectorAll('[data-tip-id]').forEach(li=>{
          const id = li.getAttribute('data-tip-id');
          if (!id || !out.has(id)) return;
          const t = out.get(id);
          const titleEl = li.querySelector('[data-tip-title]');
          const descEl  = li.querySelector('[data-tip-desc]');
          if (titleEl) titleEl.textContent = t.title;
          if (descEl)  descEl.innerHTML = t.desc ? `<div style="font-style:italic;color:#475569">${esc(t.desc)}</div>` : '';
        });
      } catch {}
    })();

    return out;
  })();

  // Hj√¶lpere
  const compLabel = (k) => {
    if (!k) return '‚Äî';
    const id = typeof k === 'object' ? (k.id || k.category_id) : k;
    return catById.get(String(id)) || k.name || k.title || k.label || String(id);
  };

  const renderGrouped = (mapObj, headingHtml) => {
    if (!mapObj || typeof mapObj !== 'object') return '';
    // mapObj: { [competenceId]: [tipIds...] }
    const blocks = Object.entries(mapObj).map(([cid, tipIds]) => {
      const compName = compLabel({ id: cid });
      const lis = (Array.isArray(tipIds) ? tipIds : []).map(tid => {
      const tip = tipLookup.get(String(tid)) || {};
      const title = esc(tip.title || `Tip ${tid}`);
      const desc  = tip.desc ? `<div style="font-style:italic;color:#475569" data-tip-desc>${esc(tip.desc)}</div>` : '<div data-tip-desc></div>';
      return `<li style="margin:6px 0" data-tip-id="${esc(String(tid))}">
                <div style="font-weight:600" data-tip-title>${title}</div>${desc}
              </li>`;
    }).join('');
      return `
        <div style="border:1px solid #e2e8f0;border-radius:10px;padding:12px;background:#fff">
          <div style="font-weight:700">${esc(compName)}</div>
          <ul style="margin:8px 0 0 16px;padding:0;list-style:disc">${lis}</ul>
        </div>
      `;
    }).join('');

    if (!blocks) return '';
    return `
      <div style="margin-bottom:18px">
        <h3 style="color:var(--brand);margin-bottom:10px;display:flex;align-items:center;gap:8px">${headingHtml}</h3>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px">${blocks}</div>
      </div>
    `;
  };

  // === Kompetencer chips (fjernet ‚Äì kompetencer fremg√•r allerede under Udvikle/Fastholde) ===
  // (intenderet tomt)
  // === Tips: Fastholde (keep_tips) + Udvikle (tips) ===
  const keep = c.keep_tips || null;   // { [compId]: [tipId...] }
  const dev  = c.tips || null;        // { [compId]: [tipId...] }

  const keepHtml = renderGrouped(keep, `<span>‚úÖ</span> Fastholde`);
  const devHtml  = renderGrouped(dev,  `<span>üìà</span> Udvikle`);

  html += keepHtml + devHtml;
}

    // Teamroller ‚Äì flyttet under Plan (se udvidet Plan-blok nedenfor)

    // Plan (30-60-90 eller generel) ‚Äî robust mod legacy/formater + Teamroller under Plan
    {
      // Normaliser alle kendte formater til tre buckets
      const norm = (() => {
        const out = { d30: [], d60: [], d90: [] };
        const p = c?.plan;

        // Case 1: objekt med plan30/plan60/plan90
        if (p && typeof p === 'object' && !Array.isArray(p)) {
          if (Array.isArray(p.plan30)) out.d30 = p.plan30;
          if (Array.isArray(p.plan60)) out.d60 = p.plan60;
          if (Array.isArray(p.plan90)) out.d90 = p.plan90;
        }

        // Case 2: liste af punkter med bucket/when der indeholder 30/60/90
        if (Array.isArray(p)) {
          p.forEach(item => {
            const tag = String(item.bucket || item.when || '').toLowerCase();
            if (tag.includes('30')) out.d30.push(item);
            else if (tag.includes('60')) out.d60.push(item);
            else if (tag.includes('90')) out.d90.push(item);
          });
        }

        // Case 3: flade n√∏gler '30' / '60' / '90'
        if (p && typeof p === 'object' && !Array.isArray(p)) {
          if (!out.d30.length && Array.isArray(p['30'])) out.d30 = p['30'];
          if (!out.d60.length && Array.isArray(p['60'])) out.d60 = p['60'];
          if (!out.d90.length && Array.isArray(p['90'])) out.d90 = p['90'];
        }

        return out;
      })();

      const hasBuckets = [norm.d30, norm.d60, norm.d90].some(lst => Array.isArray(lst) && lst.length > 0);
      const hasFlatList = Array.isArray(c.plan) && c.plan.length > 0;

      // Vis hvis flag ikke er sl√•et fra, eller hvis der faktisk er data i nogen form
      if ((c.include_306090_goals !== false) || hasBuckets || hasFlatList) {
        html += `
          <div style="margin-bottom:18px">
            <h3 style="color:var(--brand);margin-bottom:10px;display:flex;align-items:center;gap:8px"><span>üóìÔ∏è</span> Plan</h3>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px">
              ${hasBuckets ? ([
                { label: 'De f√∏rste 30 dage ‚Äì l√¶ring og relationer', list: norm.d30 },
                { label: 'Dag 31‚Äì60 ‚Äì praksis og feedback',          list: norm.d60 },
                { label: 'Dag 61‚Äì90 ‚Äì konsolidering og n√¶ste m√•l',   list: norm.d90 },
              ].map(col => `
                <div class="card" style="border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff">
                  <div style="font-weight:700;margin-bottom:6px">${col.label}</div>
                  ${col.list.length ? col.list.map(item => `
                    <div style="margin:6px 0;padding:8px 10px;border:1px solid #e2e8f0;border-radius:6px;background:#fff">
                      ${item.bucket || item.when ? `<div style="font-size:11px;color:#667eea;margin-bottom:2px">${esc(String(item.bucket || item.when))}</div>` : ''}
                      <div style="font-weight:600">${esc(item.title || item.task || item.text || 'Aktivitet')}</div>
                      ${item.description || item.desc ? `<div style="font-style:italic;color:#475569">${esc(item.description || item.desc)}</div>` : ''}
                    </div>
                  `).join('') : `<div style="color:#94a3b8;font-style:italic">Ingen m√•l</div>`}
                </div>
              `).join('')) : (
                Array.isArray(c.plan) ? c.plan.map((p, i) => `
                  <div class="card" style="border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff">
                    <div style="display:flex;justify-content:space-between;gap:12px;align-items:start">
                      <div style="font-weight:700">${i+1}. ${esc(p.title || p.task || 'Punkt')}</div>
                      <div style="color:#64748b">${esc(p.when || p.due || p.bucket || '')}</div>
                    </div>
                    ${p.description ? `<div style="color:#475569;margin-top:6px;line-height:1.6">${esc(p.description)}</div>` : ''}
                  </div>
                `).join('') : '<div style="color:#666">Planen er aktiveret (30-60-90), men uden specifikke punkter.</div>'
              )}
            </div>
          </div>
        `;
      }

      // === Teamroller under Plan (max 4) ===
      // Kilder: contract.roles | contract.team_roles | udv_json.contract.roles | udv_json.team_roles
      const rolesRaw = (() => {
        if (Array.isArray(c?.roles) && c.roles.length) return c.roles;
        if (Array.isArray(c?.team_roles) && c.team_roles.length) return c.team_roles;
        const udvObj = (typeof assessment?.udv_json === 'string'
          ? (()=>{ try { return JSON.parse(assessment.udv_json); } catch { return null; } })()
          : (assessment?.udv_json || null));
        if (udvObj && udvObj.contract && Array.isArray(udvObj.contract.roles) && udvObj.contract.roles.length) return udvObj.contract.roles;
        if (udvObj && Array.isArray(udvObj.team_roles) && udvObj.team_roles.length) return udvObj.team_roles;
        return [];
      })();

      const roles = rolesRaw.slice(0, 4);

      if ((c.include_team_roles !== false) && roles.length > 0) {
        html += `
          <div style="margin-bottom:18px">
            <h3 style="color:var(--brand);margin-bottom:10px;display:flex;align-items:center;gap:8px"><span>üë•</span> Teamroller</h3>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px">
              ${roles.map(r => `
                <div style="border:1px solid var(--line);border-radius:10px;background:#fff;padding:10px">
                  <div style="font-weight:700;margin-bottom:4px">${esc(r.name || r.title || r.role || 'Rolle')}</div>
                  ${r.description || r.desc ? `<div style="font-size:.9rem;color:#64748b">${esc(r.description || r.desc)}</div>` : ''}
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
    }

    // Kollegast√∏tte
    if (c.include_colleague_support) {
      const txt = c.colleague_support_text && String(c.colleague_support_text).trim();
      html += `
        <div style="margin-bottom:18px">
          <h3 style="color:var(--brand);margin-bottom:10px;display:flex;align-items:center;gap:8px"><span>ü§ù</span> Kollegast√∏tte</h3>
          ${txt
            ? `<div style="white-space:pre-wrap;color:#334155">${esc ? esc(txt) : txt}</div>`
            : `<div style="color:#475569">Kollegast√∏tte er markeret som en del af planen.</div>`}
        </div>
      `;
    }

    // Fritekster (read-only)
    if (c.employee_actions || c.employee_wishes || c.leader_actions) {
      html += `<div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;margin-bottom:18px">`;
      if (c.employee_actions) {
        html += `
          <div class="card" style="border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff">
            <div style="font-weight:700;margin-bottom:6px">Medarbejder ‚Äì handlinger</div>
            <div style="white-space:pre-wrap;line-height:1.6;color:#334155">${esc(c.employee_actions)}</div>
          </div>`;
      }
      if (c.employee_wishes) {
        html += `
          <div class="card" style="border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff">
            <div style="font-weight:700;margin-bottom:6px">Medarbejder ‚Äì √∏nsker</div>
            <div style="white-space:pre-wrap;line-height:1.6;color:#334155">${esc(c.employee_wishes)}</div>
          </div>`;
      }
      if (c.leader_actions) {
        html += `
          <div class="card" style="border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff">
            <div style="font-weight:700;margin-bottom:6px">Leder ‚Äì handlinger</div>
            <div style="white-space:pre-wrap;line-height:1.6;color:#334155">${esc(c.leader_actions)}</div>
          </div>`;
      }
      html += `</div>`;
    }

    // Noter
    if (c.notes) {
      html += `
        <div style="background:#fffbeb;border-left:4px solid #f59e0b;padding:20px;border-radius:12px;margin-bottom:18px">
          <h4 style="color:#92400e;margin-bottom:8px">üìù Noter</h4>
          <div style="color:#78350f;line-height:1.6;white-space:pre-wrap">${esc(c.notes)}</div>
        </div>
      `;
    }

    // Ukendte felter -> debug
    const known = new Set(['title','competencies','tips','roles','plan','employee_actions','employee_wishes','leader_actions','include_team_roles','include_colleague_support','include_306090_goals','followup_date','notes']);
    const rest = Object.keys(c).filter(k => !known.has(k));
    if (rest.length) {
      html += `
        <div class="card" style="border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff">
          <div style="font-weight:700;margin-bottom:6px">Andre felter</div>
          <pre style="white-space:pre-wrap;overflow:auto;margin:0;color:#334155">${esc(JSON.stringify(Object.fromEntries(rest.map(k => [k, c[k]])), null, 2))}</pre>
        </div>
      `;
    }
  } else {
    // === Legacy-format (u√¶ndret logik, men samme p√¶ne kort) ===
    if (Array.isArray(c.goals) && c.goals.length > 0) {
      html += '<div style="margin-bottom:20px">';
      html += '<h3 style="color:var(--brand);margin-bottom:10px;display:flex;align-items:center;gap:8px"><span>üéØ</span> Udviklingsm√•l</h3>';
      c.goals.forEach((goal, idx) => {
        const statusColor = goal.status === 'completed' ? 'var(--success)' : goal.status === 'in_progress' ? 'var(--info)' : 'var(--muted)';
        const statusLabel = goal.status === 'completed' ? '‚úì Afsluttet' : goal.status === 'in_progress' ? '‚ü≥ I gang' : '‚óã Ikke startet';
        html += `
          <div class="card" style="border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff;margin-bottom:10px">
            <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:8px">
              <div style="font-weight:700">${idx + 1}. ${esc(goal.title || 'M√•l')}</div>
              <div style="color:${statusColor};font-size:0.85em;font-weight:600;padding:4px 8px;background:var(--surface);border-radius:8px">${statusLabel}</div>
            </div>
            <div style="color:#475569;margin-bottom:8px;line-height:1.6">${esc(goal.description || '')}</div>
            ${goal.focus_areas && goal.focus_areas.length ? `<div style="display:flex;flex-wrap:wrap;gap:6px">${goal.focus_areas.map(a => `<span style="background:var(--surface);padding:4px 8px;border-radius:6px;font-size:0.85em">${esc(a)}</span>`).join('')}</div>` : ''}
            ${goal.actions && goal.actions.length ? `<div style="margin-top:6px"><div style="font-weight:600;margin-bottom:6px">Handlinger</div><ul style="padding-left:18px;color:#334155;line-height:1.8">${goal.actions.map(a => `<li>${esc(a)}</li>`).join('')}</ul></div>` : ''}
          </div>`;
      });
      html += '</div>';
    }
    
    // üìÖ 30/60/90 ‚Äî l√¶s-kun i profile (robust mod legacy/formater)
    {
      // Normaliser alle kendte formater til tre buckets
      const norm = (() => {
        const out = { d30: [], d60: [], d90: [] };
        const p = c?.plan;

        // Case 1: objekt med plan30/plan60/plan90
        if (p && typeof p === 'object' && !Array.isArray(p)) {
          if (Array.isArray(p.plan30)) out.d30 = p.plan30;
          if (Array.isArray(p.plan60)) out.d60 = p.plan60;
          if (Array.isArray(p.plan90)) out.d90 = p.plan90;
        }

        // Case 2: liste af punkter med bucket/when der indeholder 30/60/90
        if (Array.isArray(p)) {
          p.forEach(item => {
            const tag = String(item.bucket || item.when || '').toLowerCase();
            if (tag.includes('30')) out.d30.push(item);
            else if (tag.includes('60')) out.d60.push(item);
            else if (tag.includes('90')) out.d90.push(item);
          });
        }

        // Case 3: flade n√∏gler '30' / '60' / '90'
        if (p && typeof p === 'object' && !Array.isArray(p)) {
          if (!out.d30.length && Array.isArray(p['30'])) out.d30 = p['30'];
          if (!out.d60.length && Array.isArray(p['60'])) out.d60 = p['60'];
          if (!out.d90.length && Array.isArray(p['90'])) out.d90 = p['90'];
        }

        return out;
      })();

      const cols = [
        { label: 'De f√∏rste 30 dage ‚Äì l√¶ring og relationer', list: norm.d30 },
        { label: 'Dag 31‚Äì60 ‚Äì praksis og feedback',          list: norm.d60 },
        { label: 'Dag 61‚Äì90 ‚Äì konsolidering og n√¶ste m√•l',   list: norm.d90 },
      ];

      // Kun skjul, hvis du eksplicit har fravalgt 30/60/90
      const showFlag = (c.include_306090_goals !== false);
      const hasAny = cols.some(col => Array.isArray(col.list) && col.list.length > 0);

      if (showFlag && hasAny) {
        const planColsHtml = cols.map(col => {
          const chips = col.list.map(item => {
            const id   = item && item.id ? String(item.id) : null;
            const meta = id && tipLookup instanceof Map ? tipLookup.get(id) : null;

            const title = esc((meta && meta.title) || item.title || item.text || 'Aktivitet');
            const desc  = (meta && meta.desc)   || item.description || item.desc || '';
            const cat   = (meta && meta.category) || item.category || (String(item.bucket || item.when || '').trim());

            return `
              <div style="margin:6px 0;padding:8px 10px;border:1px solid #e2e8f0;border-radius:6px;background:#fff">
                ${cat ? `<div style="font-size:11px;color:#667eea;margin-bottom:2px">${esc(cat)}</div>` : ''}
                <div style="font-weight:600">${title}</div>
                ${desc ? `<div style="font-style:italic;color:#475569">${esc(desc)}</div>` : ''}
              </div>
            `;
          }).join('');

          return `
            <div style="border:1px solid #e2e8f0;border-radius:10px;padding:12px;background:#fff">
              <div style="font-weight:700;margin-bottom:6px">${esc(col.label)}</div>
              ${chips || `<div style="color:#94a3b8;font-style:italic">Ingen m√•l</div>`}
            </div>
          `;
        }).join('');

        html += `
          <div style="margin-bottom:20px">
            <h3 style="color:var(--brand);margin-bottom:10px;display:flex;align-items:center;gap:8px"><span>üìÖ</span> 30/60/90</h3>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px">${planColsHtml}</div>
          </div>
        `;
      }
    }

    if (Array.isArray(c.actions) && c.actions.length > 0) {
      html += `<div style="margin-bottom:20px"><h3 style="color:var(--brand);margin-bottom:10px;display:flex;align-items:center;gap:8px"><span>üõ†Ô∏è</span> Handlinger</h3><ul style="padding-left:18px;color:#334155;line-height:1.8">${c.actions.map(a => `<li>${esc(a)}</li>`).join('')}</ul></div>`;
    }

    if (Array.isArray(c.timeline) && c.timeline.length > 0) {
      html += `<div style="margin-bottom:20px"><h3 style="color:var(--brand);margin-bottom:10px;display:flex;align-items:center;gap:8px"><span>üóìÔ∏è</span> Tidslinje</h3>${c.timeline.map(item => `<div style="display:flex;gap:12px;margin-bottom:8px"><div style="min-width:110px;color:#64748b">${esc(item.date || '')}</div><div style="color:#334155">${esc(item.text || '')}</div></div>`).join('')}</div>`;
    }

    if (c.notes) {
      html += `<div style="background:#fffbeb;border-left:4px solid #f59e0b;padding:20px;border-radius:12px;margin-bottom:18px"><h4 style="color:#92400e;margin-bottom:8px">üìù Noter</h4><div style="color:#78350f;line-height:1.6">${esc(c.notes)}</div></div>`;
    }
  }

  html += '</div>';
  document.getElementById('contractContent').innerHTML = html;

  // Init "kompas-hjulet" i kontrakten ‚Äì brug pr√¶cis samme KOMPAS-logik som Admin (inkl. kvadrant-baggrund)
  try {
    const radarSection = document.getElementById('contractRadarSection');
    const canvas = document.getElementById('contractRadar');
    if (!canvas) {
      // Ingen canvas ‚Üí intet at g√∏re
    } else {
      // Fast akseorden (samme som Admin)
      const orderedCategories = [
        '',
        'Fleksibilitet','Nyt√¶nkning','Helhedsorientering','Fremtidsorientering',
        '',
        'H√•ndtering af pres','Beslutningstagning','Styring','Initiativ',
        '',
        'Analytisk t√¶nkning','Faglighed','Planl√¶gning','Ressourcebevidsthed',
        '',
        'Samarbejde','Udvikling af andre','Motivere andre','Kommunikation'
      ];

      // Byg data fra UDV (samme l√¶sning som i profilen, men mappet til Admins radar)
      const udv = (typeof assessment?.udv_json === 'string'
        ? (()=>{ try { return JSON.parse(assessment.udv_json); } catch { return null; } })()
        : (assessment?.udv_json || assessment?.udv || null));
      let built = [];

      if (udv && Array.isArray(udv.scores) && udv.scores.length) {
        let taxonomy = Array.isArray(udv.taxonomy)
          ? udv.taxonomy.map(t => ({ category_id: t.category_id, category_name: t.category_name }))
          : [];

        if (!taxonomy.length && Array.isArray(assessment?.categories)) {
          taxonomy = assessment.categories.map(c => ({ category_id: c.category_id, category_name: c.category_name }));
        }
        if (!taxonomy.length) {
          const ids = Array.from(new Set(udv.scores.map(s => s.category_id)));
          taxonomy = ids.map((id, i) => ({ category_id: id, category_name: `Kategori ${i+1}` }));
        }

        const people = Array.isArray(udv.people) ? udv.people : Array.isArray(udv.assessment?.people) ? udv.assessment.people : [];
        let targetId = null;
        const match = people.find(p => String(p.employee_no ?? p.ma ?? p.meta?.employee_no ?? '').trim() === String(userMA).trim());
        if (match) targetId = match.id;
        else if (people.length === 1) targetId = people[0].id;
        else targetId = people[0]?.id ?? null;

        ['self','peer','leader'].forEach(type => {
          taxonomy.forEach(cat => {
            const r = udv.scores.find(s =>
              (String(s.target_id) === String(targetId) || targetId == null) &&
              (s.category_id === cat.category_id || s.category === cat.category_id || s.category_name === cat.category_name) &&
              (s.respondent_type === type || s.type === type)
            );
            const v = r ? (Number.isFinite(r.value) ? r.value : (Number.isFinite(r.safe_avg) ? r.safe_avg : null)) : null;
            if (v != null) built.push({ category_name: cat.category_name, respondent_type: type, safe_avg: Number(v) });
          });
        });
      }

      // Fallback: kompakt snapshot (top-level ELLER under contract.compass_snapshot)
      if (!built.length) {
        const names = orderedCategories.filter(Boolean);
        const snap =
          (udv && udv.compass_snapshot) ||
          (udv && udv.contract && udv.contract.compass_snapshot) ||
          null;

        if (snap && snap.categories && snap.series) {
          const idx = new Map((snap.categories || []).map((c,i)=>[c.name, i]));
          const pull = (arr) => names.map(n => {
            const i = idx.get(n);
            return (i==null || !Array.isArray(arr) || arr[i]==null) ? null : Number(arr[i]);
          });

          const selfArr   = pull(snap.series.self);
          const peerArr   = pull(snap.series.peer || snap.series.blended); // nogle filer har "blended" i stedet for peer
          const leaderArr = pull(snap.series.leader);

          names.forEach((n, i) => {
            if (selfArr[i]   != null) built.push({ category_name:n, respondent_type:'self',   safe_avg:selfArr[i] });
            if (peerArr[i]   != null) built.push({ category_name:n, respondent_type:'peer',   safe_avg:peerArr[i] });
            if (leaderArr[i] != null) built.push({ category_name:n, respondent_type:'leader', safe_avg:leaderArr[i] });
          });
        }
      }

      // Map til Admins datas√¶t
      const self   = orderedCategories.map(c => c===''?null : built.find(r=>r.category_name===c && r.respondent_type==='self')?.safe_avg ?? null);
      const peer   = orderedCategories.map(c => c===''?null : built.find(r=>r.category_name===c && r.respondent_type==='peer')?.safe_avg ?? null);
      const leader = orderedCategories.map(c => c===''?null : built.find(r=>r.category_name===c && r.respondent_type==='leader')?.safe_avg ?? null);

      const hasAny = (arr) => Array.isArray(arr) && arr.some(v => v !== null);
      if (!(hasAny(self) || hasAny(peer) || hasAny(leader))) {
        if (radarSection) radarSection.innerHTML = '<div class="alert warning">Ingen kompasdata tilg√¶ngelig.</div>';
      } else {
        if (window._contractRadarChart) window._contractRadarChart.destroy();

        const quadrantBackgroundPlugin = {
          id: 'quadrantBackground',
          beforeDatasetsDraw: (chart) => {
            const {ctx, scales: {r}} = chart;
            const cx = r.xCenter, cy = r.yCenter, radius = r.drawingArea;
            const draw = (a,b,col)=>{ ctx.beginPath(); ctx.moveTo(cx,cy); ctx.arc(cx,cy,radius,a,b); ctx.closePath(); ctx.fillStyle=col; ctx.fill(); };
            const rad = (deg)=>(deg-90)*Math.PI/180;
            draw(rad(0),   rad(90),  'rgba(34,139,34,0.08)');
            draw(rad(90),  rad(180), 'rgba(220,20,60,0.08)');
            draw(rad(180), rad(270), 'rgba(128,128,128,0.08)');
            draw(rad(270), rad(360), 'rgba(100,149,237,0.08)');
          }
        };

        const ctx = canvas.getContext('2d');
        window._contractRadarChart = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: orderedCategories,
            datasets: [
              { label:'Selv',    data:self,   borderColor:'rgba(34, 197, 94, 1)',  backgroundColor:'rgba(34, 197, 94, 0.12)',  pointBackgroundColor:'rgba(34, 197, 94, 1)',  borderWidth:2, spanGaps:true },
              { label:'Kollega', data:peer,   borderColor:'rgba(59, 130, 246, 1)', backgroundColor:'rgba(59, 130, 246, 0.12)', pointBackgroundColor:'rgba(59, 130, 246, 1)', borderWidth:2, spanGaps:true },
              { label:'F√∏rer',   data:leader, borderColor:'rgba(249, 115, 22, 1)', backgroundColor:'rgba(249, 115, 22, 0.12)', pointBackgroundColor:'rgba(249, 115, 22, 1)', borderWidth:2, spanGaps:true }
            ]
          },
          options:{
            responsive:true,
            maintainAspectRatio:false,
            layout:{ padding:{ top:20, right:80, bottom:30, left:80 } },
            scales:{
              r:{
                beginAtZero:true,
                min:0,
                max:5,
                grid:{ circular:true },
                angleLines:{ color:'rgba(0,0,0,0.08)' },
                ticks:{ stepSize:1, display:false },
                pointLabels:{
                  display:(ctx)=>orderedCategories[ctx.index] !== '',
                  callback:(v)=>v||'',
                  padding:8,
                  font:{ size:12, weight:'bold' }
                }
              }
            },
            plugins:{ legend:{ position:'bottom', align:'center' } }
          },
          plugins:[quadrantBackgroundPlugin]
        });
      }
    }
  } catch (e) {
    console.warn('Kunne ikke tegne kontrakt-kompas:', e);
  }

  document.getElementById('contractActions').style.display = 'flex';
}

async function downloadContractPDF() {
  if (!currentContractAssessment) {
    alert('Ingen kontrakt valgt');
    return;
  }
  
  try {
    const container = document.getElementById('contractPrintable');
    
    if (!container) {
      alert('Kunne ikke finde kontrakt indhold');
      return;
    }
    
    const assessment = assessments.find(a => a.id === currentContractAssessment);
    
    // Generer PDF
    const canvas = await html2canvas(container, {
      scale: 2,
      backgroundColor: '#ffffff',
      logging: false
    });
    
    const imgData = canvas.toDataURL('image/png');
    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
    
    const imgWidth = 210;
    const imgHeight = (canvas.height * imgWidth) / canvas.width;
    
    let heightLeft = imgHeight;
    let position = 0;
    
    // F√∏rste side
    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
    heightLeft -= 297;
    
    // Flere sider hvis n√∏dvendigt
    while (heightLeft > 0) {
      position = heightLeft - imgHeight;
      pdf.addPage();
      pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= 297;
    }
    
    pdf.save(`Udviklingskontrakt_${userMA}_${assessment.project_label}.pdf`);
    
  } catch (error) {
    console.error('PDF generation error:', error);
    alert('Kunne ikke generere PDF');
  }
}

function printContract() {
  if (!currentContractAssessment) {
    alert('Ingen kontrakt valgt');
    return;
  }
  
  const container = document.getElementById('contractPrintable');
  
  if (!container) {
    alert('Kunne ikke finde kontrakt indhold');
    return;
  }

  try {
    // Klon indholdet for at undg√• at p√•virke den originale HTML
    const clonedContent = container.cloneNode(true);
    const safeHtml = clonedContent.innerHTML;
    
    // √Öbn print dialog
    const printWindow = window.open('', '', 'height=800,width=800');
    if (!printWindow) {
      alert('Kunne ikke √•bne print vindue. Tjek om pop-up er blokeret.');
      return;
    }
    
    printWindow.document.write('<!DOCTYPE html>');
    printWindow.document.write('<html><head>');
    printWindow.document.write('<meta charset="utf-8">');
    printWindow.document.write('<title>Udviklingskontrakt</title>');
    printWindow.document.write('<style>body{font-family:Arial,sans-serif;padding:20px;line-height:1.6;}</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(safeHtml);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    
    // Vent p√• at indholdet er loadet f√∏r print
    setTimeout(() => {
      printWindow.print();
    }, 250);
  } catch (error) {
    console.error('Print fejl:', error);
    alert('Kunne ikke udskrive kontrakt: ' + error.message);
  }
}
// ============================================================================
// VIEW FUNKTIONER
// ============================================================================
function viewContract(assessmentId) {
  switchTab('kontrakt');
  setTimeout(() => {
    const select = document.getElementById('contractAssessmentSelect');
    select.value = assessmentId;
    loadContractForAssessment();
  }, 100);
}

function viewCompass(assessmentId) {
  switchTab('kompas');
  const select = document.getElementById('compassAssessmentSelect');
  if (select) {
    select.value = assessmentId || (assessments[0] && assessments[0].id) || '';
    loadCompassForAssessment();
  }
}

// ============================================================================
// START APPLICATION
// ============================================================================
// Vent til DOM er klar f√∏r init
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

// Global error handler for at forhindre crash
window.addEventListener('error', function(e) {
  console.error('Global fejl fanget:', e.error);
});

window.addEventListener('unhandledrejection', function(e) {
  console.error('Unhandled promise rejection:', e.reason);
});
</script>

</body>
</html>
