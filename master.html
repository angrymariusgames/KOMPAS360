<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KOMPAS ‚Ä¢ Master Backoffice</title>
  <link rel="icon" href="data:," />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; connect-src 'self' https://*.supabase.co">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* ---------- Theme ---------- */
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg1:#667eea; --bg2:#764ba2; --ink:#2d3748; --muted:#718096;
      --card:#f8fafc; --line:#e2e8f0; --brand:#667eea; --radius:16px;
      --master-bg1:#e53e3e; --master-bg2:#d53f8c; /* R√∏de toner for master */
      --success:#48bb78; --error:#f56565;
    }
    body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,var(--master-bg1) 0%,var(--master-bg2) 100%);min-height:100vh;padding:20px;color:var(--ink)}
    .app{max-width:1400px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.15);overflow:hidden}

    /* Header */
    .header{background:linear-gradient(135deg,#2d3748 0%,#4a5568 100%);color:#fff;padding:20px 24px;display:grid;grid-template-columns:1fr auto;gap:16px;align-items:center;position:sticky;top:0;z-index:30}
    .club-title{display:flex;align-items:center;gap:14px}
    .club-logo{width:56px;height:56px;border-radius:14px;background:#fff;display:grid;place-items:center}
    .club-logo img{height:38px;object-fit:contain}
    .club-name{font-size:1.6rem;font-weight:800;margin-bottom:2px}
    .club-sub{opacity:.85;font-size:.92rem}
    .header-tools{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .input, .select{border:1px solid var(--line);background:#fff;color:#111;padding:10px 12px;border-radius:10px;font-size:.95rem}
    .btn{cursor:pointer;font-weight:700;border:1px solid var(--line);background:#fff;color:#111;padding:10px 14px;border-radius:10px;transition:.25s}
    .btn.primary{background:var(--master-bg1);border-color:var(--master-bg1);color:#fff}
    .btn.ghost{background:rgba(255,255,255,.1);color:#fff;border-color:rgba(255,255,255,.35)}
    .btn.small{padding:6px 10px;font-size:.85rem}

    /* Tabs */
    .tabbar{background:var(--card);border-bottom:1px solid var(--line);padding:0 20px;display:flex;gap:0;position:sticky;top:120px;z-index:20}
    .tabbtn{background:none;border:none;padding:16px 22px;font-size:1.05rem;font-weight:700;color:#64748b;cursor:pointer;border-bottom:3px solid transparent;transition:.25s;white-space:nowrap;position:relative}
    .tabbtn:hover{color:#334155;background:rgba(229,62,62,.06)}
    .tabbtn.active{color:var(--master-bg1);border-bottom-color:var(--master-bg1);background:#fff}
    .content{padding:20px;max-width:100%}
    .section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;margin-bottom:20px}
    .grid{display:grid;gap:16px}
    .grid2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .row{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted);font-size:.92rem}

    /* Tables */
    table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
    th,td{padding:12px;border-bottom:1px solid var(--line);text-align:left;font-size:.95rem;overflow:hidden;text-overflow:ellipsis}
    thead th{position:sticky;top:0;background:#fff;z-index:2;font-weight:700}

    /* Template editor */
    .template-editor{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:16px;margin-top:10px}
    .domain-section{border-left:4px solid var(--master-bg1);padding-left:12px;margin:10px 0}
    .category-item{background:var(--card);padding:10px;margin:5px 0;border-radius:8px}
    .question-item{background:#fff;border:1px solid var(--line);padding:8px;margin:4px 0;border-radius:6px}

    /* Coaching specific styles */
    .coaching-category{
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      margin-bottom:20px;
      overflow:hidden;
    }
    
    .coaching-category-header{
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:white;
      padding:16px 20px;
      font-weight:700;
      font-size:1.1rem;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    
    .coaching-category-content{
      padding:20px;
      display:none;
    }
    
    .coaching-category-content.active{
      display:block;
    }
    
    .coaching-section{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:8px;
      padding:16px;
      margin-bottom:16px;
    }
    
    .coaching-section h4{
      margin-bottom:12px;
      color:var(--ink);
      font-size:1rem;
    }
    
    .tip-item{
      background:#fff;
      border:1px solid var(--line);
      border-radius:8px;
      padding:12px;
      margin-bottom:12px;
    }
    
    .tip-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    
    .method-badge{
      padding:4px 8px;
      border-radius:12px;
      font-size:0.75rem;
      font-weight:600;
      text-transform:uppercase;
    }
    
    .method-self{background:#e6fffa;color:#234e52}
    .method-colleague{background:#e0e7ff;color:#3730a3}
    .method-leader_employee{background:#fef3c7;color:#92400e}
    .method-group{background:#f0f9ff;color:#0c4a6e}
    .method-external{background:#fdf2f8;color:#86198f}
    .method-course{background:#f0fdf4;color:#166534}
    
    .array-editor{
      margin-top:8px;
    }
    
    .array-item{
      display:flex;
      gap:8px;
      margin-bottom:6px;
      align-items:center;
    }
    
    .array-item input{
      flex:1;
    }
    
    .textarea{
      width:100%;
      min-height:80px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:8px;
      font-family:inherit;
      font-size:.95rem;
      resize:vertical;
    }

    /* Project table specific widths */
    .projects-table th:nth-child(1) { width: 25%; } /* Titel */
    .projects-table th:nth-child(2) { width: 20%; } /* Ejer */
    .projects-table th:nth-child(3) { width: 15%; } /* √Öbner */
    .projects-table th:nth-child(4) { width: 15%; } /* Lukker */
    .projects-table th:nth-child(5) { width: 10%; } /* Personer */
    .projects-table th:nth-child(6) { width: 10%; } /* Svar */
    .projects-table th:nth-child(7) { width: 5%; } /* Link */

    /* Status indicators */
    .status-badge{
      display:inline-block;
      padding:4px 8px;
      border-radius:12px;
      font-size:.8rem;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    
    .status-open{background:#c6f6d5;color:#22543d}
    .status-closed{background:#fed7d7;color:#9b2c2c}
    .status-draft{background:#e6fffa;color:#234e52}

    /* Users table */
    .users-table th:nth-child(1) { width: 35%; } /* Email */
    .users-table th:nth-child(2) { width: 15%; } /* Rolle */
    .users-table th:nth-child(3) { width: 20%; } /* Oprettet */
    .users-table th:nth-child(4) { width: 30%; } /* Handling */

    /* Key generation result */
    .key-result{
      background:#e6fffa;
      border:1px solid #81e6d9;
      border-radius:var(--radius);
      padding:20px;
      margin:16px 0;
      display:none;
    }
    
    .key-result h4{
      color:#234e52;
      margin-bottom:12px;
    }
    
    .key-code{
      font-family:monospace;
      font-size:1.4rem;
      font-weight:bold;
      background:#fff;
      padding:8px 12px;
      border-radius:8px;
      display:inline-block;
      margin:8px 0;
      border:2px solid #81e6d9;
    }

    /* Responsive */
    @media(max-width:1100px){
      .grid2{grid-template-columns:1fr}
      table{font-size:.85rem}
      th,td{padding:8px}
    }

    /* Success messages */
    .success-message{
      background:#d1fae5;
      border:1px solid #a7f3d0;
      color:#065f46;
      padding:12px 16px;
      border-radius:8px;
      margin:12px 0;
    }
    
    .error-message{
      background:#fef2f2;
      border:1px solid #fecaca;
      color:#dc2626;
      padding:12px 16px;
      border-radius:8px;
      margin:12px 0;
    }
  </style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <div class="header">
    <div class="club-title">
      <div class="club-logo"><img src="./assets/logo.png" alt="KOMPAS" onerror="this.style.display='none'"></div>
      <div>
        <div class="club-name">KOMPAS ‚Äî Master Backoffice</div>
        <div class="club-sub">Skabeloner ‚Ä¢ Projekter ‚Ä¢ Brugeradministration ‚Ä¢ Coaching</div>
      </div>
    </div>

    <div class="header-tools" id="authArea">
      <span id="userEmail" class="muted"></span>
      <button id="logoutBtn" class="btn ghost">Log ud</button>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabbar">
    <button class="tabbtn active" data-tab="templates">üß© Skabeloner</button>
    <button class="tabbtn" data-tab="projects">üìÅ Projekter</button>
    <button class="tabbtn" data-tab="users">üë§ Brugere</button>
    <button class="tabbtn" data-tab="coaching">üéØ Coaching</button>
  </div>

  <!-- CONTENT -->
  <div class="content">

    <!-- Skabeloner (default synlig) -->
    <div id="tab-templates" class="section" style="display:block">
      <h3>üß© Skabelon Administration</h3>
      <div class="row" style="margin:16px 0">
        <input id="tmplName" class="input" placeholder="Navn p√• skabelon">
        <input id="tmplDesc" class="input" placeholder="Beskrivelse">
        <button id="createTemplate" class="btn primary">Opret skabelon</button>
      </div>

      <div id="templateEditor" class="template-editor" style="display:none">
        <h4 id="editorTitle">Rediger skabelon</h4>
        <div id="templateContent"></div>
        <div class="row" style="margin-top:16px">
          <button id="saveTemplate" class="btn primary">Gem √¶ndringer</button>
          <button id="cancelTemplate" class="btn">Annuller</button>
        </div>
      </div>

      <h4 style="margin-top:24px">Eksisterende skabeloner</h4>
      <ul id="tmplList" style="list-style:none;display:grid;gap:8px;margin-top:8px"></ul>
    </div>

    <!-- Projekter (kun monitoring) -->
    <div id="tab-projects" class="section" style="display:none">
      <h3>üìÅ Projektoversigt</h3>
      <p class="muted" style="margin-bottom:20px">Overv√•g alle projekter i systemet. Evaluerer kan oprette projekter via deres admin-panel.</p>
      
      <div class="section">
        <table id="projectsTbl" class="projects-table">
          <thead>
            <tr>
              <th>Titel</th>
              <th>Ejer</th>
              <th>√Öbner</th>
              <th>Lukker</th>
              <th>Personer</th>
              <th>Svar</th>
              <th>Link</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Brugere -->
    <div id="tab-users" class="section" style="display:none">
      <h3>üîë Generer aktiveringsn√∏gle</h3>
      <div class="row" style="margin:16px 0">
        <input id="keyEmail" class="input" placeholder="Email til evaluator" type="email">
        <input id="keyNotes" class="input" placeholder="Valgfri note">
        <button id="generateKey" class="btn primary">Generer n√∏gle</button>
      </div>
      
      <div id="keyResult" class="key-result">
        <h4>Aktiveringsn√∏gle genereret!</h4>
        <div style="margin-top:12px">
          <p><strong>N√∏gle:</strong></p>
          <div class="key-code" id="generatedKey"></div>
          <p><strong>Email:</strong> <span id="generatedEmail"></span></p>
        </div>
        <p class="muted" style="margin-top:12px">Send denne n√∏gle til brugeren sammen med login-linket.</p>
      </div>

      <hr style="border:0;border-top:1px solid var(--line);margin:24px 0">

      <h3>üìã Aktiveringsn√∏gler</h3>
      <div class="section">
        <table id="keysTbl">
          <thead>
            <tr>
              <th>N√∏gle</th>
              <th>Email</th>
              <th>Status</th>
              <th>Oprettet</th>
              <th>Brugt</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <hr style="border:0;border-top:1px solid var(--line);margin:24px 0">
      
      <h3>üë§ Eksisterende brugere</h3>
      <div class="row" style="margin:16px 0">
        <input id="userEmailInput" class="input" placeholder="Email adresse">
        <select id="userRole" class="select">
          <option value="evaluator">Evaluator (kun projekter)</option>
          <option value="programmer">Programm√∏r (fuld adgang)</option>
        </select>
        <button id="addUser" class="btn primary">Tilf√∏j rolle direkte</button>
      </div>

      <div class="section">
        <table id="usersTbl" class="users-table">
          <thead>
            <tr>
              <th>Email</th>
              <th>Rolle</th>
              <th>Oprettet</th>
              <th style="text-align:right">Handling</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Coaching Administration -->
    <div id="tab-coaching" class="section" style="display:none">
      <h3>üéØ Coaching Administration</h3>
      
      <!-- Template selector -->
      <div class="section">
        <label>V√¶lg skabelon for coaching administration:
          <select id="coachingTemplateSelect" class="select" style="margin-left:10px">
            <option value="">-- V√¶lg skabelon --</option>
          </select>
        </label>
      </div>

      <!-- Status messages -->
      <div id="coachingStatus"></div>

      <!-- Coaching categories container -->
      <div id="coachingCategoriesContainer">
        <p class="muted" style="text-align:center;padding:40px">V√¶lg en skabelon for at administrere coaching indhold</p>
      </div>
    </div>

  </div>
</div>

<script>
window.addEventListener('load', function() {
  let user = null;
  let currentTemplate = null;
  let currentCoachingTemplate = null;
  let coachingData = {};

  const SUPABASE_URL = "https://wsrstyrsuwhcmmlmnbrz.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzcnN0eXJzdXdoY21tbG1uYnJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MTU0NTIsImV4cCI6MjA3MTE5MTQ1Mn0.Rf3Z3bQGjV5CKXKZr6IMOjzPdbhVJCh3SwuvlkpxUD0";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id) => document.getElementById(id);
  
  // Tabs switching
  document.querySelectorAll('.tabbtn').forEach(btn => {
    btn.onclick = () => {
      // Remove active from all tabs
      document.querySelectorAll('.tabbtn').forEach(x => x.classList.remove('active'));
      btn.classList.add('active');

      // Hide all sections
      ['templates', 'projects', 'users', 'coaching'].forEach(name => {
        const panel = $('tab-' + name);
        if(panel) panel.style.display = 'none';
      });

      // Show selected section
      const target = $('tab-' + btn.dataset.tab);
      if(target) target.style.display = 'block';
      
      // Load coaching data when coaching tab is selected
      if(btn.dataset.tab === 'coaching') {
        loadCoachingTemplates();
      }
    };
  });

  // Auth and logout
  $('logoutBtn').onclick = async () => { 
    await supabase.auth.signOut(); 
    window.location.href = 'login.html';
  };

  // Auth guard - only 'programmer' role allowed
  async function guard() {
    const { data: u } = await supabase.auth.getUser();
    if(!u?.user){ 
      window.location.href = 'login.html'; 
      return;
    }
    
    const { data: roleData } = await supabase
      .from('user_roles')
      .select('role')
      .eq('user_id', u.user.id)
      .single();

    if(roleData?.role !== 'programmer'){
      // Logged in but not master => send to admin
      window.location.href = 'admin.html';
      return;
    }

    user = u.user;
    const emailEl = $('userEmail');
    if(emailEl) emailEl.textContent = user.email || '';
    await loadAll();
  }

  // Run auth guard on load
  guard();

  async function loadAll() { 
    await loadTemplates(); 
    await loadProjects(); 
    await loadUsers();
  }

  // === TEMPLATES ===
  async function loadTemplates(){
    const { data } = await supabase.from('templates').select().order('created_at', {ascending: false});
    
    // List display with edit/delete buttons
    const ul = $('tmplList'); 
    ul.innerHTML = ''; 
    (data || []).forEach(t => { 
      const li = document.createElement('li'); 
      li.className = 'section'; 
      li.style.display = 'flex';
      li.style.justifyContent = 'space-between';
      li.style.alignItems = 'center';
      li.innerHTML = `
        <div>
          <strong>${t.name}</strong> v${t.version}<br>
          <span class="muted">${t.description || ''}</span>
        </div>
        <div class="row">
          <button class="btn small" onclick="editTemplate('${t.id}')" style="background:var(--brand);color:white;border-color:var(--brand)">Rediger</button>
          <button class="btn small" onclick="deleteTemplate('${t.id}', '${t.name.replace(/'/g, '\\\'')}')" style="background:#dc3545;color:white;border-color:#dc3545">Slet</button>
        </div>
      `; 
      ul.appendChild(li); 
    });
  }

  // Template creation
  $('createTemplate').onclick = async () => {
    const name = $('tmplName').value.trim();
    const desc = $('tmplDesc').value.trim();
    if(!name) return alert('Navn p√•kr√¶vet');
    
    const { data, error } = await supabase.from('templates').insert({
      name, description: desc, version: 1
    }).select().single();
    
    if(error) return alert(error.message);
    
    $('tmplName').value = '';
    $('tmplDesc').value = '';
    loadTemplates();
    alert('Skabelon oprettet!');
  };

  // Template editor - direct edit mode
  window.editTemplate = async (templateId) => {
    // Load full template structure
    const { data: template } = await supabase.from('templates').select('*').eq('id', templateId).single();
    const { data: domains } = await supabase.from('domains').select('*').eq('template_id', templateId).order('sort_order');
    const { data: categories } = await supabase.from('categories').select('*,domain_id').order('sort_order');
    const { data: questions } = await supabase.from('questions').select('*,category_id').order('sort_order');
    
    currentTemplate = { template, domains, categories, questions };
    renderTemplateEditor();
  };

  // Delete template
  window.deleteTemplate = async (templateId, templateName) => {
    if(!confirm(`Er du sikker p√• du vil slette skabelonen "${templateName}"?\n\nDenne handling kan ikke fortrydes!`)) return;
    
    try {
      const { error } = await supabase.from('templates').delete().eq('id', templateId);
      if(error) throw error;
      
      alert(`Skabelon "${templateName}" er slettet`);
      loadTemplates();
      
      // If we were editing this template, hide the editor
      if (currentTemplate && currentTemplate.template.id === templateId) {
        $('templateEditor').style.display = 'none';
        currentTemplate = null;
      }
      
    } catch(error) {
      alert('Fejl ved sletning: ' + error.message);
    }
  };

  function renderTemplateEditor() {
    const editor = $('templateEditor');
    const content = $('templateContent');
    editor.style.display = 'block';
    content.innerHTML = '';
    
    if(!currentTemplate) return;
    
    // Update editor title
    $('editorTitle').textContent = `Rediger skabelon: ${currentTemplate.template.name}`;
    
    // Template basic info
    const templateBasic = document.createElement('div');
    templateBasic.className = 'section';
    templateBasic.style.marginBottom = '20px';
    templateBasic.innerHTML = `
      <h4>Grundl√¶ggende information</h4>
      <div class="grid2" style="margin-top:12px">
        <label>Skabelon navn
          <input type="text" id="edit-template-name" class="input" value="${currentTemplate.template.name || ''}">
        </label>
        <label>Beskrivelse
          <input type="text" id="edit-template-desc" class="input" value="${currentTemplate.template.description || ''}">
        </label>
      </div>
    `;
    content.appendChild(templateBasic);
    
    // Domains and their content
    currentTemplate.domains.forEach((domain, domainIndex) => {
      const domainDiv = document.createElement('div');
      domainDiv.className = 'domain-section';
      domainDiv.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
          <input type="text" class="input" value="${domain.name}" onchange="updateDomainName(${domainIndex}, this.value)" style="flex:1">
          <button class="btn small" onclick="deleteDomain(${domainIndex})" style="background:#dc3545;color:white;border-color:#dc3545">Slet dom√¶ne</button>
        </div>
      `;
      
      const domainCats = currentTemplate.categories.filter(c => c.domain_id === domain.id);
      domainCats.forEach((category, catIndex) => {
        const catDiv = document.createElement('div');
        catDiv.className = 'category-item';
        catDiv.innerHTML = `
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <input type="text" class="input" value="${category.name}" onchange="updateCategoryName('${category.id}', this.value)" style="flex:1">
            <button class="btn small" onclick="deleteCategory('${category.id}')" style="background:#dc3545;color:white;border-color:#dc3545;font-size:0.7rem">Slet</button>
          </div>
        `;
        
        const questionsContainer = document.createElement('div');
        questionsContainer.style.marginLeft = '16px';
        
        const catQuestions = currentTemplate.questions.filter(q => q.category_id === category.id);
        catQuestions.forEach((question) => {
          const qDiv = document.createElement('div');
          qDiv.className = 'question-item';
          qDiv.innerHTML = `
            <div style="margin-bottom:8px">
              <textarea class="input" onchange="updateQuestionText('${question.id}', this.value)" style="width:100%;min-height:60px;resize:vertical">${question.text}</textarea>
              <div style="display:flex;align-items:center;gap:8px;margin-top:4px">
                <label style="display:flex;align-items:center;gap:4px;font-size:0.85rem">
                  <input type="checkbox" ${question.is_lite ? 'checked' : ''} onchange="updateQuestionLite('${question.id}', this.checked)">
                  LITE version
                </label>
                <div style="flex:1"></div>
                <button class="btn small" onclick="deleteQuestion('${question.id}')" style="background:#dc3545;color:white;border-color:#dc3545;font-size:0.7rem">Slet sp√∏rgsm√•l</button>
              </div>
            </div>
          `;
          questionsContainer.appendChild(qDiv);
        });
        
        // Add question button
        const addQBtn = document.createElement('button');
        addQBtn.className = 'btn small';
        addQBtn.textContent = '+ Tilf√∏j sp√∏rgsm√•l';
        addQBtn.style.marginTop = '8px';
        addQBtn.onclick = () => addQuestion(category.id);
        questionsContainer.appendChild(addQBtn);
        
        catDiv.appendChild(questionsContainer);
        domainDiv.appendChild(catDiv);
      });
      
      // Add category button
      const addCatBtn = document.createElement('button');
      addCatBtn.className = 'btn small';
      addCatBtn.textContent = '+ Tilf√∏j kategori';
      addCatBtn.style.marginTop = '12px';
      addCatBtn.onclick = () => addCategory(domain.id);
      domainDiv.appendChild(addCatBtn);
      
      content.appendChild(domainDiv);
    });
    
    // Add domain button
    const addDomainBtn = document.createElement('button');
    addDomainBtn.className = 'btn';
    addDomainBtn.textContent = '+ Tilf√∏j dom√¶ne';
    addDomainBtn.style.marginTop = '20px';
    addDomainBtn.onclick = addDomain;
    content.appendChild(addDomainBtn);
  }

  // Template save handler - now updates existing template
  $('saveTemplate').onclick = async () => {
    if(!currentTemplate) return alert('Ingen template indl√¶st');
    
    try {
      // Get updated basic info
      const newName = $('edit-template-name').value.trim();
      const newDesc = $('edit-template-desc').value.trim();
      
      if(!newName) return alert('Template navn p√•kr√¶vet');
      
      // Update existing template
      const { error: templateError } = await supabase
        .from('templates')
        .update({
          name: newName,
          description: newDesc
        })
        .eq('id', currentTemplate.template.id);
      
      if (templateError) throw templateError;
      
      // Delete existing domains, categories, and questions for this template
      const { error: deleteError } = await supabase
        .from('domains')
        .delete()
        .eq('template_id', currentTemplate.template.id);
      
      if (deleteError) throw deleteError;
      
      // Save updated domains
      for (let i = 0; i < currentTemplate.domains.length; i++) {
        const domain = currentTemplate.domains[i];
        const { data: newDomain, error: domainError } = await supabase
          .from('domains')
          .insert({
            template_id: currentTemplate.template.id,
            name: domain.name,
            sort_order: i + 1
          })
          .select()
          .single();
        
        if (domainError) throw domainError;
        
        // Save categories for this domain
        const domainCategories = currentTemplate.categories.filter(c => c.domain_id === domain.id);
        for (let j = 0; j < domainCategories.length; j++) {
          const category = domainCategories[j];
          const { data: newCategory, error: categoryError } = await supabase
            .from('categories')
            .insert({
              domain_id: newDomain.id,
              name: category.name,
              sort_order: j + 1
            })
            .select()
            .single();
          
          if (categoryError) throw categoryError;
          
          // Save questions for this category
          const categoryQuestions = currentTemplate.questions.filter(q => q.category_id === category.id);
          for (let k = 0; k < categoryQuestions.length; k++) {
            const question = categoryQuestions[k];
            const { error: questionError } = await supabase
              .from('questions')
              .insert({
                category_id: newCategory.id,
                text: question.text,
                is_lite: question.is_lite,
                sort_order: k + 1
              });
            
            if (questionError) throw questionError;
          }
        }
      }
      
      alert(`Skabelon "${newName}" er opdateret`);
      loadTemplates();
      
      // Hide editor
      $('templateEditor').style.display = 'none';
      currentTemplate = null;
      
    } catch (error) {
      alert('Fejl ved gem: ' + error.message);
    }
  };

  // Template editing functions
  window.updateDomainName = (domainIndex, newName) => {
    if(currentTemplate && currentTemplate.domains[domainIndex]) {
      currentTemplate.domains[domainIndex].name = newName;
    }
  };

  window.updateCategoryName = (categoryId, newName) => {
    if(currentTemplate) {
      const category = currentTemplate.categories.find(c => c.id === categoryId);
      if(category) category.name = newName;
    }
  };

  window.updateQuestionText = (questionId, newText) => {
    if(currentTemplate) {
      const question = currentTemplate.questions.find(q => q.id === questionId);
      if(question) question.text = newText;
    }
  };

  window.updateQuestionLite = (questionId, isLite) => {
    if(currentTemplate) {
      const question = currentTemplate.questions.find(q => q.id === questionId);
      if(question) question.is_lite = isLite;
    }
  };

  window.deleteDomain = (domainIndex) => {
    if(!confirm('Slet dette dom√¶ne og alt indhold?')) return;
    
    if(currentTemplate && currentTemplate.domains[domainIndex]) {
      const domainId = currentTemplate.domains[domainIndex].id;
      
      // Remove domain
      currentTemplate.domains.splice(domainIndex, 1);
      
      // Remove categories in this domain
      currentTemplate.categories = currentTemplate.categories.filter(c => c.domain_id !== domainId);
      
      // Remove questions in categories that belonged to this domain
      const categoryIds = currentTemplate.categories.filter(c => c.domain_id === domainId).map(c => c.id);
      currentTemplate.questions = currentTemplate.questions.filter(q => !categoryIds.includes(q.category_id));
      
      renderTemplateEditor();
    }
  };

  window.deleteCategory = (categoryId) => {
    if(!confirm('Slet denne kategori og alle sp√∏rgsm√•l?')) return;
    
    if(currentTemplate) {
      // Remove category
      currentTemplate.categories = currentTemplate.categories.filter(c => c.id !== categoryId);
      
      // Remove questions in this category
      currentTemplate.questions = currentTemplate.questions.filter(q => q.category_id !== categoryId);
      
      renderTemplateEditor();
    }
  };

  window.deleteQuestion = (questionId) => {
    if(!confirm('Slet dette sp√∏rgsm√•l?')) return;
    
    if(currentTemplate) {
      currentTemplate.questions = currentTemplate.questions.filter(q => q.id !== questionId);
      renderTemplateEditor();
    }
  };

  window.addQuestion = (categoryId) => {
    const text = prompt('Indtast sp√∏rgsm√•lstekst:');
    if(!text || !text.trim()) return;
    
    const newQuestion = {
      id: 'temp_' + Date.now(),
      category_id: categoryId,
      text: text.trim(),
      is_lite: false,
      sort_order: currentTemplate.questions.filter(q => q.category_id === categoryId).length + 1
    };
    
    currentTemplate.questions.push(newQuestion);
    renderTemplateEditor();
  };

  window.addCategory = (domainId) => {
    const name = prompt('Indtast kategorinavn:');
    if(!name || !name.trim()) return;
    
    const newCategory = {
      id: 'temp_' + Date.now(),
      domain_id: domainId,
      name: name.trim(),
      sort_order: currentTemplate.categories.filter(c => c.domain_id === domainId).length + 1
    };
    
    currentTemplate.categories.push(newCategory);
    renderTemplateEditor();
  };

  window.addDomain = () => {
    const name = prompt('Indtast dom√¶nenavn:');
    if(!name || !name.trim()) return;
    
    const newDomain = {
      id: 'temp_' + Date.now(),
      template_id: currentTemplate.template.id,
      name: name.trim(),
      sort_order: currentTemplate.domains.length + 1
    };
    
    currentTemplate.domains.push(newDomain);
    renderTemplateEditor();
  };

  // Cancel template editing
  $('cancelTemplate').onclick = () => {
    if(confirm('Annuller redigering? Alle √¶ndringer g√•r tabt.')) {
      $('templateEditor').style.display = 'none';
      currentTemplate = null;
    }
  };

  // === PROJECTS (monitoring only) ===
  async function loadProjects() {
    const { data } = await supabase.from('v_all_projects_with_owners').select('*').limit(1000);
    const tb = $('projectsTbl').querySelector('tbody'); 
    tb.innerHTML = '';
    
    (data || []).forEach(p => {
      const tr = document.createElement('tr');
      
      // Determine status
      const now = new Date();
      const openAt = p.open_at ? new Date(p.open_at) : null;
      const closeAt = p.close_at ? new Date(p.close_at) : null;
      
      let statusBadge = '<span class="status-badge status-draft">Kladde</span>';
      if(openAt && closeAt) {
        if(now < openAt) {
          statusBadge = '<span class="status-badge status-draft">Ikke √•bnet</span>';
        } else if(now > closeAt) {
          statusBadge = '<span class="status-badge status-closed">Lukket</span>';
        } else {
          statusBadge = '<span class="status-badge status-open">√Öben</span>';
        }
      }
      
      tr.innerHTML = `
        <td>
          <strong>${p.title}</strong><br>
          <span class="muted">${p.info_text || ''}</span><br>
          ${statusBadge}
        </td>
        <td>
          ${p.owner_email || 'N/A'}<br>
          <span class="muted">${p.owner_role || 'ingen rolle'}</span>
        </td>
        <td>${openAt ? openAt.toLocaleDateString('da-DK') : 'Ikke sat'}</td>
        <td>${closeAt ? closeAt.toLocaleDateString('da-DK') : 'Ikke sat'}</td>
        <td style="text-align:center">${p.people_count || 0}</td>
        <td style="text-align:center">${p.responses_count || 0}</td>
        <td style="text-align:center">${p.link_url ? '‚úÖ' : '‚Äî'}</td>
      `;
      tb.appendChild(tr);
    });
  }

  // === USERS ===
  async function loadUsers() {
    // Load activation keys
    const { data: keys } = await supabase.from('v_activation_keys').select('*').order('created_at', {ascending: false});
    const ktb = $('keysTbl').querySelector('tbody'); 
    ktb.innerHTML = '';
    
    (keys || []).forEach(k => {
      const tr = document.createElement('tr');
      const status = k.used ? `<span style="color:var(--success)">Brugt</span>` : `<span style="color:var(--brand)">Aktiv</span>`;
      const usedInfo = k.used ? `${new Date(k.used_at).toLocaleDateString()}<br><span class="muted">${k.used_by_email}</span>` : '-';
      
      tr.innerHTML = `
        <td style="font-family:monospace;font-weight:bold">${k.key_code}</td>
        <td>${k.email}</td>
        <td>${status}</td>
        <td>${new Date(k.created_at).toLocaleDateString()}</td>
        <td>${usedInfo}</td>
        <td>${k.notes || '-'}</td>
      `;
      ktb.appendChild(tr);
    });

    // Load existing users
    const { data } = await supabase.from('v_users_with_roles').select('*').order('created_at', {ascending: false});
    const tb = $('usersTbl').querySelector('tbody'); 
    tb.innerHTML = '';
    
    (data || []).forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.email || 'N/A'}</td>
        <td>${u.role || 'Ingen rolle'}</td>
        <td>${new Date(u.created_at).toLocaleDateString()}</td>
        <td style="text-align:right">
          <button class="btn small" onclick="removeUserRole('${u.email}')" style="background:#dc3545;color:white;border-color:#dc3545">Fjern rolle</button>
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  // Generate activation key
  $('generateKey').onclick = async () => {
    const email = $('keyEmail').value.trim();
    const notes = $('keyNotes').value.trim();
    if(!email) return alert('Email p√•kr√¶vet');
    
    const { data, error } = await supabase.rpc('generate_activation_key', {
      p_email: email,
      p_notes: notes || null
    });
    
    if(error) return alert(error.message);
    if(data.error) return alert(data.error);
    
    // Show result
    $('generatedKey').textContent = data.key_code;
    $('generatedEmail').textContent = data.email;
    $('keyResult').style.display = 'block';
    
    // Clear inputs
    $('keyEmail').value = '';
    $('keyNotes').value = '';
    
    // Reload keys table
    loadUsers();
    
    // Hide result after 30 seconds
    setTimeout(() => {
      $('keyResult').style.display = 'none';
    }, 30000);
  };

  // Global function for remove user role
  window.removeUserRole = async (email) => {
    if(!confirm(`Fjern rolle for ${email}?`)) return;
    
    const { data, error } = await supabase.rpc('remove_user_role', {
      p_user_email: email
    });
    
    if(error) return alert(error.message);
    if(data.error) return alert(data.error);
    
    alert(data.message);
    loadUsers();
  };

  // Add user role directly
  $('addUser').onclick = async () => {
    const email = $('userEmailInput').value.trim();
    const role = $('userRole').value;
    if(!email) return alert('Email p√•kr√¶vet');
    
    const { data, error } = await supabase.rpc('manage_user_role', {
      p_user_email: email,
      p_role: role
    });
    
    if(error) return alert(error.message);
    if(data.error) return alert(data.error);
    
    alert(data.message);
    $('userEmailInput').value = '';
    loadUsers();
  };

  // === COACHING ADMINISTRATION ===
  
  async function loadCoachingTemplates() {
    try {
      const { data: templates } = await supabase.from('templates').select('*').order('name');
      const select = $('coachingTemplateSelect');
      
      select.innerHTML = '<option value="">-- V√¶lg skabelon --</option>';
      (templates || []).forEach(t => {
        const option = document.createElement('option');
        option.value = t.id;
        option.textContent = `${t.name} v${t.version}`;
        select.appendChild(option);
      });
      
      select.onchange = () => {
        if(select.value) {
          loadCoachingData(select.value);
        } else {
          $('coachingCategoriesContainer').innerHTML = '<p class="muted" style="text-align:center;padding:40px">V√¶lg en skabelon for at administrere coaching indhold</p>';
        }
      };
      
    } catch(error) {
      showCoachingStatus('Fejl ved indl√¶sning af skabeloner: ' + error.message, 'error');
    }
  }

  async function loadCoachingData(templateId) {
    try {
      currentCoachingTemplate = templateId;
      showCoachingStatus('Indl√¶ser coaching data...', 'info');
      
      // Load categories for this template
      const { data: categories } = await supabase
        .from('v_category_path')
        .select('*')
        .eq('template_id', templateId)
        .order('category_sort');
      
      if(!categories || categories.length === 0) {
        $('coachingCategoriesContainer').innerHTML = '<p class="muted" style="text-align:center;padding:40px">Ingen kategorier fundet for denne skabelon</p>';
        showCoachingStatus('', '');
        return;
      }
      
      // Load existing coaching data
      const { data: competencies } = await supabase
        .from('coaching_competency')
        .select('*')
        .in('category_id', categories.map(c => c.category_id));
      
      const { data: tips } = await supabase
        .from('coaching_tip')
        .select('*')
        .in('category_id', categories.map(c => c.category_id))
        .order('sort_order');
      
      coachingData = {
        categories,
        competencies: competencies || [],
        tips: tips || []
      };
      
      renderCoachingInterface();
      showCoachingStatus('Coaching data indl√¶st succesfuldt', 'success');
      
    } catch(error) {
      console.error('Error loading coaching data:', error);
      showCoachingStatus('Fejl ved indl√¶sning: ' + error.message, 'error');
    }
  }

  function showCoachingStatus(message, type) {
    const statusDiv = $('coachingStatus');
    if(!message) {
      statusDiv.innerHTML = '';
      return;
    }
    
    const className = type === 'error' ? 'error-message' : 
                     type === 'success' ? 'success-message' : 
                     'muted';
    
    statusDiv.innerHTML = `<div class="${className}">${message}</div>`;
    
    if(type === 'success' || type === 'info') {
      setTimeout(() => {
        statusDiv.innerHTML = '';
      }, 3000);
    }
  }

  function renderCoachingInterface() {
    const container = $('coachingCategoriesContainer');
    container.innerHTML = '';
    
    coachingData.categories.forEach(category => {
      const categoryDiv = document.createElement('div');
      categoryDiv.className = 'coaching-category';
      
      const competency = coachingData.competencies.find(c => c.category_id === category.category_id);
      const categoryTips = coachingData.tips.filter(t => t.category_id === category.category_id);
      
      categoryDiv.innerHTML = `
        <div class="coaching-category-header" onclick="toggleCoachingCategory('${category.category_id}')">
          <span>${category.domain_name} ‚Ä∫ ${category.category_name}</span>
          <span id="toggle-${category.category_id}">‚ñº</span>
        </div>
        <div class="coaching-category-content" id="content-${category.category_id}">
          ${renderCompetencyEditor(category, competency)}
          ${renderTipsEditor(category, categoryTips)}
        </div>
      `;
      
      container.appendChild(categoryDiv);
    });
  }

  function renderCompetencyEditor(category, competency) {
    const comp = competency || { synopsis: '', importance: '', why_matters: '' };
    
    return `
      <div class="coaching-section">
        <h4>üìã Kompetence Oversigt</h4>
        <div class="grid" style="gap:12px">
          <label>Synopsis (kort beskrivelse)
            <textarea class="textarea" id="synopsis-${category.category_id}" placeholder="Evnen til at...">${comp.synopsis}</textarea>
          </label>
          <label>Vigtighed (hvorfor er det vigtigt?)
            <textarea class="textarea" id="importance-${category.category_id}" placeholder="Grundlag for...">${comp.importance}</textarea>
          </label>
          <label>Hvorfor det betyder noget
            <textarea class="textarea" id="why_matters-${category.category_id}" placeholder="P√•virker b√•de...">${comp.why_matters || ''}</textarea>
          </label>
          <button class="btn primary" onclick="saveCompetency('${category.category_id}')">Gem kompetence oversigt</button>
        </div>
      </div>
    `;
  }

  function renderTipsEditor(category, tips) {
    let tipsHtml = tips.map((tip, index) => renderSingleTip(category.category_id, tip, index)).join('');
    
    return `
      <div class="coaching-section">
        <h4>üí° Coaching Tips</h4>
        <div id="tips-container-${category.category_id}">
          ${tipsHtml}
        </div>
        <button class="btn" onclick="addNewTip('${category.category_id}')">+ Tilf√∏j nyt tip</button>
      </div>
    `;
  }

  function renderSingleTip(categoryId, tip, index) {
    const methods = ['self', 'leader_employee', 'colleague', 'group', 'external', 'course'];
    const methodLabels = {
      'self': 'Selv',
      'leader_employee': 'Leder/Medarbejder',
      'colleague': 'Kollega', 
      'group': 'Gruppe',
      'external': 'Ekstern',
      'course': 'Kursus'
    };
    
    return `
      <div class="tip-item" id="tip-${tip.id || 'new'}">
        <div class="tip-header">
          <span class="method-badge method-${tip.method}">${methodLabels[tip.method] || tip.method}</span>
          <button class="btn small" onclick="deleteTip('${tip.id}', '${categoryId}')" style="background:#dc3545;color:white">Slet</button>
        </div>
        
        <div class="grid2" style="gap:12px;margin-bottom:12px">
          <label>Metode
            <select class="select" id="method-${tip.id}">
              ${methods.map(m => `<option value="${m}" ${tip.method === m ? 'selected' : ''}>${methodLabels[m]}</option>`).join('')}
            </select>
          </label>
          <label>Titel
            <input class="input" id="title-${tip.id}" value="${tip.title || ''}" placeholder="Kort beskrivende titel">
          </label>
        </div>
        
        <label>Beskrivelse
          <textarea class="textarea" id="description-${tip.id}" placeholder="Detaljeret beskrivelse...">${tip.description || ''}</textarea>
        </label>
        
        <div class="grid2" style="gap:12px;margin-top:12px">
          <label>Impact (1-5)
            <input type="number" class="input" id="impact-${tip.id}" min="1" max="5" value="${tip.impact || 3}">
          </label>
          <label>Effort (1-5)
            <input type="number" class="input" id="effort-${tip.id}" min="1" max="5" value="${tip.effort || 3}">
          </label>
        </div>
        
        <label>Tidshorisont
          <input class="input" id="time_horizon-${tip.id}" value="${tip.time_horizon || ''}" placeholder="2-3 uger">
        </label>
        
        ${renderArrayEditor('Trin', 'steps', tip.id, tip.steps || [])}
        ${renderArrayEditor('Mikrovaner', 'micro_habits', tip.id, tip.micro_habits || [])}
        ${renderArrayEditor('Coach sp√∏rgsm√•l', 'prompts', tip.id, tip.prompts || [])}
        ${renderArrayEditor('Faldgruber', 'pitfalls', tip.id, tip.pitfalls || [])}
        
        <button class="btn primary" onclick="saveTip('${tip.id}', '${categoryId}')" style="margin-top:12px">Gem tip</button>
      </div>
    `;
  }

  function renderArrayEditor(label, fieldName, tipId, items) {
    const itemsHtml = items.map((item, index) => `
      <div class="array-item">
        <input class="input" value="${item}" onchange="updateArrayItem('${fieldName}', '${tipId}', ${index}, this.value)">
        <button class="btn small" onclick="removeArrayItem('${fieldName}', '${tipId}', ${index})" style="background:#dc3545;color:white">√ó</button>
      </div>
    `).join('');
    
    return `
      <div class="array-editor">
        <label>${label}</label>
        <div id="${fieldName}-${tipId}">
          ${itemsHtml}
        </div>
        <button class="btn small" onclick="addArrayItem('${fieldName}', '${tipId}')" style="margin-top:4px">+ Tilf√∏j ${label.toLowerCase()}</button>
      </div>
    `;
  }

  // Global functions for coaching management
  window.toggleCoachingCategory = (categoryId) => {
    const content = $(`content-${categoryId}`);
    const toggle = $(`toggle-${categoryId}`);
    
    if(content.classList.contains('active')) {
      content.classList.remove('active');
      toggle.textContent = '‚ñº';
    } else {
      content.classList.add('active');
      toggle.textContent = '‚ñ≤';
    }
  };

  window.saveCompetency = async (categoryId) => {
    try {
      const synopsis = $(`synopsis-${categoryId}`).value.trim();
      const importance = $(`importance-${categoryId}`).value.trim();
      const why_matters = $(`why_matters-${categoryId}`).value.trim();
      
      if(!synopsis || !importance) {
        alert('Synopsis og vigtighed er p√•kr√¶vet');
        return;
      }
      
      const existingComp = coachingData.competencies.find(c => c.category_id === categoryId);
      
      if(existingComp) {
        // Update existing
        const { error } = await supabase
          .from('coaching_competency')
          .update({ synopsis, importance, why_matters })
          .eq('id', existingComp.id);
        
        if(error) throw error;
        
        // Update local data
        existingComp.synopsis = synopsis;
        existingComp.importance = importance;
        existingComp.why_matters = why_matters;
      } else {
        // Create new
        const { data, error } = await supabase
          .from('coaching_competency')
          .insert({ category_id: categoryId, synopsis, importance, why_matters })
          .select()
          .single();
        
        if(error) throw error;
        
        coachingData.competencies.push(data);
      }
      
      showCoachingStatus('Kompetence oversigt gemt', 'success');
      
    } catch(error) {
      showCoachingStatus('Fejl ved gem: ' + error.message, 'error');
    }
  };

  window.addNewTip = (categoryId) => {
    const newTip = {
      id: 'new_' + Date.now(),
      category_id: categoryId,
      method: 'self',
      title: '',
      description: '',
      steps: [],
      micro_habits: [],
      prompts: [],
      pitfalls: [],
      impact: 3,
      effort: 3,
      time_horizon: ''
    };
    
    const container = $(`tips-container-${categoryId}`);
    container.insertAdjacentHTML('beforeend', renderSingleTip(categoryId, newTip, 0));
  };

  window.saveTip = async (tipId, categoryId) => {
    try {
      const method = $(`method-${tipId}`).value;
      const title = $(`title-${tipId}`).value.trim();
      const description = $(`description-${tipId}`).value.trim();
      const impact = parseInt($(`impact-${tipId}`).value);
      const effort = parseInt($(`effort-${tipId}`).value);
      const time_horizon = $(`time_horizon-${tipId}`).value.trim();
      
      if(!title || !description) {
        alert('Titel og beskrivelse er p√•kr√¶vet');
        return;
      }
      
      // Collect arrays
      const steps = collectArrayData('steps', tipId);
      const micro_habits = collectArrayData('micro_habits', tipId);
      const prompts = collectArrayData('prompts', tipId);
      const pitfalls = collectArrayData('pitfalls', tipId);
      
      const tipData = {
        category_id: categoryId,
        method,
        title,
        description,
        steps,
        micro_habits,
        prompts,
        pitfalls,
        impact,
        effort,
        time_horizon
      };
      
      if(tipId.startsWith('new_')) {
        // Create new tip
        const { data, error } = await supabase
          .from('coaching_tip')
          .insert(tipData)
          .select()
          .single();
        
        if(error) throw error;
        
        // Update the tip element with real ID
        const tipElement = $(`tip-${tipId}`);
        tipElement.id = `tip-${data.id}`;
        
        coachingData.tips.push(data);
      } else {
        // Update existing tip
        const { error } = await supabase
          .from('coaching_tip')
          .update(tipData)
          .eq('id', tipId);
        
        if(error) throw error;
        
        // Update local data
        const existingTip = coachingData.tips.find(t => t.id === tipId);
        if(existingTip) {
          Object.assign(existingTip, tipData);
        }
      }
      
      showCoachingStatus('Tip gemt succesfuldt', 'success');
      
    } catch(error) {
      showCoachingStatus('Fejl ved gem af tip: ' + error.message, 'error');
    }
  };

  window.deleteTip = async (tipId, categoryId) => {
    if(!confirm('Er du sikker p√• du vil slette dette tip?')) return;
    
    try {
      if(!tipId.startsWith('new_')) {
        const { error } = await supabase
          .from('coaching_tip')
          .delete()
          .eq('id', tipId);
        
        if(error) throw error;
        
        // Remove from local data
        coachingData.tips = coachingData.tips.filter(t => t.id !== tipId);
      }
      
      // Remove from DOM
      const tipElement = $(`tip-${tipId}`);
      if(tipElement) tipElement.remove();
      
      showCoachingStatus('Tip slettet', 'success');
      
    } catch(error) {
      showCoachingStatus('Fejl ved sletning: ' + error.message, 'error');
    }
  };

  function collectArrayData(fieldName, tipId) {
    const container = $(`${fieldName}-${tipId}`);
    if(!container) return [];
    
    const inputs = container.querySelectorAll('input');
    return Array.from(inputs)
      .map(input => input.value.trim())
      .filter(value => value.length > 0);
  }

  window.addArrayItem = (fieldName, tipId) => {
    const container = $(`${fieldName}-${tipId}`);
    const newIndex = container.children.length;
    
    const itemHtml = `
      <div class="array-item">
        <input class="input" value="" onchange="updateArrayItem('${fieldName}', '${tipId}', ${newIndex}, this.value)">
        <button class="btn small" onclick="removeArrayItem('${fieldName}', '${tipId}', ${newIndex})" style="background:#dc3545;color:white">√ó</button>
      </div>
    `;
    
    container.insertAdjacentHTML('beforeend', itemHtml);
  };

  window.removeArrayItem = (fieldName, tipId, index) => {
    const container = $(`${fieldName}-${tipId}`);
    const items = container.querySelectorAll('.array-item');
    if(items[index]) {
      items[index].remove();
    }
  };

  window.updateArrayItem = (fieldName, tipId, index, value) => {
    // This function is called when array items are changed
    // The actual collection happens in collectArrayData when saving
  };

});
</script>
</body>
</html>
