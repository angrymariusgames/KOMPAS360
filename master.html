<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KOMPAS ‚Ä¢ Master</title>
  <link rel="icon" href="data:," />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; connect-src 'self' https://*.supabase.co">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --ink:#1f2937; --muted:#6b7280; --line:#e5e7eb; --card:#f9fafb; --brand:#0ea5e9; --radius:14px;
      --danger:#ef4444; --success:#16a34a; --warning:#d97706; --bg1:#1f2937; --bg2:#374151;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; background:linear-gradient(135deg,var(--bg1),var(--bg2)); min-height:100vh; color:var(--ink); padding:20px}
    .app{max-width:1300px;margin:0 auto;background:#fff;border-radius:20px;overflow:hidden;box-shadow:0 18px 50px rgba(0,0,0,.15)}
    .header{display:grid;grid-template-columns:1fr auto;gap:16px;align-items:center;background:#111827;color:#fff;padding:18px 22px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:44px;height:44px;border-radius:10px;background:#fff;display:grid;place-items:center}
    .brand .title{font-weight:800;font-size:1.3rem}
    .brand .sub{opacity:.9;font-size:.9rem}
    .header-tools{display:flex;gap:10px;align-items:center}
    .btn{cursor:pointer;border:1px solid var(--line);background:#fff;color:#111;padding:10px 12px;border-radius:10px;font-weight:700}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.3);color:#fff}
    .btn.small{padding:6px 8px;font-size:.9rem}
    .tabbar{display:flex;gap:8px;padding:10px;border-bottom:1px solid var(--line);background:#f8fafc}
    .tabbtn{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:700}
    .tabbtn.active{background:var(--brand);border-color:var(--brand);color:#fff}
    .layout{display:grid;grid-template-columns:1fr 320px;gap:16px;padding:16px}
    .rail{border-left:1px solid var(--line);padding-left:16px}
    .section{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .input,.select,textarea{border:1px solid var(--line);background:#fff;color:#111;padding:9px 10px;border-radius:8px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top}
    th{text-align:left;color:#111}
    .muted{color:var(--muted)}
    .template-editor{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:14px;margin-top:10px}
    .domain{border-left:4px solid var(--brand);padding-left:10px;margin:10px 0}
    .category{background:var(--card);padding:10px;border-radius:10px;margin:6px 0}
    .question{background:#fff;border:1px solid var(--line);border-radius:8px;padding:8px;margin:4px 0}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:.75rem;margin-left:6px}
    .actions{display:flex;gap:6px}
    @media(max-width:1000px){.layout{grid-template-columns:1fr}.rail{border-left:0;border-top:1px solid var(--line);padding-left:0;padding-top:16px}}
  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="brand">
      <div class="logo"><img src="./kompas_logo.png" alt="logo" style="max-height:28px" onerror="this.style.display='none'"></div>
      <div>
        <div class="title">KOMPAS ‚Äî Master</div>
        <div class="sub">Skabeloner ‚Ä¢ Projekter (monitor) ‚Ä¢ Brugere</div>
      </div>
    </div>
    <div class="header-tools">
      <span id="userEmail" class="muted"></span>
      <button id="logoutBtn" class="btn ghost">Log ud</button>
    </div>
  </div>

  <div class="tabbar">
    <button class="tabbtn active" data-tab="templates">üß© Skabeloner</button>
    <button class="tabbtn" data-tab="projects">üìÇ Projekter</button>
    <button class="tabbtn" data-tab="users">üë§ Brugere</button>
  </div>

  <div class="layout">
    <div class="content">
      <!-- TEMPLATES -->
      <div id="tab-templates" class="section" style="display:block">
        <h3>üß© Skabeloner</h3>
        <div class="row" style="margin:12px 0">
          <input id="tmplName" class="input" placeholder="Ny skabelon ‚Äî navn">
          <input id="tmplDesc" class="input" placeholder="Beskrivelse (valgfri)">
          <button id="createTemplate" class="btn">Opret</button>
        </div>
        <div class="grid2" style="margin-bottom:12px">
          <select id="selTemplate" class="select"><option value="">V√¶lg skabelon til redigering‚Ä¶</option></select>
          <button id="loadTemplate" class="btn">Indl√¶s</button>
        </div>

        <div id="templateEditor" class="template-editor" style="display:none">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h4 id="tmplHeader">Rediger skabelon</h4>
            <div class="actions">
              <button id="saveTemplate" class="btn primary" title="Gem som ny version (klonerer hele strukturen)">Gem som ny version</button>
              <button id="addDomain" class="btn" title="Tilf√∏j dom√¶ne">+ Dom√¶ne</button>
            </div>
          </div>
          <div id="templateContent" style="margin-top:8px"></div>
        </div>

        <h4 style="margin-top:16px">Eksisterende skabeloner</h4>
        <ul id="tmplList" style="list-style:none;display:grid;gap:8px;margin-top:8px"></ul>
      </div>

      <!-- PROJECTS (MONITOR) -->
      <div id="tab-projects" class="section" style="display:none">
        <h3>üìÇ Projekter (overblik)</h3>
        <p class="muted" style="margin-bottom:10px">Kun visning. Oprettelse/√¶ndringer foreg√•r i Admin.
          Du kan kopiere respondent-link og vise QR.</p>
        <div class="section" style="padding:0">
          <table id="projectsTbl">
            <thead>
              <tr>
                <th>Projekt</th>
                <th>Ejer</th>
                <th>√Öbn</th>
                <th>Luk</th>
                <th>Link</th>
                <th>M√•lpersoner</th>
                <th>Besvarelser</th>
                <th>QR</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- USERS -->
      <div id="tab-users" class="section" style="display:none">
        <h3>üë§ Brugere & roller</h3>
        <div class="row" style="margin:12px 0">
          <input id="userEmailInput" class="input" placeholder="brugers email">
          <select id="userRoleSelect" class="select">
            <option value="evaluator">Evaluator</option>
            <option value="programmer">Programm√∏r</option>
          </select>
          <button id="addUserRole" class="btn primary">Tildel rolle</button>
        </div>

        <h4 style="margin-top:8px">Aktiveringsn√∏gler</h4>
        <div class="row" style="margin:8px 0">
          <input id="keyEmail" class="input" placeholder="email til aktivering">
          <input id="keyNotes" class="input" placeholder="note (valgfri)">
          <button id="generateKey" class="btn">Gener√©r n√∏gle</button>
        </div>
        <div id="keyResult" class="section" style="display:none;background:#ecfeff;border-color:#a5f3fc">
          <div><strong>N√∏gle:</strong> <span id="generatedKey" style="font-family:monospace"></span></div>
          <div><strong>Email:</strong> <span id="generatedEmail"></span></div>
          <p class="muted">Del n√∏glen + link til login-siden.</p>
        </div>

        <div class="section" style="margin-top:12px">
          <table id="keysTbl">
            <thead>
              <tr><th>N√∏gle</th><th>Email</th><th>Status</th><th>Oprettet</th><th>Brugt</th><th>Note</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <h4 style="margin-top:16px">Eksisterende brugere</h4>
        <div class="section">
          <table id="usersTbl">
            <thead>
              <tr><th>Email</th><th>Rolle</th><th>Oprettet</th><th style="text-align:right">Handling</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="rail">
      <div class="section">
        <h4>Hurtige links</h4>
        <div class="row" style="margin-top:8px">
          <a class="btn" href="admin.html">Admin</a>
          <a class="btn" href="login.html">Login</a>
        </div>
        <p class="muted" style="margin-top:10px">Master er kun for rollen ‚Äúprogrammer‚Äù. Alle andre sendes til Admin.</p>
      </div>
      <div class="section">
        <h4>Info</h4>
        <p class="muted">Gem af skabelon laver automatisk en ny version og kloner alle dom√¶ner, kategorier og sp√∏rgsm√•l.
        LITE-markering p√• sp√∏rgsm√•l respekteres i respondent.</p>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const SUPABASE_URL = "https://wsrstyrsuwhcmmlmnbrz.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzcnN0eXJzdXdoY21tbG1uYnJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MTU0NTIsImV4cCI6MjA3MTE5MTQ1Mn0.Rf3Z3bQGjV5CKXKZr6IMOjzPdbhVJCh3SwuvlkpxUD0";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id) => document.getElementById(id);
  let user = null;
  let currentTemplate = null;

  // Tabs
  document.querySelectorAll('.tabbtn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tabbtn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      ['templates','projects','users'].forEach(name => {
        const el = document.getElementById('tab-' + name);
        if (el) el.style.display = (btn.dataset.tab === name) ? 'block' : 'none';
      });
    });
  });

  // Auth guard ‚Äî kun programmer m√• blive p√• master
  $('logoutBtn').onclick = async () => { await supabase.auth.signOut(); location.href = 'login.html'; };
  async function guard(){
    const { data: u } = await supabase.auth.getUser();
    if(!u?.user){ location.href = 'login.html'; return; }
    const { data: roleData } = await supabase.from('user_roles').select('role').eq('user_id', u.user.id).single();
    if(roleData?.role !== 'programmer'){ location.href = 'admin.html'; return; }
    user = u.user; $('userEmail').textContent = user.email || '';
    await loadAll();
  }
  guard();

  async function loadAll(){ await loadTemplates(); await loadProjects(); await loadUsers(); }

  /* -------------------- SKABELONER -------------------- */
  async function loadTemplates(){
    const { data, error } = await supabase.from('templates').select('*').order('created_at',{ascending:false});
    if(error){ console.error(error); return; }
    // dropdown
    const sel = $('selTemplate'); sel.innerHTML = '<option value="">V√¶lg skabelon‚Ä¶</option>';
    (data||[]).forEach(t => { const o = document.createElement('option'); o.value = t.id; o.textContent = `${t.name} v${t.version}`; sel.appendChild(o); });
    // list
    const ul = $('tmplList'); ul.innerHTML = '';
    (data||[]).forEach(t => { const li = document.createElement('li'); li.className='section'; li.innerHTML = `<strong>${t.name}</strong> v${t.version}<br><span class="muted">${t.description||''}</span>`; ul.appendChild(li); });
  }

  $('createTemplate').onclick = async () => {
    const name = $('tmplName').value.trim();
    const description = $('tmplDesc').value.trim() || null;
    if(!name) return alert('Navn p√•kr√¶vet');
    const { error } = await supabase.from('templates').insert({ name, description, version:1, created_by: user.id });
    if(error) return alert(error.message); $('tmplName').value=''; $('tmplDesc').value=''; loadTemplates();
  };

  $('loadTemplate').onclick = async () => {
    const tid = $('selTemplate').value; if(!tid) return;
    const { data: template } = await supabase.from('templates').select('*').eq('id', tid).single();
    const { data: domains } = await supabase.from('domains').select('*').eq('template_id', tid).order('sort_order');
    const { data: categories } = await supabase.from('categories').select('*').in('domain_id', (domains||[]).map(d=>d.id)).order('sort_order');
    const { data: questions } = await supabase.from('questions').select('*').in('category_id', (categories||[]).map(c=>c.id)).order('sort_order');
    currentTemplate = { template, domains: domains||[], categories: categories||[], questions: questions||[] };
    $('tmplHeader').textContent = `${template.name} v${template.version}`;
    renderTemplateEditor();
  };

  function renderTemplateEditor(){
    $('templateEditor').style.display = 'block';
    const wrap = $('templateContent'); wrap.innerHTML = '';
    const dmap = new Map(currentTemplate.domains.map(d=>[d.id,d]));
    const catsByDomain = {}; currentTemplate.categories.forEach(c=>{ (catsByDomain[c.domain_id] ||= []).push(c); });
    const qsByCat = {}; currentTemplate.questions.forEach(q=>{ (qsByCat[q.category_id] ||= []).push(q); });

    (currentTemplate.domains||[]).sort((a,b)=>a.sort_order-b.sort_order).forEach(d => {
      const dEl = document.createElement('div'); dEl.className='domain';
      dEl.innerHTML = `<div class="row" style="justify-content:space-between;align-items:center"><h4>${d.name}</h4><button class="btn small" data-dom="${d.id}">+ Kategori</button></div>`;
      (catsByDomain[d.id]||[]).sort((a,b)=>a.sort_order-b.sort_order).forEach(c => {
        const cEl = document.createElement('div'); cEl.className='category';
        cEl.innerHTML = `<div class="row" style="justify-content:space-between;align-items:center"><strong>${c.name}</strong><button class="btn small" data-cat="${c.id}">+ Sp√∏rgsm√•l</button></div>`;
        (qsByCat[c.id]||[]).sort((a,b)=>a.sort_order-b.sort_order).forEach(q => {
          const qEl = document.createElement('div'); qEl.className='question';
          qEl.innerHTML = `${q.text} ${q.is_lite ? '<span class="pill">LITE</span>' : ''}`;
          cEl.appendChild(qEl);
        });
        dEl.appendChild(cEl);
      });
      wrap.appendChild(dEl);
    });

    // wire the dynamic "+ Kategori" and "+ Sp√∏rgsm√•l" buttons
    wrap.querySelectorAll('button[data-dom]').forEach(btn => btn.onclick = () => addCategory(btn.getAttribute('data-dom')));
    wrap.querySelectorAll('button[data-cat]').forEach(btn => btn.onclick = () => addQuestion(btn.getAttribute('data-cat')));
  }

  // Add Domain/Category/Question (CRUD ‚Äî minimal)
  $('addDomain').onclick = async () => {
    if(!currentTemplate) return alert('Ingen skabelon indl√¶st');
    const name = prompt('Dom√¶nenavn?'); if(!name) return;
    const nextOrder = (currentTemplate.domains.reduce((m,d)=>Math.max(m,d.sort_order||0),0)||0)+1;
    const { data, error } = await supabase.from('domains').insert({ template_id: currentTemplate.template.id, name, sort_order: nextOrder }).select().single();
    if(error) return alert(error.message);
    currentTemplate.domains.push(data); renderTemplateEditor();
  };

  async function addCategory(domain_id){
    const name = prompt('Kategorinavn?'); if(!name) return;
    const nextOrder = (currentTemplate.categories.filter(c=>c.domain_id===domain_id).reduce((m,c)=>Math.max(m,c.sort_order||0),0)||0)+1;
    const { data, error } = await supabase.from('categories').insert({ domain_id, name, sort_order: nextOrder }).select().single();
    if(error) return alert(error.message);
    currentTemplate.categories.push(data); renderTemplateEditor();
  }

  async function addQuestion(category_id){
    const text = prompt('Sp√∏rgsm√•lstekst?'); if(!text) return;
    const isLite = confirm('Mark√©r som LITE-sp√∏rgsm√•l? OK = Ja, Annuller = Nej');
    const nextOrder = (currentTemplate.questions.filter(q=>q.category_id===category_id).reduce((m,q)=>Math.max(m,q.sort_order||0),0)||0)+1;
    const { data, error } = await supabase.from('questions').insert({ category_id, text, is_lite: isLite, sort_order: nextOrder }).select().single();
    if(error) return alert(error.message);
    currentTemplate.questions.push(data); renderTemplateEditor();
  }

  // Deep clone template -> new version
  $('saveTemplate').onclick = async () => {
    if(!currentTemplate) return alert('Ingen skabelon indl√¶st');
    try {
      const newVersion = (currentTemplate.template.version||1) + 1;
      const { data: newT, error: tErr } = await supabase.from('templates').insert({
        name: currentTemplate.template.name,
        description: currentTemplate.template.description,
        version: newVersion,
        created_by: user.id
      }).select().single();
      if(tErr) throw tErr;

      // maps
      const domMap = new Map();
      const catMap = new Map();

      // clone domains
      const domainsSorted = [...currentTemplate.domains].sort((a,b)=>a.sort_order-b.sort_order);
      for(const d of domainsSorted){
        const { data: d2, error: dErr } = await supabase.from('domains').insert({ template_id: newT.id, name: d.name, sort_order: d.sort_order }).select().single();
        if(dErr) throw dErr; domMap.set(d.id, d2.id);
      }
      // clone categories
      const catsSorted = [...currentTemplate.categories].sort((a,b)=>a.sort_order-b.sort_order);
      for(const c of catsSorted){
        const { data: c2, error: cErr } = await supabase.from('categories').insert({ domain_id: domMap.get(c.domain_id), name: c.name, sort_order: c.sort_order }).select().single();
        if(cErr) throw cErr; catMap.set(c.id, c2.id);
      }
      // clone questions
      const qsSorted = [...currentTemplate.questions].sort((a,b)=>a.sort_order-b.sort_order);
      for(const q of qsSorted){
        const { error: qErr } = await supabase.from('questions').insert({ category_id: catMap.get(q.category_id), text: q.text, is_lite: !!q.is_lite, scale_min: q.scale_min||1, scale_max: q.scale_max||5, weight: q.weight||1, sort_order: q.sort_order });
        if(qErr) throw qErr;
      }

      alert(`Skabelon gemt som version ${newVersion}`);
      await loadTemplates();
      $('selTemplate').value = newT.id; $('loadTemplate').click();
    } catch (e) { alert('Fejl ved gem: ' + (e.message||e)); }
  };

  /* -------------------- PROJEKTER (monitor) -------------------- */
  function generateProjectUrl(token){
    const { protocol, hostname, port, pathname } = location;
    let base = `${protocol}//${hostname}${port && port!=='80' && port!=='443' ? ':'+port : ''}`;
    if(hostname.includes('github.io')){
      const parts = pathname.split('/').filter(Boolean); if(parts.length>0) base += '/' + parts[0];
    }
    return base + '/respondent.html?t=' + token;
  }

  async function loadProjects(){
    const { data, error } = await supabase.from('v_all_projects_with_owners').select('*').limit(1000);
    if(error){ console.error(error); return; }
    const tb = $('projectsTbl').querySelector('tbody'); tb.innerHTML='';
    for (const p of (data||[])) {
      // link
      const { data: link } = await supabase.from('project_link').select().eq('project_id', p.id).maybeSingle();
      const url = link ? generateProjectUrl(link.token) : null;
      const tr = document.createElement('tr');
      const qrId = 'qr-' + p.id;
      tr.innerHTML = `
        <td><strong>${p.title}</strong><br><span class="muted">${p.info_text||''}</span></td>
        <td>${p.owner_email||'N/A'}<br><span class="muted">${p.owner_role||''}</span></td>
        <td>${p.open_at ? new Date(p.open_at).toLocaleString('da-DK') : '‚Äî'}</td>
        <td>${p.close_at ? new Date(p.close_at).toLocaleString('da-DK') : '‚Äî'}</td>
        <td>${url ? `<button class="btn small" onclick="copyToClipboard('${url}', this)">Kopi√©r link</button>` : '<span class="muted">Intet link</span>'}</td>
        <td>${p.people_count ?? '‚Äî'}</td>
        <td>${p.responses_count ?? '‚Äî'}</td>
        <td>${url ? `<canvas id="${qrId}" width="60" height="60" style="image-rendering:pixelated"></canvas>` : '‚Äî'}</td>`;
      tb.appendChild(tr);
      if(url){
        try { QRCode.toCanvas(document.getElementById(qrId), url, { width:60, height:60 }); } catch(_){}
      }
    }
  }

  window.copyToClipboard = (text, el) => {
    const prev = el.textContent; el.textContent='Kopieret!';
    navigator.clipboard.writeText(text).catch(()=>{}).finally(()=>{ setTimeout(()=>{ el.textContent=prev; }, 900); });
  };

  /* -------------------- BRUGERE -------------------- */
  async function loadUsers(){
    // activation keys (if view exists)
    try {
      const { data: keys } = await supabase.from('v_activation_keys').select('*').order('created_at',{ascending:false});
      const ktb = $('keysTbl').querySelector('tbody'); ktb.innerHTML='';
      (keys||[]).forEach(k => {
        const status = k.used ? '<span style="color:var(--success)">Brugt</span>' : '<span style="color:var(--brand)">Aktiv</span>';
        const used = k.used ? `${new Date(k.used_at).toLocaleDateString()}<br><span class=\"muted\">${k.used_by_email}</span>` : '‚Äî';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td style="font-family:monospace">${k.key_code}</td><td>${k.email}</td><td>${status}</td><td>${new Date(k.created_at).toLocaleDateString()}</td><td>${used}</td><td>${k.notes||'‚Äî'}</td>`;
        ktb.appendChild(tr);
      });
    } catch(e) { /* optional */ }

    // users with roles
    const { data } = await supabase.from('v_users_with_roles').select('*').order('created_at',{ascending:false});
    const tb = $('usersTbl').querySelector('tbody'); tb.innerHTML='';
    (data||[]).forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${u.email||'N/A'}</td><td>${u.role||'‚Äî'}</td><td>${new Date(u.created_at).toLocaleDateString()}</td><td style="text-align:right"><button class="btn small" onclick="removeUserRole('${u.email}')">Fjern rolle</button></td>`;
      tb.appendChild(tr);
    });
  }

  $('addUserRole').onclick = async () => {
    const email = $('userEmailInput').value.trim();
    const role = $('userRoleSelect').value;
    if(!email) return alert('Email p√•kr√¶vet');
    const { data, error } = await supabase.rpc('manage_user_role', { p_user_email: email, p_role: role });
    if(error) return alert(error.message);
    if(data?.error) return alert(data.error);
    alert(data.message || 'Rolle opdateret'); $('userEmailInput').value=''; loadUsers();
  };

  window.removeUserRole = async (email) => {
    if(!confirm(`Fjern rolle for ${email}?`)) return;
    const { data, error } = await supabase.rpc('remove_user_role', { p_user_email: email });
    if(error) return alert(error.message);
    if(data?.error) return alert(data.error);
    alert(data.message || 'Rolle fjernet'); loadUsers();
  };

  $('generateKey').onclick = async () => {
    const email = $('keyEmail').value.trim(); const notes = $('keyNotes').value.trim();
    if(!email) return alert('Email p√•kr√¶vet');
    const { data, error } = await supabase.rpc('generate_activation_key', { p_email: email, p_notes: notes || null });
    if(error) return alert(error.message); if(data?.error) return alert(data.error);
    $('generatedKey').textContent = data.key_code; $('generatedEmail').textContent = data.email; $('keyResult').style.display='block';
    $('keyEmail').value=''; $('keyNotes').value=''; loadUsers(); setTimeout(()=> $('keyResult').style.display='none', 30000);
  };
})();
</script>
</body>
</html>
