<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KOMPAS ‚Ä¢ Master Backoffice</title>
  <link rel="icon" href="data:," />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; connect-src 'self' https://*.supabase.co">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* ---------- Theme ---------- */
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg1:#667eea; --bg2:#764ba2; --ink:#2d3748; --muted:#718096;
      --card:#f8fafc; --line:#e2e8f0; --brand:#667eea; --radius:16px;
      --master-bg1:#e53e3e; --master-bg2:#d53f8c; /* R√∏de toner for master */
      --success:#48bb78; --error:#f56565; --warning:#ed8936;
    }
    body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,var(--master-bg1) 0%,var(--master-bg2) 100%);min-height:100vh;padding:20px;color:var(--ink)}
    .app{max-width:1400px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.15);overflow:hidden}

    /* Header */
    .header{background:linear-gradient(135deg,#2d3748 0%,#4a5568 100%);color:#fff;padding:20px 24px;display:grid;grid-template-columns:1fr auto;gap:16px;align-items:center;position:sticky;top:0;z-index:30}
    .club-title{display:flex;align-items:center;gap:14px}
    .club-logo{width:56px;height:56px;border-radius:14px;background:#fff;display:grid;place-items:center}
    .club-logo img{height:38px;object-fit:contain}
    .club-name{font-size:1.6rem;font-weight:800;margin-bottom:2px}
    .club-sub{opacity:.85;font-size:.92rem}
    .header-tools{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .input, .select{border:1px solid var(--line);background:#fff;color:#111;padding:10px 12px;border-radius:10px;font-size:.95rem}
    .btn{cursor:pointer;font-weight:700;border:1px solid var(--line);background:#fff;color:#111;padding:10px 14px;border-radius:10px;transition:.25s}
    .btn.primary{background:var(--master-bg1);border-color:var(--master-bg1);color:#fff}
    .btn.success{background:var(--success);border-color:var(--success);color:#fff}
    .btn.warning{background:var(--warning);border-color:var(--warning);color:#fff}
    .btn.ghost{background:rgba(255,255,255,.1);color:#fff;border-color:rgba(255,255,255,.35)}
    .btn.small{padding:6px 10px;font-size:.85rem}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    /* Tabs */
    .tabbar{background:var(--card);border-bottom:1px solid var(--line);padding:0 20px;display:flex;gap:0;position:sticky;top:120px;z-index:20}
    .tabbtn{background:none;border:none;padding:16px 22px;font-size:1.05rem;font-weight:700;color:#64748b;cursor:pointer;border-bottom:3px solid transparent;transition:.25s;white-space:nowrap;position:relative}
    .tabbtn:hover{color:#334155;background:rgba(229,62,62,.06)}
    .tabbtn.active{color:var(--master-bg1);border-bottom-color:var(--master-bg1);background:#fff}
    .content{padding:20px;max-width:100%}
    .section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;margin-bottom:20px}
    .grid{display:grid;gap:16px}
    .grid2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .grid3{display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr}
    .grid4{display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr 1fr}
    .row{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted);font-size:.92rem}

    /* Tables */
    table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
    th,td{padding:12px;border-bottom:1px solid var(--line);text-align:left;font-size:.95rem;overflow:hidden;text-overflow:ellipsis}
    thead th{position:sticky;top:0;background:#fff;z-index:2;font-weight:700;cursor:pointer}
    thead th:hover{background:#f1f5f9}
    thead th.sorted-asc::after{content:" ‚Üë";color:var(--brand)}
    thead th.sorted-desc::after{content:" ‚Üì";color:var(--brand)}

    /* Search and Filter Controls */
    .controls-row{display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
    .search-box{flex:1;min-width:200px}
    .filter-group{display:flex;gap:8px;align-items:center}

    /* Stats Dashboard */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:20px}
    .stat-card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:16px;text-align:center}
    .stat-number{font-size:2rem;font-weight:800;color:var(--brand);margin-bottom:4px}
    .stat-label{color:var(--muted);font-size:.9rem}
    .stat-trend{font-size:.8rem;margin-top:4px}
    .trend-up{color:var(--success)}
    .trend-down{color:var(--error)}

    /* Bulk Operations */
    .bulk-controls{background:#f8fafc;border:1px solid var(--line);border-radius:8px;padding:12px;margin-bottom:16px;display:none}
    .bulk-controls.active{display:flex;align-items:center;gap:12px}
    .selection-count{font-weight:600}

    /* Progress Indicators */
    .progress-bar{background:#e2e8f0;border-radius:8px;height:8px;overflow:hidden;margin:8px 0}
    .progress-fill{background:var(--success);height:100%;transition:width .3s ease}

    /* Template editor */
    .template-editor{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:16px;margin-top:10px}
    .domain-section{border-left:4px solid var(--master-bg1);padding-left:12px;margin:10px 0}
    .category-item{background:var(--card);padding:10px;margin:5px 0;border-radius:8px}
    .question-item{background:#fff;border:1px solid var(--line);padding:8px;margin:4px 0;border-radius:6px}

    /* Coaching specific styles */
    .coaching-category{
      background:#fff;
      border:1px solid var(--line);
      border-radius:12px;
      margin-bottom:20px;
      overflow:hidden;
    }
    
    .coaching-category-header{
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      color:white;
      padding:16px 20px;
      font-weight:700;
      font-size:1.1rem;
      cursor:pointer;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    
    .coaching-category-content{
      padding:20px;
      display:none;
    }
    
    .coaching-category-content.active{
      display:block;
    }
    
    .coaching-section{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:8px;
      padding:16px;
      margin-bottom:16px;
    }
    
    .coaching-section h4{
      margin-bottom:12px;
      color:var(--ink);
      font-size:1rem;
    }
    
    .tip-item{
      background:#fff;
      border:1px solid var(--line);
      border-radius:8px;
      padding:12px;
      margin-bottom:12px;
    }
    
    .tip-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    
    .method-badge{
      padding:4px 8px;
      border-radius:12px;
      font-size:0.75rem;
      font-weight:600;
      text-transform:uppercase;
    }
    
    .method-self{background:#e6fffa;color:#234e52}
    .method-colleague{background:#e0e7ff;color:#3730a3}
    .method-leader_employee{background:#fef3c7;color:#92400e}
    .method-group{background:#f0f9ff;color:#0c4a6e}
    .method-external{background:#fdf2f8;color:#86198f}
    .method-course{background:#f0fdf4;color:#166534}
    
    .array-editor{
      margin-top:8px;
    }
    
    .array-item{
      display:flex;
      gap:8px;
      margin-bottom:6px;
      align-items:center;
    }
    
    .array-item input{
      flex:1;
    }
    
    .textarea{
      width:100%;
      min-height:80px;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:8px;
      font-family:inherit;
      font-size:.95rem;
      resize:vertical;
    }

    /* Project table specific widths */
    .projects-table th:nth-child(1) { width: 20%; } /* Titel */
    .projects-table th:nth-child(2) { width: 15%; } /* Ejer */
    .projects-table th:nth-child(3) { width: 12%; } /* Status & Svar */
    .projects-table th:nth-child(4) { width: 12%; } /* √Öbner */
    .projects-table th:nth-child(5) { width: 12%; } /* Lukker */
    .projects-table th:nth-child(6) { width: 8%; } /* Personer */
    .projects-table th:nth-child(7) { width: 8%; } /* Link */
    .projects-table th:nth-child(8) { width: 13%; } /* Handling */

    /* Status indicators */
    .status-badge{
      display:inline-block;
      padding:4px 8px;
      border-radius:12px;
      font-size:.8rem;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    
    .status-open{background:#c6f6d5;color:#22543d}
    .status-closed{background:#fed7d7;color:#9b2c2c}
    .status-draft{background:#e6fffa;color:#234e52}

    /* Users table */
    .users-table th:nth-child(1) { width: 30%; } /* Email */
    .users-table th:nth-child(2) { width: 15%; } /* Rolle */
    .users-table th:nth-child(3) { width: 20%; } /* Oprettet */
    .users-table th:nth-child(4) { width: 35%; } /* Handling */

    /* Key generation result */
    .key-result{
      background:#e6fffa;
      border:1px solid #81e6d9;
      border-radius:var(--radius);
      padding:20px;
      margin:16px 0;
      display:none;
    }
    
    .key-result h4{
      color:#234e52;
      margin-bottom:12px;
    }
    
    .key-code{
      font-family:monospace;
      font-size:1.4rem;
      font-weight:bold;
      background:#fff;
      padding:8px 12px;
      border-radius:8px;
      display:inline-block;
      margin:8px 0;
      border:2px solid #81e6d9;
    }

    /* Responsive */
    @media(max-width:1100px){
      .grid2{grid-template-columns:1fr}
      .grid3{grid-template-columns:1fr 1fr}
      .grid4{grid-template-columns:1fr 1fr}
      table{font-size:.85rem}
      th,td{padding:8px}
      .stats-grid{grid-template-columns:1fr 1fr}
    }

    /* Success messages */
    .success-message{
      background:#d1fae5;
      border:1px solid #a7f3d0;
      color:#065f46;
      padding:12px 16px;
      border-radius:8px;
      margin:12px 0;
    }
    
    .error-message{
      background:#fef2f2;
      border:1px solid #fecaca;
      color:#dc2626;
      padding:12px 16px;
      border-radius:8px;
      margin:12px 0;
    }

    .warning-message{
      background:#fef3c7;
      border:1px solid #fde047;
      color:#92400e;
      padding:12px 16px;
      border-radius:8px;
      margin:12px 0;
    }

    /* Modal */
    .modal{
      position:fixed;
      top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.8);
      z-index:1000;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    
    .modal-content{
      background:white;
      padding:24px;
      border-radius:12px;
      max-width:90vw;
      max-height:90vh;
      overflow-y:auto;
    }

    /* Checkboxes */
    .checkbox-cell{
      width:40px;
      text-align:center;
    }
    .checkbox-cell input[type="checkbox"]{
      cursor:pointer;
    }
  </style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <div class="header">
    <div class="club-title">
      <div class="club-logo"><img src="./assets/logo.png" alt="KOMPAS" onerror="this.style.display='none'"></div>
      <div>
        <div class="club-name">KOMPAS ‚Äî Master Backoffice</div>
        <div class="club-sub">System Administration ‚Ä¢ Templates ‚Ä¢ Users ‚Ä¢ Projects ‚Ä¢ Analytics</div>
      </div>
    </div>

    <div class="header-tools" id="authArea">
      <span id="userEmail" class="muted"></span>
      <button id="logoutBtn" class="btn ghost">Log ud</button>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabbar">
    <button class="tabbtn active" data-tab="dashboard">üìä Dashboard</button>
    <button class="tabbtn" data-tab="templates">üß© Skabeloner</button>
    <button class="tabbtn" data-tab="projects">üìÅ Projekter</button>
    <button class="tabbtn" data-tab="users">üë§ Brugere</button>
    <button class="tabbtn" data-tab="coaching">üéØ Coaching</button>
    <button class="tabbtn" data-tab="maintenance">üîß Vedligeholdelse</button>
    <button class="tabbtn" data-tab="tokens">üîë Tokens</button>
    <button class="tabbtn" data-tab="invoicing">üìß Fakturering</button>

  </div>

  <!-- CONTENT -->
  <div class="content">

    <!-- Dashboard (new default) -->
    <div id="tab-dashboard" class="section" style="display:block">
      <h3>üìä System Dashboard</h3>
      
      <!-- System Statistics -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="stat-projects">0</div>
          <div class="stat-label">Aktive Projekter</div>
          <div class="stat-trend" id="stat-projects-trend"></div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="stat-users">0</div>
          <div class="stat-label">Registrerede Brugere</div>
          <div class="stat-trend" id="stat-users-trend"></div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="stat-responses">0</div>
          <div class="stat-label">Samlede Besvarelser</div>
          <div class="stat-trend" id="stat-responses-trend"></div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="stat-keys">0</div>
          <div class="stat-label">Ubrugte N√∏gler</div>
          <div class="stat-trend" id="stat-keys-trend"></div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="section">
        <h4>üöÄ Hurtige Handlinger</h4>
        <div class="grid4" style="margin-top:12px">
          <button class="btn success" onclick="quickCleanupKeys()">üóëÔ∏è Ryd Brugte N√∏gler</button>
          <button class="btn warning" onclick="quickPurgeOldProjects()">üìÅ Ryd Gamle Projekter</button>
          <button class="btn primary" onclick="exportSystemStats()">üìä Eksporter Statistik</button>
          <button class="btn" onclick="systemHealthCheck()">üîç System Sundhed</button>
        </div>
      </div>

      <!-- Recent Activity -->
      <div class="section">
        <h4>üìà Seneste Aktivitet</h4>
        <div id="recentActivity" style="margin-top:12px">
          <div class="muted">Indl√¶ser aktivitet...</div>
        </div>
      </div>

      <!-- System Health -->
      <div class="section">
        <h4>üí° System Status</h4>
        <div id="systemHealth" style="margin-top:12px">
          <div class="muted">Indl√¶ser system status...</div>
        </div>
      </div>
    </div>

    <!-- Skabeloner -->
    <div id="tab-templates" class="section" style="display:none">
      <h3>üß© Skabelon Administration</h3>
      
      <!-- Template Actions -->
      <div class="row" style="margin:16px 0">
        <input id="tmplName" class="input" placeholder="Navn p√• skabelon">
        <input id="tmplDesc" class="input" placeholder="Beskrivelse">
        <button id="createTemplate" class="btn primary">Opret skabelon</button>
        <button id="backupTemplates" class="btn warning">üíæ Backup Alle</button>
      </div>

      <div id="templateEditor" class="template-editor" style="display:none">
        <h4 id="editorTitle">Rediger skabelon</h4>
        <div id="templateContent"></div>
        <div class="row" style="margin-top:16px">
          <button id="saveTemplate" class="btn primary">Gem √¶ndringer</button>
          <button id="cancelTemplate" class="btn">Annuller</button>
          <button id="versionTemplate" class="btn warning">üíæ Gem Version</button>
        </div>
      </div>

      <h4 style="margin-top:24px">Eksisterende skabeloner</h4>
      <ul id="tmplList" style="list-style:none;display:grid;gap:8px;margin-top:8px"></ul>
    </div>

    <!-- Projekter (udvidet monitoring + administration) -->
    <div id="tab-projects" class="section" style="display:none">
      <h3>üìÅ Projektoversigt og Administration</h3>
      
      <!-- Project Controls -->
      <div class="controls-row">
        <input type="text" id="projectSearch" class="input search-box" placeholder="üîç S√∏g i projekter (titel, ejer, info...)">
        <div class="filter-group">
          <select id="projectStatusFilter" class="select">
            <option value="">Alle status</option>
            <option value="draft">Kladde</option>
            <option value="open">√Öben</option>
            <option value="closed">Lukket</option>
            <option value="expired">Udl√∏bet</option>
          </select>
          <button id="refreshProjects" class="btn small">üîÑ Opdater</button>
          <button id="cleanupProjects" class="btn small warning">üóëÔ∏è Ryd Op</button>
        </div>
      </div>
      
      <div class="section">
        <table id="projectsTbl" class="projects-table">
          <thead>
            <tr>
              <th onclick="sortProjects('title')">Titel</th>
              <th onclick="sortProjects('owner_email')">Ejer</th>
              <th onclick="sortProjects('responses')">Status & Svar</th>
              <th onclick="sortProjects('open_at')">√Öbner</th>
              <th onclick="sortProjects('close_at')">Lukker</th>
              <th onclick="sortProjects('people_count')">Personer</th>
              <th>Link</th>
              <th style="text-align:right">Handling</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Brugere (udvidet med s√∏gning og bulk operationer) -->
    <div id="tab-users" class="section" style="display:none">
      <!-- Activation Keys Section -->
      <h3>üîë Generer aktiveringsn√∏gle</h3>
      <div class="row" style="margin:16px 0">
        <input id="keyEmail" class="input" placeholder="Email til evaluator" type="email">
        <input id="keyNotes" class="input" placeholder="Valgfri note">
        <button id="generateKey" class="btn primary">Generer n√∏gle</button>
      </div>
      
      <div id="keyResult" class="key-result">
        <h4>Aktiveringsn√∏gle genereret!</h4>
        <div style="margin-top:12px">
          <p><strong>N√∏gle:</strong></p>
          <div class="key-code" id="generatedKey"></div>
          <p><strong>Email:</strong> <span id="generatedEmail"></span></p>
        </div>
        <p class="muted" style="margin-top:12px">Send denne n√∏gle til brugeren sammen med login-linket.</p>
      </div>

      <hr style="border:0;border-top:1px solid var(--line);margin:24px 0">

      <!-- Activation Keys Management -->
      <h3>üìã Aktiveringsn√∏gler</h3>
      <div class="controls-row">
        <input type="text" id="keySearch" class="input search-box" placeholder="üîç S√∏g i n√∏gler (n√∏gle, email, note...)">
        <div class="filter-group">
          <select id="keyStatusFilter" class="select">
            <option value="">Alle n√∏gler</option>
            <option value="used">Kun brugte</option>
            <option value="unused">Kun ubrugte</option>
          </select>
          <button id="cleanupUsedKeys" class="btn small warning">üóëÔ∏è Ryd Brugte</button>
          <button id="bulkDeleteKeys" class="btn small" style="background:#dc3545;color:white">‚ùå Slet Valgte</button>
        </div>
      </div>

      <!-- Bulk selection for keys -->
      <div id="keyBulkControls" class="bulk-controls">
        <span class="selection-count">0 n√∏gler valgt</span>
        <button class="btn small warning" onclick="bulkDeleteSelectedKeys()">Slet valgte</button>
        <button class="btn small" onclick="clearKeySelection()">Ryd valg</button>
      </div>
      
      <div class="section">
        <table id="keysTbl">
          <thead>
            <tr>
              <th class="checkbox-cell"><input type="checkbox" id="selectAllKeys" onchange="toggleAllKeys()"></th>
              <th onclick="sortKeys('key_code')">N√∏gle</th>
              <th onclick="sortKeys('email')">Email</th>
              <th onclick="sortKeys('used')">Status</th>
              <th onclick="sortKeys('created_at')">Oprettet</th>
              <th onclick="sortKeys('used_at')">Brugt</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <hr style="border:0;border-top:1px solid var(--line);margin:24px 0">
      
      <!-- User Management -->
      <h3>üë§ Brugeradministration</h3>
      <div class="row" style="margin:16px 0">
        <input id="userEmailInput" class="input" placeholder="Email adresse">
        <select id="userRole" class="select">
          <option value="evaluator">Evaluator (kun projekter)</option>
          <option value="programmer">Programm√∏r (fuld adgang)</option>
        </select>
        <button id="addUser" class="btn primary">Tilf√∏j rolle direkte</button>
      </div>

      <!-- User Search and Filters -->
      <div class="controls-row">
        <input type="text" id="userSearch" class="input search-box" placeholder="üîç S√∏g brugere (email, rolle...)">
        <div class="filter-group">
          <select id="userRoleFilter" class="select">
            <option value="">Alle roller</option>
            <option value="programmer">Programm√∏rer</option>
            <option value="evaluator">Evaluatorer</option>
            <option value="none">Ingen rolle</option>
          </select>
          <select id="userSortBy" class="select">
            <option value="email">Sort√©r efter email</option>
            <option value="created_at">Sort√©r efter oprettelse</option>
            <option value="role">Sort√©r efter rolle</option>
          </select>
          <button id="exportUsers" class="btn small success">üìä Eksporter Liste</button>
        </div>
      </div>

      <!-- Bulk User Operations -->
      <div id="userBulkControls" class="bulk-controls">
        <span class="selection-count">0 brugere valgt</span>
        <select id="bulkRoleChange" class="select">
          <option value="">Skift rolle...</option>
          <option value="evaluator">Til Evaluator</option>
          <option value="programmer">Til Programm√∏r</option>
          <option value="remove">Fjern rolle</option>
        </select>
        <button class="btn small primary" onclick="applyBulkRoleChange()">Anvend</button>
        <button class="btn small warning" onclick="bulkDeleteUsers()">Slet valgte</button>
        <button class="btn small" onclick="clearUserSelection()">Ryd valg</button>
      </div>

      <div class="section">
        <table id="usersTbl" class="users-table">
          <thead>
            <tr>
              <th class="checkbox-cell"><input type="checkbox" id="selectAllUsers" onchange="toggleAllUsers()"></th>
              <th onclick="sortUsers('email')">Email</th>
              <th onclick="sortUsers('role')">Rolle</th>
              <th onclick="sortUsers('created_at')">Oprettet</th>
              <th style="text-align:right">Handling</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="tab-invoicing" class="section" style="display:none">
      <h3>üìß Fakturering & Regnskab</h3>

      <!-- Periode valg -->
      <div class="section" style="background:#fff; margin-top:10px;">
        <div style="display:grid; grid-template-columns: repeat(4, minmax(150px, 1fr)); gap:12px; align-items:end;">
          <label>Periode
            <select id="inv-period" class="select">
              <option value="last_month">Forrige m√•ned</option>
              <option value="q1">Q1 (Jan-Mar)</option>
              <option value="q2">Q2 (Apr-Jun)</option>
              <option value="q3">Q3 (Jul-Sep)</option>
              <option value="q4">Q4 (Okt-Dec)</option>
              <option value="last_year">Sidste √•r</option>
              <option value="custom">Brugerdefineret</option>
            </select>
          </label>
          <label>√Ör
            <select id="inv-year" class="select">
              <option value="2025">2025</option>
              <option value="2024">2024</option>
              <option value="2023">2023</option>
            </select>
          </label>
          <label id="custom-dates" style="display:none;">Fra - Til
            <div style="display:flex; gap:4px;">
              <input id="inv-start" class="input" type="date" style="flex:1;">
              <input id="inv-end" class="input" type="date" style="flex:1;">
            </div>
          </label>
          <div>
            <button id="btn-load-invoices" class="btn">Opdater</button>
            <button id="btn-export-accounting" class="btn ghost">Export regnskab</button>
          </div>
        </div>
      </div>

      <!-- Regnskabsoversigt -->
      <div class="section" style="background:#f8f9fa; margin-top:10px;">
        <h4>üìà Regnskabsoversigt</h4>
        <div id="accounting-summary" class="muted">V√¶lg periode for at se data...</div>
      </div>

      <!-- Filtre for fakturaer -->
      <div class="section" style="background:#fff; margin-top:10px;">
        <h4>üßæ Fakturaer (kun abonnement-kunder)</h4>
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
          <label><input type="checkbox" id="filter-new" checked> Kun nye (ikke faktureret)</label>
          <label><input type="checkbox" id="filter-unpaid"> Kun ubetalte</label>
          <label><input type="checkbox" id="filter-usage" checked> Kun forbrug > 0</label>
        </div>
        <div id="invoice-summary" class="muted" style="margin-top:8px;"></div>
      </div>

      <!-- Faktura tabel -->
      <div class="section" style="background:#fff; margin-top:10px; overflow:auto;">
        <table id="invoice-table" class="table" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding:6px;">Email</th>
              <th style="text-align:right; padding:6px;">Tokens</th>
              <th style="text-align:right; padding:6px;">Bel√∏b</th>
              <th style="text-align:left; padding:6px;">Status</th>
              <th style="text-align:left; padding:6px;">Sendt</th>
              <th style="text-align:left; padding:6px;">Handlinger</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    
    <!-- Coaching  -->
    <div id="tab-coaching" class="section" style="display:none">
      <h3>üéØ Coaching Administration</h3>
      
      <!-- Coaching Controls -->
      <div class="row" style="margin:16px 0">
        <select id="coachingTemplateSelect" class="select">
          <option value="">-- V√¶lg skabelon --</option>
        </select>
        <button id="backupCoaching" class="btn warning">üíæ Backup Coaching Data</button>
        <button id="importCoaching" class="btn success">üì• Import Coaching Data</button>
        <input type="file" id="coachingFileInput" accept=".json" style="display:none">
      </div>

      <!-- Status messages -->
      <div id="coachingStatus"></div>

      <!-- Coaching categories container -->
      <div id="coachingCategoriesContainer">
        <p class="muted" style="text-align:center;padding:40px">V√¶lg en skabelon for at administrere coaching indhold</p>
      </div>
    </div>

    <div id="tab-tokens" class="section" style="display:none">
      <h3>üîí Token & Abonnement</h3>

      <!-- Filtre -->
      <div class="section" style="background:#fff; margin-top:10px;">
        <div style="display:grid; grid-template-columns: repeat(3, minmax(180px, 1fr)); gap:12px;">
          <label>Plan
            <select id="flt-plan" class="select">
              <option value="">Alle</option>
              <option value="subscription">Abonnement (ubegr√¶nset)</option>
              <option value="prepaid">Forudbetalt (tokens)</option>
            </select>
          </label>
          <label>Saldo
            <select id="flt-balance" class="select">
              <option value="">Alle</option>
              <option value="positive">Har tokens (&gt; 0)</option>
              <option value="zero">Ingen tokens (= 0)</option>
              <option value="negative">I minus (&lt; 0)</option>
            </select>
          </label>
          <label>Periode for forbrug (dage)
            <input id="flt-days" class="input" type="number" min="1" value="30">
          </label>
        </div>
        <div style="margin-top:10px;">
          <button id="btn-load-overview" class="btn">Opdater</button>
          <button id="btn-export-csv" class="btn ghost">Export CSV</button>
        </div>
        <div id="overview-summary" class="muted" style="margin-top:8px"></div>
      </div>

      <!-- Oversigtstabel -->
      <div class="section" style="background:#fff; margin-top:10px; overflow:auto;">
        <table id="overview-table" class="table" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding:6px;">Email</th>
              <th style="text-align:left; padding:6px;">Plan</th>
              <th style="text-align:right; padding:6px;">Saldo</th>
              <th style="text-align:right; padding:6px;">Forbrug (periode)</th>
              <th style="text-align:left; padding:6px;">Sidste forbrug</th>
              <th style="text-align:left; padding:6px;">Hurtig tildeling</th>
              <th style="text-align:left; padding:6px;">Detaljer</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Dine eksisterende bokse: Skift plan / Tildel tokens -->
      <div class="grid2" style="margin-top:12px">
        <div class="section" style="background:#fff">
          <h4>Skift plan</h4>
          <label>Email
            <input id="tok-email" class="input" placeholder="bruger@dom√¶ne.dk">
          </label>
          <label>Plan
            <select id="tok-plan" class="select">
              <option value="subscription">Abonnement (ubegr√¶nset)</option>
              <option value="prepaid">Forudbetalt (tokens)</option>
            </select>
          </label>
          <label>Start-saldo (kun ved forudbetalt)
            <input id="tok-start" class="input" type="number" value="0">
          </label>
          <button id="tok-save" class="btn primary">Gem plan</button>
          <div id="tok-plan-msg" class="muted" style="margin-top:8px"></div>
        </div>

        <div class="section" style="background:#fff">
          <h4>Tildel tokens</h4>
          <label>Email
            <input id="grant-email" class="input" placeholder="bruger@dom√¶ne.dk">
          </label>
          <label>Antal tokens
            <input id="grant-qty" class="input" type="number" value="5">
          </label>
          <label>Note
            <input id="grant-note" class="input" placeholder="fx 'Kampagne'">
          </label>
          <button id="grant-save" class="btn success">Tildel</button>
          <div id="grant-msg" class="muted" style="margin-top:8px"></div>
        </div>
      </div>

      <!-- Ledger-dialog -->
      <dialog id="dlg-ledger" style="width:min(860px,95vw); border:0; border-radius:12px; padding:16px;">
        <h4>Ledger for <span id="dlg-email"></span></h4>
        <div id="ledger-wrap" style="max-height:60vh; overflow:auto; margin-top:8px;"></div>
        <div style="margin-top:12px; text-align:right;">
          <button id="dlg-close" class="btn">Luk</button>
        </div>
      </dialog>
    </div>



    <!-- Maintenance (new tab) -->
    <div id="tab-maintenance" class="section" style="display:none">
      <h3>üîß System Vedligeholdelse</h3>
      
      <!-- Database Cleanup -->
      <div class="section">
        <h4>üóëÔ∏è Database Oprydning</h4>
        <div class="grid3" style="margin-top:12px">
          <button class="btn warning" onclick="purgeExpiredProjects()">Ryd Udl√∏bne Projekter</button>
          <button class="btn warning" onclick="cleanupOrphanedData()">Ryd For√¶ldrel√∏se Data</button>
          <button class="btn warning" onclick="compactDatabase()">Kompakt√©r Database</button>
        </div>
        <div id="cleanupProgress" style="margin-top:12px;display:none">
          <div class="progress-bar">
            <div class="progress-fill" id="cleanupProgressFill"></div>
          </div>
          <div class="muted" id="cleanupProgressText">Behandler...</div>
        </div>
      </div>

      <!-- Backup & Export -->
      <div class="section">
        <h4>üíæ Backup & Export</h4>
        <div class="grid3" style="margin-top:12px">
          <button class="btn success" onclick="exportFullSystem()">üì¶ Fuld System Export</button>
          <button class="btn success" onclick="exportTemplates()">üß© Eksporter Skabeloner</button>
          <button class="btn success" onclick="exportCoachingData()">üéØ Eksporter Coaching Data</button>
        </div>
      </div>

      <!-- Content Versioning -->
      <div class="section">
        <h4>üìö Content Versionering</h4>
        <div class="controls-row">
          <select id="versionTypeFilter" class="select">
            <option value="">Alle typer</option>
            <option value="template">Skabeloner</option>
            <option value="coaching">Coaching</option>
            <option value="system">System</option>
          </select>
          <button class="btn small primary" onclick="createSystemSnapshot()">üì∏ Opret Snapshot</button>
          <button class="btn small" onclick="loadVersionHistory()">üîÑ Opdater Liste</button>
        </div>
        
        <div id="versionHistory" style="margin-top:16px">
          <div class="muted">Indl√¶ser versionshistorik...</div>
        </div>
      </div>

      <!-- System Monitoring -->
      <div class="section">
        <h4>üìä System Monitoring</h4>
        <div id="systemMetrics" style="margin-top:12px">
          <div class="muted">Indl√¶ser system metrics...</div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
window.addEventListener('load', function() {
  let user = null;
  let currentTemplate = null;
  let currentCoachingTemplate = null;
  let coachingData = {};
  let currentSort = { column: null, direction: 'asc' };
  let filteredData = { projects: [], users: [], keys: [] };

  const SUPABASE_URL = "https://wsrstyrsuwhcmmlmnbrz.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzcnN0eXJzdXdoY21tbG1uYnJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MTU0NTIsImV4cCI6MjA3MTE5MTQ1Mn0.Rf3Z3bQGjV5CKXKZr6IMOjzPdbhVJCh3SwuvlkpxUD0";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id) => document.getElementById(id);
  
  // Tabs switching
  document.querySelectorAll('.tabbtn').forEach(btn => {
    btn.onclick = () => {
      // Remove active from all tabs
      document.querySelectorAll('.tabbtn').forEach(x => x.classList.remove('active'));
      btn.classList.add('active');

      // Hide all sections
      ['dashboard', 'templates', 'projects', 'users', 'coaching', 'maintenance', 'tokens'].forEach(name => {
        const panel = $('tab-' + name);
        if(panel) panel.style.display = 'none';
      });


      // Show selected section
      const target = $('tab-' + btn.dataset.tab);
      if(target) target.style.display = 'block';
      
      // Load data when coaching or maintenance tab is selected
      if(btn.dataset.tab === 'coaching') {
        loadCoachingTemplates();
      } else if(btn.dataset.tab === 'maintenance') {
        loadVersionHistory();
        loadSystemMetrics();
      }
    };
  });

  // Auth and logout
  $('logoutBtn').onclick = async () => { 
    await supabase.auth.signOut(); 
    window.location.href = 'login.html';
  };

  // Auth guard - only 'programmer' role allowed
  async function guard() {
    const { data: u } = await supabase.auth.getUser();
    if(!u?.user){ 
      window.location.href = 'login.html'; 
      return;
    }
    
    const { data: roleData } = await supabase
      .from('user_roles')
      .select('role')
      .eq('user_id', u.user.id)
      .single();

    if(roleData?.role !== 'programmer'){
      // Logged in but not master => send to admin
      window.location.href = 'admin.html';
      return;
    }

    user = u.user;
    const emailEl = $('userEmail');
    if(emailEl) emailEl.textContent = user.email || '';
    await loadAll();
  }

  // Run auth guard on load
  guard();

  async function loadAll() { 
    await loadDashboard();
    await loadTemplates(); 
    await loadProjects(); 
    await loadUsers();
    setupSearchAndFilters();
  }

  // === DASHBOARD FUNCTIONS ===
  async function loadDashboard() {
    try {
      // Load basic statistics
      const [
        { data: projects, count: projectCount },
        { data: users, count: userCount },
        { data: responses, count: responseCount },
        { data: keys }
      ] = await Promise.all([
        supabase.from('projects').select('*', { count: 'exact' }),
        supabase.from('user_roles').select('*', { count: 'exact' }),
        supabase.from('responses').select('id', { count: 'exact' }),
        supabase.from('v_activation_keys').select('*').eq('used', false)
      ]);

      // Update stat cards
      $('stat-projects').textContent = projectCount || 0;
      $('stat-users').textContent = userCount || 0;
      $('stat-responses').textContent = responseCount || 0;
      $('stat-keys').textContent = keys?.length || 0;

      // Calculate trends (simplified)
      const activeProjects = projects?.filter(p => {
        const now = new Date();
        const openAt = p.open_at ? new Date(p.open_at) : null;
        const closeAt = p.close_at ? new Date(p.close_at) : null;
        return openAt && closeAt && now >= openAt && now <= closeAt;
      }).length || 0;

      $('stat-projects-trend').innerHTML = `<span class="trend-up">‚ñ≤ ${activeProjects} aktive</span>`;

      // Load recent activity
      await loadRecentActivity();
      
      // Load system health
      await loadSystemHealth();

    } catch (error) {
      console.error('Dashboard load error:', error);
    }
  }

  async function loadRecentActivity() {
    try {
      const { data: recentProjects } = await supabase
        .from('projects')
        .select('title, created_at, owner')
        .order('created_at', { ascending: false })
        .limit(5);

      const { data: recentKeys } = await supabase
        .from('v_activation_keys')
        .select('email, created_at, used_at')
        .order('created_at', { ascending: false })
        .limit(5);

      let activityHtml = '<div style="max-height:200px;overflow-y:auto">';
      
      if (recentProjects && recentProjects.length > 0) {
        activityHtml += '<h5>üìÅ Seneste Projekter:</h5>';
        recentProjects.forEach(p => {
          const date = new Date(p.created_at).toLocaleDateString('da-DK');
          activityHtml += `<div style="margin:4px 0;padding:4px 0;border-bottom:1px solid var(--line)">
            <strong>${p.title}</strong> oprettet ${date}
          </div>`;
        });
      }

      if (recentKeys && recentKeys.length > 0) {
        activityHtml += '<h5 style="margin-top:12px">üîë Seneste N√∏gler:</h5>';
        recentKeys.forEach(k => {
          const date = new Date(k.created_at).toLocaleDateString('da-DK');
          const status = k.used_at ? 'brugt' : 'ubrugt';
          activityHtml += `<div style="margin:4px 0;padding:4px 0;border-bottom:1px solid var(--line)">
            N√∏gle til <strong>${k.email}</strong> ${status} (${date})
          </div>`;
        });
      }

      activityHtml += '</div>';
      $('recentActivity').innerHTML = activityHtml;

    } catch (error) {
      $('recentActivity').innerHTML = '<div class="error-message">Fejl ved indl√¶sning af aktivitet</div>';
    }
  }

  async function loadSystemHealth() {
    try {
      // Check for various system health indicators
      const healthChecks = [];

      // Check for old unused keys
      const { data: oldKeys } = await supabase
        .from('v_activation_keys')
        .select('*')
        .eq('used', false)
        .lt('created_at', new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString());

      if (oldKeys && oldKeys.length > 0) {
        healthChecks.push({
          type: 'warning',
          message: `${oldKeys.length} ubrugte n√∏gler er √¶ldre end 30 dage`,
          action: 'cleanupOldKeys'
        });
      }

      // Check for projects without responses
      const { data: emptyProjects } = await supabase
        .from('projects')
        .select(`
          id, title,
          responses(id)
        `)
        .eq('responses.id', null);

      if (emptyProjects && emptyProjects.length > 0) {
        healthChecks.push({
          type: 'info',
          message: `${emptyProjects.length} projekter uden besvarelser`,
          action: null
        });
      }

      // Display health status
      let healthHtml = '';
      if (healthChecks.length === 0) {
        healthHtml = '<div style="color:var(--success)">‚úÖ System status: Alt fungerer normalt</div>';
      } else {
        healthChecks.forEach(check => {
          const icon = check.type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
          const color = check.type === 'warning' ? 'var(--warning)' : 'var(--brand)';
          healthHtml += `<div style="color:${color};margin:4px 0">${icon} ${check.message}</div>`;
        });
      }

      $('systemHealth').innerHTML = healthHtml;

    } catch (error) {
      $('systemHealth').innerHTML = '<div class="error-message">Fejl ved system sundhedstjek</div>';
    }
  }

  // Quick action functions
  window.quickCleanupKeys = async () => {
    if (!confirm('Slet alle brugte aktiveringsn√∏gler? Dette kan ikke fortrydes.')) return;
    
    try {
      const { data, error } = await supabase
        .from('activation_keys')
        .delete()
        .eq('used', true);

      if (error) throw error;
      
      alert('‚úÖ Brugte n√∏gler slettet');
      await loadDashboard();
      await loadUsers();
    } catch (error) {
      alert('‚ùå Fejl: ' + error.message);
    }
  };

  window.quickPurgeOldProjects = async () => {
    if (!confirm('Ryd alle udl√∏bne projekter? Dette sletter projekter hvor purge_at dato er overskredet.')) return;
    
    try {
      const { data, error } = await supabase.rpc('purge_expired_projects');
      if (error) throw error;
      
      alert('‚úÖ Gamle projekter ryddet');
      await loadDashboard();
      await loadProjects();
    } catch (error) {
      alert('‚ùå Fejl: ' + error.message);
    }
  };

  window.exportSystemStats = async () => {
    try {
      const [
        { data: projects },
        { data: users },
        { data: responses },
        { data: keys }
      ] = await Promise.all([
        supabase.from('projects').select('*'),
        supabase.from('v_users_with_roles').select('*'),
        supabase.from('responses').select('*'),
        supabase.from('v_activation_keys').select('*')
      ]);

      const stats = {
        export_date: new Date().toISOString(),
        projects: {
          total: projects?.length || 0,
          active: projects?.filter(p => {
            const now = new Date();
            const openAt = p.open_at ? new Date(p.open_at) : null;
            const closeAt = p.close_at ? new Date(p.close_at) : null;
            return openAt && closeAt && now >= openAt && now <= closeAt;
          }).length || 0
        },
        users: {
          total: users?.length || 0,
          programmers: users?.filter(u => u.role === 'programmer').length || 0,
          evaluators: users?.filter(u => u.role === 'evaluator').length || 0
        },
        responses: {
          total: responses?.length || 0
        },
        keys: {
          total: keys?.length || 0,
          used: keys?.filter(k => k.used).length || 0,
          unused: keys?.filter(k => !k.used).length || 0
        }
      };

      const blob = new Blob([JSON.stringify(stats, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `kompas_system_stats_${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

    } catch (error) {
      alert('‚ùå Fejl ved eksport: ' + error.message);
    }
  };

  window.systemHealthCheck = async () => {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
      <div class="modal-content">
        <h3>üîç System Sundhedstjek</h3>
        <div id="healthCheckResults" style="margin-top:16px">
          <div>K√∏rer sundhedstjek...</div>
        </div>
        <button class="btn" onclick="this.parentElement.parentElement.remove()" style="margin-top:16px">Luk</button>
      </div>
    `;
    document.body.appendChild(modal);

    try {
      const results = [];

      // Check database integrity
      const { data: orphanedResponses } = await supabase
        .from('responses')
        .select('id')
        .not('project_id', 'in', '(SELECT id FROM projects)');

      if (orphanedResponses && orphanedResponses.length > 0) {
        results.push(`‚ö†Ô∏è ${orphanedResponses.length} for√¶ldrel√∏se besvarelser fundet`);
      }

      // Check for projects without links
      const { data: projectsWithoutLinks } = await supabase
        .from('projects')
        .select('id, title')
        .not('id', 'in', '(SELECT project_id FROM project_link)');

      if (projectsWithoutLinks && projectsWithoutLinks.length > 0) {
        results.push(`‚ÑπÔ∏è ${projectsWithoutLinks.length} projekter mangler links`);
      }

      const resultsHtml = results.length > 0 
        ? results.map(r => `<div style="margin:8px 0">${r}</div>`).join('')
        : '<div style="color:var(--success)">‚úÖ Ingen problemer fundet</div>';

      $('healthCheckResults').innerHTML = resultsHtml;

    } catch (error) {
      $('healthCheckResults').innerHTML = `<div class="error-message">Fejl: ${error.message}</div>`;
    }
  };

  // === SEARCH AND FILTER SETUP ===
  function setupSearchAndFilters() {
    // Project search
    $('projectSearch')?.addEventListener('input', debounce(filterProjects, 300));
    $('projectStatusFilter')?.addEventListener('change', filterProjects);

    // User search
    $('userSearch')?.addEventListener('input', debounce(filterUsers, 300));
    $('userRoleFilter')?.addEventListener('change', filterUsers);
    $('userSortBy')?.addEventListener('change', filterUsers);

    // Key search
    $('keySearch')?.addEventListener('input', debounce(filterKeys, 300));
    $('keyStatusFilter')?.addEventListener('change', filterKeys);
  }

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // === TEMPLATES ===
  async function loadTemplates(){
    const { data } = await supabase.from('templates').select().order('created_at',{ascending:false});
    
    // List display with edit/delete buttons
    const ul = $('tmplList'); 
    ul.innerHTML = ''; 
    (data || []).forEach(t => { 
      const li = document.createElement('li'); 
      li.className = 'section'; 
      li.style.display = 'flex';
      li.style.justifyContent = 'space-between';
      li.style.alignItems = 'center';
      li.innerHTML = `
        <div>
          <strong>${t.name}</strong> v${t.version}<br>
          <span class="muted">${t.description || ''}</span>
        </div>
        <div class="row">
          <button class="btn small" onclick="editTemplate('${t.id}')" style="background:var(--brand);color:white;border-color:var(--brand)">Rediger</button>
          <button class="btn small warning" onclick="versionTemplate('${t.id}')">üíæ Version</button>
          <button class="btn small" onclick="deleteTemplate('${t.id}', '${t.name.replace(/'/g, '\\\'')}')" style="background:#dc3545;color:white;border-color:#dc3545">Slet</button>
        </div>
      `; 
      ul.appendChild(li); 
    });
  }

  // Template creation
  $('createTemplate').onclick = async () => {
    const name = $('tmplName').value.trim();
    const desc = $('tmplDesc').value.trim();
    if(!name) return alert('Navn p√•kr√¶vet');
    
    const { data, error } = await supabase.from('templates').insert({
      name, description: desc, version: 1
    }).select().single();
    
    if(error) return alert(error.message);
    
    $('tmplName').value = '';
    $('tmplDesc').value = '';
    loadTemplates();
    alert('Skabelon oprettet!');
  };

  // Backup templates
  $('backupTemplates').onclick = async () => {
    try {
      const { data: templates } = await supabase.from('templates').select(`
        *,
        domains(*, categories(*, questions(*)))
      `);

      const backup = {
        backup_date: new Date().toISOString(),
        backup_type: 'templates',
        data: templates
      };

      const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `kompas_templates_backup_${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

    } catch (error) {
      alert('‚ùå Backup fejlede: ' + error.message);
    }
  };

  // Version template
  window.versionTemplate = async (templateId) => {
    const comment = prompt('Versionskommentar for ny KOMPAS version:');
    if (!comment) return;

    try {
      // Hent current template info
      const { data: currentTemplate } = await supabase
        .from('templates')
        .select('*')
        .eq('id', templateId)
        .single();

      if (!currentTemplate) throw new Error('Template ikke fundet');

      // Find n√¶ste version nummer
      const { data: existingVersions } = await supabase
        .from('template_versions')
        .select('version_number')
        .eq('template_id', templateId)
        .order('version_number', { ascending: false });

      const nextVersion = (existingVersions?.[0]?.version_number || currentTemplate.version || 0) + 1;
      const baseName = currentTemplate.base_template_name || 'KOMPAS';

      // Opret ny version af templaten
      const { data: newTemplate, error: insertError } = await supabase
        .from('templates')
        .insert({
          name: `${baseName} v${nextVersion}.0`,
          base_template_name: baseName,
          description: `${currentTemplate.description} (Version ${nextVersion})`,
          version: nextVersion,
          is_active: true,
          created_by: user?.id
        })
        .select()
        .single();

      if (insertError) throw insertError;

      // Registrer version i versions tabel
      const { error: versionError } = await supabase
        .from('template_versions')
        .insert({
          template_id: newTemplate.id,
          version_number: nextVersion,
          comment: comment,
          created_by: user?.id
        });

      if (versionError) throw versionError;

      // Kopi√©r template indhold (domains, categories, questions)
      await duplicateTemplateContent(templateId, newTemplate.id);

      alert(`‚úÖ ${baseName} v${nextVersion}.0 oprettet succesfuldt`);
      loadTemplates();

    } catch (error) {
      console.error('Versioning fejl:', error);
      alert('‚ùå Fejl ved oprettelse af version: ' + error.message);
    }
  };

  // Hj√¶lpefunktion til at kopiere template indhold
  async function duplicateTemplateContent(sourceTemplateId, targetTemplateId) {
    try {
      // Kopi√©r domains
      const { data: domains } = await supabase
        .from('domains')
        .select('name, sort_order')
        .eq('template_id', sourceTemplateId);

      for (const domain of domains || []) {
        const { data: newDomain } = await supabase
          .from('domains')
          .insert({
            template_id: targetTemplateId,
            name: domain.name,
            sort_order: domain.sort_order
          })
          .select()
          .single();

        // Kopi√©r categories for dette domain
        const { data: categories } = await supabase
          .from('categories')
          .select('name, sort_order')
          .eq('domain_id', (await supabase
            .from('domains')
            .select('id')
            .eq('template_id', sourceTemplateId)
            .eq('name', domain.name)
            .single()
          ).data.id);

        for (const category of categories || []) {
          const { data: newCategory } = await supabase
            .from('categories')
            .insert({
              domain_id: newDomain.id,
              name: category.name,
              sort_order: category.sort_order
            })
            .select()
            .single();

          // Kopi√©r questions for denne category
          const { data: questions } = await supabase
            .from('questions')
            .select('text, is_lite, scale_min, scale_max, weight, sort_order')
            .eq('category_id', (await supabase
              .from('categories')
              .select('id')
              .eq('domain_id', (await supabase
                .from('domains')
                .select('id')
                .eq('template_id', sourceTemplateId)
                .eq('name', domain.name)
                .single()
              ).data.id)
              .eq('name', category.name)
              .single()
            ).data.id);

          for (const question of questions || []) {
            await supabase
              .from('questions')
              .insert({
                category_id: newCategory.id,
                text: question.text,
                is_lite: question.is_lite,
                scale_min: question.scale_min,
                scale_max: question.scale_max,
                weight: question.weight,
                sort_order: question.sort_order
              });
          }
        }
      }
    } catch (error) {
      console.error('Fejl ved kopiering af template indhold:', error);
      throw error;
    }
  }

  // [Rest of template functions remain the same as in original]
  // Template editor - direct edit mode
  window.editTemplate = async (templateId) => {
    // Load full template structure
    const { data: template } = await supabase.from('templates').select('*').eq('id', templateId).single();
    const { data: domains } = await supabase.from('domains').select('*').eq('template_id', templateId).order('sort_order');
    const { data: categories } = await supabase.from('categories').select('*,domain_id').order('sort_order');
    const { data: questions } = await supabase.from('questions').select('*,category_id').order('sort_order');
    
    currentTemplate = { template, domains, categories, questions };
    renderTemplateEditor();
  };

  // Delete template
  window.deleteTemplate = async (templateId, templateName) => {
    if(!confirm(`Er du sikker p√• du vil slette skabelonen "${templateName}"?\n\nDenne handling kan ikke fortrydes!`)) return;
    
    try {
      const { error } = await supabase.from('templates').delete().eq('id', templateId);
      if(error) throw error;
      
      alert(`Skabelon "${templateName}" er slettet`);
      loadTemplates();
      
      // If we were editing this template, hide the editor
      if (currentTemplate && currentTemplate.template.id === templateId) {
        $('templateEditor').style.display = 'none';
        currentTemplate = null;
      }
      
    } catch(error) {
      alert('Fejl ved sletning: ' + error.message);
    }
  };

  function renderTemplateEditor() {
    const editor = $('templateEditor');
    const content = $('templateContent');
    editor.style.display = 'block';
    content.innerHTML = '';
    
    if(!currentTemplate) return;
    
    // Update editor title
    $('editorTitle').textContent = `Rediger skabelon: ${currentTemplate.template.name}`;
    
    // Template basic info
    const templateBasic = document.createElement('div');
    templateBasic.className = 'section';
    templateBasic.style.marginBottom = '20px';
    templateBasic.innerHTML = `
      <h4>Grundl√¶ggende information</h4>
      <div class="grid2" style="margin-top:12px">
        <label>Skabelon navn
          <input type="text" id="edit-template-name" class="input" value="${currentTemplate.template.name || ''}">
        </label>
        <label>Beskrivelse
          <input type="text" id="edit-template-desc" class="input" value="${currentTemplate.template.description || ''}">
        </label>
      </div>
    `;
    content.appendChild(templateBasic);
    
    // Domains and their content
    currentTemplate.domains.forEach((domain, domainIndex) => {
      const domainDiv = document.createElement('div');
      domainDiv.className = 'domain-section';
      domainDiv.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
          <input type="text" class="input" value="${domain.name}" onchange="updateDomainName(${domainIndex}, this.value)" style="flex:1">
          <button class="btn small" onclick="deleteDomain(${domainIndex})" style="background:#dc3545;color:white;border-color:#dc3545">Slet dom√¶ne</button>
        </div>
      `;
      
      const domainCats = currentTemplate.categories.filter(c => c.domain_id === domain.id);
      domainCats.forEach((category, catIndex) => {
        const catDiv = document.createElement('div');
        catDiv.className = 'category-item';
        catDiv.innerHTML = `
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
            <input type="text" class="input" value="${category.name}" onchange="updateCategoryName('${category.id}', this.value)" style="flex:1">
            <button class="btn small" onclick="deleteCategory('${category.id}')" style="background:#dc3545;color:white;border-color:#dc3545;font-size:0.7rem">Slet</button>
          </div>
        `;
        
        const questionsContainer = document.createElement('div');
        questionsContainer.style.marginLeft = '16px';
        
        const catQuestions = currentTemplate.questions.filter(q => q.category_id === category.id);
        catQuestions.forEach((question) => {
          const qDiv = document.createElement('div');
          qDiv.className = 'question-item';
          qDiv.innerHTML = `
            <div style="margin-bottom:8px">
              <textarea class="input" onchange="updateQuestionText('${question.id}', this.value)" style="width:100%;min-height:60px;resize:vertical">${question.text}</textarea>
              <div style="display:flex;align-items:center;gap:8px;margin-top:4px">
                <label style="display:flex;align-items:center;gap:4px;font-size:0.85rem">
                  <input type="checkbox" ${question.is_lite ? 'checked' : ''} onchange="updateQuestionLite('${question.id}', this.checked)">
                  LITE version
                </label>
                <div style="flex:1"></div>
                <button class="btn small" onclick="deleteQuestion('${question.id}')" style="background:#dc3545;color:white;border-color:#dc3545;font-size:0.7rem">Slet sp√∏rgsm√•l</button>
              </div>
            </div>
          `;
          questionsContainer.appendChild(qDiv);
        });
        
        // Add question button
        const addQBtn = document.createElement('button');
        addQBtn.className = 'btn small';
        addQBtn.textContent = '+ Tilf√∏j sp√∏rgsm√•l';
        addQBtn.style.marginTop = '8px';
        addQBtn.onclick = () => addQuestion(category.id);
        questionsContainer.appendChild(addQBtn);
        
        catDiv.appendChild(questionsContainer);
        domainDiv.appendChild(catDiv);
      });
      
      // Add category button
      const addCatBtn = document.createElement('button');
      addCatBtn.className = 'btn small';
      addCatBtn.textContent = '+ Tilf√∏j kategori';
      addCatBtn.style.marginTop = '12px';
      addCatBtn.onclick = () => addCategory(domain.id);
      domainDiv.appendChild(addCatBtn);
      
      content.appendChild(domainDiv);
    });
    
    // Add domain button
    const addDomainBtn = document.createElement('button');
    addDomainBtn.className = 'btn';
    addDomainBtn.textContent = '+ Tilf√∏j dom√¶ne';
    addDomainBtn.style.marginTop = '20px';
    addDomainBtn.onclick = addDomain;
    content.appendChild(addDomainBtn);
  }

  // Template save handler - now updates existing template
  $('saveTemplate').onclick = async () => {
    if(!currentTemplate) return alert('Ingen template indl√¶st');
    
    try {
      // Get updated basic info
      const newName = $('edit-template-name').value.trim();
      const newDesc = $('edit-template-desc').value.trim();
      
      if(!newName) return alert('Template navn p√•kr√¶vet');
      
      // Update existing template
      const { error: templateError } = await supabase
        .from('templates')
        .update({
          name: newName,
          description: newDesc
        })
        .eq('id', currentTemplate.template.id);
      
      if (templateError) throw templateError;
      
      // Delete existing domains, categories, and questions for this template
      const { error: deleteError } = await supabase
        .from('domains')
        .delete()
        .eq('template_id', currentTemplate.template.id);
      
      if (deleteError) throw deleteError;
      
      // Save updated domains
      for (let i = 0; i < currentTemplate.domains.length; i++) {
        const domain = currentTemplate.domains[i];
        const { data: newDomain, error: domainError } = await supabase
          .from('domains')
          .insert({
            template_id: currentTemplate.template.id,
            name: domain.name,
            sort_order: i + 1
          })
          .select()
          .single();
        
        if (domainError) throw domainError;
        
        // Save categories for this domain
        const domainCategories = currentTemplate.categories.filter(c => c.domain_id === domain.id);
        for (let j = 0; j < domainCategories.length; j++) {
          const category = domainCategories[j];
          const { data: newCategory, error: categoryError } = await supabase
            .from('categories')
            .insert({
              domain_id: newDomain.id,
              name: category.name,
              sort_order: j + 1
            })
            .select()
            .single();
          
          if (categoryError) throw categoryError;
          
          // Save questions for this category
          const categoryQuestions = currentTemplate.questions.filter(q => q.category_id === category.id);
          for (let k = 0; k < categoryQuestions.length; k++) {
            const question = categoryQuestions[k];
            const { error: questionError } = await supabase
              .from('questions')
              .insert({
                category_id: newCategory.id,
                text: question.text,
                is_lite: question.is_lite,
                sort_order: k + 1
              });
            
            if (questionError) throw questionError;
          }
        }
      }
      
      alert(`Skabelon "${newName}" er opdateret`);
      loadTemplates();
      
      // Hide editor
      $('templateEditor').style.display = 'none';
      currentTemplate = null;
      
    } catch (error) {
      alert('Fejl ved gem: ' + error.message);
    }
  };

  // Template editing functions
  window.updateDomainName = (domainIndex, newName) => {
    if(currentTemplate && currentTemplate.domains[domainIndex]) {
      currentTemplate.domains[domainIndex].name = newName;
    }
  };

  window.updateCategoryName = (categoryId, newName) => {
    if(currentTemplate) {
      const category = currentTemplate.categories.find(c => c.id === categoryId);
      if(category) category.name = newName;
    }
  };

  window.updateQuestionText = (questionId, newText) => {
    if(currentTemplate) {
      const question = currentTemplate.questions.find(q => q.id === questionId);
      if(question) question.text = newText;
    }
  };

  window.updateQuestionLite = (questionId, isLite) => {
    if(currentTemplate) {
      const question = currentTemplate.questions.find(q => q.id === questionId);
      if(question) question.is_lite = isLite;
    }
  };

  window.deleteDomain = (domainIndex) => {
    if(!confirm('Slet dette dom√¶ne og alt indhold?')) return;
    
    if(currentTemplate && currentTemplate.domains[domainIndex]) {
      const domainId = currentTemplate.domains[domainIndex].id;
      
      // Remove domain
      currentTemplate.domains.splice(domainIndex, 1);
      
      // Remove categories in this domain
      currentTemplate.categories = currentTemplate.categories.filter(c => c.domain_id !== domainId);
      
      // Remove questions in categories that belonged to this domain
      const categoryIds = currentTemplate.categories.filter(c => c.domain_id === domainId).map(c => c.id);
      currentTemplate.questions = currentTemplate.questions.filter(q => !categoryIds.includes(q.category_id));
      
      renderTemplateEditor();
    }
  };

  window.deleteCategory = (categoryId) => {
    if(!confirm('Slet denne kategori og alle sp√∏rgsm√•l?')) return;
    
    if(currentTemplate) {
      // Remove category
      currentTemplate.categories = currentTemplate.categories.filter(c => c.id !== categoryId);
      
      // Remove questions in this category
      currentTemplate.questions = currentTemplate.questions.filter(q => q.category_id !== categoryId);
      
      renderTemplateEditor();
    }
  };

  window.deleteQuestion = (questionId) => {
    if(!confirm('Slet dette sp√∏rgsm√•l?')) return;
    
    if(currentTemplate) {
      currentTemplate.questions = currentTemplate.questions.filter(q => q.id !== questionId);
      renderTemplateEditor();
    }
  };

  window.addQuestion = (categoryId) => {
    const text = prompt('Indtast sp√∏rgsm√•lstekst:');
    if(!text || !text.trim()) return;
    
    const newQuestion = {
      id: 'temp_' + Date.now(),
      category_id: categoryId,
      text: text.trim(),
      is_lite: false,
      sort_order: currentTemplate.questions.filter(q => q.category_id === categoryId).length + 1
    };
    
    currentTemplate.questions.push(newQuestion);
    renderTemplateEditor();
  };

  window.addCategory = (domainId) => {
    const name = prompt('Indtast kategorinavn:');
    if(!name || !name.trim()) return;
    
    const newCategory = {
      id: 'temp_' + Date.now(),
      domain_id: domainId,
      name: name.trim(),
      sort_order: currentTemplate.categories.filter(c => c.domain_id === domainId).length + 1
    };
    
    currentTemplate.categories.push(newCategory);
    renderTemplateEditor();
  };

  window.addDomain = () => {
    const name = prompt('Indtast dom√¶nenavn:');
    if(!name || !name.trim()) return;
    
    const newDomain = {
      id: 'temp_' + Date.now(),
      template_id: currentTemplate.template.id,
      name: name.trim(),
      sort_order: currentTemplate.domains.length + 1
    };
    
    currentTemplate.domains.push(newDomain);
    renderTemplateEditor();
  };

  // Cancel template editing
  $('cancelTemplate').onclick = () => {
    if(confirm('Annuller redigering? Alle √¶ndringer g√•r tabt.')) {
      $('templateEditor').style.display = 'none';
      currentTemplate = null;
    }
  };

  // === PROJECTS (enhanced monitoring) ===
  async function loadProjects() {
    try {
      const { data } = await supabase.from('v_all_projects_with_owners').select('*').limit(1000);
      
      // Get response counts and deletion dates
      for (const p of (data || [])) {
        // Get response count
        const { data: responses } = await supabase.from('responses').select('id', { count: 'exact' }).eq('project_id', p.id);
        p.response_count = responses?.length || 0;
        
        // Calculate deletion date (7 days after close_at)
        if (p.close_at) {
          const closeDate = new Date(p.close_at);
          const deletionDate = new Date(closeDate.getTime() + (7 * 24 * 60 * 60 * 1000));
          p.deletion_date = deletionDate;
        }
      }
      
      filteredData.projects = data || [];
      filterProjects();
    } catch (error) {
      console.error('Projects load error:', error);
    }
  }

  function filterProjects() {
    const searchTerm = $('projectSearch')?.value.toLowerCase() || '';
    const statusFilter = $('projectStatusFilter')?.value || '';
    
    let filtered = filteredData.projects.filter(p => {
      const matchesSearch = !searchTerm || 
        p.title.toLowerCase().includes(searchTerm) ||
        (p.owner_email || '').toLowerCase().includes(searchTerm) ||
        (p.info_text || '').toLowerCase().includes(searchTerm);
      
      let matchesStatus = true;
      if (statusFilter) {
        const now = new Date();
        const openAt = p.open_at ? new Date(p.open_at) : null;
        const closeAt = p.close_at ? new Date(p.close_at) : null;
        
        switch (statusFilter) {
          case 'draft':
            matchesStatus = !openAt || !closeAt;
            break;
          case 'open':
            matchesStatus = openAt && closeAt && now >= openAt && now <= closeAt;
            break;
          case 'closed':
            matchesStatus = closeAt && now > closeAt;
            break;
          case 'expired':
            matchesStatus = p.deletion_date && now > p.deletion_date;
            break;
        }
      }
      
      return matchesSearch && matchesStatus;
    });
    
    renderProjectsTable(filtered);
  }

  function renderProjectsTable(projects) {
    const tb = $('projectsTbl').querySelector('tbody');
    tb.innerHTML = '';
    
    projects.forEach(p => {
      const tr = document.createElement('tr');
      
      // Status determination
      const now = new Date();
      const openAt = p.open_at ? new Date(p.open_at) : null;
      const closeAt = p.close_at ? new Date(p.close_at) : null;
      
      let statusBadge = '<span class="status-badge status-draft">Kladde</span>';
      if (openAt && closeAt) {
        if (now < openAt) {
          statusBadge = '<span class="status-badge status-draft">Ikke √•bnet</span>';
        } else if (now > closeAt) {
          statusBadge = '<span class="status-badge status-closed">Lukket</span>';
        } else {
          statusBadge = '<span class="status-badge status-open">√Öben</span>';
        }
      }
      
      const deletionInfo = p.deletion_date ? 
        p.deletion_date.toLocaleString('da-DK') : 'Ikke sat';
      
      tr.innerHTML = `
        <td>
          <strong>${p.title}</strong><br>
          <span class="muted">${p.info_text || ''}</span>
        </td>
        <td>
          ${p.owner_email || 'N/A'}<br>
          <span class="muted">${p.owner_role || 'ingen rolle'}</span>
        </td>
        <td>
          ${statusBadge}<br>
          <strong>${p.response_count || 0}</strong> svar<br>
          <div style="font-size:0.8rem;color:var(--muted)">
            Slettes: ${deletionInfo}
          </div>
        </td>
        <td>${openAt ? openAt.toLocaleDateString('da-DK') : 'Ikke sat'}</td>
        <td>${closeAt ? closeAt.toLocaleDateString('da-DK') : 'Ikke sat'}</td>
        <td style="text-align:center">${p.people_count || 0}</td>
        <td style="text-align:center">${p.link_url ? '‚úÖ' : '‚Äî'}</td>
        <td style="text-align:right">
          <button class="btn small" onclick="viewProject('${p.id}')" style="background:var(--brand);color:white;border-color:var(--brand);margin-right:4px">Se</button>
          <button class="btn small warning" onclick="purgeProject('${p.id}', '${p.title.replace(/'/g, '\\\'')}')" title="Slet projekt nu">üóëÔ∏è</button>
        </td>
      `;
      
      tb.appendChild(tr);
    });
  }

  window.sortProjects = (column) => {
    const direction = currentSort.column === column && currentSort.direction === 'asc' ? 'desc' : 'asc';
    currentSort = { column, direction };
    
    filteredData.projects.sort((a, b) => {
      let aVal = a[column];
      let bVal = b[column];
      
      if (column === 'open_at' || column === 'close_at') {
        aVal = aVal ? new Date(aVal) : new Date(0);
        bVal = bVal ? new Date(bVal) : new Date(0);
      }
      
      if (aVal < bVal) return direction === 'asc' ? -1 : 1;
      if (aVal > bVal) return direction === 'asc' ? 1 : -1;
      return 0;
    });
    
    // Update header styling
    document.querySelectorAll('#projectsTbl th').forEach(th => {
      th.className = '';
    });
    event.target.className = `sorted-${direction}`;
    
    filterProjects();
  }

  window.viewProject = (projectId) => {
    // Switch to admin view for this project (could open in new window)
    window.open(`admin.html?project=${projectId}`, '_blank');
  };

  window.purgeProject = async (projectId, projectTitle) => {
    if (!confirm(`ADVARSEL: Slet projektet "${projectTitle}" permanent?\n\nDette sletter:\n‚Ä¢ Projektet\n‚Ä¢ Alle besvarelser\n‚Ä¢ Alle data\n\nDenne handling kan IKKE fortrydes!`)) return;
    
    try {
      const { error } = await supabase.from('projects').delete().eq('id', projectId);
      if (error) throw error;
      
      alert(`‚úÖ Projekt "${projectTitle}" er permanent slettet`);
      await loadProjects();
      await loadDashboard();
    } catch (error) {
      alert(`‚ùå Fejl ved sletning: ${error.message}`);
    }
  };

  // Project cleanup
  $('refreshProjects').onclick = loadProjects;
  
  $('cleanupProjects').onclick = async () => {
    if (!confirm('Ryd alle udl√∏bne projekter? Dette kan ikke fortrydes.')) return;
    
    try {
      const { data, error } = await supabase.rpc('purge_expired_projects');
      if (error) throw error;
      
      alert('‚úÖ Gamle projekter ryddet');
      await loadProjects();
      await loadDashboard();
    } catch (error) {
      alert('‚ùå Fejl: ' + error.message);
    }
  };

  // === USERS (enhanced with search and bulk operations) ===
  async function loadUsers() {
    try {
      // Load activation keys
      const { data: keys } = await supabase.from('v_activation_keys').select('*').order('created_at', {ascending: false});
      filteredData.keys = keys || [];
      
      // Load existing users
      const { data } = await supabase.from('v_users_with_roles').select('*').order('created_at', {ascending: false});
      filteredData.users = data || [];
      
      filterKeys();
      filterUsers();
    } catch (error) {
      console.error('Users load error:', error);
    }
  }

  function filterKeys() {
    const searchTerm = $('keySearch')?.value.toLowerCase() || '';
    const statusFilter = $('keyStatusFilter')?.value || '';
    
    let filtered = filteredData.keys.filter(k => {
      const matchesSearch = !searchTerm || 
        k.key_code.toLowerCase().includes(searchTerm) ||
        k.email.toLowerCase().includes(searchTerm) ||
        (k.notes || '').toLowerCase().includes(searchTerm);
      
      let matchesStatus = true;
      if (statusFilter === 'used') matchesStatus = k.used;
      if (statusFilter === 'unused') matchesStatus = !k.used;
      
      return matchesSearch && matchesStatus;
    });
    
    renderKeysTable(filtered);
  }

  function renderKeysTable(keys) {
    const tb = $('keysTbl').querySelector('tbody');
    tb.innerHTML = '';
    
    keys.forEach(k => {
      const tr = document.createElement('tr');
      const status = k.used ? `<span style="color:var(--success)">Brugt</span>` : `<span style="color:var(--brand)">Aktiv</span>`;
      const usedInfo = k.used ? `${new Date(k.used_at).toLocaleDateString()}<br><span class="muted">${k.used_by_email}</span>` : '-';
      
      tr.innerHTML = `
        <td class="checkbox-cell">
          <input type="checkbox" value="${k.id}" onchange="updateKeySelection()">
        </td>
        <td style="font-family:monospace;font-weight:bold">${k.key_code}</td>
        <td>${k.email}</td>
        <td>${status}</td>
        <td>${new Date(k.created_at).toLocaleDateString()}</td>
        <td>${usedInfo}</td>
        <td>${k.notes || '-'}</td>
      `;
      tb.appendChild(tr);
    });
  }

  function filterUsers() {
    const searchTerm = $('userSearch')?.value.toLowerCase() || '';
    const roleFilter = $('userRoleFilter')?.value || '';
    const sortBy = $('userSortBy')?.value || 'email';
    
    let filtered = filteredData.users.filter(u => {
      const matchesSearch = !searchTerm || 
        (u.email || '').toLowerCase().includes(searchTerm) ||
        (u.role || '').toLowerCase().includes(searchTerm);
      
      let matchesRole = true;
      if (roleFilter === 'none') matchesRole = !u.role;
      else if (roleFilter) matchesRole = u.role === roleFilter;
      
      return matchesSearch && matchesRole;
    });
    
    // Sort
    filtered.sort((a, b) => {
      let aVal = a[sortBy] || '';
      let bVal = b[sortBy] || '';
      
      if (sortBy === 'created_at') {
        aVal = new Date(aVal);
        bVal = new Date(bVal);
      }
      
      return aVal.toString().localeCompare(bVal.toString());
    });
    
    renderUsersTable(filtered);
  }

  function renderUsersTable(users) {
    const tb = $('usersTbl').querySelector('tbody');
    tb.innerHTML = '';
    
    users.forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="checkbox-cell">
          <input type="checkbox" value="${u.id}" onchange="updateUserSelection()">
        </td>
        <td>${u.email || 'N/A'}</td>
        <td>${u.role || 'Ingen rolle'}</td>
        <td>${new Date(u.created_at).toLocaleDateString()}</td>
        <td style="text-align:right">
          <button class="btn small" onclick="removeUserRole('${u.email}')" style="background:#dc3545;color:white;border-color:#dc3545">Fjern rolle</button>
        </td>
      `;
      tb.appendChild(tr);
    });
  }

  // Selection management
  window.toggleAllKeys = () => {
    const mainCheckbox = $('selectAllKeys');
    const checkboxes = document.querySelectorAll('#keysTbl input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = mainCheckbox.checked);
    updateKeySelection();
  };

  window.toggleAllUsers = () => {
    const mainCheckbox = $('selectAllUsers');
    const checkboxes = document.querySelectorAll('#usersTbl input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = mainCheckbox.checked);
    updateUserSelection();
  };

  window.updateKeySelection = () => {
    const checked = document.querySelectorAll('#keysTbl input[type="checkbox"]:checked').length;
    const bulkControls = $('keyBulkControls');
    
    if (checked > 0) {
      bulkControls.classList.add('active');
      bulkControls.querySelector('.selection-count').textContent = `${checked} n√∏gler valgt`;
    } else {
      bulkControls.classList.remove('active');
    }
  };

  window.updateUserSelection = () => {
    const checked = document.querySelectorAll('#usersTbl input[type="checkbox"]:checked').length;
    const bulkControls = $('userBulkControls');
    
    if (checked > 0) {
      bulkControls.classList.add('active');
      bulkControls.querySelector('.selection-count').textContent = `${checked} brugere valgt`;
    } else {
      bulkControls.classList.remove('active');
    }
  };

  window.clearKeySelection = () => {
    document.querySelectorAll('#keysTbl input[type="checkbox"]').forEach(cb => cb.checked = false);
    $('selectAllKeys').checked = false;
    updateKeySelection();
  };

  window.clearUserSelection = () => {
    document.querySelectorAll('#usersTbl input[type="checkbox"]').forEach(cb => cb.checked = false);
    $('selectAllUsers').checked = false;
    updateUserSelection();
  };

  // Sort functions
  window.sortKeys = (column) => {
    const direction = currentSort.column === column && currentSort.direction === 'asc' ? 'desc' : 'asc';
    currentSort = { column, direction };
    
    filteredData.keys.sort((a, b) => {
      let aVal = a[column] || '';
      let bVal = b[column] || '';
      
      if (column === 'created_at' || column === 'used_at') {
        aVal = aVal ? new Date(aVal) : new Date(0);
        bVal = bVal ? new Date(bVal) : new Date(0);
      }
      
      if (aVal < bVal) return direction === 'asc' ? -1 : 1;
      if (aVal > bVal) return direction === 'asc' ? 1 : -1;
      return 0;
    });
    
    filterKeys();
  };

  window.sortUsers = (column) => {
    const direction = currentSort.column === column && currentSort.direction === 'asc' ? 'desc' : 'asc';
    currentSort = { column, direction };
    
    filteredData.users.sort((a, b) => {
      let aVal = a[column] || '';
      let bVal = b[column] || '';
      
      if (column === 'created_at') {
        aVal = aVal ? new Date(aVal) : new Date(0);
        bVal = bVal ? new Date(bVal) : new Date(0);
      }
      
      if (aVal < bVal) return direction === 'asc' ? -1 : 1;
      if (aVal > bVal) return direction === 'asc' ? 1 : -1;
      return 0;
    });
    
    filterUsers();
  };

  // Bulk operations
  window.bulkDeleteSelectedKeys = async () => {
    const selected = Array.from(document.querySelectorAll('#keysTbl input[type="checkbox"]:checked')).map(cb => cb.value);
    if (selected.length === 0) return;
    
    if (!confirm(`Slet ${selected.length} valgte n√∏gler? Dette kan ikke fortrydes.`)) return;
    
    try {
      const { error } = await supabase.from('activation_keys').delete().in('id', selected);
      if (error) throw error;
      
      alert(`‚úÖ ${selected.length} n√∏gler slettet`);
      clearKeySelection();
      await loadUsers();
      await loadDashboard();
    } catch (error) {
      alert('‚ùå Fejl: ' + error.message);
    }
  };

  window.applyBulkRoleChange = async () => {
    const selected = Array.from(document.querySelectorAll('#usersTbl input[type="checkbox"]:checked')).map(cb => cb.value);
    const newRole = $('bulkRoleChange').value;
    
    if (selected.length === 0 || !newRole) return;
    
    if (!confirm(`√Ündre rolle for ${selected.length} brugere til ${newRole}?`)) return;
    
    try {
      for (const userId of selected) {
        if (newRole === 'remove') {
          await supabase.from('user_roles').delete().eq('user_id', userId);
        } else {
          await supabase.from('user_roles').upsert({ user_id: userId, role: newRole });
        }
      }
      
      alert(`‚úÖ Roller opdateret for ${selected.length} brugere`);
      clearUserSelection();
      $('bulkRoleChange').value = '';
      await loadUsers();
      await loadDashboard();
    } catch (error) {
      alert('‚ùå Fejl: ' + error.message);
    }
  };

  window.bulkDeleteUsers = async () => {
    const selected = Array.from(document.querySelectorAll('#usersTbl input[type="checkbox"]:checked')).map(cb => cb.value);
    if (selected.length === 0) return;
    
    if (!confirm(`ADVARSEL: Slet ${selected.length} brugere permanent? Dette sletter deres konti og kan ikke fortrydes.`)) return;
    
    // Note: This would require admin API access to actually delete users
    alert('‚ö†Ô∏è Bruger sletning kr√¶ver admin API adgang. Kontakt system administrator.');
  };

  // Key management
  $('generateKey').onclick = async () => {
    const email = $('keyEmail').value.trim();
    const notes = $('keyNotes').value.trim();
    if(!email) return alert('Email p√•kr√¶vet');
    
    const { data, error } = await supabase.rpc('generate_activation_key', {
      p_email: email,
      p_notes: notes || null
    });
    
    if(error) return alert(error.message);
    if(data.error) return alert(data.error);
    
    // Show result
    $('generatedKey').textContent = data.key_code;
    $('generatedEmail').textContent = data.email;
    $('keyResult').style.display = 'block';
    
    // Clear inputs
    $('keyEmail').value = '';
    $('keyNotes').value = '';
    
    // Reload keys table
    loadUsers();
    loadDashboard();
    
    // Hide result after 30 seconds
    setTimeout(() => {
      $('keyResult').style.display = 'none';
    }, 30000);
  };

  $('cleanupUsedKeys').onclick = async () => {
    if (!confirm('Slet alle brugte aktiveringsn√∏gler? Dette kan ikke fortrydes.')) return;
    
    try {
      const { error } = await supabase.from('activation_keys').delete().eq('used', true);
      if (error) throw error;
      
      alert('‚úÖ Brugte n√∏gler slettet');
      await loadUsers();
      await loadDashboard();
    } catch (error) {
      alert('‚ùå Fejl: ' + error.message);
      }
  };

  $('bulkDeleteKeys').onclick = bulkDeleteSelectedKeys;

  // Export users
  $('exportUsers').onclick = async () => {
    try {
      const { data: users } = await supabase.from('v_users_with_roles').select('*');
      
      const csv = [
        'Email,Rolle,Oprettet,Rolle Tildelt',
        ...users.map(u => `"${u.email || ''}","${u.role || ''}","${u.created_at}","${u.role_assigned_at || ''}"`)
      ].join('\n');
      
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `kompas_users_${new Date().toISOString().slice(0, 10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } catch (error) {
      alert('‚ùå Eksport fejlede: ' + error.message);
    }
  };

  // Global function for remove user role
  window.removeUserRole = async (email) => {
    if(!confirm(`Fjern rolle for ${email}?`)) return;
    
    const { data, error } = await supabase.rpc('remove_user_role', {
      p_user_email: email
    });
    
    if(error) return alert(error.message);
    if(data.error) return alert(data.error);
    
    alert(data.message);
    loadUsers();
    loadDashboard();
  };

  // Add user role directly
  $('addUser').onclick = async () => {
    const email = $('userEmailInput').value.trim();
    const role = $('userRole').value;
    if(!email) return alert('Email p√•kr√¶vet');
    
    const { data, error } = await supabase.rpc('manage_user_role', {
      p_user_email: email,
      p_role: role
    });
    
    if(error) return alert(error.message);
    if(data.error) return alert(data.error);
    
    alert(data.message);
    $('userEmailInput').value = '';
    loadUsers();
    loadDashboard();
  };

  // === COACHING ADMINISTRATION ===
  
  async function loadCoachingTemplates() {
    try {
      const { data: templates } = await supabase.from('templates').select('*').order('name');
      const select = $('coachingTemplateSelect');
      
      select.innerHTML = '<option value="">-- V√¶lg skabelon --</option>';
      (templates || []).forEach(t => {
        const option = document.createElement('option');
        option.value = t.id;
        option.textContent = `${t.name} v${t.version}`;
        select.appendChild(option);
      });
      
      select.onchange = () => {
        if(select.value) {
          loadCoachingData(select.value);
        } else {
          $('coachingCategoriesContainer').innerHTML = '<p class="muted" style="text-align:center;padding:40px">V√¶lg en skabelon for at administrere coaching indhold</p>';
        }
      };
      
    } catch(error) {
      showCoachingStatus('Fejl ved indl√¶sning af skabeloner: ' + error.message, 'error');
    }
  }

  async function loadCoachingData(templateId) {
    try {
      currentCoachingTemplate = templateId;
      showCoachingStatus('Indl√¶ser coaching data...', 'info');
      
      // Load categories for this template
      const { data: categories } = await supabase
        .from('v_category_path')
        .select('*')
        .eq('template_id', templateId)
        .order('category_sort');
      
      if(!categories || categories.length === 0) {
        $('coachingCategoriesContainer').innerHTML = '<p class="muted" style="text-align:center;padding:40px">Ingen kategorier fundet for denne skabelon</p>';
        showCoachingStatus('', '');
        return;
      }
      
      // Load existing coaching data
      const { data: competencies } = await supabase
        .from('coaching_competency')
        .select('*')
        .in('category_id', categories.map(c => c.category_id));
      
      const { data: tips } = await supabase
        .from('coaching_tip')
        .select('*')
        .in('category_id', categories.map(c => c.category_id))
        .order('sort_order');
      
      coachingData = {
        categories,
        competencies: competencies || [],
        tips: tips || []
      };
      
      renderCoachingInterface();
      showCoachingStatus('Coaching data indl√¶st succesfuldt', 'success');
      
    } catch(error) {
      console.error('Error loading coaching data:', error);
      showCoachingStatus('Fejl ved indl√¶sning: ' + error.message, 'error');
    }
  }

  function showCoachingStatus(message, type) {
    const statusDiv = $('coachingStatus');
    if(!message) {
      statusDiv.innerHTML = '';
      return;
    }
    
    const className = type === 'error' ? 'error-message' : 
                     type === 'success' ? 'success-message' : 
                     type === 'warning' ? 'warning-message' :
                     'muted';
    
    statusDiv.innerHTML = `<div class="${className}">${message}</div>`;
    
    if(type === 'success' || type === 'info') {
      setTimeout(() => {
        statusDiv.innerHTML = '';
      }, 3000);
    }
  }

  function renderCoachingInterface() {
    const container = $('coachingCategoriesContainer');
    container.innerHTML = '';
    
    coachingData.categories.forEach(category => {
      const categoryDiv = document.createElement('div');
      categoryDiv.className = 'coaching-category';
      
      const competency = coachingData.competencies.find(c => c.category_id === category.category_id);
      const categoryTips = coachingData.tips.filter(t => t.category_id === category.category_id);
      
      categoryDiv.innerHTML = `
        <div class="coaching-category-header" onclick="toggleCoachingCategory('${category.category_id}')">
          <span>${category.domain_name} ‚Ä∫ ${category.category_name}</span>
          <span id="toggle-${category.category_id}">‚ñº</span>
        </div>
        <div class="coaching-category-content" id="content-${category.category_id}">
          ${renderCompetencyEditor(category, competency)}
          ${renderTipsEditor(category, categoryTips)}
        </div>
      `;
      
      container.appendChild(categoryDiv);
    });
  }

  function renderCompetencyEditor(category, competency) {
    const comp = competency || { synopsis: '', importance: '', why_matters: '' };
    
    return `
      <div class="coaching-section">
        <h4>üìã Kompetence Oversigt</h4>
        <div class="grid" style="gap:12px">
          <label>Synopsis (kort beskrivelse)
            <textarea class="textarea" id="synopsis-${category.category_id}" placeholder="Evnen til at...">${comp.synopsis}</textarea>
          </label>
          <label>Vigtighed (hvorfor er det vigtigt?)
            <textarea class="textarea" id="importance-${category.category_id}" placeholder="Grundlag for...">${comp.importance}</textarea>
          </label>
          <label>Hvorfor det betyder noget
            <textarea class="textarea" id="why_matters-${category.category_id}" placeholder="P√•virker b√•de...">${comp.why_matters || ''}</textarea>
          </label>
          <button class="btn primary" onclick="saveCompetency('${category.category_id}')">Gem kompetence oversigt</button>
        </div>
      </div>
    `;
  }

  function renderTipsEditor(category, tips) {
    let tipsHtml = tips.map((tip, index) => renderSingleTip(category.category_id, tip, index)).join('');
    
    return `
      <div class="coaching-section">
        <h4>üí° Coaching Tips</h4>
        <div id="tips-container-${category.category_id}">
          ${tipsHtml}
        </div>
        <button class="btn" onclick="addNewTip('${category.category_id}')">+ Tilf√∏j nyt tip</button>
      </div>
    `;
  }

  function renderSingleTip(categoryId, tip, index) {
    const methods = ['self', 'leader_employee', 'colleague', 'group', 'external', 'course'];
    const methodLabels = {
      'self': 'Selv',
      'leader_employee': 'Leder/Medarbejder',
      'colleague': 'Kollega', 
      'group': 'Gruppe',
      'external': 'Ekstern',
      'course': 'Kursus'
    };
    
    return `
      <div class="tip-item" id="tip-${tip.id || 'new'}">
        <div class="tip-header">
          <span class="method-badge method-${tip.method}">${methodLabels[tip.method] || tip.method}</span>
          <button class="btn small" onclick="deleteTip('${tip.id}', '${categoryId}')" style="background:#dc3545;color:white">Slet</button>
        </div>
        
        <div class="grid2" style="gap:12px;margin-bottom:12px">
          <label>Metode
            <select class="select" id="method-${tip.id}">
              ${methods.map(m => `<option value="${m}" ${tip.method === m ? 'selected' : ''}>${methodLabels[m]}</option>`).join('')}
            </select>
          </label>
          <label>Titel
            <input class="input" id="title-${tip.id}" value="${tip.title || ''}" placeholder="Kort beskrivende titel">
          </label>
        </div>
        
        <label>Beskrivelse
          <textarea class="textarea" id="description-${tip.id}" placeholder="Detaljeret beskrivelse...">${tip.description || ''}</textarea>
        </label>
        
        <div class="grid2" style="gap:12px;margin-top:12px">
          <label>Impact (1-5)
            <input type="number" class="input" id="impact-${tip.id}" min="1" max="5" value="${tip.impact || 3}">
          </label>
          <label>Effort (1-5)
            <input type="number" class="input" id="effort-${tip.id}" min="1" max="5" value="${tip.effort || 3}">
          </label>
        </div>
        
        <label>Tidshorisont
          <input class="input" id="time_horizon-${tip.id}" value="${tip.time_horizon || ''}" placeholder="2-3 uger">
        </label>
        
        ${renderArrayEditor('Trin', 'steps', tip.id, tip.steps || [])}
        ${renderArrayEditor('Mikrovaner', 'micro_habits', tip.id, tip.micro_habits || [])}
        ${renderArrayEditor('Coach sp√∏rgsm√•l', 'prompts', tip.id, tip.prompts || [])}
        ${renderArrayEditor('Faldgruber', 'pitfalls', tip.id, tip.pitfalls || [])}
        
        <button class="btn primary" onclick="saveTip('${tip.id}', '${categoryId}')" style="margin-top:12px">Gem tip</button>
      </div>
    `;
  }

  function renderArrayEditor(label, fieldName, tipId, items) {
    const itemsHtml = items.map((item, index) => `
      <div class="array-item">
        <input class="input" value="${item}" onchange="updateArrayItem('${fieldName}', '${tipId}', ${index}, this.value)">
        <button class="btn small" onclick="removeArrayItem('${fieldName}', '${tipId}', ${index})" style="background:#dc3545;color:white">√ó</button>
      </div>
    `).join('');
    
    return `
      <div class="array-editor">
        <label>${label}</label>
        <div id="${fieldName}-${tipId}">
          ${itemsHtml}
        </div>
        <button class="btn small" onclick="addArrayItem('${fieldName}', '${tipId}')" style="margin-top:4px">+ Tilf√∏j ${label.toLowerCase()}</button>
      </div>
    `;
  }

  // Global functions for coaching management
  window.toggleCoachingCategory = (categoryId) => {
    const content = $(`content-${categoryId}`);
    const toggle = $(`toggle-${categoryId}`);
    
    if(content.classList.contains('active')) {
      content.classList.remove('active');
      toggle.textContent = '‚ñº';
    } else {
      content.classList.add('active');
      toggle.textContent = '‚ñ≤';
    }
  };

  window.saveCompetency = async (categoryId) => {
    try {
      const synopsis = $(`synopsis-${categoryId}`).value.trim();
      const importance = $(`importance-${categoryId}`).value.trim();
      const why_matters = $(`why_matters-${categoryId}`).value.trim();
      
      if(!synopsis || !importance) {
        alert('Synopsis og vigtighed er p√•kr√¶vet');
        return;
      }
      
      const existingComp = coachingData.competencies.find(c => c.category_id === categoryId);
      
      if(existingComp) {
        // Update existing
        const { error } = await supabase
          .from('coaching_competency')
          .update({ synopsis, importance, why_matters })
          .eq('id', existingComp.id);
        
        if(error) throw error;
        
        // Update local data
        existingComp.synopsis = synopsis;
        existingComp.importance = importance;
        existingComp.why_matters = why_matters;
      } else {
        // Create new
        const { data, error } = await supabase
          .from('coaching_competency')
          .insert({ category_id: categoryId, synopsis, importance, why_matters })
          .select()
          .single();
        
        if(error) throw error;
        
        coachingData.competencies.push(data);
      }
      
      showCoachingStatus('Kompetence oversigt gemt', 'success');
      
    } catch(error) {
      showCoachingStatus('Fejl ved gem: ' + error.message, 'error');
    }
  };

  window.addNewTip = (categoryId) => {
    const newTip = {
      id: 'new_' + Date.now(),
      category_id: categoryId,
      method: 'self',
      title: '',
      description: '',
      steps: [],
      micro_habits: [],
      prompts: [],
      pitfalls: [],
      impact: 3,
      effort: 3,
      time_horizon: ''
    };
    
    const container = $(`tips-container-${categoryId}`);
    container.insertAdjacentHTML('beforeend', renderSingleTip(categoryId, newTip, 0));
  };

  window.saveTip = async (tipId, categoryId) => {
    try {
      const method = $(`method-${tipId}`).value;
      const title = $(`title-${tipId}`).value.trim();
      const description = $(`description-${tipId}`).value.trim();
      const impact = parseInt($(`impact-${tipId}`).value);
      const effort = parseInt($(`effort-${tipId}`).value);
      const time_horizon = $(`time_horizon-${tipId}`).value.trim();
      
      if(!title || !description) {
        alert('Titel og beskrivelse er p√•kr√¶vet');
        return;
      }
      
      // Collect arrays
      const steps = collectArrayData('steps', tipId);
      const micro_habits = collectArrayData('micro_habits', tipId);
      const prompts = collectArrayData('prompts', tipId);
      const pitfalls = collectArrayData('pitfalls', tipId);
      
      const tipData = {
        category_id: categoryId,
        method,
        title,
        description,
        steps,
        micro_habits,
        prompts,
        pitfalls,
        impact,
        effort,
        time_horizon
      };
      
      if(tipId.startsWith('new_')) {
        // Create new tip
        const { data, error } = await supabase
          .from('coaching_tip')
          .insert(tipData)
          .select()
          .single();
        
        if(error) throw error;
        
        // Update the tip element with real ID
        const tipElement = $(`tip-${tipId}`);
        tipElement.id = `tip-${data.id}`;
        
        coachingData.tips.push(data);
      } else {
        // Update existing tip
        const { error } = await supabase
          .from('coaching_tip')
          .update(tipData)
          .eq('id', tipId);
        
        if(error) throw error;
        
        // Update local data
        const existingTip = coachingData.tips.find(t => t.id === tipId);
        if(existingTip) {
          Object.assign(existingTip, tipData);
        }
      }
      
      showCoachingStatus('Tip gemt succesfuldt', 'success');
      
    } catch(error) {
      showCoachingStatus('Fejl ved gem af tip: ' + error.message, 'error');
    }
  };

  window.deleteTip = async (tipId, categoryId) => {
    if(!confirm('Er du sikker p√• du vil slette dette tip?')) return;
    
    try {
      if(!tipId.startsWith('new_')) {
        const { error } = await supabase
          .from('coaching_tip')
          .delete()
          .eq('id', tipId);
        
        if(error) throw error;
        
        // Remove from local data
        coachingData.tips = coachingData.tips.filter(t => t.id !== tipId);
      }
      
      // Remove from DOM
      const tipElement = $(`tip-${tipId}`);
      if(tipElement) tipElement.remove();
      
      showCoachingStatus('Tip slettet', 'success');
      
    } catch(error) {
      showCoachingStatus('Fejl ved sletning: ' + error.message, 'error');
    }
  };

  function collectArrayData(fieldName, tipId) {
    const container = $(`${fieldName}-${tipId}`);
    if(!container) return [];
    
    const inputs = container.querySelectorAll('input');
    return Array.from(inputs)
      .map(input => input.value.trim())
      .filter(value => value.length > 0);
  }

  window.addArrayItem = (fieldName, tipId) => {
    const container = $(`${fieldName}-${tipId}`);
    const newIndex = container.children.length;
    
    const itemHtml = `
      <div class="array-item">
        <input class="input" value="" onchange="updateArrayItem('${fieldName}', '${tipId}', ${newIndex}, this.value)">
        <button class="btn small" onclick="removeArrayItem('${fieldName}', '${tipId}', ${newIndex})" style="background:#dc3545;color:white">√ó</button>
      </div>
    `;
    
    container.insertAdjacentHTML('beforeend', itemHtml);
  };

  window.removeArrayItem = (fieldName, tipId, index) => {
    const container = $(`${fieldName}-${tipId}`);
    const items = container.querySelectorAll('.array-item');
    if(items[index]) {
      items[index].remove();
    }
  };

  window.updateArrayItem = (fieldName, tipId, index, value) => {
    // This function is called when array items are changed
    // The actual collection happens in collectArrayData when saving
  };

  // Coaching backup and import
  $('backupCoaching').onclick = async () => {
    if (!currentCoachingTemplate) {
      alert('V√¶lg en skabelon f√∏rst');
      return;
    }

    try {
      const { data: competencies } = await supabase
        .from('coaching_competency')
        .select('*')
        .in('category_id', coachingData.categories.map(c => c.category_id));

      const { data: tips } = await supabase
        .from('coaching_tip')
        .select('*')
        .in('category_id', coachingData.categories.map(c => c.category_id));

      const backup = {
        backup_date: new Date().toISOString(),
        backup_type: 'coaching',
        template_id: currentCoachingTemplate,
        categories: coachingData.categories,
        competencies: competencies || [],
        tips: tips || []
      };

      const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `kompas_coaching_backup_${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

    } catch (error) {
      alert('‚ùå Backup fejlede: ' + error.message);
    }
  };

  $('importCoaching').onclick = () => {
    $('coachingFileInput').click();
  };

  $('coachingFileInput').onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      const text = await file.text();
      const backup = JSON.parse(text);

      if (backup.backup_type !== 'coaching') {
        alert('Ugyldig coaching backup fil');
        return;
      }

      if (!confirm('Import coaching data? Dette vil overskrive eksisterende data.')) return;

      // Import logic would go here
      alert('‚úÖ Coaching data importeret (funktionalitet skal implementeres)');

    } catch (error) {
      alert('‚ùå Import fejlede: ' + error.message);
    }
  };

    // === MAINTENANCE FUNCTIONS ===
  async function loadVersionHistory() {
    try {
      // This would need a versions table to be implemented
      $('versionHistory').innerHTML = `
        <div class="warning-message">
          üìö Content versionering kr√¶ver versions tabel i database.<br>
          Implementer versions tabel for at aktivere denne funktionalitet.
        </div>
      `;
    } catch (error) {
      $('versionHistory').innerHTML = `<div class="error-message">Fejl: ${error.message}</div>`;
    }
  }

  async function loadSystemMetrics() {
    try {
      const [
        { count: projectCount },
        { count: userCount },
        { count: responseCount },
        { data: dbSize }
      ] = await Promise.all([
        supabase.from('projects').select('*', { count: 'exact', head: true }),
        supabase.from('user_roles').select('*', { count: 'exact', head: true }),
        supabase.from('responses').select('*', { count: 'exact', head: true }),
        supabase.rpc('get_database_size') // This RPC would need to be created
      ]);

      $('systemMetrics').innerHTML = `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number">${projectCount || 0}</div>
            <div class="stat-label">Projekter i Database</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${userCount || 0}</div>
            <div class="stat-label">Brugere med Roller</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">${responseCount || 0}</div>
            <div class="stat-label">Samlede Besvarelser</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">N/A</div>
            <div class="stat-label">Database St√∏rrelse</div>
          </div>
        </div>
        <div style="margin-top:16px">
          <h5>üíæ Storage Status:</h5>
          <div class="muted">Database metrics kr√¶ver custom RPC funktioner</div>
        </div>
      `;
    } catch (error) {
      $('systemMetrics').innerHTML = `<div class="error-message">Fejl: ${error.message}</div>`;
    }
  }

  // Maintenance functions
  window.purgeExpiredProjects = async () => {
    if (!confirm('Ryd alle udl√∏bne projekter? Dette kan ikke fortrydes.')) return;

    const progressDiv = $('cleanupProgress');
    const progressFill = $('cleanupProgressFill');
    const progressText = $('cleanupProgressText');

    progressDiv.style.display = 'block';
    progressFill.style.width = '0%';
    progressText.textContent = 'Starter oprydning...';

    try {
      progressFill.style.width = '25%';
      progressText.textContent = 'Finder udl√∏bne projekter...';

      const { data, error } = await supabase.rpc('purge_expired_projects');
      if (error) throw error;

      progressFill.style.width = '100%';
      progressText.textContent = 'Oprydning fuldf√∏rt!';

      setTimeout(() => {
        progressDiv.style.display = 'none';
      }, 2000);

      alert('‚úÖ Udl√∏bne projekter ryddet');
      await loadDashboard();
      await loadProjects();
    } catch (error) {
      progressDiv.style.display = 'none';
      alert('‚ùå Fejl: ' + error.message);
    }
  };

  window.cleanupOrphanedData = async () => {
    if (!confirm('Ryd for√¶ldrel√∏se data? Dette finder og sletter data uden gyldig reference.')) return;

    try {
      // This would need custom cleanup RPC functions
      alert('‚ö†Ô∏è Orphaned data cleanup kr√¶ver custom RPC funktioner');
    } catch (error) {
      alert('‚ùå Fejl: ' + error.message);
    }
  };

  window.compactDatabase = async () => {
    if (!confirm('Kompakt√©r database? Dette kan tage lang tid.')) return;

    try {
      // This would need database admin functions
      alert('‚ö†Ô∏è Database kompaktering kr√¶ver admin rettigheder');
    } catch (error) {
      alert('‚ùå Fejl: ' + error.message);
    }
  };

  window.exportFullSystem = async () => {
    try {
      const [
        { data: projects },
        { data: users },
        { data: templates },
        { data: responses },
        { data: keys }
      ] = await Promise.all([
        supabase.from('projects').select('*'),
        supabase.from('v_users_with_roles').select('*'),
        supabase.from('templates').select(`*, domains(*, categories(*, questions(*)))`),
        supabase.from('responses').select('*, response_items(*)'),
        supabase.from('v_activation_keys').select('*')
      ]);

      const systemExport = {
        export_date: new Date().toISOString(),
        export_type: 'full_system',
        version: '1.0',
        data: {
          projects: projects || [],
          users: users || [],
          templates: templates || [],
          responses: responses || [],
          activation_keys: keys || []
        },
        metadata: {
          projects_count: projects?.length || 0,
          users_count: users?.length || 0,
          templates_count: templates?.length || 0,
          responses_count: responses?.length || 0,
          keys_count: keys?.length || 0
        }
      };

      const blob = new Blob([JSON.stringify(systemExport, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `kompas_system_export_${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

    } catch (error) {
      alert('‚ùå System export fejlede: ' + error.message);
    }
  };

  window.exportTemplates = async () => {
    try {
      const { data: templates } = await supabase.from('templates').select(`
        *,
        domains(*, categories(*, questions(*)))
      `);

      const templateExport = {
        export_date: new Date().toISOString(),
        export_type: 'templates',
        data: templates || []
      };

      const blob = new Blob([JSON.stringify(templateExport, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `kompas_templates_${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

    } catch (error) {
      alert('‚ùå Template export fejlede: ' + error.message);
    }
  };

  window.exportCoachingData = async () => {
    try {
      const { data: competencies } = await supabase.from('coaching_competency').select('*');
      const { data: tips } = await supabase.from('coaching_tip').select('*');

      const coachingExport = {
        export_date: new Date().toISOString(),
        export_type: 'coaching',
        data: {
          competencies: competencies || [],
          tips: tips || []
        }
      };

      const blob = new Blob([JSON.stringify(coachingExport, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `kompas_coaching_${new Date().toISOString().slice(0, 10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

    } catch (error) {
      alert('‚ùå Coaching export fejlede: ' + error.message);
    }
  };

  window.createSystemSnapshot = async () => {
    const comment = prompt('Snapshot kommentar:');
    if (!comment) return;

    try {
      // This would need a snapshots table
      alert('‚úÖ System snapshot oprettet (funktionalitet skal implementeres)');
    } catch (error) {
      alert('‚ùå Fejl: ' + error.message);
    }
  };

  /* === TOKENS: plan + grants (ny) ===
     Ligger i samme load()-blok, s√• supabase er i scope.
  */
  const btnPlan = document.getElementById('tok-save');
  if (btnPlan) {
    btnPlan.addEventListener('click', async () => {
      const email = document.getElementById('tok-email').value.trim();
      const plan  = document.getElementById('tok-plan').value;
      const start = parseInt(document.getElementById('tok-start').value || '0', 10);

      const { data, error } = await supabase.rpc('set_user_plan', { p_email: email, p_plan: plan, p_tokens: start });
      const msg = document.getElementById('tok-plan-msg');
      if (error) {
        msg.textContent = `‚ö†Ô∏è ${error.message || error}`;
      } else if (data?.error) {
        msg.textContent = `‚ö†Ô∏è ${data.error}`;
      } else {
        msg.textContent = '‚úÖ Gemt';
      }

    });
  }

 const btnGrant = document.getElementById('grant-save');
  if (btnGrant) {
    btnGrant.addEventListener('click', async () => {
      const email = document.getElementById('grant-email').value.trim();
      const qty   = parseInt(document.getElementById('grant-qty').value || '0', 10);
      const note  = document.getElementById('grant-note').value;

      const { data, error } = await supabase.rpc('grant_tokens', { p_email: email, p_qty: qty, p_note: note });
      const msg2 = document.getElementById('grant-msg');
      if (error) {
        msg2.textContent = `‚ö†Ô∏è ${error.message || error}`;
      } else if (data?.error) {
        msg2.textContent = `‚ö†Ô∏è ${data.error}`;
      } else {
        msg2.textContent = '‚úÖ Tildelt';
        // Opdater oversigten automatisk
        await loadOverview();
        // Ryd felterne
        document.getElementById('grant-email').value = '';
        document.getElementById('grant-qty').value = '5';
        document.getElementById('grant-note').value = '';
      }
    });
  }

  // === TOKEN OVERSIGT FUNKTIONER ===
  
  // Load overview function
  async function loadOverview() {
    const plan = document.getElementById('flt-plan').value || null;
    const balance = document.getElementById('flt-balance').value || null;
    const days = parseInt(document.getElementById('flt-days').value || '30', 10);

    try {
      const { data, error } = await supabase.rpc('get_billing_overview', {
        p_plan: plan,
        p_has_tokens: balance,
        p_days: days
      });

      if (error) throw error;

      displayOverview(data || []);
    } catch (error) {
      console.error('Fejl ved indl√¶sning af oversigt:', error);
      document.getElementById('overview-summary').textContent = `‚ùå Fejl: ${error.message}`;
    }
  }

  // Display overview data in table
  function displayOverview(data) {
    const tbody = document.querySelector('#overview-table tbody');
    const summary = document.getElementById('overview-summary');
    
    // Clear existing rows
    tbody.innerHTML = '';
    
    if (!data || data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:var(--muted)">Ingen brugere fundet</td></tr>';
      summary.textContent = 'Ingen data at vise';
      return;
    }

    // Calculate summary stats
    const totalUsers = data.length;
    const totalTokens = data.reduce((sum, row) => sum + (row.token_balance || 0), 0);
    const totalSpent = data.reduce((sum, row) => sum + (row.spent_period || 0), 0);
    const subscriptionUsers = data.filter(row => row.plan === 'subscription').length;
    const prepaidUsers = data.filter(row => row.plan === 'prepaid').length;

    summary.innerHTML = `
      <strong>${totalUsers}</strong> brugere ‚Ä¢ 
      <strong>${subscriptionUsers}</strong> abonnement ‚Ä¢ 
      <strong>${prepaidUsers}</strong> forudbetalt ‚Ä¢ 
      <strong>${totalTokens}</strong> tokens i alt ‚Ä¢ 
      <strong>${totalSpent}</strong> brugt i periode
    `;

    // Populate table
    data.forEach(row => {
      const tr = document.createElement('tr');
      
      const formatDate = (dateStr) => {
        if (!dateStr) return '-';
        return new Date(dateStr).toLocaleString('da-DK', {
          day: '2-digit',
          month: '2-digit',
          hour: '2-digit',
          minute: '2-digit'
        });
      };

      const planText = row.plan === 'subscription' ? 'Abonnement' : 'Forudbetalt';
      const balanceColor = row.token_balance > 0 ? 'color:green' : 
                          row.token_balance < 0 ? 'color:red' : '';

      tr.innerHTML = `
        <td style="padding:6px;">${row.email}</td>
        <td style="padding:6px;">${planText}</td>
        <td style="padding:6px;text-align:right;${balanceColor}"><strong>${row.token_balance || 0}</strong></td>
        <td style="padding:6px;text-align:right;">${row.spent_period || 0}</td>
        <td style="padding:6px;">${formatDate(row.last_spend_at)}</td>
        <td style="padding:6px;">
          <input type="number" class="input" style="width:60px;padding:2px 4px;font-size:0.8rem;" value="10" min="1" max="100">
          <button class="btn small" style="font-size:0.7rem;padding:2px 6px;margin-left:4px;" 
                  onclick="quickGrant('${row.email}', this.previousElementSibling.value)">+</button>
        </td>
        <td style="padding:6px;">
          <button class="btn small" style="font-size:0.7rem;padding:2px 6px;" 
                  onclick="showLedger('${row.email}', '${row.user_id}')">Se ledger</button>
        </td>
      `;
      
      tbody.appendChild(tr);
    });
  }

  // Quick grant tokens function
  async function quickGrant(email, qty) {
    const amount = parseInt(qty, 10);
    if (!amount || amount < 1) {
      alert('Indtast et gyldigt antal tokens');
      return;
    }

    try {
      const { data, error } = await supabase.rpc('grant_tokens', {
        p_email: email,
        p_qty: amount,
        p_note: `Hurtig tildeling via oversigt`
      });

      if (error) throw error;
      if (data?.error) throw new Error(data.error);

      // Reload overview
      await loadOverview();
      
      // Show success message briefly
      const summary = document.getElementById('overview-summary');
      const originalText = summary.innerHTML;
      summary.innerHTML = `‚úÖ Tildelt ${amount} tokens til ${email}`;
      setTimeout(() => { summary.innerHTML = originalText; }, 3000);

    } catch (error) {
      alert(`Fejl ved tildeling: ${error.message}`);
    }
  }

  // Show ledger function
  async function showLedger(email, userId) {
    try {
      const { data, error } = await supabase
        .from('token_ledger')
        .select('*')
        .eq('user_id', userId)
        .order('created_at', { ascending: false });

      if (error) throw error;

      const dialog = document.getElementById('dlg-ledger');
      const emailSpan = document.getElementById('dlg-email');
      const ledgerWrap = document.getElementById('ledger-wrap');

      emailSpan.textContent = email;

      if (!data || data.length === 0) {
        ledgerWrap.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px;">Ingen transaktioner fundet</p>';
      } else {
        ledgerWrap.innerHTML = `
          <table style="width:100%;border-collapse:collapse;font-size:0.9rem;">
            <thead>
              <tr style="background:var(--bg);border-bottom:1px solid var(--line);">
                <th style="padding:8px;text-align:left;">Dato</th>
                <th style="padding:8px;text-align:left;">Type</th>
                <th style="padding:8px;text-align:right;">Antal</th>
                <th style="padding:8px;text-align:left;">Note</th>
              </tr>
            </thead>
            <tbody>
              ${data.map(entry => {
                const typeText = {
                  'grant': 'Tildeling',
                  'spend': 'Forbrug',
                  'refund': 'Refusion',
                  'adjust': 'Justering'
                }[entry.kind] || entry.kind;
                
                const qtyColor = entry.qty > 0 ? 'color:green' : 'color:red';
                
                return `
                  <tr style="border-bottom:1px solid var(--line);">
                    <td style="padding:6px;">${new Date(entry.created_at).toLocaleString('da-DK')}</td>
                    <td style="padding:6px;">${typeText}</td>
                    <td style="padding:6px;text-align:right;${qtyColor}"><strong>${entry.qty > 0 ? '+' : ''}${entry.qty}</strong></td>
                    <td style="padding:6px;">${entry.note || '-'}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;
      }

      dialog.showModal();
    } catch (error) {
      alert(`Fejl ved indl√¶sning af ledger: ${error.message}`);
    }
  }

  // Export CSV function
  async function exportOverview() {
    const plan = document.getElementById('flt-plan').value || null;
    const balance = document.getElementById('flt-balance').value || null;
    const days = parseInt(document.getElementById('flt-days').value || '30', 10);

    try {
      const { data, error } = await supabase.rpc('get_billing_overview', {
        p_plan: plan,
        p_has_tokens: balance,
        p_days: days
      });

      if (error) throw error;
      if (!data || data.length === 0) {
        alert('Ingen data at eksportere');
        return;
      }

      // Create CSV content
      const headers = ['Email', 'Plan', 'Token Saldo', 'Forbrug (periode)', 'Sidste Forbrug'];
      const csvContent = [
        headers.join(','),
        ...data.map(row => [
          `"${row.email}"`,
          `"${row.plan === 'subscription' ? 'Abonnement' : 'Forudbetalt'}"`,
          row.token_balance || 0,
          row.spent_period || 0,
          `"${row.last_spend_at ? new Date(row.last_spend_at).toLocaleString('da-DK') : '-'}"`
        ].join(','))
      ].join('\n');

      // Download CSV
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `token_oversigt_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

    } catch (error) {
      alert(`Fejl ved eksport: ${error.message}`);
    }
  }

  // Event listeners for overview functionality
  const btnLoadOverview = document.getElementById('btn-load-overview');
  if (btnLoadOverview) {
    btnLoadOverview.addEventListener('click', loadOverview);
  }

  const btnExportCsv = document.getElementById('btn-export-csv');
  if (btnExportCsv) {
    btnExportCsv.addEventListener('click', exportOverview);
  }

  const dlgClose = document.getElementById('dlg-close');
  if (dlgClose) {
    dlgClose.addEventListener('click', () => {
      document.getElementById('dlg-ledger').close();
    });
  }

  // Auto-load overview when tokens tab is selected
  document.querySelector('[data-tab="tokens"]')?.addEventListener('click', () => {
    setTimeout(() => {
      if (document.getElementById('tab-tokens').style.display !== 'none') {
        loadOverview();
      }
    }, 100);
  });

  // Make functions globally available
  window.quickGrant = quickGrant;
  window.showLedger = showLedger;
  window.loadOverview = loadOverview;

  // === FAKTURERING FUNKTIONER ===
  
  // Periode beregning
  function calculatePeriod() {
    const period = document.getElementById('inv-period').value;
    const year = parseInt(document.getElementById('inv-year').value);
    const customDates = document.getElementById('custom-dates');
    
    if (period === 'custom') {
      customDates.style.display = 'block';
      return null;
    } else {
      customDates.style.display = 'none';
    }
    
    let start, end;
    const now = new Date();
    
    switch(period) {
      case 'last_month':
        start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        end = new Date(now.getFullYear(), now.getMonth(), 0);
        break;
      case 'q1':
        start = new Date(year, 0, 1);
        end = new Date(year, 2, 31);
        break;
      case 'q2':
        start = new Date(year, 3, 1);
        end = new Date(year, 5, 30);
        break;
      case 'q3':
        start = new Date(year, 6, 1);
        end = new Date(year, 8, 30);
        break;
      case 'q4':
        start = new Date(year, 9, 1);
        end = new Date(year, 11, 31);
        break;
      case 'last_year':
        start = new Date(year, 0, 1);
        end = new Date(year, 11, 31);
        break;
    }
    
    return {
      start: start.toISOString().split('T')[0],
      end: end.toISOString().split('T')[0]
    };
  }
  
  // Indl√¶s faktura data
  async function loadInvoiceData() {
    let period = calculatePeriod();
    
    if (!period) {
      period = {
        start: document.getElementById('inv-start').value,
        end: document.getElementById('inv-end').value
      };
    }
    
    if (!period.start || !period.end) {
      alert('V√¶lg venligst en gyldig periode');
      return;
    }
    
    try {
      // Hent regnskabsoversigt
      const { data: accounting, error: accError } = await supabase.rpc('get_accounting_overview', {
        p_start: period.start,
        p_end: period.end
      });
      
      if (accError) throw accError;
      
      // Hent faktura data
      const { data: invoices, error: invError } = await supabase.rpc('get_invoice_data', {
        p_start: period.start,
        p_end: period.end
      });
      
      if (invError) throw invError;
      
      displayAccountingSummary(accounting[0] || {});
      displayInvoiceData(invoices || []);
      
    } catch (error) {
      console.error('Fejl ved indl√¶sning af faktura data:', error);
      alert('Fejl ved indl√¶sning: ' + error.message);
    }
  }
  
  // Vis regnskabsoversigt
  function displayAccountingSummary(data) {
    const summary = document.getElementById('accounting-summary');
    
    summary.innerHTML = `
      <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:20px;">
        <div>
          <strong>Abonnement-oms√¶tning:</strong><br>
          ${(data.subscription_revenue || 0).toLocaleString('da-DK')} kr<br>
          <span class="muted">${(data.subscription_tokens || 0).toLocaleString('da-DK')} tokens</span>
        </div>
        <div>
          <strong>Forudbetalt-oms√¶tning:</strong><br>
          ${(data.prepaid_revenue || 0).toLocaleString('da-DK')} kr<br>
          <span class="muted">${(data.prepaid_tokens || 0).toLocaleString('da-DK')} tokens</span>
        </div>
        <div>
          <strong>Total oms√¶tning:</strong><br>
          <span style="font-size:1.2em; color:green;">
            ${(data.total_revenue || 0).toLocaleString('da-DK')} kr
          </span><br>
          <span class="muted">${(data.total_tokens || 0).toLocaleString('da-DK')} tokens</span>
        </div>
      </div>
    `;
  }
  
  // Vis faktura data
  function displayInvoiceData(data) {
    const tbody = document.querySelector('#invoice-table tbody');
    const summary = document.getElementById('invoice-summary');
    
    // Anvend filtre
    const showNew = document.getElementById('filter-new').checked;
    const showUnpaid = document.getElementById('filter-unpaid').checked;
    const showUsage = document.getElementById('filter-usage').checked;
    
    let filteredData = data.filter(row => {
      if (showUsage && row.tokens_used <= 0) return false;
      if (showNew && row.invoice_status !== 'not_invoiced') return false;
      if (showUnpaid && row.invoice_status === 'paid') return false;
      return true;
    });
    
    tbody.innerHTML = '';
    
    if (filteredData.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--muted)">Ingen fakturaer fundet</td></tr>';
      summary.textContent = 'Ingen data at vise';
      return;
    }
    
    // Beregn resum√©
    const totalInvoices = filteredData.length;
    const totalAmount = filteredData.reduce((sum, row) => sum + parseFloat(row.amount_dkk || 0), 0);
    const newCount = filteredData.filter(row => row.invoice_status === 'not_invoiced').length;
    const sentCount = filteredData.filter(row => row.invoice_status === 'sent').length;
    const paidCount = filteredData.filter(row => row.invoice_status === 'paid').length;
    
    summary.innerHTML = `
      <strong>${totalInvoices}</strong> fakturaer ‚Ä¢ 
      <strong>${totalAmount.toLocaleString('da-DK')} kr</strong> ‚Ä¢ 
      ${newCount} nye ‚Ä¢ ${sentCount} sendt ‚Ä¢ ${paidCount} betalt
    `;
    
    // Populer tabel
    filteredData.forEach(row => {
      const tr = document.createElement('tr');
      
      const statusText = {
        'not_invoiced': 'Ikke faktureret',
        'draft': 'Kladde', 
        'sent': 'Sendt',
        'paid': 'Betalt'
      }[row.invoice_status] || row.invoice_status;
      
      const statusColor = {
        'not_invoiced': '#666',
        'draft': '#f39c12',
        'sent': '#3498db', 
        'paid': '#27ae60'
      }[row.invoice_status] || '#666';
      
      const sentDate = row.sent_at ? new Date(row.sent_at).toLocaleDateString('da-DK') : '-';
      
      tr.innerHTML = `
        <td style="padding:6px;">${row.email}</td>
        <td style="padding:6px;text-align:right;"><strong>${row.tokens_used}</strong></td>
        <td style="padding:6px;text-align:right;"><strong>${parseFloat(row.amount_dkk || 0).toLocaleString('da-DK')} kr</strong></td>
        <td style="padding:6px;color:${statusColor};"><strong>${statusText}</strong></td>
        <td style="padding:6px;">${sentDate}</td>
        <td style="padding:6px;">
          ${row.invoice_status === 'not_invoiced' ? 
            `<button class="btn small" onclick="generateInvoice('${row.email}')">üìÑ Generer</button>` :
            `<button class="btn small ghost" onclick="updateInvoiceStatus('${row.email}', 'sent')">üìß Marker sendt</button>
             <button class="btn small ghost" onclick="updateInvoiceStatus('${row.email}', 'paid')">‚úÖ Marker betalt</button>`
          }
        </td>
      `;
      
      tbody.appendChild(tr);
    });
  }
  
  // Generer faktura
  async function generateInvoice(email) {
    let period = calculatePeriod();
    if (!period) {
      period = {
        start: document.getElementById('inv-start').value,
        end: document.getElementById('inv-end').value
      };
    }
    
    try {
      const { data, error } = await supabase.rpc('create_or_update_invoice', {
        p_user_email: email,
        p_start: period.start,
        p_end: period.end,
        p_status: 'draft'
      });
      
      if (error) throw error;
      if (data.error) throw new Error(data.error);
      
      alert('‚úÖ Faktura oprettet!');
      loadInvoiceData();
      
    } catch (error) {
      alert('‚ùå Fejl: ' + error.message);
    }
  }
  
  // Opdater faktura status
  async function updateInvoiceStatus(email, status) {
    let period = calculatePeriod();
    if (!period) {
      period = {
        start: document.getElementById('inv-start').value,
        end: document.getElementById('inv-end').value
      };
    }
    
    try {
      const { data, error } = await supabase.rpc('create_or_update_invoice', {
        p_user_email: email,
        p_start: period.start,
        p_end: period.end,
        p_status: status
      });
      
      if (error) throw error;
      if (data.error) throw new Error(data.error);
      
      alert('‚úÖ Status opdateret!');
      loadInvoiceData();
      
    } catch (error) {
      alert('‚ùå Fejl: ' + error.message);
    }
  }
  
  // Event listeners for fakturering
  document.getElementById('btn-load-invoices')?.addEventListener('click', loadInvoiceData);
  document.getElementById('inv-period')?.addEventListener('change', function() {
    document.getElementById('custom-dates').style.display = 
      this.value === 'custom' ? 'block' : 'none';
  });
  
  document.getElementById('filter-new')?.addEventListener('change', () => {
    const currentData = document.querySelector('#invoice-table tbody').innerHTML;
    if (currentData && !currentData.includes('Ingen fakturaer')) {
      loadInvoiceData();
    }
  });
  
  document.getElementById('filter-unpaid')?.addEventListener('change', () => {
    const currentData = document.querySelector('#invoice-table tbody').innerHTML;
    if (currentData && !currentData.includes('Ingen fakturaer')) {
      loadInvoiceData();
    }
  });
  
  document.getElementById('filter-usage')?.addEventListener('change', () => {
    const currentData = document.querySelector('#invoice-table tbody').innerHTML;
    if (currentData && !currentData.includes('Ingen fakturaer')) {
      loadInvoiceData();
    }
  });

  // Make invoice functions globally available
  window.generateInvoice = generateInvoice;
  window.updateInvoiceStatus = updateInvoiceStatus;
  window.loadInvoiceData = loadInvoiceData;

});  <!-- slut p√• window.addEventListener('load', ...) -->
</script>
</body>
</html>
