<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KOMPAS ‚Ä¢ Master Backoffice</title>
  <link rel="icon" href="data:," />
 <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; connect-src 'self' https://*.supabase.co">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* ---------- Theme ---------- */
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg1:#667eea; --bg2:#764ba2; --ink:#2d3748; --muted:#718096;
      --card:#f8fafc; --line:#e2e8f0; --brand:#667eea; --radius:16px;
      --master-bg1:#e53e3e; --master-bg2:#d53f8c; /* R√∏de toner for master */
      --success:#48bb78; --error:#f56565;
    }
    body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,var(--master-bg1) 0%,var(--master-bg2) 100%);min-height:100vh;padding:20px;color:var(--ink)}
    .app{max-width:1400px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.15);overflow:hidden}

    /* Header */
    .header{background:linear-gradient(135deg,#2d3748 0%,#4a5568 100%);color:#fff;padding:20px 24px;display:grid;grid-template-columns:1fr auto;gap:16px;align-items:center;position:sticky;top:0;z-index:30}
    .club-title{display:flex;align-items:center;gap:14px}
    .club-logo{width:56px;height:56px;border-radius:14px;background:#fff;display:grid;place-items:center}
    .club-logo img{height:38px;object-fit:contain}
    .club-name{font-size:1.6rem;font-weight:800;margin-bottom:2px}
    .club-sub{opacity:.85;font-size:.92rem}
    .header-tools{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .input, .select{border:1px solid var(--line);background:#fff;color:#111;padding:10px 12px;border-radius:10px;font-size:.95rem}
    .btn{cursor:pointer;font-weight:700;border:1px solid var(--line);background:#fff;color:#111;padding:10px 14px;border-radius:10px}
    .btn.primary{background:var(--master-bg1);border-color:var(--master-bg1);color:#fff}
    .btn.ghost{background:rgba(255,255,255,.1);color:#fff;border-color:rgba(255,255,255,.35)}

    /* Tabs */
    .tabbar{background:var(--card);border-bottom:1px solid var(--line);padding:0 20px;display:flex;gap:0;position:sticky;top:120px;z-index:20}
    .tabbtn{background:none;border:none;padding:16px 22px;font-size:1.05rem;font-weight:700;color:#64748b;cursor:pointer;border-bottom:3px solid transparent;transition:.25s;white-space:nowrap;position:relative}
    .tabbtn:hover{color:#334155;background:rgba(229,62,62,.06)}
    .tabbtn.active{color:var(--master-bg1);border-bottom-color:var(--master-bg1);background:#fff}
    .content{padding:20px}
    .section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px}
    .grid{display:grid;gap:16px}
    .grid2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .row{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted);font-size:.92rem}

    /* Tables */
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left;font-size:.95rem}
    thead th{position:sticky;top:0;background:#fff;z-index:2}

    /* Template editor */
    .template-editor{background:#fff;border:1px solid var(--line);border-radius:var(--radius);padding:16px;margin-top:10px}
    .domain-section{border-left:4px solid var(--master-bg1);padding-left:12px;margin:10px 0}
    .category-item{background:var(--card);padding:10px;margin:5px 0;border-radius:8px}
    .question-item{background:#fff;border:1px solid var(--line);padding:8px;margin:4px 0;border-radius:6px}
  </style>
</head>
<body>
<div class="app">
  <!-- HEADER -->
  <div class="header">
    <div class="club-title">
      <div class="club-logo"><img src="../kompas_logo.png" alt="KOMPAS" onerror="this.style.display='none'"></div>
      <div>
        <div class="club-name">KOMPAS ‚Äî Master Backoffice</div>
        <div class="club-sub">Skabeloner ‚Ä¢ Projekter ‚Ä¢ Full Admin</div>
      </div>
    </div>

    <div class="header-tools" id="authArea">
        <span id="userEmail" class="muted"></span>
        <button id="logoutBtn" class="btn ghost">Log ud</button>
    </div>
  </div>

  <!-- TABS - FJERNET people og results tabs -->
  <div class="tabbar">
    <button class="tabbtn active" data-tab="templates">üß© Skabeloner</button>
    <button class="tabbtn" data-tab="projects">üìÅ Projekter</button>
    <button class="tabbtn" data-tab="users">üë§ Brugere</button>
  </div>

  <!-- LAYOUT -->
  <div class="layout" style="display:grid;grid-template-columns:1fr 300px">
    <!-- MAIN -->
    <div class="content">

      <!-- Skabeloner (default synlig) -->
      <div id="tab-templates" class="section" style="display:block">
        <h3>üß© Skabelon Administration</h3>
        <div class="row" style="margin:16px 0">
          <input id="tmplName" class="input" placeholder="Navn p√• skabelon">
          <input id="tmplDesc" class="input" placeholder="Beskrivelse">
          <button id="createTemplate" class="btn primary">Opret skabelon</button>
        </div>

        <h4 style="margin-top:24px">Eksisterende skabeloner</h4>
        <ul id="tmplList" style="list-style:none;display:grid;gap:8px;margin-top:8px"></ul>
      </div>

      <!-- Projekter - KUN MONITORING -->
      <div id="tab-projects" class="section" style="display:none">
        <h3>üìÅ Projektoversigt</h3>
        <p class="muted" style="margin-bottom:20px">Overv√•g alle projekter i systemet. Evaluerere kan oprette projekter via deres admin-panel.</p>
        
        <div class="section" style="margin-top:8px">
          <table id="projectsTbl">
            <thead>
              <tr>
                <th>Titel</th>
                <th>Ejer</th>
                <th>√Öbner</th>
                <th>Lukker</th>
                <th>Link</th>
                <th style="text-align:right">Handling</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

     
    <!-- Brugere -->
    <div id="tab-users" class="section" style="display:none">
    <h3>üîë Generer aktiveringsn√∏gle</h3>
    <div class="row" style="margin:16px 0">
        <input id="keyEmail" class="input" placeholder="Email til evaluator" type="email">
        <input id="keyNotes" class="input" placeholder="Valgfri note">
        <button id="generateKey" class="btn primary">Generer n√∏gle</button>
    </div>
    
    <div id="keyResult" class="section" style="display:none;background:#e6fffa;border-color:#81e6d9">
        <h4 style="color:#234e52">Aktiveringsn√∏gle genereret!</h4>
        <div style="margin-top:12px">
        <p><strong>N√∏gle:</strong> <span id="generatedKey" style="font-family:monospace;font-size:1.2rem;font-weight:bold"></span></p>
        <p><strong>Email:</strong> <span id="generatedEmail"></span></p>
        </div>
        <p class="muted" style="margin-top:12px">Send denne n√∏gle til brugeren sammen med login-linket.</p>
    </div>

    <hr style="border:0;border-top:1px solid var(--line);margin:24px 0">

    <h3>üìã Aktiveringsn√∏gler</h3>
    <div class="section" style="margin-top:8px">
        <table id="keysTbl">
        <thead>
            <tr>
            <th>N√∏gle</th>
            <th>Email</th>
            <th>Status</th>
            <th>Oprettet</th>
            <th>Brugt</th>
            <th>Note</th>
            </tr>
        </thead>
        <tbody></tbody>
        </table>
    </div>

    <hr style="border:0;border-top:1px solid var(--line);margin:24px 0">
    
    <h3>üë§ Eksisterende brugere</h3>
    <div class="row" style="margin:16px 0">
        <input id="userEmail" class="input" placeholder="Email adresse">
        <select id="userRole" class="select">
        <option value="evaluator">Evaluator (kun projekter)</option>
        <option value="programmer">Programm√∏r (fuld adgang)</option>
        </select>
        <button id="addUser" class="btn primary">Tilf√∏j rolle direkte</button>
    </div>

    <div class="section">
        <table id="usersTbl">
        <thead>
            <tr>
            <th>Email</th>
            <th>Rolle</th>
            <th>Oprettet</th>
            <th style="text-align:right">Handling</th>
            </tr>
        </thead>
        <tbody></tbody>
        </table>
    </div>
    </div>

    
  </div>

<script>
window.addEventListener('load', function() {
  let user = null;

  const SUPABASE_URL = "https://wsrstyrsuwhcmmlmnbrz.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzcnN0eXJzdXdoY21tbG1uYnJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MTU0NTIsImV4cCI6MjA3MTE5MTQ1Mn0.Rf3Z3bQGjV5CKXKZr6IMOjzPdbhVJCh3SwuvlkpxUD0";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id)=>document.getElementById(id);
  
  // Tabs - FJERNET people og results
  document.querySelectorAll('.tabbtn').forEach(btn=>{
    btn.onclick = ()=>{
      document.querySelectorAll('.tabbtn').forEach(x=>x.classList.remove('active'));
      btn.classList.add('active');

      // Hide all sections
      ['templates','projects','users'].forEach(name=>{
        const panel = $('tab-'+name);
        if(panel) panel.style.display = 'none';
      });

      // Show selected section
      const target = $('tab-' + btn.dataset.tab);
      if(target) target.style.display = 'block';
    };
  });

  // Auth gate: kun 'programmer' m√• blive p√• master.html
  $('logoutBtn').onclick = async ()=>{ 
    await supabase.auth.signOut(); 
    window.location.href = 'login.html';
  };

  async function guard(){
    const { data: u } = await supabase.auth.getUser();
    if(!u?.user){ 
        window.location.href = 'login.html'; 
        return;
    }
    const { data: roleData } = await supabase
        .from('user_roles')
        .select('role')
        .eq('user_id', u.user.id)
        .single();

    if(roleData?.role !== 'programmer'){
        // Logget ind men ikke master => send til admin
        window.location.href = 'admin.html';
        return;
    }

    user = u.user;
    const emailEl = document.getElementById('userEmail');
    if(emailEl) emailEl.textContent = user.email || '';
    await loadAll();
  }

  // K√∏r gate ved load
  guard();

  async function loadAll(){ 
    await loadTemplates(); 
    await loadProjects(); 
    await loadUsers();
  }

  // Templates - √ÜNDRET til direkte rediger/slet knapper
  async function loadTemplates(){
    const { data } = await supabase.from('templates').select().order('created_at',{ascending:false});
    
    // List med rediger/slet knapper
    const ul = $('tmplList'); 
    ul.innerHTML=''; 
    (data||[]).forEach(t=>{ 
      const li=document.createElement('li'); 
      li.className='section'; 
      li.style.display = 'flex';
      li.style.justifyContent = 'space-between';
      li.style.alignItems = 'center';
      li.innerHTML=`
        <div>
          <strong>${t.name}</strong> v${t.version}<br>
          <span class="muted">${t.description||''}</span>
        </div>
        <div class="row">
          <button class="btn" onclick="editTemplate('${t.id}')" style="background:var(--brand);color:white;border-color:var(--brand)">Rediger</button>
          <button class="btn" onclick="deleteTemplate('${t.id}', '${t.name.replace(/'/g, '\\\'')}')" style="background:#dc3545;color:white;border-color:#dc3545">Slet</button>
        </div>
      `; 
      ul.appendChild(li); 
    });
  }

  // Template actions
  window.editTemplate = (id) => {
    alert('Template redigering kommer snart! ID: ' + id);
  };

  window.deleteTemplate = async (templateId, templateName) => {
    if(!confirm(`Er du sikker p√• du vil slette skabelonen "${templateName}"?\n\nDenne handling kan ikke fortrydes!`)) return;
    
    try {
      const { error } = await supabase.from('templates').delete().eq('id', templateId);
      if(error) throw error;
      
      alert(`Skabelon "${templateName}" er slettet`);
      loadTemplates();
      
    } catch(error) {
      alert('Fejl ved sletning: ' + error.message);
    }
  };

  $('createTemplate').onclick = async ()=>{
    const name = $('tmplName').value;
    const desc = $('tmplDesc').value;
    if(!name) return alert('Navn p√•kr√¶vet');
    
    const { data, error } = await supabase.from('templates').insert({
      name, description: desc, version: 1
    }).select().single();
    
    if(error) return alert(error.message);
    $('tmplName').value = '';
    $('tmplDesc').value = '';
    loadTemplates();
  };

  // Projects (show all projects for master with owner info) - KUN MONITORING
  async function loadProjects(){
    const { data } = await supabase.from('v_all_projects_with_owners').select('*').limit(1000);
    const tb = $('projectsTbl').querySelector('tbody'); 
    tb.innerHTML='';
    (data||[]).forEach(p=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
        <td><strong>${p.title}</strong><br><span class="muted">${p.info_text || ''}</span></td>
        <td>${p.owner_email || 'N/A'}<br><span class="muted">${p.owner_role || 'ingen rolle'}</span></td>
        <td>${p.open_at ? new Date(p.open_at).toLocaleString('da-DK') : 'Ikke sat'}</td>
        <td>${p.close_at ? new Date(p.close_at).toLocaleString('da-DK') : 'Ikke sat'}</td>
        <td>${p.link_url ? '‚úÖ' : '‚Äî'}</td>
        <td style="text-align:right">
            <span class="muted">Kun monitoring</span>
        </td>`;
        tb.appendChild(tr);
    });
  }

  // Users management
  async function loadUsers(){
  // Load activation keys
  const { data: keys } = await supabase.from('v_activation_keys').select('*').order('created_at',{ascending:false});
  const ktb = $('keysTbl').querySelector('tbody'); 
  ktb.innerHTML='';
  (keys||[]).forEach(k=>{
    const tr=document.createElement('tr');
    const status = k.used ? `<span style="color:var(--success)">Brugt</span>` : `<span style="color:var(--brand)">Aktiv</span>`;
    const usedInfo = k.used ? `${new Date(k.used_at).toLocaleDateString()}<br><span class="muted">${k.used_by_email}</span>` : '-';
    tr.innerHTML = `
      <td style="font-family:monospace;font-weight:bold">${k.key_code}</td>
      <td>${k.email}</td>
      <td>${status}</td>
      <td>${new Date(k.created_at).toLocaleDateString()}</td>
      <td>${usedInfo}</td>
      <td>${k.notes || '-'}</td>
    `;
    ktb.appendChild(tr);
  });

  // Load existing users
  const { data } = await supabase.from('v_users_with_roles').select('*').order('created_at',{ascending:false});
  const tb = $('usersTbl').querySelector('tbody'); 
  tb.innerHTML='';
  (data||[]).forEach(u=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${u.email || 'N/A'}</td><td>${u.role || 'Ingen rolle'}</td><td>${new Date(u.created_at).toLocaleDateString()}</td><td style="text-align:right"><button class="btn" onclick="removeUserRole('${u.email}')">Fjern rolle</button></td>`;
    tb.appendChild(tr);
  });
}

// Generate activation key
$('generateKey').onclick = async ()=>{
  const email = $('keyEmail').value;
  const notes = $('keyNotes').value;
  if(!email) return alert('Email p√•kr√¶vet');
  
  const { data, error } = await supabase.rpc('generate_activation_key', {
    p_email: email,
    p_notes: notes || null
  });
  
  if(error) return alert(error.message);
  if(data.error) return alert(data.error);
  
  // Show result
  $('generatedKey').textContent = data.key_code;
  $('generatedEmail').textContent = data.email;
  $('keyResult').style.display = 'block';
  
  // Clear inputs
  $('keyEmail').value = '';
  $('keyNotes').value = '';
  
  // Reload keys table
  loadUsers();
  
  // Hide result after 30 seconds
  setTimeout(() => {
    $('keyResult').style.display = 'none';
  }, 30000);
};

  // Global function for remove user role
  window.removeUserRole = async (email) => {
    if(!confirm(`Fjern rolle for ${email}?`)) return;
    
    const { data, error } = await supabase.rpc('remove_user_role', {
      p_user_email: email
    });
    
    if(error) return alert(error.message);
    if(data.error) return alert(data.error);
    
    alert(data.message);
    loadUsers();
  };

  // Add user role directly
  $('addUser').onclick = async ()=>{
    const email = $('userEmail').value.trim();
    const role = $('userRole').value;
    if(!email) return alert('Email p√•kr√¶vet');
    
    const { data, error } = await supabase.rpc('manage_user_role', {
      p_user_email: email,
      p_role: role
    });
    
    if(error) return alert(error.message);
    if(data.error) return alert(data.error);
    
    alert(data.message);
    $('userEmail').value = '';
    loadUsers();
  };

});
</script>
</body>
</html>
