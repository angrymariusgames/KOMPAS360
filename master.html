<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KOMPAS ‚Ä¢ Master Backoffice</title>
  <link rel="icon" href="data:," />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; connect-src 'self' https://*.supabase.co">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* ---------- Theme ---------- */
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg1:#667eea; --bg2:#764ba2; --ink:#2d3748; --muted:#718096;
      --card:#f8fafc; --line:#e2e8f0; --brand:#667eea; --radius:16px;
      --master-bg1:#e53e3e; --master-bg2:#d53f8c;
      --success:#48bb78; --error:#f56565;
    }
    body{font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,var(--master-bg1) 0%,var(--master-bg2) 100%);min-height:100vh;padding:20px;color:var(--ink)}
    .app{max-width:1400px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.15);overflow:hidden}

    /* Header */
    .header{background:linear-gradient(135deg,#2d3748 0%,#4a5568 100%);color:#fff;padding:20px 24px;display:grid;grid-template-columns:1fr auto;gap:16px;align-items:center;position:sticky;top:0;z-index:30}
    .club-title{display:flex;align-items:center;gap:14px}
    .club-logo{width:56px;height:56px;border-radius:14px;background:#fff;display:grid;place-items:center}
    .club-logo img{height:38px;object-fit:contain}
    .club-name{font-size:1.6rem;font-weight:800;margin-bottom:2px}
    .club-sub{opacity:.85;font-size:.92rem}
    .header-tools{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .input, .select{border:1px solid var(--line);background:#fff;color:#111;padding:10px 12px;border-radius:10px;font-size:.95rem}
    .btn{cursor:pointer;font-weight:700;border:1px solid var(--line);background:#fff;color:#111;padding:10px 14px;border-radius:10px;transition:.25s}
    .btn.primary{background:var(--master-bg1);border-color:var(--master-bg1);color:#fff}
    .btn.ghost{background:rgba(255,255,255,.1);color:#fff;border-color:rgba(255,255,255,.35)}
    .btn.small{padding:6px 10px;font-size:.85rem}

    /* Tabs */
    .tabbar{background:var(--card);border-bottom:1px solid var(--line);padding:0 20px;display:flex;gap:0;position:sticky;top:120px;z-index:20}
    .tabbtn{background:none;border:none;padding:16px 22px;font-size:1.05rem;font-weight:700;color:#64748b;cursor:pointer;border-bottom:3px solid transparent;transition:.25s;white-space:nowrap;position:relative}
    .tabbtn:hover{color:#334155;background:rgba(229,62,62,.06)}
    .tabbtn.active{color:var(--master-bg1);border-bottom-color:var(--master-bg1);background:#fff}
    .content{padding:20px;max-width:100%}
    .section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;margin-bottom:20px}
    .grid{display:grid;gap:16px}
    .grid2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .row{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted);font-size:.92rem}

    /* Tables */
    table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
    th,td{padding:12px;border-bottom:1px solid var(--line);text-align:left;font-size:.95rem;overflow:hidden;text-overflow:ellipsis}
    thead th{position:sticky;top:0;background:#fff;z-index:2;font-weight:700}

    /* Project table */
    .projects-table th:nth-child(1) { width: 25%; }
    .projects-table th:nth-child(2) { width: 20%; }
    .projects-table th:nth-child(3) { width: 15%; }
    .projects-table th:nth-child(4) { width: 15%; }
    .projects-table th:nth-child(5) { width: 10%; }
    .projects-table th:nth-child(6) { width: 10%; }
    .projects-table th:nth-child(7) { width: 5%; }

    /* Status badges */
    .status-badge{display:inline-block;padding:4px 8px;border-radius:12px;font-size:.8rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
    .status-open{background:#c6f6d5;color:#22543d}
    .status-closed{background:#fed7d7;color:#9b2c2c}
    .status-draft{background:#e6fffa;color:#234e52}

    /* Users table */
    .users-table th:nth-child(1) { width: 35%; }
    .users-table th:nth-child(2) { width: 15%; }
    .users-table th:nth-child(3) { width: 20%; }
    .users-table th:nth-child(4) { width: 30%; }

    /* Key result */
    .key-result{background:#e6fffa;border:1px solid #81e6d9;border-radius:var(--radius);padding:20px;margin:16px 0;display:none}
    .key-result h4{color:#234e52;margin-bottom:12px}
    .key-code{font-family:monospace;font-size:1.4rem;font-weight:bold;background:#fff;padding:8px 12px;border-radius:8px;display:inline-block;margin:8px 0;border:2px solid #81e6d9}

    /* Template list */
    .template-item{display:flex;justify-content:space-between;align-items:center;padding:16px;background:var(--card);border:1px solid var(--line);border-radius:var(--radius);margin-bottom:12px}
    .template-info{flex:1}
    .template-actions{display:flex;gap:8px}

    @media(max-width:1100px){.grid2{grid-template-columns:1fr}table{font-size:.85rem}th,td{padding:8px}}
  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="club-title">
      <div class="club-logo"><img src="./assets/logo.png" alt="KOMPAS" onerror="this.style.display='none'"></div>
      <div>
        <div class="club-name">KOMPAS ‚Äî Master Backoffice</div>
        <div class="club-sub">Skabeloner ‚Ä¢ Projekter ‚Ä¢ Brugeradministration</div>
      </div>
    </div>
    <div class="header-tools">
      <span id="userEmail" class="muted"></span>
      <button id="logoutBtn" class="btn ghost">Log ud</button>
    </div>
  </div>

  <div class="tabbar">
    <button class="tabbtn active" data-tab="templates">üß© Skabeloner</button>
    <button class="tabbtn" data-tab="projects">üìÅ Projekter</button>
    <button class="tabbtn" data-tab="users">üë§ Brugere</button>
  </div>

  <div class="content">

    <!-- Skabeloner -->
    <div id="tab-templates" style="display:block">
      <div class="section">
        <h3>üß© Skabelon Administration</h3>
        <div class="row" style="margin:16px 0">
          <input id="tmplName" class="input" placeholder="Navn p√• skabelon">
          <input id="tmplDesc" class="input" placeholder="Beskrivelse">
          <button id="createTemplate" class="btn primary">Opret skabelon</button>
        </div>

        <h4 style="margin-top:24px">Eksisterende skabeloner</h4>
        <div id="tmplList" style="margin-top:16px"></div>
      </div>
    </div>

    <!-- Projekter -->
    <div id="tab-projects" style="display:none">
      <div class="section">
        <h3>üìÅ Projektoversigt</h3>
        <p class="muted" style="margin-bottom:20px">Overv√•g alle projekter i systemet.</p>
        
        <table id="projectsTbl" class="projects-table">
          <thead>
            <tr>
              <th>Titel</th>
              <th>Ejer</th>
              <th>√Öbner</th>
              <th>Lukker</th>
              <th>Personer</th>
              <th>Svar</th>
              <th>Link</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Brugere -->
    <div id="tab-users" style="display:none">
      <div class="section">
        <h3>üîë Generer aktiveringsn√∏gle</h3>
        <div class="row" style="margin:16px 0">
          <input id="keyEmail" class="input" placeholder="Email til evaluator" type="email">
          <input id="keyNotes" class="input" placeholder="Valgfri note">
          <button id="generateKey" class="btn primary">Generer n√∏gle</button>
        </div>
        
        <div id="keyResult" class="key-result">
          <h4>Aktiveringsn√∏gle genereret!</h4>
          <div style="margin-top:12px">
            <p><strong>N√∏gle:</strong></p>
            <div class="key-code" id="generatedKey"></div>
            <p><strong>Email:</strong> <span id="generatedEmail"></span></p>
          </div>
          <p class="muted" style="margin-top:12px">Send denne n√∏gle til brugeren.</p>
        </div>

        <h3 style="margin-top:32px">üìã Aktiveringsn√∏gler</h3>
        <table id="keysTbl" style="margin-top:16px">
          <thead>
            <tr>
              <th>N√∏gle</th>
              <th>Email</th>
              <th>Status</th>
              <th>Oprettet</th>
              <th>Note</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <h3 style="margin-top:32px">üë§ Brugere</h3>
        <div class="row" style="margin:16px 0">
          <input id="userEmailInput" class="input" placeholder="Email adresse">
          <select id="userRole" class="select">
            <option value="evaluator">Evaluator</option>
            <option value="programmer">Programm√∏r</option>
          </select>
          <button id="addUser" class="btn primary">Tilf√∏j rolle</button>
        </div>

        <table id="usersTbl" class="users-table" style="margin-top:16px">
          <thead>
            <tr>
              <th>Email</th>
              <th>Rolle</th>
              <th>Oprettet</th>
              <th>Handling</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>
</div>

<script>
window.addEventListener('load', function() {
  const SUPABASE_URL = "https://wsrstyrsuwhcmmlmnbrz.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndzcnN0eXJzdXdoY21tbG1uYnJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MTU0NTIsImV4cCI6MjA3MTE5MTQ1Mn0.Rf3Z3bQGjV5CKXKZr6IMOjzPdbhVJCh3SwuvlkpxUD0";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id) => document.getElementById(id);
  let user = null;
  
  // Tab switching
  document.querySelectorAll('.tabbtn').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.tabbtn').forEach(x => x.classList.remove('active'));
      btn.classList.add('active');

      ['templates', 'projects', 'users'].forEach(name => {
        const panel = $('tab-' + name);
        if(panel) panel.style.display = 'none';
      });

      const target = $('tab-' + btn.dataset.tab);
      if(target) target.style.display = 'block';
    };
  });

  // Auth
  $('logoutBtn').onclick = async () => { 
    await supabase.auth.signOut(); 
    window.location.href = 'login.html';
  };

  async function guard() {
    const { data: u } = await supabase.auth.getUser();
    if(!u?.user){ 
      window.location.href = 'login.html'; 
      return;
    }
    
    const { data: roleData } = await supabase
      .from('user_roles')
      .select('role')
      .eq('user_id', u.user.id)
      .single();

    if(roleData?.role !== 'programmer'){
      window.location.href = 'admin.html';
      return;
    }

    user = u.user;
    const emailEl = $('userEmail');
    if(emailEl) emailEl.textContent = user.email || '';
    await loadAll();
  }

  guard();

  async function loadAll() { 
    await loadTemplates(); 
    await loadProjects(); 
    await loadUsers();
  }

  // Templates
  async function loadTemplates() {
    const { data } = await supabase.from('templates').select().order('created_at', {ascending: false});
    const container = $('tmplList'); 
    container.innerHTML = ''; 
    
    (data || []).forEach(t => { 
      const div = document.createElement('div'); 
      div.className = 'template-item'; 
      div.innerHTML = `
        <div class="template-info">
          <strong>${t.name}</strong> v${t.version}<br>
          <span class="muted">${t.description || ''}</span>
        </div>
        <div class="template-actions">
          <button class="btn small" onclick="editTemplate('${t.id}')" style="background:var(--brand);color:white;border-color:var(--brand)">Rediger</button>
          <button class="btn small" onclick="deleteTemplate('${t.id}', '${t.name.replace(/'/g, '\\\'')}')" style="background:#dc3545;color:white;border-color:#dc3545">Slet</button>
        </div>
      `; 
      container.appendChild(div); 
    });
  }

  // Template actions (simplified)
  window.editTemplate = (id) => {
    alert('Redigering kommer snart! Template ID: ' + id);
  };

  window.deleteTemplate = async (templateId, templateName) => {
    if(!confirm(`Slet "${templateName}"?`)) return;
    
    try {
      const { error } = await supabase.from('templates').delete().eq('id', templateId);
      if(error) throw error;
      alert(`"${templateName}" slettet`);
      loadTemplates();
    } catch(error) {
      alert('Fejl: ' + error.message);
    }
  };

  $('createTemplate').onclick = async () => {
    const name = $('tmplName').value.trim();
    const desc = $('tmplDesc').value.trim();
    if(!name) return alert('Navn p√•kr√¶vet');
    
    const { error } = await supabase.from('templates').insert({
      name, description: desc, version: 1
    });
    
    if(error) return alert(error.message);
    $('tmplName').value = '';
    $('tmplDesc').value = '';
    loadTemplates();
    alert('Skabelon oprettet!');
  };

  // Projects
  async function loadProjects() {
    const { data } = await supabase.from('v_all_projects_with_owners').select('*').limit(1000);
    const tb = $('projectsTbl').querySelector('tbody'); 
    tb.innerHTML = '';
    
    (data || []).forEach(p => {
      const tr = document.createElement('tr');
      const now = new Date();
      const openAt = p.open_at ? new Date(p.open_at) : null;
      const closeAt = p.close_at ? new Date(p.close_at) : null;
      
      let statusBadge = '<span class="status-badge status-draft">Kladde</span>';
      if(openAt && closeAt) {
        if(now < openAt) {
          statusBadge = '<span class="status-badge status-draft">Ikke √•bnet</span>';
        } else if(now > closeAt) {
          statusBadge = '<span class="status-badge status-closed">Lukket</span>';
        } else {
          statusBadge = '<span class="status-badge status-open">√Öben</span>';
        }
      }
      
      tr.innerHTML = `
        <td><strong>${p.title}</strong><br><span class="muted">${p.info_text || ''}</span><br>${statusBadge}</td>
        <td>${p.owner_email || 'N/A'}<br><span class="muted">${p.owner_role || 'ingen rolle'}</span></td>
        <td>${openAt ? openAt.toLocaleDateString('da-DK') : 'Ikke sat'}</td>
        <td>${closeAt ? closeAt.toLocaleDateString('da-DK') : 'Ikke sat'}</td>
        <td style="text-align:center">${p.people_count || 0}</td>
        <td style="text-align:center">${p.responses_count || 0}</td>
        <td style="text-align:center">${p.link_url ? '‚úÖ' : '‚Äî'}</td>
      `;
      tb.appendChild(tr);
    });
  }

  // Users
  async function loadUsers() {
    const { data: keys } = await supabase.from('v_activation_keys').select('*').order('created_at', {ascending: false});
    const ktb = $('keysTbl').querySelector('tbody'); 
    ktb.innerHTML = '';
    
    (keys || []).forEach(k => {
      const tr = document.createElement('tr');
      const status = k.used ? '<span style="color:var(--success)">Brugt</span>' : '<span style="color:var(--brand)">Aktiv</span>';
      
      tr.innerHTML = `
        <td style="font-family:monospace;font-weight:bold">${k.key_code}</td>
        <td>${k.email}</td>
        <td>${status}</td>
        <td>${new Date(k.created_at).toLocaleDateString()}</td>
        <td>${k.notes || '-'}</td>
      `;
      ktb.appendChild(tr);
    });

    const { data } = await supabase.from('v_users_with_roles').select('*').order('created_at', {ascending: false});
    const tb = $('usersTbl').querySelector('tbody'); 
    tb.innerHTML = '';
    
    (data || []).forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.email || 'N/A'}</td>
        <td>${u.role || 'Ingen rolle'}</td>
        <td>${new Date(u.created_at).toLocaleDateString()}</td>
        <td><button class="btn small" onclick="removeUserRole('${u.email}')" style="background:#dc3545;color:white">Fjern</button></td>
      `;
      tb.appendChild(tr);
    });
  }

  $('generateKey').onclick = async () => {
    const email = $('keyEmail').value.trim();
    const notes = $('keyNotes').value.trim();
    if(!email) return alert('Email p√•kr√¶vet');
    
    const { data, error } = await supabase.rpc('generate_activation_key', {
      p_email: email, p_notes: notes || null
    });
    
    if(error || data.error) return alert(error?.message || data.error);
    
    $('generatedKey').textContent = data.key_code;
    $('generatedEmail').textContent = data.email;
    $('keyResult').style.display = 'block';
    $('keyEmail').value = '';
    $('keyNotes').value = '';
    loadUsers();
    
    setTimeout(() => $('keyResult').style.display = 'none', 30000);
  };

  window.removeUserRole = async (email) => {
    if(!confirm(`Fjern rolle for ${email}?`)) return;
    const { data, error } = await supabase.rpc('remove_user_role', { p_user_email: email });
    if(error || data.error) return alert(error?.message || data.error);
    alert(data.message);
    loadUsers();
  };

  $('addUser').onclick = async () => {
    const email = $('userEmailInput').value.trim();
    const role = $('userRole').value;
    if(!email) return alert('Email p√•kr√¶vet');
    
    const { data, error } = await supabase.rpc('manage_user_role', {
      p_user_email: email, p_role: role
    });
    
    if(error || data.error) return alert(error?.message || data.error);
    alert(data.message);
    $('userEmailInput').value = '';
    loadUsers();
  };
});
</script>
</body>
</html>
